# 14.4 安全存储与传输

## 数据存储安全

### 1. 文件加密

```python
from cryptography.fernet import Fernet
import os

class SecureFileStorage:
    """安全文件存储"""

    def __init__(self, key_file='secret.key'):
        if os.path.exists(key_file):
            with open(key_file, 'rb') as f:
                self.key = f.read()
        else:
            self.key = Fernet.generate_key()
            with open(key_file, 'wb') as f:
                f.write(self.key)

        self.cipher = Fernet(self.key)

    def encrypt_file(self, input_file, output_file):
        """加密文件"""
        with open(input_file, 'rb') as f:
            data = f.read()

        encrypted = self.cipher.encrypt(data)

        with open(output_file, 'wb') as f:
            f.write(encrypted)

    def decrypt_file(self, input_file, output_file):
        """解密文件"""
        with open(input_file, 'rb') as f:
            encrypted = f.read()

        decrypted = self.cipher.decrypt(encrypted)

        with open(output_file, 'wb') as f:
            f.write(decrypted)

# 使用
storage = SecureFileStorage()
storage.encrypt_file('patients.xlsx', 'patients.xlsx.encrypted')
```

### 2. 数据库加密

```python
import sqlite3
from sqlalchemy import create_engine

# 使用SQLCipher(加密SQLite)
conn = sqlite3.connect('database.db')
conn.execute("PRAGMA key = 'your-secret-password'")
```

### 3. 访问控制

```python
import os
import stat

# 设置文件权限(仅所有者可读写)
os.chmod('sensitive_data.xlsx', stat.S_IRUSR | stat.S_IWUSR)

# 验证
file_stats = os.stat('sensitive_data.xlsx')
print(f"文件权限: {oct(file_stats.st_mode)}")
```

## 数据传输安全

### HTTPS传输

```python
import requests

# ✅ 使用HTTPS
response = requests.get('https://api.example.com/data')

# ❌ 避免HTTP
# response = requests.get('http://api.example.com/data')
```

### SSH/SFTP传输

```python
import paramiko

def secure_file_transfer(local_file, remote_file, host, username, password):
    """通过SFTP安全传输文件"""

    transport = paramiko.Transport((host, 22))
    transport.connect(username=username, password=password)

    sftp = paramiko.SFTPClient.from_transport(transport)
    sftp.put(local_file, remote_file)

    sftp.close()
    transport.close()
```

## 检查清单

- [ ] 敏感数据已加密存储
- [ ] 使用强密码
- [ ] 定期备份
- [ ] 访问日志记录
- [ ] 传输使用加密协议

## 下一步

[14.5 最佳实践清单](14.5-best-practices.md)
