# 8.3 测试验证:确保代码正确运行

## 为什么需要测试?

AI生成的代码可能:
- ✅ 语法正确
- ✅ 逻辑看起来对
- ❌ 但边界情况未考虑

**测试 = 给代码做体检**

## 测试策略

### 1. 手动测试(初学者必备)

**准备测试数据**:
```python
# test_data.csv (故意包含各种情况)
patient_id,age,blood_pressure
P001,45,120/80     # 正常
P002,150,135/90    # 异常年龄
P003,52,           # 缺失血压
P004,38,999/999    # 异常血压
P005,P001,120/80   # 重复ID
```

**测试步骤**:
1. 运行代码
2. 检查输出是否符合预期
3. 验证异常数据被正确处理

### 2. 断言测试

```python
def calculate_bmi(weight, height):
    return weight / (height ** 2)

# 测试用例
assert calculate_bmi(70, 1.75) == 22.857142857142858
assert calculate_bmi(50, 1.50) == 22.22222222222222

print("✓ 所有测试通过!")
```

### 3. 使用pytest(进阶)

```python
# test_bmi.py
import pytest
from bmi_calculator import calculate_bmi

def test_normal_case():
    assert calculate_bmi(70, 1.75) == pytest.approx(22.86, rel=0.01)

def test_edge_case():
    with pytest.raises(ValueError):
        calculate_bmi(-70, 1.75)  # 负数应该报错

# 运行: pytest test_bmi.py
```

## 让AI帮你写测试

**提示AI**:
```
为以下函数编写测试用例,包括:
1. 正常情况
2. 边界情况(0, 负数, 极大值)
3. 异常输入(None, 字符串)

[粘贴你的函数代码]
```

**AI生成测试**:
```python
def test_calculate_bmi():
    # 正常情况
    assert calculate_bmi(70, 1.75) == 22.857142857142858

    # 边界情况
    assert calculate_bmi(1, 1) == 1.0  # 最小值
    assert calculate_bmi(200, 2.0) == 50.0  # 极端值

    # 异常情况
    try:
        calculate_bmi(-70, 1.75)
        assert False, "应该抛出ValueError"
    except ValueError:
        pass  # 正确抛出异常

    try:
        calculate_bmi(None, 1.75)
        assert False, "应该抛出TypeError"
    except TypeError:
        pass
```

## 实战检查清单

运行代码前检查:

- [ ] 准备了测试数据(包含异常情况)
- [ ] 函数返回值类型正确
- [ ] 错误处理是否生效
- [ ] 边界情况(空数据、单条数据)
- [ ] 输出文件是否正确生成

## 常见问题排查

### 问题1: 代码能运行,但结果不对

**解决**:
```python
# 添加调试输出
print(f"DEBUG: df shape = {df.shape}")
print(f"DEBUG: 平均年龄 = {df['age'].mean()}")

# 检查中间结果
```

### 问题2: 特定数据报错

**解决**: 隔离问题数据
```python
# 只测试出错的那一行
problematic_row = df.iloc[42]
process_patient(problematic_row)  # 单独测试
```

## 下一步

[8.4 调试修复:AI辅助排错](8.4-debugging-with-ai.md)
