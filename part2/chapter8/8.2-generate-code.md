# 8.2 生成代码:迭代优化的技巧

## AI生成代码的正确姿势

**核心原则**: 不要期望一次生成完美代码,而是通过多轮迭代逐步优化。

## 迭代开发流程

```
第1轮: 生成基础框架
  ↓
第2轮: 添加核心功能
  ↓
第3轮: 完善错误处理
  ↓
第4轮: 优化性能和代码质量
  ↓
第5轮: 添加文档和测试
```

## 实战案例: 血压数据分析工具

### 第1轮: 基础框架

**你的提示**:
```
写一个Python脚本框架,用于血压数据分析:
- 读取CSV文件
- 打印数据基本信息
- 不需要复杂功能,只要能运行
```

**AI生成**:
```python
import pandas as pd

def main():
    # 读取数据
    df = pd.read_csv('blood_pressure.csv')

    # 显示基本信息
    print("数据概览:")
    print(df.head())
    print(f"\n总记录数: {len(df)}")
    print(f"列名: {df.columns.tolist()}")

if __name__ == "__main__":
    main()
```

**测试**: 运行确保能读取文件 ✅

### 第2轮: 添加分析功能

**你的提示**:
```
在上面的代码基础上,添加:
1. 计算平均血压
2. 统计高血压患者数(收缩压≥140)
3. 按年龄段分组统计
```

**AI扩展**:
```python
import pandas as pd

def analyze_blood_pressure(df):
    """分析血压数据"""

    # 1. 平均血压
    avg_systolic = df['systolic'].mean()
    avg_diastolic = df['diastolic'].mean()
    print(f"\n平均血压: {avg_systolic:.1f}/{avg_diastolic:.1f} mmHg")

    # 2. 高血压统计
    hypertension = df[df['systolic'] >= 140]
    print(f"高血压患者: {len(hypertension)}人 ({len(hypertension)/len(df)*100:.1f}%)")

    # 3. 年龄段分组
    df['age_group'] = pd.cut(df['age'], bins=[0, 40, 60, 100], labels=['<40', '40-60', '>60'])
    grouped = df.groupby('age_group')['systolic'].mean()
    print("\n各年龄段平均收缩压:")
    print(grouped)

def main():
    df = pd.read_csv('blood_pressure.csv')
    print("数据概览:")
    print(df.head())
    analyze_blood_pressure(df)

if __name__ == "__main__":
    main()
```

**测试**: 验证统计结果是否正确 ✅

### 第3轮: 添加错误处理

**你的提示**:
```
添加完整的错误处理:
- 文件不存在
- 列名不匹配
- 数据格式错误
- 异常值(如负数血压)
```

**AI改进**:
```python
import pandas as pd
import sys

def validate_data(df):
    """验证数据完整性"""
    required_columns = ['patient_id', 'age', 'systolic', 'diastolic']

    # 检查必需列
    missing_cols = [col for col in required_columns if col not in df.columns]
    if missing_cols:
        raise ValueError(f"缺少必需的列: {missing_cols}")

    # 检查异常值
    invalid_bp = df[(df['systolic'] < 0) | (df['diastolic'] < 0)]
    if len(invalid_bp) > 0:
        print(f"⚠️  警告: 发现{len(invalid_bp)}条异常血压数据,已自动删除")
        df = df[(df['systolic'] >= 0) & (df['diastolic'] >= 0)]

    return df

def main():
    try:
        # 读取数据
        df = pd.read_csv('blood_pressure.csv')
    except FileNotFoundError:
        print("❌ 错误: 找不到blood_pressure.csv文件")
        sys.exit(1)
    except Exception as e:
        print(f"❌ 读取文件出错: {e}")
        sys.exit(1)

    try:
        # 验证数据
        df = validate_data(df)

        # 分析
        print("✓ 数据加载成功")
        analyze_blood_pressure(df)

    except ValueError as e:
        print(f"❌ 数据验证失败: {e}")
        sys.exit(1)
    except Exception as e:
        print(f"❌ 分析过程出错: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()
```

**测试**: 故意用错误数据测试 ✅

### 第4轮: 添加可视化

**你的提示**:
```
添加数据可视化:
1. 血压分布直方图
2. 年龄与血压散点图
3. 保存图片到output文件夹
```

**AI扩展**:
```python
import matplotlib.pyplot as plt
from pathlib import Path

def visualize_data(df, output_dir='output'):
    """生成可视化图表"""

    # 创建输出目录
    Path(output_dir).mkdir(exist_ok=True)

    # 图1: 血压分布
    fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(12, 4))

    ax1.hist(df['systolic'], bins=20, color='steelblue', alpha=0.7)
    ax1.axvline(140, color='red', linestyle='--', label='高血压阈值')
    ax1.set_xlabel('收缩压 (mmHg)')
    ax1.set_ylabel('人数')
    ax1.set_title('收缩压分布')
    ax1.legend()

    # 图2: 年龄与血压
    ax2.scatter(df['age'], df['systolic'], alpha=0.5)
    ax2.set_xlabel('年龄')
    ax2.set_ylabel('收缩压 (mmHg)')
    ax2.set_title('年龄与血压关系')

    plt.tight_layout()
    plt.savefig(f'{output_dir}/bp_analysis.png', dpi=300)
    print(f"✓ 图表已保存: {output_dir}/bp_analysis.png")
```

### 第5轮: 最终优化

**你的提示**:
```
最后优化:
1. 添加命令行参数(输入文件、输出目录)
2. 添加docstring文档
3. 生成分析报告文件
4. 代码符合PEP 8规范
```

**AI完善**:
```python
"""
血压数据分析工具

用法:
    python bp_analyzer.py input.csv --output results/

作者: AI辅助开发
日期: 2025-01-15
"""

import pandas as pd
import matplotlib.pyplot as plt
import argparse
from pathlib import Path
from datetime import datetime

def analyze_blood_pressure(df):
    """
    分析血压数据

    Args:
        df: 包含血压数据的DataFrame

    Returns:
        dict: 分析结果
    """
    results = {}

    # 统计分析
    results['avg_systolic'] = df['systolic'].mean()
    results['avg_diastolic'] = df['diastolic'].mean()
    results['hypertension_count'] = len(df[df['systolic'] >= 140])
    results['hypertension_rate'] = results['hypertension_count'] / len(df) * 100

    return results

def generate_report(results, output_file):
    """生成分析报告"""
    with open(output_file, 'w', encoding='utf-8') as f:
        f.write("=" * 50 + "\n")
        f.write("血压数据分析报告\n")
        f.write("=" * 50 + "\n")
        f.write(f"生成时间: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n")
        f.write(f"平均收缩压: {results['avg_systolic']:.1f} mmHg\n")
        f.write(f"平均舒张压: {results['avg_diastolic']:.1f} mmHg\n")
        f.write(f"高血压患者: {results['hypertension_count']}人 ({results['hypertension_rate']:.1f}%)\n")

    print(f"✓ 报告已保存: {output_file}")

def main():
    parser = argparse.ArgumentParser(description='血压数据分析工具')
    parser.add_argument('input_file', help='输入CSV文件路径')
    parser.add_argument('--output', default='output', help='输出目录(默认: output)')

    args = parser.parse_args()

    # 创建输出目录
    output_dir = Path(args.output)
    output_dir.mkdir(exist_ok=True)

    # 分析流程
    df = pd.read_csv(args.input_file)
    df = validate_data(df)
    results = analyze_blood_pressure(df)
    visualize_data(df, args.output)
    generate_report(results, output_dir / 'report.txt')

    print("\n✓ 分析完成!")

if __name__ == "__main__":
    main()
```

## 迭代优化的关键

### 1. 每次只改进一个方面

✅ 好的迭代:
- 第1轮: 实现基础功能
- 第2轮: 添加错误处理
- 第3轮: 优化性能

❌ 错误做法:
- 一次性要求所有功能 → AI容易出错

### 2. 及时测试

每一轮生成后:
1. 运行代码
2. 测试边界情况
3. 发现问题立即反馈给AI

### 3. 保留版本

```
bp_analyzer_v1.py  # 基础版
bp_analyzer_v2.py  # 添加错误处理
bp_analyzer_v3.py  # 最终版
```

如果新版本有问题,可以回退。

## 常见优化请求

### 性能优化
```
"这段代码处理100万行数据很慢,请优化性能"
```

### 代码重构
```
"将这个200行的函数拆分为多个小函数,提高可读性"
```

### 添加功能
```
"在原有基础上添加导出Excel功能,包含多个工作表"
```

### 修复Bug
```
"运行时出现KeyError: 'age',请修复并添加验证"
```

## 检查清单

- [ ] 理解迭代开发的重要性
- [ ] 能够拆分需求为多个阶段
- [ ] 每轮迭代后及时测试
- [ ] 知道如何向AI反馈问题
- [ ] 保留代码版本便于回退

## 下一步

[8.3 测试验证:确保代码正确运行](8.3-testing.md)
