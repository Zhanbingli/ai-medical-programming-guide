# 7.5 实战:用Cursor开发数据清洗脚本

## 项目目标

开发一个完整的患者数据清洗工具,从混乱数据到可用数据集。

## 需求分析

**输入**: `raw_patients.xlsx` (包含各种问题的原始数据)
**问题**:
- 缺失值
- 重复记录
- 格式不统一
- 异常值

**输出**: `cleaned_patients.xlsx` (标准化的清洗数据)

## 开发步骤

### Step 1: 创建项目

```bash
mkdir patient_data_cleaner
cd patient_data_cleaner
```

用Cursor打开此文件夹。

### Step 2: 与AI对话

按 `Cmd+L`,输入需求:

```
我要开发一个Python脚本,清洗患者数据:

输入文件: raw_patients.xlsx
列: patient_id, name, age, gender, blood_pressure

需要处理:
1. 删除重复的patient_id
2. 年龄: 填充缺失值为中位数,删除<0或>120的异常值
3. 性别: 统一为M/F,删除其他值
4. 血压: 格式统一为"120/80",处理异常格式

输出: cleaned_patients.xlsx

要求:
- 使用pandas
- 添加完整错误处理
- 显示清洗前后对比
- 生成清洗日志
```

### Step 3: AI生成代码

Cursor会生成类似:

```python
import pandas as pd
import re
from datetime import datetime

def clean_patient_data(input_file, output_file):
    """清洗患者数据"""

    print("=" * 50)
    print("患者数据清洗工具")
    print("=" * 50)

    # 读取数据
    try:
        df = pd.read_excel(input_file)
        print(f"\n✓ 成功读取数据: {len(df)}条记录")
    except FileNotFoundError:
        print(f"❌ 错误: 找不到文件 {input_file}")
        return
    except Exception as e:
        print(f"❌ 读取文件出错: {e}")
        return

    original_count = len(df)

    # 1. 删除重复记录
    df = df.drop_duplicates(subset=['patient_id'], keep='first')
    dup_removed = original_count - len(df)
    print(f"\n1. 删除重复记录: {dup_removed}条")

    # 2. 清洗年龄
    df['age'] = pd.to_numeric(df['age'], errors='coerce')
    age_median = df['age'].median()
    age_missing = df['age'].isnull().sum()
    df['age'].fillna(age_median, inplace=True)

    # 删除异常年龄
    age_outliers = len(df[(df['age'] < 0) | (df['age'] > 120)])
    df = df[(df['age'] >= 0) & (df['age'] <= 120)]

    print(f"2. 年龄清洗:")
    print(f"   - 填充缺失值: {age_missing}个 (用中位数{age_median:.0f})")
    print(f"   - 删除异常值: {age_outliers}个")

    # 3. 清洗性别
    df['gender'] = df['gender'].str.upper()
    df['gender'] = df['gender'].map({'M': 'M', 'MALE': 'M',
                                      'F': 'F', 'FEMALE': 'F'})
    gender_invalid = df['gender'].isnull().sum()
    df = df.dropna(subset=['gender'])
    print(f"3. 性别清洗: 删除无效值{gender_invalid}个")

    # 4. 清洗血压
    def clean_bp(bp_str):
        if pd.isnull(bp_str):
            return None
        # 提取数字
        numbers = re.findall(r'\d+', str(bp_str))
        if len(numbers) >= 2:
            return f"{numbers[0]}/{numbers[1]}"
        return None

    df['blood_pressure'] = df['blood_pressure'].apply(clean_bp)
    bp_invalid = df['blood_pressure'].isnull().sum()
    df = df.dropna(subset=['blood_pressure'])
    print(f"4. 血压清洗: 删除无效格式{bp_invalid}个")

    # 保存结果
    try:
        df.to_excel(output_file, index=False)
        print(f"\n✓ 清洗完成! 保存到: {output_file}")
        print(f"  原始记录: {original_count}条")
        print(f"  清洗后: {len(df)}条")
        print(f"  清洗率: {(1-len(df)/original_count)*100:.1f}%")

        # 生成日志
        log_file = f"cleaning_log_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt"
        with open(log_file, 'w', encoding='utf-8') as f:
            f.write(f"数据清洗日志\n")
            f.write(f"清洗时间: {datetime.now()}\n")
            f.write(f"原始记录: {original_count}\n")
            f.write(f"清洗后: {len(df)}\n")
        print(f"  日志已保存: {log_file}")

    except Exception as e:
        print(f"❌ 保存文件出错: {e}")

if __name__ == "__main__":
    clean_patient_data('raw_patients.xlsx', 'cleaned_patients.xlsx')
```

### Step 4: 测试和优化

运行代码,如果遇到问题:

```
👤: 运行时发现血压列有"120-80"格式,请改进正则表达式

🤖 Cursor: (自动修改clean_bp函数)
```

## 扩展功能

继续对话,添加更多功能:

```
👤: 请添加:
1. 生成HTML清洗报告
2. 可视化清洗前后对比
3. 支持命令行参数
```

AI会继续扩展代码。

## 总结

通过Cursor,我们在30分钟内:
- ✅ 开发了完整的数据清洗工具
- ✅ 包含错误处理和日志
- ✅ 可复用于其他项目

**关键**: 描述清楚需求,让AI生成,你只需审核和测试!

## 检查清单

- [ ] 成功运行数据清洗脚本
- [ ] 理解每部分代码逻辑
- [ ] 能根据需求调整参数
- [ ] 可以扩展到自己的数据集
