# 7.2 Cursor：AI原生编辑器

## 什么是Cursor？

Cursor是一个基于VSCode的AI原生代码编辑器，核心理念是**"用对话开发代码"**。

### 与传统编辑器的区别

| 传统编辑器（VSCode） | Cursor |
|---------------------|--------|
| 你写代码，编辑器高亮显示 | AI帮你写代码，你审核修改 |
| 需要手动查文档 | 直接问AI怎么做 |
| 报错需要自己调试 | AI解释错误并提供修复 |
| 重构靠手工 | AI理解多文件逻辑，智能重构 |

### 为什么医生应该用Cursor？

✅ **零基础友好**：不需要记忆语法，用自然语言描述需求
✅ **理解医学场景**：AI可以理解"随访"、"病历"等医学概念
✅ **完整项目支持**：不只是代码片段，能开发完整工具
✅ **多文件理解**：自动理解项目结构，无需手动切换文件

## 安装与配置

### 第1步：下载安装

1. 访问 [cursor.sh](https://cursor.sh)
2. 下载对应系统版本（Mac/Windows/Linux）
3. 安装（如同安装普通软件）

### 第2步：登录与配置

1. 首次打开，使用邮箱注册/登录
2. 选择AI模型（推荐：Claude 3.5 Sonnet或GPT-4）
3. 设置：Settings → Cursor Settings
   - ✅ 开启 "Cursor Tab" (代码补全)
   - ✅ 开启 "Auto-import" (自动导入库)

### 第3步：测试是否正常

按 `Cmd+L` (Mac) 或 `Ctrl+L` (Windows)，在聊天框输入：
```
写一个Python函数，计算BMI
```

如果AI返回代码，说明配置成功！

## 核心功能详解

### 功能1：Chat - 对话式编程

**快捷键**：`Cmd+L` (Mac) / `Ctrl+L` (Windows)

#### 使用场景：从零开始写代码

**示例：开发随访提醒工具**

```
👤 你：我需要一个Python脚本，功能是：
1. 读取Excel文件（包含患者姓名、手机号、随访日期）
2. 找出距离今天7天内需要随访的患者
3. 导出到新的Excel文件

🤖 Cursor：我来帮你实现...（生成完整代码）
```

生成的代码：
```python
import pandas as pd
from datetime import datetime, timedelta

# 读取患者数据
df = pd.read_excel('patients.xlsx')

# 计算随访日期
today = datetime.now()
reminder_date = today + timedelta(days=7)

# 筛选需要随访的患者
df['随访日期'] = pd.to_datetime(df['随访日期'])
upcoming = df[
    (df['随访日期'] >= today) &
    (df['随访日期'] <= reminder_date)
]

# 导出结果
upcoming.to_excel('upcoming_followups.xlsx', index=False)
print(f"找到{len(upcoming)}位需要随访的患者")
```

#### 技巧：如何提问更有效？

**❌ 模糊提问**：
```
帮我写个处理数据的代码
```

**✅ 清晰提问**：
```
写一个Python脚本：
- 输入：patients.xlsx（列：姓名、年龄、血糖值）
- 功能：筛选血糖>7.0的患者
- 输出：high_glucose.xlsx
- 要求：使用pandas库
```

### 功能2：Cmd+K - 行内代码生成/修改

**快捷键**：选中代码 → `Cmd+K` (Mac) / `Ctrl+K` (Windows)

#### 使用场景1：生成新代码

1. 在空白行按 `Cmd+K`
2. 输入需求：`读取Excel文件并打印前5行`
3. AI直接在光标位置生成代码

#### 使用场景2：修改现有代码

选中这段代码：
```python
patients = pd.read_excel('data.xlsx')
print(patients)
```

按 `Cmd+K`，输入：
```
添加错误处理，如果文件不存在，打印友好提示
```

AI自动修改为：
```python
try:
    patients = pd.read_excel('data.xlsx')
    print(patients)
except FileNotFoundError:
    print("错误：找不到data.xlsx文件，请检查文件路径")
except Exception as e:
    print(f"读取文件时出错：{e}")
```

#### 使用场景3：重构代码

选中重复代码：
```python
# 计算患者1的BMI
weight1 = 70
height1 = 1.75
bmi1 = weight1 / (height1 ** 2)

# 计算患者2的BMI
weight2 = 65
height2 = 1.68
bmi2 = weight2 / (height2 ** 2)
```

`Cmd+K` → 输入：`重构为函数`

AI生成：
```python
def calculate_bmi(weight, height):
    """计算BMI"""
    return weight / (height ** 2)

bmi1 = calculate_bmi(70, 1.75)
bmi2 = calculate_bmi(65, 1.68)
```

### 功能3：多文件理解

Cursor能自动理解项目中多个文件的关系。

#### 示例：重构多文件项目

**项目结构**：
```
medical_tool/
├── data_loader.py    # 数据加载
├── analysis.py       # 数据分析
└── main.py          # 主程序
```

在 Chat 中输入：
```
我想在analysis.py中添加一个新函数calculate_mean_age，
然后在main.py中调用它
```

Cursor会：
1. 自动在 `analysis.py` 中添加函数
2. 自动在 `main.py` 中导入并调用
3. 确保代码风格一致

### 功能4：@符号引用

在Chat中使用 `@` 来引用特定内容：

| 符号 | 作用 | 示例 |
|------|------|------|
| @文件名 | 引用特定文件 | `@data_loader.py 这个文件有什么问题？` |
| @Codebase | 引用整个项目 | `@Codebase 项目中哪里处理了患者年龄？` |
| @Docs | 引用文档 | `@Docs pandas如何读取Excel？` |
| @Web | 搜索网络 | `@Web Python最新版本是什么？` |

#### 实战示例

```
👤 你：@data_loader.py 这个文件的load_patients函数能处理缺失值吗？

🤖 Cursor：分析代码...目前没有处理缺失值。我建议添加：
（显示具体代码改进方案）

👤 你：@Codebase 项目中所有涉及日期处理的地方

🤖 Cursor：找到3处：
1. data_loader.py 第45行 - 解析随访日期
2. analysis.py 第23行 - 计算日期差
3. utils.py 第12行 - 格式化日期输出
```

## 实战案例：用Cursor开发文献管理工具

### 需求
批量重命名PubMed下载的PDF文件：
- 原文件名：`pubmed_12345678.pdf`
- 目标格式：`作者_年份_标题.pdf`

### 开发流程

#### Step 1：创建项目

1. 新建文件夹 `literature_manager`
2. 用Cursor打开：File → Open Folder

#### Step 2：与AI对话

按 `Cmd+L`，输入：

```
我要开发一个Python脚本，功能是：

1. 扫描指定文件夹中的所有PDF文件
2. 从文件名中提取PubMed ID（如12345678）
3. 调用PubMed API获取文献信息（作者、年份、标题）
4. 重命名文件为"第一作者_年份_标题.pdf"

请使用：
- os库处理文件
- requests库调用API
- 添加错误处理
- 显示进度

请分步实现，先写基础框架。
```

#### Step 3：AI生成代码

Cursor生成 `rename_papers.py`：

```python
import os
import re
import requests
from pathlib import Path

def extract_pmid(filename):
    """从文件名提取PubMed ID"""
    match = re.search(r'pubmed_(\d+)', filename)
    return match.group(1) if match else None

def fetch_paper_info(pmid):
    """从PubMed获取文献信息"""
    url = f"https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi"
    params = {
        'db': 'pubmed',
        'id': pmid,
        'retmode': 'json'
    }

    try:
        response = requests.get(url, params=params)
        data = response.json()
        result = data['result'][pmid]

        # 提取信息
        authors = result['authors'][0]['name'] if result['authors'] else 'Unknown'
        year = result['pubdate'][:4]
        title = result['title']

        return {
            'author': authors.split()[0],  # 姓
            'year': year,
            'title': title[:50]  # 限制长度
        }
    except Exception as e:
        print(f"获取PMID {pmid}信息失败: {e}")
        return None

def rename_papers(folder_path):
    """批量重命名文献"""
    folder = Path(folder_path)
    pdf_files = list(folder.glob('pubmed_*.pdf'))

    print(f"找到{len(pdf_files)}个文件")

    for i, pdf_file in enumerate(pdf_files, 1):
        print(f"\n处理 {i}/{len(pdf_files)}: {pdf_file.name}")

        # 提取PMID
        pmid = extract_pmid(pdf_file.name)
        if not pmid:
            print("  ⚠️  无法提取PMID，跳过")
            continue

        # 获取文献信息
        info = fetch_paper_info(pmid)
        if not info:
            print("  ⚠️  无法获取文献信息，跳过")
            continue

        # 生成新文件名
        new_name = f"{info['author']}_{info['year']}_{info['title']}.pdf"
        # 清理非法字符
        new_name = re.sub(r'[<>:"/\\|?*]', '', new_name)

        # 重命名
        new_path = pdf_file.parent / new_name
        try:
            pdf_file.rename(new_path)
            print(f"  ✅ 重命名为: {new_name}")
        except Exception as e:
            print(f"  ❌ 重命名失败: {e}")

if __name__ == "__main__":
    folder = input("请输入PDF文件夹路径: ")
    rename_papers(folder)
```

#### Step 4：测试与改进

运行代码，发现问题后继续对话：

```
👤 你：运行后发现标题中有特殊字符导致重命名失败，请改进

🤖 Cursor：（自动修改代码，添加字符过滤）

👤 你：能否添加进度条？

🤖 Cursor：可以，我使用tqdm库...（添加进度条代码）
```

## 最佳实践

### 1. 描述需求要具体

**❌ 不好**：
```
写个处理Excel的代码
```

**✅ 好**：
```
读取patients.xlsx，筛选age>60的行，计算平均血压，保存到结果文件
```

### 2. 分步开发

不要一次性要求完成复杂功能，而是：
```
第1轮：先实现基础读取和保存
第2轮：添加数据筛选逻辑
第3轮：添加统计功能
第4轮：优化错误处理
```

### 3. 使用@引用提高精度

```
@data.xlsx 这个文件的结构是什么？
（AI分析文件后再提需求）

基于这个结构，帮我写筛选代码
```

### 4. 让AI解释代码

```
这段代码的逻辑是什么？
为什么要用try-except？
有没有更好的写法？
```

## 常见问题

### Q1：AI生成的代码运行报错怎么办？

**方法1**：复制完整错误信息，发给AI
```
运行后出现错误：
KeyError: 'age'
请帮我修复
```

**方法2**：使用 `Cmd+L`，点击 "Debug" 按钮，AI自动分析

### Q2：如何让AI生成符合规范的代码？

在Chat中设置规范：
```
从现在开始，生成的Python代码需要：
1. 添加类型提示
2. 使用有意义的变量名（医学场景）
3. 添加注释
4. 包含错误处理
```

### Q3：AI理解我的项目吗？

使用 `@Codebase` 测试：
```
@Codebase 总结项目的主要功能
@Codebase 数据流是怎样的？
```

## 💡 核心要点

1. **Cursor = 会写代码的助手**，你负责提需求和审核
2. **Chat功能**用于大块开发，**Cmd+K**用于局部修改
3. **@符号**让AI精准理解你的意图
4. **迭代开发**比一次性完成更高效
5. **遇到问题立即问AI**，不要自己死磕

## 下一步

掌握了Cursor，你已经可以独立开发医学小工具了！下一节学习[Claude Code](7.3-claude-code.md)——适合命令行场景的AI助手。

---

## 🔨 实战任务

使用Cursor完成以下任务：

1. **初级**：写一个脚本，读取Excel文件并打印前5行
2. **中级**：开发BMI计算工具，从Excel读取身高体重，计算BMI并分类
3. **高级**：实现本节的文献重命名工具，测试5个PDF文件

**提示**：不要自己从零写，而是用Chat描述需求，让AI生成！
