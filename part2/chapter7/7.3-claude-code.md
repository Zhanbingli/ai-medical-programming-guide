# 7.3 Claude Code:命令行AI助手

## 什么是Claude Code?

Claude Code是Anthropic推出的**命令行AI编程助手**,它将Claude的强大能力带入终端环境,让你无需离开命令行就能获得AI辅助编程支持。

### 与其他工具的区别

| 特性 | Claude Code | Copilot | Cursor |
|------|------------|---------|--------|
| **运行环境** | 命令行/终端 | IDE插件 | 独立编辑器 |
| **交互方式** | 对话式 | 自动补全 | 对话+补全 |
| **适用场景** | 服务器、脚本 | 日常编码 | 大型项目 |
| **学习曲线** | 低 | 低 | 中 |
| **网络要求** | 需要API | 需要网络 | 需要网络 |

### 核心优势

✅ **无需离开终端** - 在SSH、服务器环境下也能使用
✅ **快速执行** - 适合快速生成脚本或解决问题
✅ **轻量级** - 不依赖IDE,资源占用小
✅ **Shell集成** - 可直接执行生成的命令
✅ **长文本处理** - Claude擅长理解复杂需求

## 安装与配置

### 1. 获取API密钥

首先需要在Anthropic官网获取API密钥:

```bash
# 访问 https://console.anthropic.com/
# 注册账号并创建API Key
```

### 2. 安装Claude Code

**方式一: 使用pip安装(推荐)**

```bash
pip install claude-code
```

**方式二: 使用npm安装**

```bash
npm install -g @anthropic-ai/claude-code
```

**方式三: 从源码安装**

```bash
git clone https://github.com/anthropics/claude-code.git
cd claude-code
pip install -e .
```

### 3. 配置API密钥

**方式一: 环境变量(推荐)**

```bash
# macOS/Linux - 添加到 ~/.bashrc 或 ~/.zshrc
export ANTHROPIC_API_KEY="your-api-key-here"

# Windows - 设置环境变量
setx ANTHROPIC_API_KEY "your-api-key-here"
```

**方式二: 配置文件**

```bash
# 创建配置文件
claude-code config init

# 编辑 ~/.claude-code/config.yaml
api_key: "your-api-key-here"
model: "claude-3-5-sonnet-20241022"
max_tokens: 4096
```

### 4. 验证安装

```bash
# 测试连接
claude-code --version

# 简单测试
claude-code "hello world"
```

## 核心功能

### 1. 对话式编程

**场景:快速生成数据处理脚本**

```bash
$ claude-code "写一个Python脚本,读取patients.csv,筛选年龄>60岁的患者,导出到elderly.csv"

# Claude Code会生成:
import pandas as pd

# 读取数据
df = pd.read_csv('patients.csv')

# 筛选年龄>60岁的患者
elderly = df[df['age'] > 60]

# 导出
elderly.to_csv('elderly.csv', index=False)
print(f"共筛选出{len(elderly)}位老年患者")
```

### 2. 代码解释与调试

**场景:理解复杂命令**

```bash
$ claude-code "解释这个命令: find . -name '*.py' -exec grep -l 'import pandas' {} \;"

# Claude Code返回:
这个命令的作用是:
1. find . - 在当前目录及子目录搜索
2. -name '*.py' - 查找所有.py文件
3. -exec grep -l 'import pandas' {} \; - 对每个文件执行grep
   - grep -l 只显示文件名(不显示匹配内容)
   - 'import pandas' 搜索导入pandas的行

总结: 找出所有导入了pandas库的Python文件
```

### 3. 错误诊断

**场景:调试报错**

```bash
$ claude-code "为什么会报错: ModuleNotFoundError: No module named 'openpyxl'"

# Claude Code分析:
这个错误表示Python找不到openpyxl模块。原因和解决方案:

原因:
- openpyxl未安装(最常见)
- 安装在错误的Python环境
- 虚拟环境未激活

解决方案:
1. 安装openpyxl:
   pip install openpyxl

2. 如果使用conda:
   conda install openpyxl

3. 检查环境:
   which python
   pip list | grep openpyxl
```

### 4. Shell脚本生成

**场景:批量处理DICOM文件**

```bash
$ claude-code "写一个bash脚本,遍历当前目录所有.dcm文件,重命名为患者ID_序列号.dcm格式"

# Claude Code生成:
#!/bin/bash

counter=1
for file in *.dcm; do
    if [ -f "$file" ]; then
        # 提取患者ID(假设在文件名中)
        patient_id=$(echo "$file" | cut -d'_' -f1)

        # 新文件名
        new_name="${patient_id}_$(printf "%04d" $counter).dcm"

        # 重命名
        mv "$file" "$new_name"
        echo "重命名: $file -> $new_name"

        ((counter++))
    fi
done

echo "处理完成,共处理 $((counter-1)) 个文件"
```

### 5. 多轮对话

Claude Code支持上下文记忆,可以进行多轮对话:

```bash
$ claude-code "写一个函数计算BMI"

def calculate_bmi(weight, height):
    """计算BMI
    weight: 体重(kg)
    height: 身高(m)
    """
    bmi = weight / (height ** 2)
    return round(bmi, 2)

$ claude-code "增加BMI分类判断"

def calculate_bmi(weight, height):
    """计算BMI并分类"""
    bmi = weight / (height ** 2)

    if bmi < 18.5:
        category = "体重过低"
    elif bmi < 24:
        category = "正常"
    elif bmi < 28:
        category = "超重"
    else:
        category = "肥胖"

    return round(bmi, 2), category

# 示例
weight, height = 70, 1.75
bmi, cat = calculate_bmi(weight, height)
print(f"BMI: {bmi}, 分类: {cat}")
```

## 实战案例

### 案例1:快速生成数据清洗脚本

**需求**: 有一批临床数据,需要清洗并生成统计报告

```bash
$ claude-code "
我有一个clinical_data.csv文件,包含以下列:
- patient_id: 患者ID
- age: 年龄(有些是字符串如'45岁')
- gender: 性别(M/F/男/女混用)
- bp: 血压(格式混乱:120/80, 120-80, 120mmHg等)

帮我写一个Python脚本:
1. 清洗这些数据
2. 标准化格式
3. 输出清洗后的数据
4. 生成基础统计报告
"
```

**Claude Code生成完整脚本**:

```python
import pandas as pd
import re

class ClinicalDataCleaner:
    def __init__(self, file_path):
        self.df = pd.read_csv(file_path)

    def clean_age(self):
        """清洗年龄数据"""
        def parse_age(value):
            # 提取数字
            match = re.search(r'\d+', str(value))
            if match:
                age = int(match.group())
                return age if 0 < age < 120 else None
            return None

        self.df['age'] = self.df['age'].apply(parse_age)

    def clean_gender(self):
        """标准化性别"""
        gender_map = {
            'M': '男', 'F': '女',
            'm': '男', 'f': '女',
            'male': '男', 'female': '女'
        }
        self.df['gender'] = self.df['gender'].map(
            lambda x: gender_map.get(str(x).strip(), x)
        )

    def clean_bp(self):
        """清洗血压数据"""
        def parse_bp(value):
            # 提取两个数字
            numbers = re.findall(r'\d+', str(value))
            if len(numbers) >= 2:
                return f"{numbers[0]}/{numbers[1]}"
            return None

        self.df['bp'] = self.df['bp'].apply(parse_bp)

    def clean_all(self):
        """执行所有清洗"""
        print("开始清洗数据...")
        self.clean_age()
        self.clean_gender()
        self.clean_bp()

        # 删除有缺失的行
        before = len(self.df)
        self.df = self.df.dropna()
        after = len(self.df)
        print(f"清洗完成: {before}条 -> {after}条")

        return self.df

    def generate_report(self):
        """生成统计报告"""
        print("\n=== 数据统计报告 ===")
        print(f"\n总样本量: {len(self.df)}")
        print(f"\n年龄分布:")
        print(self.df['age'].describe())
        print(f"\n性别分布:")
        print(self.df['gender'].value_counts())

    def save(self, output_path):
        """保存清洗后的数据"""
        self.df.to_csv(output_path, index=False)
        print(f"\n已保存到: {output_path}")

# 使用示例
if __name__ == "__main__":
    cleaner = ClinicalDataCleaner('clinical_data.csv')
    cleaned_df = cleaner.clean_all()
    cleaner.generate_report()
    cleaner.save('clinical_data_cleaned.csv')
```

### 案例2:Git操作辅助

**场景**: 不熟悉Git命令

```bash
$ claude-code "我想撤销上一次commit但保留修改,应该用什么命令?"

使用以下命令:

git reset --soft HEAD~1

解释:
- git reset: 重置当前分支
- --soft: 保留工作区和暂存区的修改
- HEAD~1: 回退到上一次commit

如果想完全撤销(包括修改):
git reset --hard HEAD~1  (⚠️ 危险,会丢失修改)

查看效果:
git log --oneline  # 查看commit历史
git status         # 查看文件状态
```

### 案例3:正则表达式生成

**场景**: 需要提取患者ID

```bash
$ claude-code "写一个正则表达式,匹配格式为P001-2024-001的患者ID"

正则表达式:
^P\d{3}-\d{4}-\d{3}$

Python使用示例:

import re

pattern = r'^P\d{3}-\d{4}-\d{3}$'

# 测试
test_ids = [
    "P001-2024-001",  # ✅ 匹配
    "P001-2024-1",    # ❌ 不匹配(最后部分不足3位)
    "A001-2024-001",  # ❌ 不匹配(首字母不是P)
]

for test_id in test_ids:
    if re.match(pattern, test_id):
        print(f"✅ {test_id}")
    else:
        print(f"❌ {test_id}")

# 提取所有患者ID
text = "患者P001-2024-001和P002-2024-015今日就诊"
ids = re.findall(r'P\d{3}-\d{4}-\d{3}', text)
print(ids)  # ['P001-2024-001', 'P002-2024-015']
```

## 高级技巧

### 1. 管道使用

将Claude Code与其他命令结合:

```bash
# 分析Python文件中的函数
find . -name "*.py" | xargs cat | claude-code "分析这些代码中定义了哪些函数"

# 优化SQL查询
cat query.sql | claude-code "优化这个SQL查询的性能"
```

### 2. 批量处理

创建循环调用:

```bash
# 为每个数据文件生成分析脚本
for file in data/*.csv; do
    claude-code "为文件 $file 生成一个数据分析脚本" > "scripts/analyze_$(basename $file .csv).py"
done
```

### 3. 会话管理

```bash
# 开始新会话
claude-code --new-session "medical-project"

# 在会话中工作(保持上下文)
claude-code --session "medical-project" "继续上次的代码"

# 列出所有会话
claude-code --list-sessions

# 删除旧会话
claude-code --delete-session "old-project"
```

### 4. 输出格式化

```bash
# 只输出代码(不包含解释)
claude-code --code-only "写一个函数读取CSV"

# 输出为Markdown
claude-code --format markdown "解释pandas的groupby"

# 保存到文件
claude-code "生成数据清洗脚本" > clean_data.py
```

## 与其他工具对比

### Claude Code vs ChatGPT命令行

| 对比项 | Claude Code | ChatGPT CLI |
|-------|-------------|-------------|
| 长文本理解 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| 代码生成 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 多轮对话 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| 响应速度 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 安装难度 | 简单 | 简单 |

### Claude Code vs Copilot CLI

| 对比项 | Claude Code | Copilot CLI |
|-------|-------------|-------------|
| 使用场景 | 通用编程 | Shell命令 |
| 交互方式 | 自然语言 | 自然语言 |
| 代码生成 | 完整脚本 | 命令建议 |
| GitHub集成 | ❌ | ✅ |
| 离线使用 | ❌ | ❌ |

## 最佳实践

### 1. 清晰描述需求

```bash
# ❌ 不好的提问
claude-code "处理数据"

# ✅ 好的提问
claude-code "读取patients.csv,删除age列的缺失值,按gender分组统计平均年龄,保存到summary.csv"
```

### 2. 提供上下文

```bash
# 提供文件结构
claude-code "
我的项目结构:
- data/
  - patients.csv
  - treatments.csv
- scripts/
  - analysis.py

我想写一个脚本合并这两个CSV文件,基于patient_id字段
"
```

### 3. 迭代优化

```bash
# 第一版
claude-code "写一个函数计算平均值"

# 优化
claude-code "加上错误处理"

# 再优化
claude-code "添加参数类型提示和docstring"
```

### 4. 验证生成的代码

```bash
# 生成代码
claude-code "写一个排序函数" > sort.py

# 让Claude Code生成测试
claude-code "为sort.py写单元测试" > test_sort.py

# 运行测试
python test_sort.py
```

## 使用场景总结

### 适合使用Claude Code的场景

✅ **快速生成脚本** - 一次性数据处理任务
✅ **服务器环境** - SSH远程工作
✅ **学习新技术** - 快速获取示例代码
✅ **调试问题** - 解释报错信息
✅ **正则表达式** - 生成和测试复杂模式
✅ **Shell命令** - 查询和生成命令

### 不适合的场景

❌ **大型项目** - 用Cursor或VSCode更好
❌ **实时补全** - Copilot更合适
❌ **UI开发** - 需要可视化预览
❌ **协作编程** - 需要IDE功能

## 常见问题

### Q1: API费用如何?

Claude Code使用Anthropic的API,按token计费:
- Claude 3.5 Sonnet: $3/百万输入token, $15/百万输出token
- 日常使用成本: 约$1-5/月

### Q2: 如何处理敏感数据?

```bash
# ⚠️ 不要直接发送真实患者数据
# 使用示例数据或脱敏数据

# ✅ 好的做法
claude-code "写一个函数处理患者数据,字段包括name, age, diagnosis"

# ❌ 避免
claude-code "处理这些数据: 张三,45岁,糖尿病; 李四,38岁,高血压"
```

### Q3: 离线能用吗?

不能,Claude Code需要网络连接。如需离线,考虑:
- 使用本地LLM(如Ollama)
- 提前生成常用脚本
- 使用传统工具(文档、StackOverflow缓存)

### Q4: 如何提高响应速度?

```bash
# 使用更快的模型(但能力稍弱)
claude-code --model claude-3-haiku-20240307 "快速查询"

# 限制输出长度
claude-code --max-tokens 500 "简要说明pandas用法"

# 关闭流式输出
claude-code --no-stream "生成代码"
```

## 检查清单

在使用Claude Code前,确保:

- [ ] 已安装Python 3.8+或Node.js 16+
- [ ] 已获取Anthropic API密钥
- [ ] 已正确配置环境变量
- [ ] 网络连接正常
- [ ] 了解API计费规则
- [ ] 不发送敏感数据

## 小结

Claude Code是医生学习编程的好帮手:

**核心优势**:
- 🚀 无需离开终端,快速获得帮助
- 💡 自然语言交互,降低学习门槛
- 🔧 适合服务器和脚本开发
- 📚 长文本理解能力强

**适用人群**:
- 需要在服务器环境工作的医生
- 喜欢命令行界面的用户
- 需要快速生成脚本的场景
- 学习阶段频繁查询问题

**下一步**:
- 第7.4节学习如何选择合适的AI工具
- 第7.5节通过实战掌握工具使用技巧

---

> **医学场景提示**: 在科室服务器上处理去标识化数据时,Claude Code可以帮你快速生成分析脚本,而无需在本地和服务器间来回切换代码。
