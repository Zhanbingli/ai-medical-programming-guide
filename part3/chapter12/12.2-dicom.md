# 12.2 DICOM文件处理

## 什么是DICOM?

**DICOM** (Digital Imaging and Communications in Medicine)
- 医学图像标准格式
- 包含图像数据 + 患者信息
- CT、MRI、X光都用DICOM

## DICOM文件结构

```
DICOM文件 = 元数据 + 图像数据

元数据(Metadata):
- 患者信息: 姓名、ID、年龄、性别
- 检查信息: 设备、日期、序列
- 图像参数: 窗宽窗位、层厚、间距

图像数据(Pixel Data):
- 原始像素值
- 通常是16位灰度
```

## 用AI生成DICOM处理代码

### 需求描述

**向AI提问**:
```
生成Python代码处理DICOM文件:
1. 读取DICOM
2. 提取患者信息(姓名、ID、日期)
3. 提取图像参数(窗宽窗位、层厚)
4. 显示图像(调整窗位)
5. 保存为PNG
```

### AI生成代码

```python
"""
DICOM文件处理工具
"""

import pydicom
import numpy as np
from PIL import Image
import matplotlib.pyplot as plt

class DICOMProcessor:
    """DICOM处理器"""

    def __init__(self, dicom_path):
        """读取DICOM文件"""
        self.ds = pydicom.dcmread(dicom_path)
        self.image = self.ds.pixel_array

    def get_patient_info(self):
        """提取患者信息"""
        info = {
            '患者姓名': str(self.ds.get('PatientName', 'Unknown')),
            '患者ID': str(self.ds.get('PatientID', 'Unknown')),
            '性别': str(self.ds.get('PatientSex', 'Unknown')),
            '年龄': str(self.ds.get('PatientAge', 'Unknown')),
            '检查日期': str(self.ds.get('StudyDate', 'Unknown')),
            '设备': str(self.ds.get('Manufacturer', 'Unknown')),
            '序列描述': str(self.ds.get('SeriesDescription', 'Unknown'))
        }
        return info

    def get_image_info(self):
        """提取图像参数"""
        info = {
            '图像尺寸': f"{self.image.shape[0]} x {self.image.shape[1]}",
            '窗中心': self.ds.get('WindowCenter', 'N/A'),
            '窗宽': self.ds.get('WindowWidth', 'N/A'),
            '层厚': f"{self.ds.get('SliceThickness', 'N/A')} mm",
            '像素间距': str(self.ds.get('PixelSpacing', 'N/A'))
        }
        return info

    def apply_window(self, window_center, window_width):
        """应用窗宽窗位"""
        img = self.image.copy()

        img_min = window_center - window_width // 2
        img_max = window_center + window_width // 2

        img = np.clip(img, img_min, img_max)
        img = ((img - img_min) / (img_max - img_min) * 255).astype(np.uint8)

        return img

    def show_image(self, window_name='default'):
        """显示图像"""
        # 预设窗位
        windows = {
            'lung': (-600, 1500),      # 肺窗
            'mediastinal': (40, 400),  # 纵隔窗
            'bone': (400, 1800),       # 骨窗
            'brain': (40, 80)          # 脑窗
        }

        if window_name in windows:
            wc, ww = windows[window_name]
            img = self.apply_window(wc, ww)
            title = f'{window_name.title()} Window (WC={wc}, WW={ww})'
        else:
            img = self.image
            title = 'Original'

        plt.figure(figsize=(10, 10))
        plt.imshow(img, cmap='gray')
        plt.title(title)
        plt.axis('off')
        plt.show()

    def save_as_png(self, output_path, window_name='lung'):
        """保存为PNG"""
        windows = {
            'lung': (-600, 1500),
            'mediastinal': (40, 400),
            'bone': (400, 1800)
        }

        wc, ww = windows.get(window_name, (-600, 1500))
        img = self.apply_window(wc, ww)

        pil_img = Image.fromarray(img)
        pil_img.save(output_path)

        print(f"✓ 已保存: {output_path}")

# 使用示例
if __name__ == "__main__":
    # 读取DICOM
    processor = DICOMProcessor('ct_scan.dcm')

    # 显示患者信息
    print("患者信息:")
    for key, value in processor.get_patient_info().items():
        print(f"  {key}: {value}")

    print("\n图像信息:")
    for key, value in processor.get_image_info().items():
        print(f"  {key}: {value}")

    # 显示不同窗位
    processor.show_image('lung')         # 肺窗
    processor.show_image('mediastinal')  # 纵隔窗

    # 保存为PNG
    processor.save_as_png('output_lung.png', 'lung')
```

### 运行效果

```
患者信息:
  患者姓名: Zhang^San
  患者ID: 12345678
  性别: M
  年龄: 045Y
  检查日期: 20240115
  设备: SIEMENS
  序列描述: Chest CT

图像信息:
  图像尺寸: 512 x 512
  窗中心: -600
  窗宽: 1500
  层厚: 5.0 mm
  像素间距: ['0.7', '0.7']

✓ 已保存: output_lung.png
```

## 批量处理DICOM

```python
from pathlib import Path

def batch_process_dicom(dicom_folder, output_folder):
    """批量处理DICOM文件"""

    dicom_files = list(Path(dicom_folder).glob('*.dcm'))

    print(f"找到 {len(dicom_files)} 个DICOM文件")

    for dicom_file in dicom_files:
        try:
            processor = DICOMProcessor(str(dicom_file))

            # 保存为PNG
            output_file = Path(output_folder) / f"{dicom_file.stem}.png"
            processor.save_as_png(str(output_file), 'lung')

        except Exception as e:
            print(f"⚠️ {dicom_file.name} 处理失败: {e}")

    print("\n✓ 批量处理完成")
```

## 检查清单

- [ ] 能读取DICOM文件
- [ ] 能提取患者信息
- [ ] 能调整窗宽窗位
- [ ] 能保存为PNG
- [ ] 能批量处理

## 下一步

[12.3 图像预处理](12.3-preprocessing.md) - 图像增强与去噪
