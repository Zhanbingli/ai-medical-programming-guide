# 9.2 批量下载PubMed文献信息

## 用AI开发PubMed数据抓取工具

### 需求描述

**向AI提问**:
```
我需要一个Python脚本,功能是:

输入: PubMed搜索关键词(如"hypertension treatment 2024")
处理:
1. 调用PubMed API搜索
2. 获取前50篇文章的信息
3. 提取: PMID, 标题, 作者, 期刊, 年份, 摘要

输出: 保存为Excel文件

要求:
- 使用Biopython库(如果不会可以用requests)
- 添加进度显示
- 错误处理
```

### AI生成代码

```python
"""
PubMed文献信息批量获取工具
"""

from Bio import Entrez
import pandas as pd
from tqdm import tqdm
import time

# 配置邮箱(NCBI要求)
Entrez.email = "your.email@example.com"

def search_pubmed(query, max_results=50):
    """
    搜索PubMed

    Args:
        query: 搜索关键词
        max_results: 最大结果数

    Returns:
        PMID列表
    """
    print(f"搜索PubMed: {query}")

    handle = Entrez.esearch(
        db="pubmed",
        term=query,
        retmax=max_results,
        sort="relevance"
    )
    results = Entrez.read(handle)
    handle.close()

    pmid_list = results["IdList"]
    print(f"✓ 找到{len(pmid_list)}篇文章")

    return pmid_list

def fetch_details(pmid_list):
    """
    获取文献详细信息

    Args:
        pmid_list: PMID列表

    Returns:
        文献信息列表
    """
    papers = []

    for pmid in tqdm(pmid_list, desc="获取文献信息"):
        try:
            # 获取详细信息
            handle = Entrez.efetch(
                db="pubmed",
                id=pmid,
                rettype="medline",
                retmode="text"
            )
            record = handle.read()
            handle.close()

            # 解析信息
            paper_info = parse_medline(record)
            paper_info['PMID'] = pmid
            papers.append(paper_info)

            # 避免请求过快
            time.sleep(0.3)

        except Exception as e:
            print(f"⚠️  PMID {pmid} 获取失败: {e}")
            continue

    return papers

def parse_medline(record):
    """解析MEDLINE格式数据"""
    info = {
        'Title': '',
        'Authors': '',
        'Journal': '',
        'Year': '',
        'Abstract': ''
    }

    lines = record.split('\n')
    current_field = None
    current_value = []

    for line in lines:
        if line.startswith('TI  -'):
            current_field = 'Title'
            current_value = [line[6:]]
        elif line.startswith('AU  -'):
            if current_field == 'Authors':
                current_value.append(line[6:])
            else:
                current_field = 'Authors'
                current_value = [line[6:]]
        elif line.startswith('TA  -'):
            info['Journal'] = line[6:].strip()
        elif line.startswith('DP  -'):
            year = line[6:].strip().split()[0]
            info['Year'] = year
        elif line.startswith('AB  -'):
            current_field = 'Abstract'
            current_value = [line[6:]]
        elif line.startswith('      ') and current_field:
            current_value.append(line.strip())
        else:
            if current_field and current_value:
                if current_field == 'Authors':
                    info[current_field] = '; '.join(current_value)
                else:
                    info[current_field] = ' '.join(current_value)
                current_field = None
                current_value = []

    return info

def save_to_excel(papers, filename):
    """保存为Excel"""
    df = pd.DataFrame(papers)

    # 重排列顺序
    columns = ['PMID', 'Title', 'Authors', 'Journal', 'Year', 'Abstract']
    df = df[columns]

    # 保存
    df.to_excel(filename, index=False, engine='openpyxl')
    print(f"\n✓ 已保存{len(papers)}篇文献到: {filename}")

def main():
    """主程序"""
    print("=" * 60)
    print("PubMed文献信息批量获取工具")
    print("=" * 60)

    # 输入搜索词
    query = input("\n请输入搜索关键词: ")
    max_results = int(input("获取文献数量(默认50): ") or "50")

    # 搜索
    pmid_list = search_pubmed(query, max_results)

    if not pmid_list:
        print("未找到相关文献")
        return

    # 获取详细信息
    papers = fetch_details(pmid_list)

    # 保存
    filename = f"pubmed_{query.replace(' ', '_')[:20]}.xlsx"
    save_to_excel(papers, filename)

    print("\n✓ 完成!")

if __name__ == "__main__":
    main()
```

### 使用方法

#### 1. 安装依赖

```bash
pip install biopython pandas openpyxl tqdm
```

#### 2. 运行脚本

```bash
python pubmed_fetcher.py
```

**交互示例**:
```
请输入搜索关键词: diabetes treatment 2024
获取文献数量(默认50): 30

搜索PubMed: diabetes treatment 2024
✓ 找到30篇文章
获取文献信息: 100%|████████| 30/30 [00:15<00:00]
✓ 已保存30篇文献到: pubmed_diabetes_treatment_2024.xlsx
```

### 进阶功能

#### 添加筛选条件

**向AI请求**:
```
添加功能:
- 只获取最近3年的文章
- 只要综述(Review)
- 排除Meta分析
```

**AI改进代码**:
```python
def search_pubmed(query, max_results=50, years=3, article_type='Review'):
    """
    高级搜索
    """
    # 构建复杂查询
    from datetime import datetime
    current_year = datetime.now().year
    year_filter = f"{current_year - years}:{current_year}[PDAT]"

    full_query = f"{query} AND {year_filter}"

    if article_type:
        full_query += f" AND {article_type}[PT]"

    print(f"搜索条件: {full_query}")

    # ... 其余代码
```

### 常见问题

**Q: 请求过快被限制怎么办?**
```python
# 增加延迟
time.sleep(0.5)  # 从0.3改为0.5秒
```

**Q: 某些文章没有摘要?**
```python
# 已处理,摘要字段可能为空
info['Abstract'] = info.get('Abstract', '无摘要')
```

**Q: 想导出为CSV而非Excel?**
```python
df.to_csv(filename, index=False, encoding='utf-8-sig')
```

## 检查清单

- [ ] 成功安装Biopython
- [ ] 能运行基础搜索
- [ ] 导出的Excel包含所有信息
- [ ] 理解API调用流程
- [ ] 可以自定义搜索条件

## 下一步

[9.3 提取关键信息到Excel](9.3-extract-info.md) - 从PDF中自动提取信息
