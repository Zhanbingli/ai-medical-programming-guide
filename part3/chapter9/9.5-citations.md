# 9.5 ç”Ÿæˆå‚è€ƒæ–‡çŒ®æ ¼å¼

## åœºæ™¯éœ€æ±‚

**å†™è®ºæ–‡æ—¶çš„ç—›ç‚¹**:
```
éœ€è¦æ•´ç†50ç¯‡å‚è€ƒæ–‡çŒ®:
- Natureè¦æ±‚APAæ ¼å¼
- JAMAè¦æ±‚Vancouveræ ¼å¼
- å­¦ä½è®ºæ–‡è¦æ±‚GB/T 7714æ ¼å¼

æ‰‹å·¥æ ¼å¼åŒ– â†’ 2å°æ—¶ + å®¹æ˜“å‡ºé”™ ğŸ˜«
```

## å¸¸è§å¼•ç”¨æ ¼å¼

### 1. APAæ ¼å¼(ç¾å›½å¿ƒç†å­¦ä¼š)

```
Smith, J., & Jones, M. (2024). Hypertension treatment strategies.
    Nature Medicine, 30(5), 123-130. https://doi.org/10.1038/xxx
```

### 2. Vancouveræ ¼å¼(æ¸©å“¥åæ ¼å¼)

```
1. Smith J, Jones M. Hypertension treatment strategies.
   Nat Med. 2024;30(5):123-30.
```

### 3. GB/T 7714æ ¼å¼(ä¸­å›½å›½æ ‡)

```
SMITH J, JONES M. Hypertension treatment strategies[J].
Nature Medicine, 2024, 30(5): 123-130.
```

## ç”¨AIç”Ÿæˆå¼•ç”¨æ ¼å¼å·¥å…·

### éœ€æ±‚æè¿°

**å‘AIæé—®**:
```
æˆ‘éœ€è¦ä¸€ä¸ªPythonè„šæœ¬:

è¾“å…¥: æ–‡çŒ®å…ƒæ•°æ®Excel(9.3èŠ‚ç”Ÿæˆçš„)
åŠŸèƒ½:
1. æ”¯æŒå¤šç§å¼•ç”¨æ ¼å¼(APA, Vancouver, GB/T 7714)
2. è‡ªåŠ¨æ’åºå’Œç¼–å·
3. å¯¼å‡ºä¸ºWord/TXTæ–‡ä»¶

è¦æ±‚:
- æ ¼å¼ä¸¥æ ¼éµå¾ªè§„èŒƒ
- æ”¯æŒæ‰¹é‡å¤„ç†
- å¯è‡ªå®šä¹‰æ ¼å¼æ¨¡æ¿
```

### AIç”Ÿæˆä»£ç 

```python
"""
å‚è€ƒæ–‡çŒ®æ ¼å¼ç”Ÿæˆå·¥å…·
"""

import pandas as pd
from datetime import datetime
from docx import Document

class CitationFormatter:
    """å¼•ç”¨æ ¼å¼ç”Ÿæˆå™¨"""

    def __init__(self, metadata_excel):
        """
        åˆå§‹åŒ–

        Args:
            metadata_excel: å…ƒæ•°æ®Excelæ–‡ä»¶è·¯å¾„
        """
        self.df = pd.read_excel(metadata_excel)
        # åªå¤„ç†æœ‰å®Œæ•´ä¿¡æ¯çš„æ–‡çŒ®
        self.df = self.df[
            self.df['Title'].notna() &
            self.df['Authors'].notna() &
            self.df['Year'].notna()
        ]

    def format_apa(self, row):
        """
        APAæ ¼å¼(ç¬¬7ç‰ˆ)

        ç¤ºä¾‹:
        Smith, J., & Jones, M. (2024). Article title.
            Journal Name, 30(5), 123-130. https://doi.org/xxx
        """
        # å¤„ç†ä½œè€…
        authors = row['Authors']
        if 'et al.' in authors:
            # å¤šäº3ä½ä½œè€…
            author_list = authors.replace(' et al.', '').split(';')
            formatted_authors = ', '.join(author_list[:3]) + ', et al.'
        else:
            author_list = authors.split(';')
            if len(author_list) == 1:
                formatted_authors = author_list[0].strip()
            elif len(author_list) == 2:
                formatted_authors = f"{author_list[0].strip()} & {author_list[1].strip()}"
            else:
                formatted_authors = ', '.join([a.strip() for a in author_list[:-1]])
                formatted_authors += f", & {author_list[-1].strip()}"

        # ç»„è£…å¼•ç”¨
        citation = f"{formatted_authors} ({row['Year']}). {row['Title']}. "

        if row['Journal']:
            citation += f"{row['Journal']}"
            if row['Volume']:
                citation += f", {row['Volume']}"
                if row['Issue']:
                    citation += f"({row['Issue']})"
            if row['Pages']:
                citation += f", {row['Pages']}"
            citation += "."

        if row['DOI']:
            citation += f" https://doi.org/{row['DOI']}"

        return citation

    def format_vancouver(self, row, index):
        """
        Vancouveræ ¼å¼

        ç¤ºä¾‹:
        1. Smith J, Jones M. Article title. J Abbrev. 2024;30(5):123-30.
        """
        # å¤„ç†ä½œè€…(Vancouverç”¨ç¼©å†™)
        authors = row['Authors'].split(';')
        formatted_authors = ', '.join([a.strip() for a in authors[:6]])
        if len(authors) > 6:
            formatted_authors += ', et al.'

        # ç»„è£…å¼•ç”¨
        citation = f"{index}. {formatted_authors}. {row['Title']}. "

        if row['Journal']:
            # Vancouverä½¿ç”¨æœŸåˆŠç¼©å†™,è¿™é‡Œç®€åŒ–å¤„ç†
            journal_abbrev = self._abbreviate_journal(row['Journal'])
            citation += f"{journal_abbrev}. "

        if row['Year']:
            citation += f"{row['Year']}"

        if row['Volume']:
            citation += f";{row['Volume']}"
            if row['Issue']:
                citation += f"({row['Issue']})"

        if row['Pages']:
            # Vancouveræ ¼å¼é¡µç åªä¿ç•™åé¢å˜åŒ–çš„æ•°å­—
            pages = self._format_pages_vancouver(row['Pages'])
            citation += f":{pages}"

        citation += "."

        return citation

    def format_gb7714(self, row):
        """
        GB/T 7714æ ¼å¼(ä¸­å›½å›½æ ‡)

        ç¤ºä¾‹:
        SMITH J, JONES M. Article title[J]. Journal Name, 2024, 30(5): 123-130.
        """
        # ä½œè€…å§“å¤§å†™
        authors = row['Authors'].split(';')
        formatted_authors = ', '.join([a.strip().upper() for a in authors[:3]])
        if len(authors) > 3:
            formatted_authors += ', ç­‰'

        # æ–‡çŒ®ç±»å‹æ ‡è¯† [J]=æœŸåˆŠ
        doc_type = '[J]'

        citation = f"{formatted_authors}. {row['Title']}{doc_type}. "

        if row['Journal']:
            citation += f"{row['Journal']}, "

        if row['Year']:
            citation += f"{row['Year']}"

        if row['Volume']:
            citation += f", {row['Volume']}"
            if row['Issue']:
                citation += f"({row['Issue']})"

        if row['Pages']:
            citation += f": {row['Pages']}"

        citation += "."

        return citation

    def _abbreviate_journal(self, journal):
        """ç®€åŒ–æœŸåˆŠåç¼©å†™(å®é™…åº”ç”¨éœ€è¦æ ‡å‡†ç¼©å†™è¡¨)"""
        # è¿™é‡Œåªåšæ¼”ç¤º,å®é™…åº”ä½¿ç”¨MEDLINEç¼©å†™
        abbrev_dict = {
            'Nature Medicine': 'Nat Med',
            'The Lancet': 'Lancet',
            'New England Journal of Medicine': 'N Engl J Med',
            'Journal of the American Medical Association': 'JAMA',
        }
        return abbrev_dict.get(journal, journal)

    def _format_pages_vancouver(self, pages):
        """Vancouveræ ¼å¼é¡µç å¤„ç†"""
        if '-' in pages:
            start, end = pages.split('-')
            # ç®€åŒ–ç‰ˆ:åªä¿ç•™ç»“æŸé¡µç çš„ä¸åŒéƒ¨åˆ†
            # 123-130 â†’ 123-30
            if len(end) >= 2:
                return f"{start}-{end[-2:]}"
        return pages

    def generate_all_formats(self, output_prefix='references'):
        """
        ç”Ÿæˆæ‰€æœ‰æ ¼å¼çš„å¼•ç”¨

        Args:
            output_prefix: è¾“å‡ºæ–‡ä»¶å‰ç¼€
        """
        print("=" * 60)
        print("å‚è€ƒæ–‡çŒ®æ ¼å¼ç”Ÿæˆå·¥å…·")
        print("=" * 60)

        if self.df.empty:
            print("âš ï¸  æ²¡æœ‰å¯ç”¨çš„æ–‡çŒ®æ•°æ®")
            return

        print(f"\nå…±æœ‰{len(self.df)}ç¯‡æ–‡çŒ®\n")

        # 1. ç”ŸæˆAPAæ ¼å¼
        print("ç”ŸæˆAPAæ ¼å¼...")
        apa_citations = []
        for idx, row in self.df.iterrows():
            apa_citations.append(self.format_apa(row))

        # APAæŒ‰ä½œè€…å§“æ°å­—æ¯æ’åº
        apa_citations.sort()

        with open(f'{output_prefix}_APA.txt', 'w', encoding='utf-8') as f:
            f.write("APA Format (7th Edition)\n")
            f.write("=" * 60 + "\n\n")
            for citation in apa_citations:
                f.write(citation + "\n\n")

        # 2. ç”ŸæˆVancouveræ ¼å¼
        print("ç”ŸæˆVancouveræ ¼å¼...")
        vancouver_citations = []
        for idx, row in enumerate(self.df.itertuples(), 1):
            vancouver_citations.append(
                self.format_vancouver(row, idx)
            )

        with open(f'{output_prefix}_Vancouver.txt', 'w', encoding='utf-8') as f:
            f.write("Vancouver Format\n")
            f.write("=" * 60 + "\n\n")
            for citation in vancouver_citations:
                f.write(citation + "\n\n")

        # 3. ç”ŸæˆGB/T 7714æ ¼å¼
        print("ç”ŸæˆGB/T 7714æ ¼å¼...")
        gb_citations = []
        for idx, row in self.df.iterrows():
            gb_citations.append(self.format_gb7714(row))

        # å›½æ ‡æŒ‰å¼•ç”¨é¡ºåºæˆ–ä½œè€…æ’åº
        gb_citations.sort()

        with open(f'{output_prefix}_GB7714.txt', 'w', encoding='utf-8') as f:
            f.write("GB/T 7714 Format\n")
            f.write("=" * 60 + "\n\n")
            for citation in gb_citations:
                f.write(citation + "\n\n")

        # 4. ç”ŸæˆWordæ–‡æ¡£
        print("ç”ŸæˆWordæ–‡æ¡£...")
        self._generate_word_doc(
            apa_citations,
            vancouver_citations,
            gb_citations,
            f'{output_prefix}.docx'
        )

        print(f"\nâœ“ ç”Ÿæˆå®Œæˆ!")
        print(f"  - {output_prefix}_APA.txt")
        print(f"  - {output_prefix}_Vancouver.txt")
        print(f"  - {output_prefix}_GB7714.txt")
        print(f"  - {output_prefix}.docx")

    def _generate_word_doc(self, apa, vancouver, gb, filename):
        """ç”ŸæˆåŒ…å«æ‰€æœ‰æ ¼å¼çš„Wordæ–‡æ¡£"""
        doc = Document()

        # æ·»åŠ æ ‡é¢˜
        doc.add_heading('å‚è€ƒæ–‡çŒ® References', 0)

        # APAéƒ¨åˆ†
        doc.add_heading('APA Format (7th Edition)', 1)
        for citation in apa:
            p = doc.add_paragraph(citation)
            p.paragraph_format.left_indent = Inches(0.5)
            p.paragraph_format.first_line_indent = Inches(-0.5)

        doc.add_page_break()

        # Vancouveréƒ¨åˆ†
        doc.add_heading('Vancouver Format', 1)
        for citation in vancouver:
            doc.add_paragraph(citation)

        doc.add_page_break()

        # GB/T 7714éƒ¨åˆ†
        doc.add_heading('GB/T 7714 Format', 1)
        for citation in gb:
            doc.add_paragraph(citation)

        # æ·»åŠ ç”Ÿæˆä¿¡æ¯
        doc.add_page_break()
        doc.add_paragraph(
            f"Generated on {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}",
            style='Caption'
        )

        doc.save(filename)

# ä¸ºäº†å¯¼å…¥Inches
from docx.shared import Inches

def main():
    """ä¸»ç¨‹åº"""
    import sys

    if len(sys.argv) < 2:
        print("ç”¨æ³•: python format_citations.py <å…ƒæ•°æ®Excelæ–‡ä»¶> [è¾“å‡ºå‰ç¼€]")
        print("\nç¤ºä¾‹: python format_citations.py literature_metadata.xlsx my_refs")
        return

    excel_file = sys.argv[1]
    output_prefix = sys.argv[2] if len(sys.argv) > 2 else 'references'

    formatter = CitationFormatter(excel_file)
    formatter.generate_all_formats(output_prefix)

if __name__ == "__main__":
    main()
```

### ä½¿ç”¨æ–¹æ³•

#### 1. å®‰è£…ä¾èµ–

```bash
pip install pandas openpyxl python-docx
```

#### 2. è¿è¡Œè„šæœ¬

```bash
python format_citations.py literature_metadata.xlsx
```

**è¾“å‡º**:
```
============================================================
å‚è€ƒæ–‡çŒ®æ ¼å¼ç”Ÿæˆå·¥å…·
============================================================

å…±æœ‰50ç¯‡æ–‡çŒ®

ç”ŸæˆAPAæ ¼å¼...
ç”ŸæˆVancouveræ ¼å¼...
ç”ŸæˆGB/T 7714æ ¼å¼...
ç”ŸæˆWordæ–‡æ¡£...

âœ“ ç”Ÿæˆå®Œæˆ!
  - references_APA.txt
  - references_Vancouver.txt
  - references_GB7714.txt
  - references.docx
```

### è¿›é˜¶åŠŸèƒ½

#### åŠŸèƒ½1: ç”ŸæˆBibTeXæ ¼å¼

**å‘AIè¯·æ±‚**:
```
æ·»åŠ BibTeXæ ¼å¼æ”¯æŒ,ç”¨äºLaTeXè®ºæ–‡
```

**AIæ·»åŠ ä»£ç **:
```python
def format_bibtex(self, row, cite_key=None):
    """
    BibTeXæ ¼å¼

    ç¤ºä¾‹:
    @article{Smith2024,
      title={Article Title},
      author={Smith, J and Jones, M},
      journal={Nature Medicine},
      year={2024},
      volume={30},
      number={5},
      pages={123--130},
      doi={10.1038/xxx}
    }
    """
    # ç”Ÿæˆå¼•ç”¨é”®
    if not cite_key:
        first_author = row['Authors'].split(';')[0].split()[0]
        cite_key = f"{first_author}{row['Year']}"

    # æ ¼å¼åŒ–ä½œè€…(BibTeXç”¨ and è¿æ¥)
    authors = ' and '.join([a.strip() for a in row['Authors'].split(';')[:10]])

    bibtex = f"@article{{{cite_key},\n"
    bibtex += f"  title={{{row['Title']}}},\n"
    bibtex += f"  author={{{authors}}},\n"

    if row['Journal']:
        bibtex += f"  journal={{{row['Journal']}}},\n"
    if row['Year']:
        bibtex += f"  year={{{row['Year']}}},\n"
    if row['Volume']:
        bibtex += f"  volume={{{row['Volume']}}},\n"
    if row['Issue']:
        bibtex += f"  number={{{row['Issue']}}},\n"
    if row['Pages']:
        # BibTeXç”¨--è¡¨ç¤ºé¡µç èŒƒå›´
        pages = row['Pages'].replace('-', '--')
        bibtex += f"  pages={{{pages}}},\n"
    if row['DOI']:
        bibtex += f"  doi={{{row['DOI']}}}\n"

    bibtex += "}\n"

    return bibtex
```

#### åŠŸèƒ½2: ä»DOIç›´æ¥è·å–å¼•ç”¨

**å‘AIè¯·æ±‚**:
```
é€šè¿‡DOIç›´æ¥è·å–æ ‡å‡†å¼•ç”¨æ ¼å¼(ä½¿ç”¨CrossRefæˆ–DOI.org API)
```

**AIç”Ÿæˆä»£ç **:
```python
import requests

def get_citation_from_doi(doi, format='apa'):
    """
    é€šè¿‡DOIè·å–å¼•ç”¨æ ¼å¼

    Args:
        doi: DOIå­—ç¬¦ä¸²
        format: 'apa', 'bibtex', 'vancouver'ç­‰

    Returns:
        æ ¼å¼åŒ–çš„å¼•ç”¨å­—ç¬¦ä¸²
    """
    # ä½¿ç”¨CrossRefå†…å®¹åå•†
    headers = {
        'Accept': 'text/x-bibliography; style=apa'  # æˆ–å…¶ä»–æ ¼å¼
    }

    url = f"https://doi.org/{doi}"

    try:
        response = requests.get(url, headers=headers)
        if response.status_code == 200:
            return response.text
    except:
        pass

    return None

# ä½¿ç”¨ç¤ºä¾‹
citation = get_citation_from_doi('10.1038/s41591-024-12345-6')
print(citation)
```

## å®ç”¨æŠ€å·§

### æŠ€å·§1: æ‰¹é‡å¯¼å…¥EndNote

```python
def export_endnote_xml(metadata_df, output_file='references.xml'):
    """å¯¼å‡ºEndNote XMLæ ¼å¼"""
    # EndNoteä½¿ç”¨ç‰¹å®šçš„XMLæ ¼å¼
    # å¯ä½¿ç”¨xmltodictæˆ–ç›´æ¥ç”ŸæˆXML
    pass
```

### æŠ€å·§2: åœ¨Wordä¸­æ’å…¥å¼•ç”¨

```
1. å°†ç”Ÿæˆçš„Wordæ–‡æ¡£æ‰“å¼€
2. å¤åˆ¶éœ€è¦çš„å¼•ç”¨æ ¼å¼
3. åœ¨è®ºæ–‡ä¸­ç›´æ¥ç²˜è´´
```

### æŠ€å·§3: è‡ªå®šä¹‰æ ¼å¼æ¨¡æ¿

```python
# åˆ›å»ºè‡ªå®šä¹‰æ ¼å¼
def format_custom(self, row, template):
    """
    ä½¿ç”¨æ¨¡æ¿ç”Ÿæˆè‡ªå®šä¹‰æ ¼å¼

    Args:
        template: "{authors}. {title}. {journal} {year};{volume}:{pages}"
    """
    return template.format(
        authors=row['Authors'],
        title=row['Title'],
        journal=row['Journal'],
        year=row['Year'],
        volume=row['Volume'],
        pages=row['Pages']
    )
```

## æ£€æŸ¥æ¸…å•

- [ ] ç”Ÿæˆçš„å¼•ç”¨æ ¼å¼æ­£ç¡®
- [ ] ä½œè€…å§“åæ ¼å¼ç¬¦åˆè§„èŒƒ
- [ ] æœŸåˆŠç¼©å†™å‡†ç¡®(Vancouver)
- [ ] é¡µç æ ¼å¼æ­£ç¡®
- [ ] DOIé“¾æ¥å¯ç‚¹å‡»(Wordæ–‡æ¡£)

## ä¸‹ä¸€æ­¥

[9.6 AIæ€»ç»“æ–‡çŒ®è¦ç‚¹](9.6-ai-summary.md) - è®©AIå¿«é€Ÿæ€»ç»“æ–‡çŒ®æ ¸å¿ƒå†…å®¹
