# 9.5 生成参考文献格式

## 场景需求

**写论文时的痛点**:
```
需要整理50篇参考文献:
- Nature要求APA格式
- JAMA要求Vancouver格式
- 学位论文要求GB/T 7714格式

手工格式化 → 2小时 + 容易出错 😫
```

## 常见引用格式

### 1. APA格式(美国心理学会)

```
Smith, J., & Jones, M. (2024). Hypertension treatment strategies.
    Nature Medicine, 30(5), 123-130. https://doi.org/10.1038/xxx
```

### 2. Vancouver格式(温哥华格式)

```
1. Smith J, Jones M. Hypertension treatment strategies.
   Nat Med. 2024;30(5):123-30.
```

### 3. GB/T 7714格式(中国国标)

```
SMITH J, JONES M. Hypertension treatment strategies[J].
Nature Medicine, 2024, 30(5): 123-130.
```

## 用AI生成引用格式工具

### 需求描述

**向AI提问**:
```
我需要一个Python脚本:

输入: 文献元数据Excel(9.3节生成的)
功能:
1. 支持多种引用格式(APA, Vancouver, GB/T 7714)
2. 自动排序和编号
3. 导出为Word/TXT文件

要求:
- 格式严格遵循规范
- 支持批量处理
- 可自定义格式模板
```

### AI生成代码

```python
"""
参考文献格式生成工具
"""

import pandas as pd
from datetime import datetime
from docx import Document

class CitationFormatter:
    """引用格式生成器"""

    def __init__(self, metadata_excel):
        """
        初始化

        Args:
            metadata_excel: 元数据Excel文件路径
        """
        self.df = pd.read_excel(metadata_excel)
        # 只处理有完整信息的文献
        self.df = self.df[
            self.df['Title'].notna() &
            self.df['Authors'].notna() &
            self.df['Year'].notna()
        ]

    def format_apa(self, row):
        """
        APA格式(第7版)

        示例:
        Smith, J., & Jones, M. (2024). Article title.
            Journal Name, 30(5), 123-130. https://doi.org/xxx
        """
        # 处理作者
        authors = row['Authors']
        if 'et al.' in authors:
            # 多于3位作者
            author_list = authors.replace(' et al.', '').split(';')
            formatted_authors = ', '.join(author_list[:3]) + ', et al.'
        else:
            author_list = authors.split(';')
            if len(author_list) == 1:
                formatted_authors = author_list[0].strip()
            elif len(author_list) == 2:
                formatted_authors = f"{author_list[0].strip()} & {author_list[1].strip()}"
            else:
                formatted_authors = ', '.join([a.strip() for a in author_list[:-1]])
                formatted_authors += f", & {author_list[-1].strip()}"

        # 组装引用
        citation = f"{formatted_authors} ({row['Year']}). {row['Title']}. "

        if row['Journal']:
            citation += f"{row['Journal']}"
            if row['Volume']:
                citation += f", {row['Volume']}"
                if row['Issue']:
                    citation += f"({row['Issue']})"
            if row['Pages']:
                citation += f", {row['Pages']}"
            citation += "."

        if row['DOI']:
            citation += f" https://doi.org/{row['DOI']}"

        return citation

    def format_vancouver(self, row, index):
        """
        Vancouver格式

        示例:
        1. Smith J, Jones M. Article title. J Abbrev. 2024;30(5):123-30.
        """
        # 处理作者(Vancouver用缩写)
        authors = row['Authors'].split(';')
        formatted_authors = ', '.join([a.strip() for a in authors[:6]])
        if len(authors) > 6:
            formatted_authors += ', et al.'

        # 组装引用
        citation = f"{index}. {formatted_authors}. {row['Title']}. "

        if row['Journal']:
            # Vancouver使用期刊缩写,这里简化处理
            journal_abbrev = self._abbreviate_journal(row['Journal'])
            citation += f"{journal_abbrev}. "

        if row['Year']:
            citation += f"{row['Year']}"

        if row['Volume']:
            citation += f";{row['Volume']}"
            if row['Issue']:
                citation += f"({row['Issue']})"

        if row['Pages']:
            # Vancouver格式页码只保留后面变化的数字
            pages = self._format_pages_vancouver(row['Pages'])
            citation += f":{pages}"

        citation += "."

        return citation

    def format_gb7714(self, row):
        """
        GB/T 7714格式(中国国标)

        示例:
        SMITH J, JONES M. Article title[J]. Journal Name, 2024, 30(5): 123-130.
        """
        # 作者姓大写
        authors = row['Authors'].split(';')
        formatted_authors = ', '.join([a.strip().upper() for a in authors[:3]])
        if len(authors) > 3:
            formatted_authors += ', 等'

        # 文献类型标识 [J]=期刊
        doc_type = '[J]'

        citation = f"{formatted_authors}. {row['Title']}{doc_type}. "

        if row['Journal']:
            citation += f"{row['Journal']}, "

        if row['Year']:
            citation += f"{row['Year']}"

        if row['Volume']:
            citation += f", {row['Volume']}"
            if row['Issue']:
                citation += f"({row['Issue']})"

        if row['Pages']:
            citation += f": {row['Pages']}"

        citation += "."

        return citation

    def _abbreviate_journal(self, journal):
        """简化期刊名缩写(实际应用需要标准缩写表)"""
        # 这里只做演示,实际应使用MEDLINE缩写
        abbrev_dict = {
            'Nature Medicine': 'Nat Med',
            'The Lancet': 'Lancet',
            'New England Journal of Medicine': 'N Engl J Med',
            'Journal of the American Medical Association': 'JAMA',
        }
        return abbrev_dict.get(journal, journal)

    def _format_pages_vancouver(self, pages):
        """Vancouver格式页码处理"""
        if '-' in pages:
            start, end = pages.split('-')
            # 简化版:只保留结束页码的不同部分
            # 123-130 → 123-30
            if len(end) >= 2:
                return f"{start}-{end[-2:]}"
        return pages

    def generate_all_formats(self, output_prefix='references'):
        """
        生成所有格式的引用

        Args:
            output_prefix: 输出文件前缀
        """
        print("=" * 60)
        print("参考文献格式生成工具")
        print("=" * 60)

        if self.df.empty:
            print("⚠️  没有可用的文献数据")
            return

        print(f"\n共有{len(self.df)}篇文献\n")

        # 1. 生成APA格式
        print("生成APA格式...")
        apa_citations = []
        for idx, row in self.df.iterrows():
            apa_citations.append(self.format_apa(row))

        # APA按作者姓氏字母排序
        apa_citations.sort()

        with open(f'{output_prefix}_APA.txt', 'w', encoding='utf-8') as f:
            f.write("APA Format (7th Edition)\n")
            f.write("=" * 60 + "\n\n")
            for citation in apa_citations:
                f.write(citation + "\n\n")

        # 2. 生成Vancouver格式
        print("生成Vancouver格式...")
        vancouver_citations = []
        for idx, row in enumerate(self.df.itertuples(), 1):
            vancouver_citations.append(
                self.format_vancouver(row, idx)
            )

        with open(f'{output_prefix}_Vancouver.txt', 'w', encoding='utf-8') as f:
            f.write("Vancouver Format\n")
            f.write("=" * 60 + "\n\n")
            for citation in vancouver_citations:
                f.write(citation + "\n\n")

        # 3. 生成GB/T 7714格式
        print("生成GB/T 7714格式...")
        gb_citations = []
        for idx, row in self.df.iterrows():
            gb_citations.append(self.format_gb7714(row))

        # 国标按引用顺序或作者排序
        gb_citations.sort()

        with open(f'{output_prefix}_GB7714.txt', 'w', encoding='utf-8') as f:
            f.write("GB/T 7714 Format\n")
            f.write("=" * 60 + "\n\n")
            for citation in gb_citations:
                f.write(citation + "\n\n")

        # 4. 生成Word文档
        print("生成Word文档...")
        self._generate_word_doc(
            apa_citations,
            vancouver_citations,
            gb_citations,
            f'{output_prefix}.docx'
        )

        print(f"\n✓ 生成完成!")
        print(f"  - {output_prefix}_APA.txt")
        print(f"  - {output_prefix}_Vancouver.txt")
        print(f"  - {output_prefix}_GB7714.txt")
        print(f"  - {output_prefix}.docx")

    def _generate_word_doc(self, apa, vancouver, gb, filename):
        """生成包含所有格式的Word文档"""
        doc = Document()

        # 添加标题
        doc.add_heading('参考文献 References', 0)

        # APA部分
        doc.add_heading('APA Format (7th Edition)', 1)
        for citation in apa:
            p = doc.add_paragraph(citation)
            p.paragraph_format.left_indent = Inches(0.5)
            p.paragraph_format.first_line_indent = Inches(-0.5)

        doc.add_page_break()

        # Vancouver部分
        doc.add_heading('Vancouver Format', 1)
        for citation in vancouver:
            doc.add_paragraph(citation)

        doc.add_page_break()

        # GB/T 7714部分
        doc.add_heading('GB/T 7714 Format', 1)
        for citation in gb:
            doc.add_paragraph(citation)

        # 添加生成信息
        doc.add_page_break()
        doc.add_paragraph(
            f"Generated on {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}",
            style='Caption'
        )

        doc.save(filename)

# 为了导入Inches
from docx.shared import Inches

def main():
    """主程序"""
    import sys

    if len(sys.argv) < 2:
        print("用法: python format_citations.py <元数据Excel文件> [输出前缀]")
        print("\n示例: python format_citations.py literature_metadata.xlsx my_refs")
        return

    excel_file = sys.argv[1]
    output_prefix = sys.argv[2] if len(sys.argv) > 2 else 'references'

    formatter = CitationFormatter(excel_file)
    formatter.generate_all_formats(output_prefix)

if __name__ == "__main__":
    main()
```

### 使用方法

#### 1. 安装依赖

```bash
pip install pandas openpyxl python-docx
```

#### 2. 运行脚本

```bash
python format_citations.py literature_metadata.xlsx
```

**输出**:
```
============================================================
参考文献格式生成工具
============================================================

共有50篇文献

生成APA格式...
生成Vancouver格式...
生成GB/T 7714格式...
生成Word文档...

✓ 生成完成!
  - references_APA.txt
  - references_Vancouver.txt
  - references_GB7714.txt
  - references.docx
```

### 进阶功能

#### 功能1: 生成BibTeX格式

**向AI请求**:
```
添加BibTeX格式支持,用于LaTeX论文
```

**AI添加代码**:
```python
def format_bibtex(self, row, cite_key=None):
    """
    BibTeX格式

    示例:
    @article{Smith2024,
      title={Article Title},
      author={Smith, J and Jones, M},
      journal={Nature Medicine},
      year={2024},
      volume={30},
      number={5},
      pages={123--130},
      doi={10.1038/xxx}
    }
    """
    # 生成引用键
    if not cite_key:
        first_author = row['Authors'].split(';')[0].split()[0]
        cite_key = f"{first_author}{row['Year']}"

    # 格式化作者(BibTeX用 and 连接)
    authors = ' and '.join([a.strip() for a in row['Authors'].split(';')[:10]])

    bibtex = f"@article{{{cite_key},\n"
    bibtex += f"  title={{{row['Title']}}},\n"
    bibtex += f"  author={{{authors}}},\n"

    if row['Journal']:
        bibtex += f"  journal={{{row['Journal']}}},\n"
    if row['Year']:
        bibtex += f"  year={{{row['Year']}}},\n"
    if row['Volume']:
        bibtex += f"  volume={{{row['Volume']}}},\n"
    if row['Issue']:
        bibtex += f"  number={{{row['Issue']}}},\n"
    if row['Pages']:
        # BibTeX用--表示页码范围
        pages = row['Pages'].replace('-', '--')
        bibtex += f"  pages={{{pages}}},\n"
    if row['DOI']:
        bibtex += f"  doi={{{row['DOI']}}}\n"

    bibtex += "}\n"

    return bibtex
```

#### 功能2: 从DOI直接获取引用

**向AI请求**:
```
通过DOI直接获取标准引用格式(使用CrossRef或DOI.org API)
```

**AI生成代码**:
```python
import requests

def get_citation_from_doi(doi, format='apa'):
    """
    通过DOI获取引用格式

    Args:
        doi: DOI字符串
        format: 'apa', 'bibtex', 'vancouver'等

    Returns:
        格式化的引用字符串
    """
    # 使用CrossRef内容协商
    headers = {
        'Accept': 'text/x-bibliography; style=apa'  # 或其他格式
    }

    url = f"https://doi.org/{doi}"

    try:
        response = requests.get(url, headers=headers)
        if response.status_code == 200:
            return response.text
    except:
        pass

    return None

# 使用示例
citation = get_citation_from_doi('10.1038/s41591-024-12345-6')
print(citation)
```

## 实用技巧

### 技巧1: 批量导入EndNote

```python
def export_endnote_xml(metadata_df, output_file='references.xml'):
    """导出EndNote XML格式"""
    # EndNote使用特定的XML格式
    # 可使用xmltodict或直接生成XML
    pass
```

### 技巧2: 在Word中插入引用

```
1. 将生成的Word文档打开
2. 复制需要的引用格式
3. 在论文中直接粘贴
```

### 技巧3: 自定义格式模板

```python
# 创建自定义格式
def format_custom(self, row, template):
    """
    使用模板生成自定义格式

    Args:
        template: "{authors}. {title}. {journal} {year};{volume}:{pages}"
    """
    return template.format(
        authors=row['Authors'],
        title=row['Title'],
        journal=row['Journal'],
        year=row['Year'],
        volume=row['Volume'],
        pages=row['Pages']
    )
```

## 检查清单

- [ ] 生成的引用格式正确
- [ ] 作者姓名格式符合规范
- [ ] 期刊缩写准确(Vancouver)
- [ ] 页码格式正确
- [ ] DOI链接可点击(Word文档)

## 下一步

[9.6 AI总结文献要点](9.6-ai-summary.md) - 让AI快速总结文献核心内容
