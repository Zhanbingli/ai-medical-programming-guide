# 9.7 完整工具:文献管理助手

## 项目目标

整合前面章节的所有功能,构建一个**完整的文献管理自动化工具**:

```
文献管理助手 = 下载 + 提取 + 去重 + 分类 + 引用 + 总结
```

## 完整功能架构

```
literature_manager/
├── main.py              # 主程序和菜单
├── pubmed_fetcher.py    # PubMed下载 (9.2)
├── metadata_extractor.py # 元数据提取 (9.3)
├── deduplicator.py      # 去重 (9.4)
├── classifier.py        # 分类 (9.4)
├── citation_formatter.py # 引用格式 (9.5)
├── ai_summarizer.py     # AI总结 (9.6)
├── config.py            # 配置文件
├── utils.py             # 工具函数
└── requirements.txt     # 依赖
```

## 用AI开发完整工具

### 需求描述

**向AI提问**:
```
创建一个文献管理命令行工具,功能包括:

1. 从PubMed搜索并下载文献信息
2. 扫描本地PDF,提取元数据
3. 自动去重
4. 智能分类到文件夹
5. 生成各种引用格式
6. AI总结文献要点
7. 生成完整的文献管理报告

要求:
- 模块化设计,每个功能独立
- 命令行菜单界面
- 完整的错误处理
- 配置文件管理API密钥
- 生成使用日志
```

### AI生成核心代码

#### 1. main.py - 主程序

```python
"""
文献管理助手 - 主程序
"""

import os
from pathlib import Path
from datetime import datetime

from pubmed_fetcher import PubMedFetcher
from metadata_extractor import MetadataExtractor
from deduplicator import Deduplicator
from classifier import Classifier
from citation_formatter import CitationFormatter
from ai_summarizer import AISummarizer
from config import Config

class LiteratureManager:
    """文献管理助手主类"""

    def __init__(self):
        self.config = Config()
        self.current_project = None
        self.metadata_file = None

    def show_menu(self):
        """显示主菜单"""
        print("\n" + "=" * 60)
        print(" " * 20 + "文献管理助手")
        print("=" * 60)
        print("\n📚 项目管理:")
        print("  1. 创建新项目")
        print("  2. 加载现有项目")

        print("\n🔍 文献获取:")
        print("  3. 从PubMed搜索下载")
        print("  4. 扫描本地PDF提取元数据")

        print("\n🛠️  数据处理:")
        print("  5. 文献去重")
        print("  6. 智能分类")
        print("  7. 重命名文件")

        print("\n📝 文献分析:")
        print("  8. 生成引用格式")
        print("  9. AI总结文献")

        print("\n📊 报告生成:")
        print("  10. 生成完整报告")
        print("  11. 导出数据")

        print("\n⚙️  设置:")
        print("  12. 配置管理")

        print("\n  0. 退出")
        print("=" * 60)

    def create_project(self):
        """创建新项目"""
        print("\n创建新项目")
        print("-" * 60)

        project_name = input("项目名称: ").strip()
        if not project_name:
            print("⚠️  项目名称不能为空")
            return

        project_dir = Path(f"projects/{project_name}")
        project_dir.mkdir(parents=True, exist_ok=True)

        # 创建项目子文件夹
        (project_dir / "papers").mkdir(exist_ok=True)
        (project_dir / "outputs").mkdir(exist_ok=True)
        (project_dir / "classified").mkdir(exist_ok=True)

        self.current_project = project_dir
        self.metadata_file = project_dir / "outputs" / "metadata.xlsx"

        print(f"✓ 项目创建成功: {project_dir}")
        self.log_action(f"Created project: {project_name}")

    def load_project(self):
        """加载现有项目"""
        projects = list(Path("projects").glob("*"))

        if not projects:
            print("⚠️  没有找到项目")
            return

        print("\n现有项目:")
        for idx, proj in enumerate(projects, 1):
            print(f"  {idx}. {proj.name}")

        choice = input("\n选择项目编号: ").strip()
        try:
            idx = int(choice) - 1
            self.current_project = projects[idx]
            self.metadata_file = self.current_project / "outputs" / "metadata.xlsx"
            print(f"✓ 已加载项目: {self.current_project.name}")
        except:
            print("⚠️  无效选择")

    def search_pubmed(self):
        """PubMed搜索"""
        if not self.current_project:
            print("⚠️  请先创建或加载项目")
            return

        print("\nPubMed搜索")
        print("-" * 60)

        query = input("搜索关键词: ").strip()
        if not query:
            return

        max_results = int(input("获取文献数量 [50]: ") or "50")

        fetcher = PubMedFetcher(self.config.get('pubmed_email'))
        results = fetcher.search_and_fetch(query, max_results)

        if results:
            output_file = self.current_project / "outputs" / f"pubmed_{query[:20]}.xlsx"
            fetcher.save_to_excel(results, str(output_file))
            print(f"✓ 已保存到: {output_file}")
            self.log_action(f"PubMed search: {query}, {len(results)} results")

    def extract_metadata(self):
        """提取PDF元数据"""
        if not self.current_project:
            print("⚠️  请先创建或加载项目")
            return

        print("\n提取PDF元数据")
        print("-" * 60)

        pdf_folder = self.current_project / "papers"
        extractor = MetadataExtractor()

        results = extractor.process_folder(str(pdf_folder))

        if results:
            extractor.save_to_excel(results, str(self.metadata_file))
            print(f"✓ 元数据已保存到: {self.metadata_file}")
            self.log_action(f"Extracted metadata: {len(results)} papers")

    def deduplicate(self):
        """去重"""
        if not self.check_metadata():
            return

        print("\n文献去重")
        print("-" * 60)

        dedup = Deduplicator(str(self.metadata_file))
        report = dedup.deduplicate_all()

        print(report)
        self.log_action("Deduplication completed")

    def classify(self):
        """智能分类"""
        if not self.check_metadata():
            return

        print("\n智能分类")
        print("-" * 60)

        classifier = Classifier(str(self.metadata_file))
        output_dir = self.current_project / "classified"

        stats = classifier.classify_all(str(output_dir))

        print("\n分类统计:")
        for category, count in sorted(stats.items(), key=lambda x: x[1], reverse=True):
            if count > 0:
                print(f"  {category:15}: {count:3}篇")

        self.log_action(f"Classification completed: {sum(stats.values())} papers")

    def generate_citations(self):
        """生成引用格式"""
        if not self.check_metadata():
            return

        print("\n生成引用格式")
        print("-" * 60)
        print("选择格式:")
        print("  1. APA")
        print("  2. Vancouver")
        print("  3. GB/T 7714")
        print("  4. BibTeX")
        print("  5. 全部")

        choice = input("选择 [5]: ").strip() or "5"

        formatter = CitationFormatter(str(self.metadata_file))
        output_prefix = self.current_project / "outputs" / "references"

        formatter.generate_formats(str(output_prefix), choice)

        print("✓ 引用格式生成完成")
        self.log_action("Citations generated")

    def ai_summarize(self):
        """AI总结"""
        if not self.check_metadata():
            return

        print("\nAI文献总结")
        print("-" * 60)

        api_key = self.config.get('openai_api_key')
        if not api_key:
            print("⚠️  请先配置OpenAI API密钥")
            return

        pdf_folder = self.current_project / "papers"
        summarizer = AISummarizer(api_key)

        summaries = summarizer.batch_summarize(
            str(pdf_folder),
            str(self.metadata_file)
        )

        if summaries:
            output_file = self.current_project / "outputs" / "summaries.xlsx"
            summarizer.save_summaries(summaries, str(output_file))
            print(f"✓ 总结已保存: {output_file}")
            self.log_action(f"AI summaries: {len(summaries)} papers")

    def generate_report(self):
        """生成完整报告"""
        if not self.check_metadata():
            return

        print("\n生成完整报告")
        print("-" * 60)

        from report_generator import ReportGenerator

        report = ReportGenerator(str(self.current_project))
        output_file = self.current_project / "outputs" / "project_report.docx"

        report.generate(str(output_file))

        print(f"✓ 报告已生成: {output_file}")
        self.log_action("Project report generated")

    def manage_config(self):
        """配置管理"""
        print("\n配置管理")
        print("-" * 60)
        print("1. 设置PubMed邮箱")
        print("2. 设置OpenAI API密钥")
        print("3. 查看当前配置")

        choice = input("选择: ").strip()

        if choice == "1":
            email = input("PubMed邮箱: ").strip()
            self.config.set('pubmed_email', email)
            print("✓ 已保存")
        elif choice == "2":
            api_key = input("OpenAI API密钥: ").strip()
            self.config.set('openai_api_key', api_key)
            print("✓ 已保存")
        elif choice == "3":
            print(f"PubMed邮箱: {self.config.get('pubmed_email')}")
            print(f"OpenAI API: {'已配置' if self.config.get('openai_api_key') else '未配置'}")

    def check_metadata(self):
        """检查元数据文件是否存在"""
        if not self.current_project:
            print("⚠️  请先创建或加载项目")
            return False

        if not self.metadata_file.exists():
            print("⚠️  未找到元数据文件,请先扫描PDF")
            return False

        return True

    def log_action(self, message):
        """记录操作日志"""
        log_file = self.current_project / "project.log" if self.current_project else Path("app.log")

        with open(log_file, 'a', encoding='utf-8') as f:
            timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            f.write(f"[{timestamp}] {message}\n")

    def run(self):
        """运行主程序"""
        while True:
            self.show_menu()

            if self.current_project:
                print(f"\n当前项目: {self.current_project.name}")

            choice = input("\n请选择 (0-12): ").strip()

            if choice == "0":
                print("\n感谢使用! 👋")
                break
            elif choice == "1":
                self.create_project()
            elif choice == "2":
                self.load_project()
            elif choice == "3":
                self.search_pubmed()
            elif choice == "4":
                self.extract_metadata()
            elif choice == "5":
                self.deduplicate()
            elif choice == "6":
                self.classify()
            elif choice == "7":
                print("功能开发中...")
            elif choice == "8":
                self.generate_citations()
            elif choice == "9":
                self.ai_summarize()
            elif choice == "10":
                self.generate_report()
            elif choice == "11":
                print("功能开发中...")
            elif choice == "12":
                self.manage_config()
            else:
                print("⚠️  无效选择")

            input("\n按Enter继续...")

def main():
    """程序入口"""
    print("""
    ╔═══════════════════════════════════════════════╗
    ║                                               ║
    ║          文献管理助手 v1.0                    ║
    ║          Literature Manager                   ║
    ║                                               ║
    ║          让AI帮你管理文献                     ║
    ║                                               ║
    ╚═══════════════════════════════════════════════╝
    """)

    manager = LiteratureManager()
    manager.run()

if __name__ == "__main__":
    main()
```

#### 2. config.py - 配置管理

```python
"""
配置管理模块
"""

import json
from pathlib import Path

class Config:
    """配置管理类"""

    def __init__(self, config_file='config.json'):
        self.config_file = Path(config_file)
        self.config = self.load()

    def load(self):
        """加载配置"""
        if self.config_file.exists():
            with open(self.config_file, 'r', encoding='utf-8') as f:
                return json.load(f)
        else:
            # 默认配置
            return {
                'pubmed_email': '',
                'openai_api_key': '',
                'classification_categories': {
                    'Hypertension': ['hypertension', 'blood pressure'],
                    'Diabetes': ['diabetes', 'glucose', 'insulin'],
                    'Cancer': ['cancer', 'tumor', 'oncology']
                }
            }

    def save(self):
        """保存配置"""
        with open(self.config_file, 'w', encoding='utf-8') as f:
            json.dump(self.config, f, indent=2, ensure_ascii=False)

    def get(self, key, default=None):
        """获取配置项"""
        return self.config.get(key, default)

    def set(self, key, value):
        """设置配置项"""
        self.config[key] = value
        self.save()
```

#### 3. requirements.txt

```txt
# PDF处理
pdfplumber>=0.9.0

# 数据处理
pandas>=2.0.0
openpyxl>=3.1.0

# 生物信息学
biopython>=1.81

# AI和API
openai>=1.0.0
requests>=2.31.0

# 文档生成
python-docx>=0.8.11

# 进度条
tqdm>=4.65.0

# 配置
python-dotenv>=1.0.0
```

## 使用流程演示

### 完整工作流

```bash
# 1. 安装依赖
pip install -r requirements.txt

# 2. 启动程序
python main.py
```

**操作示例**:
```
请选择 (0-12): 1
项目名称: 高血压治疗综述2024

✓ 项目创建成功: projects/高血压治疗综述2024

请选择 (0-12): 3
搜索关键词: hypertension treatment 2024
获取文献数量 [50]: 30

✓ 已保存到: projects/高血压治疗综述2024/outputs/pubmed_hypertension_treatment_2024.xlsx

请选择 (0-12): 4
# (将下载的PDF放到papers文件夹)

✓ 元数据已保存到: metadata.xlsx

请选择 (0-12): 5
发现3篇重复文献
✓ 去重完成

请选择 (0-12): 6
✓ 分类完成

请选择 (0-12): 8
✓ 引用格式生成完成

请选择 (0-12): 9
AI总结中: 100%|██████| 30/30
✓ 总结已保存

请选择 (0-12): 10
✓ 报告已生成: project_report.docx
```

### 项目文件结构

最终生成的项目结构:
```
projects/高血压治疗综述2024/
├── papers/                    # 原始PDF
│   ├── Smith_2024_xxx.pdf
│   └── ...
├── classified/                # 分类后的PDF
│   ├── Hypertension/
│   ├── Diabetes/
│   └── Others/
├── outputs/                   # 所有输出
│   ├── metadata.xlsx         # 元数据
│   ├── summaries.xlsx        # AI总结
│   ├── references_APA.txt    # APA引用
│   ├── references_Vancouver.txt
│   ├── references.docx       # Word格式引用
│   └── project_report.docx   # 完整报告
└── project.log               # 操作日志
```

## 进阶功能

### 功能1: Web界面

**向AI请求**:
```
为文献管理助手添加Web界面:
- 使用Flask或Streamlit
- 可视化文献分布
- 在线预览PDF
- 交互式筛选
```

### 功能2: 数据库存储

```python
# 使用SQLite存储元数据
import sqlite3

def create_database():
    conn = sqlite3.connect('literature.db')
    cursor = conn.cursor()

    cursor.execute('''
        CREATE TABLE IF NOT EXISTS papers (
            id INTEGER PRIMARY KEY,
            filename TEXT,
            title TEXT,
            authors TEXT,
            journal TEXT,
            year INTEGER,
            doi TEXT UNIQUE,
            abstract TEXT,
            keywords TEXT,
            relevance_score INTEGER,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')

    conn.commit()
    return conn
```

### 功能3: 自动更新检测

```python
def check_for_updates(query, last_search_date):
    """
    检查PubMed是否有新文献

    定期运行,自动添加新发表的文献
    """
    # 在原查询基础上添加日期限制
    date_filter = f"{last_search_date}:3000[PDAT]"
    new_query = f"{query} AND {date_filter}"

    # 搜索并下载...
```

## 部署建议

### 个人使用

```bash
# 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt

# 运行
python main.py
```

### 团队共享

1. **Docker部署**:
```dockerfile
FROM python:3.9-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .

CMD ["python", "main.py"]
```

2. **Git版本控制**:
```bash
git init
git add .
git commit -m "Initial commit"
```

## 总结

### 你已经学会

✅ PubMed API调用
✅ PDF元数据提取
✅ 文献去重和分类
✅ 引用格式生成
✅ AI文献总结
✅ 完整项目架构

### 实际效果

**传统方式**:
- 下载文献: 2小时
- 整理重命名: 3小时
- 去重: 1小时
- 写参考文献: 2小时
- **总计: 8小时**

**使用本工具**:
- 所有操作: **30分钟**
- **效率提升: 16倍!**

## 检查清单

- [ ] 工具运行正常
- [ ] 所有模块都经过测试
- [ ] 配置文件管理API密钥
- [ ] 生成了使用文档
- [ ] 理解每个模块的功能
- [ ] 可以根据需求定制

## 下一章预告

[第10章 临床数据处理](../chapter10/10.1-overview.md) - 用AI处理临床试验数据

恭喜完成第9章! 🎉
