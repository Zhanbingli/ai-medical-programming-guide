# 10.2 数据清洗实战

## 真实数据的样子

### 混乱的Excel数据

```excel
患者ID  姓名  年龄    性别  血压      体重   血糖     随访日期
001    张三   35岁    男   120/80   70kg  5.5     2024-01-15
002    李四   42     F    140  90   85    6.2     01/15/2024
003    王五   NA     女   135/85   N/A   7.1mmol/L  2024/1/15
004    张三   35岁    男   120/80   70    5.5     2024-01-15  # 重复!
005    赵六   150    男   160/100  120   15.5    2024-13-45  # 错误!
```

**问题汇总**:
- ❌ 年龄格式不统一("35岁" vs "35")
- ❌ 性别编码不一致("男" vs "F")
- ❌ 血压是字符串"120/80",无法计算
- ❌ 缺失值表示不统一(NA, N/A, 空格)
- ❌ 单位混在数据里("70kg", "7.1mmol/L")
- ❌ 日期格式不统一
- ❌ 有重复记录
- ❌ 有明显错误(年龄150岁,日期13月45日)

## 用AI开发数据清洗工具

### 需求描述

**向AI提问**:
```
我有一个临床试验Excel文件,数据质量很差,需要清洗:

问题:
1. 年龄列包含"35岁"和"35"两种格式,需要统一为数字
2. 性别列有"男"、"女"、"M"、"F",需要统一为"男"/"女"
3. 血压列是"120/80"格式,需要拆分为收缩压和舒张压两列
4. 体重和血糖包含单位(kg, mmol/L),需要去除
5. 缺失值表示不统一(NA, N/A, 无, 空格),需要统一为NaN
6. 删除完全重复的行
7. 删除明显错误的数据(年龄>120或<18,日期不合法)

请生成完整的Python清洗脚本,并生成清洗报告。
```

### AI生成代码

```python
"""
临床数据清洗工具
"""

import pandas as pd
import numpy as np
import re
from datetime import datetime

class ClinicalDataCleaner:
    """临床数据清洗器"""

    def __init__(self, file_path):
        """
        初始化

        Args:
            file_path: Excel文件路径
        """
        self.file_path = file_path
        self.df_raw = None
        self.df_clean = None
        self.cleaning_log = []

    def load_data(self):
        """加载数据"""
        print("加载数据...")
        self.df_raw = pd.read_excel(self.file_path)
        self.log(f"原始数据: {len(self.df_raw)}行, {len(self.df_raw.columns)}列")
        return self

    def clean_age(self):
        """清洗年龄列"""
        print("清洗年龄数据...")

        def parse_age(value):
            """解析年龄"""
            if pd.isna(value):
                return np.nan

            # 转为字符串
            value_str = str(value)

            # 提取数字
            match = re.search(r'\d+', value_str)
            if match:
                age = int(match.group())

                # 验证范围
                if 18 <= age <= 120:
                    return age
                else:
                    return np.nan
            return np.nan

        before_na = self.df_clean['年龄'].isna().sum()

        self.df_clean['年龄'] = self.df_clean['年龄'].apply(parse_age)

        after_na = self.df_clean['年龄'].isna().sum()
        self.log(f"年龄清洗: 新增{after_na - before_na}个缺失值(异常值)")

        return self

    def clean_gender(self):
        """清洗性别列"""
        print("清洗性别数据...")

        gender_map = {
            '男': '男',
            '女': '女',
            'M': '男',
            'F': '女',
            'Male': '男',
            'Female': '女',
            'm': '男',
            'f': '女',
            '1': '男',
            '2': '女'
        }

        before_na = self.df_clean['性别'].isna().sum()

        self.df_clean['性别'] = self.df_clean['性别'].map(
            lambda x: gender_map.get(str(x).strip(), np.nan)
        )

        after_na = self.df_clean['性别'].isna().sum()
        self.log(f"性别清洗: 新增{after_na - before_na}个缺失值(无效值)")

        return self

    def clean_blood_pressure(self):
        """
        清洗血压数据

        将"120/80"格式拆分为收缩压和舒张压两列
        """
        print("清洗血压数据...")

        def parse_bp(value):
            """解析血压"""
            if pd.isna(value):
                return np.nan, np.nan

            value_str = str(value)

            # 尝试不同分隔符
            for sep in ['/', '  ', ' ']:
                if sep in value_str:
                    parts = value_str.split(sep)
                    if len(parts) == 2:
                        try:
                            sbp = int(parts[0].strip())
                            dbp = int(parts[1].strip())

                            # 验证范围
                            if 80 <= sbp <= 250 and 40 <= dbp <= 150:
                                return sbp, dbp
                        except ValueError:
                            pass

            return np.nan, np.nan

        # 拆分血压
        bp_data = self.df_clean['血压'].apply(parse_bp)
        self.df_clean['收缩压'] = bp_data.apply(lambda x: x[0])
        self.df_clean['舒张压'] = bp_data.apply(lambda x: x[1])

        # 删除原血压列
        self.df_clean.drop('血压', axis=1, inplace=True)

        sbp_na = self.df_clean['收缩压'].isna().sum()
        self.log(f"血压清洗: 拆分为收缩压和舒张压,{sbp_na}个缺失值")

        return self

    def clean_numeric_with_unit(self, column, unit_pattern=r'[a-zA-Z/]+'):
        """
        清洗带单位的数值列

        Args:
            column: 列名
            unit_pattern: 单位正则表达式
        """
        print(f"清洗{column}数据...")

        def remove_unit(value):
            """去除单位"""
            if pd.isna(value):
                return np.nan

            value_str = str(value)

            # 去除单位
            cleaned = re.sub(unit_pattern, '', value_str).strip()

            try:
                return float(cleaned)
            except ValueError:
                return np.nan

        before_na = self.df_clean[column].isna().sum()

        self.df_clean[column] = self.df_clean[column].apply(remove_unit)

        after_na = self.df_clean[column].isna().sum()
        self.log(f"{column}清洗: 去除单位,新增{after_na - before_na}个缺失值")

        return self

    def clean_date(self, column):
        """清洗日期列"""
        print(f"清洗{column}数据...")

        def parse_date(value):
            """解析日期"""
            if pd.isna(value):
                return np.nan

            value_str = str(value)

            # 尝试不同格式
            date_formats = [
                '%Y-%m-%d',
                '%Y/%m/%d',
                '%m/%d/%Y',
                '%Y年%m月%d日',
                '%Y-%m-%d %H:%M:%S'
            ]

            for fmt in date_formats:
                try:
                    return pd.to_datetime(value_str, format=fmt)
                except ValueError:
                    continue

            # 如果都失败,尝试自动解析
            try:
                return pd.to_datetime(value_str)
            except:
                return np.nan

        before_na = self.df_clean[column].isna().sum()

        self.df_clean[column] = self.df_clean[column].apply(parse_date)

        after_na = self.df_clean[column].isna().sum()
        self.log(f"{column}清洗: 统一日期格式,新增{after_na - before_na}个缺失值")

        return self

    def remove_duplicates(self, subset=None):
        """删除重复行"""
        print("删除重复行...")

        before = len(self.df_clean)

        self.df_clean.drop_duplicates(subset=subset, keep='first', inplace=True)

        after = len(self.df_clean)
        removed = before - after

        self.log(f"删除重复: {removed}行")

        return self

    def standardize_missing_values(self):
        """统一缺失值表示"""
        print("统一缺失值...")

        # 定义缺失值的各种表示
        missing_values = ['NA', 'N/A', 'na', 'n/a', 'NaN', 'nan',
                         'None', 'none', '无', '空', '', ' ']

        # 替换为NaN
        self.df_clean.replace(missing_values, np.nan, inplace=True)

        self.log("缺失值统一为NaN")

        return self

    def remove_invalid_rows(self, max_missing_rate=0.5):
        """
        删除无效行

        Args:
            max_missing_rate: 最大缺失率(0-1)
        """
        print("删除无效行...")

        before = len(self.df_clean)

        # 计算每行缺失率
        missing_rate = self.df_clean.isna().sum(axis=1) / len(self.df_clean.columns)

        # 删除缺失率超过阈值的行
        self.df_clean = self.df_clean[missing_rate <= max_missing_rate]

        after = len(self.df_clean)
        removed = before - after

        self.log(f"删除无效行: {removed}行(缺失率>{max_missing_rate})")

        return self

    def clean_all(self):
        """执行完整清洗流程"""
        print("=" * 60)
        print("临床数据清洗工具")
        print("=" * 60)

        # 复制数据
        self.df_clean = self.df_raw.copy()

        # 1. 统一缺失值
        self.standardize_missing_values()

        # 2. 清洗各列
        if '年龄' in self.df_clean.columns:
            self.clean_age()

        if '性别' in self.df_clean.columns:
            self.clean_gender()

        if '血压' in self.df_clean.columns:
            self.clean_blood_pressure()

        if '体重' in self.df_clean.columns:
            self.clean_numeric_with_unit('体重', r'kg|KG|公斤')

        if '血糖' in self.df_clean.columns:
            self.clean_numeric_with_unit('血糖', r'mmol/L|mg/dl')

        if '随访日期' in self.df_clean.columns:
            self.clean_date('随访日期')

        # 3. 删除重复
        self.remove_duplicates()

        # 4. 删除无效行
        self.remove_invalid_rows()

        print("\n" + "=" * 60)
        print("清洗完成!")
        print("=" * 60)

        return self

    def generate_report(self):
        """生成清洗报告"""
        print("\n清洗报告:")
        print("-" * 60)

        for log_entry in self.cleaning_log:
            print(f"✓ {log_entry}")

        print(f"\n数据维度变化:")
        print(f"  原始: {len(self.df_raw)}行 × {len(self.df_raw.columns)}列")
        print(f"  清洗后: {len(self.df_clean)}行 × {len(self.df_clean.columns)}列")

        # 缺失值统计
        print(f"\n缺失值统计:")
        missing = self.df_clean.isna().sum()
        for col, count in missing.items():
            if count > 0:
                rate = count / len(self.df_clean) * 100
                print(f"  {col}: {count}个 ({rate:.1f}%)")

    def save(self, output_file):
        """保存清洗后的数据"""
        self.df_clean.to_excel(output_file, index=False, engine='openpyxl')
        print(f"\n✓ 已保存到: {output_file}")

    def log(self, message):
        """记录日志"""
        self.cleaning_log.append(message)

def main():
    """主程序"""
    import sys

    if len(sys.argv) < 2:
        print("用法: python data_cleaner.py <输入文件> [输出文件]")
        print("\n示例: python data_cleaner.py trial_data.xlsx trial_data_clean.xlsx")
        return

    input_file = sys.argv[1]
    output_file = sys.argv[2] if len(sys.argv) > 2 else 'cleaned_data.xlsx'

    # 清洗数据
    cleaner = ClinicalDataCleaner(input_file)
    cleaner.load_data().clean_all()

    # 生成报告
    cleaner.generate_report()

    # 保存
    cleaner.save(output_file)

if __name__ == "__main__":
    main()
```

### 使用方法

```bash
python data_cleaner.py trial_data.xlsx trial_data_clean.xlsx
```

**输出示例**:
```
============================================================
临床数据清洗工具
============================================================
加载数据...
统一缺失值...
清洗年龄数据...
清洗性别数据...
清洗血压数据...
清洗体重数据...
清洗血糖数据...
清洗随访日期数据...
删除重复行...
删除无效行...

============================================================
清洗完成!
============================================================

清洗报告:
------------------------------------------------------------
✓ 原始数据: 500行, 8列
✓ 缺失值统一为NaN
✓ 年龄清洗: 新增12个缺失值(异常值)
✓ 性别清洗: 新增3个缺失值(无效值)
✓ 血压清洗: 拆分为收缩压和舒张压,8个缺失值
✓ 体重清洗: 去除单位,新增5个缺失值
✓ 血糖清洗: 去除单位,新增2个缺失值
✓ 随访日期清洗: 统一日期格式,新增7个缺失值
✓ 删除重复: 15行
✓ 删除无效行: 23行(缺失率>0.5)

数据维度变化:
  原始: 500行 × 8列
  清洗后: 462行 × 9列

缺失值统计:
  年龄: 12个 (2.6%)
  性别: 3个 (0.6%)
  体重: 5个 (1.1%)
  收缩压: 8个 (1.7%)
  舒张压: 8个 (1.7%)

✓ 已保存到: trial_data_clean.xlsx
```

## 常见清洗场景

### 场景1: BMI计算

```python
# 向AI请求:
"""
在清洗后的数据中添加BMI列:
BMI = 体重(kg) / 身高(m)²

身高列单位是cm,需要转换为m
"""

def add_bmi(self):
    """添加BMI列"""
    if '体重' in self.df_clean.columns and '身高' in self.df_clean.columns:
        # 身高cm转m
        height_m = self.df_clean['身高'] / 100

        # 计算BMI
        self.df_clean['BMI'] = (
            self.df_clean['体重'] / (height_m ** 2)
        ).round(1)

        self.log("添加BMI列")

    return self
```

### 场景2: 异常值处理

```python
def handle_outliers(self, column, method='iqr'):
    """
    处理异常值

    Args:
        column: 列名
        method: 'iqr'使用四分位数, 'zscore'使用z分数
    """
    if method == 'iqr':
        Q1 = self.df_clean[column].quantile(0.25)
        Q3 = self.df_clean[column].quantile(0.75)
        IQR = Q3 - Q1

        lower = Q1 - 1.5 * IQR
        upper = Q3 + 1.5 * IQR

        # 标记异常值为NaN
        mask = (self.df_clean[column] < lower) | (self.df_clean[column] > upper)
        outliers = mask.sum()

        self.df_clean.loc[mask, column] = np.nan

        self.log(f"{column}异常值处理: {outliers}个")

    return self
```

### 场景3: 编码分类变量

```python
def encode_categorical(self, column, method='label'):
    """
    编码分类变量

    Args:
        method: 'label' 或 'onehot'
    """
    if method == 'label':
        # 标签编码: 男=0, 女=1
        self.df_clean[f'{column}_编码'] = self.df_clean[column].map(
            {'男': 0, '女': 1}
        )
    elif method == 'onehot':
        # 独热编码
        dummies = pd.get_dummies(self.df_clean[column], prefix=column)
        self.df_clean = pd.concat([self.df_clean, dummies], axis=1)

    return self
```

## 检查清单

- [ ] 所有列格式统一
- [ ] 缺失值标记一致
- [ ] 删除了重复数据
- [ ] 异常值已处理
- [ ] 数值列没有单位
- [ ] 日期格式统一
- [ ] 生成了清洗报告

## 下一步

[10.3 数据验证与质控](10.3-data-validation.md) - 确保数据质量
