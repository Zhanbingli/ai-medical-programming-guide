# 10.4 描述性统计分析

## 什么是描述性统计?

**医学类比**:
```
描述性统计 = 患者的"体格检查"
- 基本情况: 年龄、性别分布
- 生命体征: 血压、心率均值
- 整体状况: 数据分布特征
```

## 论文中的Table 1

### 标准格式

```
Table 1. 患者基线特征

特征                    A药组(n=50)    B药组(n=50)    P值
------------------------------------------------------------
年龄(岁)                45.2±8.3       46.1±7.9       0.52
性别(男/女)             28/22          30/20          0.65
基线收缩压(mmHg)        145.3±12.5     144.8±13.1     0.84
基线舒张压(mmHg)        92.1±8.3       91.8±8.7       0.86
BMI(kg/m²)              25.8±3.2       26.1±3.5       0.67
```

## 用AI生成描述性统计

### 需求描述

**向AI提问**:
```
我有临床试验数据,需要生成描述性统计表:

数据列:
- 分类变量: 性别, 治疗分组
- 连续变量: 年龄, 收缩压, 舒张压, BMI

要求:
1. 按治疗分组计算统计量
2. 连续变量: 均值±标准差
3. 分类变量: 频数(百分比)
4. 自动计算组间P值(t检验或卡方检验)
5. 生成论文格式的表格

请生成Python代码。
```

### AI生成代码

```python
"""
描述性统计分析工具
"""

import pandas as pd
import numpy as np
from scipy import stats

class DescriptiveStats:
    """描述性统计分析"""

    def __init__(self, data_file, group_col):
        """
        初始化

        Args:
            data_file: 数据文件
            group_col: 分组列名
        """
        self.df = pd.read_excel(data_file)
        self.group_col = group_col
        self.groups = self.df[group_col].unique()

    def describe_continuous(self, column):
        """
        描述连续变量

        Returns:
            字典: {组名: "均值±标准差"}
        """
        results = {}

        for group in self.groups:
            group_data = self.df[self.df[self.group_col] == group][column]
            group_data = group_data.dropna()

            mean = group_data.mean()
            std = group_data.std()

            results[group] = f"{mean:.1f}±{std:.1f}"

        # 计算P值(t检验)
        if len(self.groups) == 2:
            group1_data = self.df[self.df[self.group_col] == self.groups[0]][column].dropna()
            group2_data = self.df[self.df[self.group_col] == self.groups[1]][column].dropna()

            _, p_value = stats.ttest_ind(group1_data, group2_data)
            results['P值'] = f"{p_value:.3f}"

        return results

    def describe_categorical(self, column):
        """
        描述分类变量

        Returns:
            字典: {组名: "频数(百分比)"}
        """
        results = {}

        for group in self.groups:
            group_df = self.df[self.df[self.group_col] == group]
            value_counts = group_df[column].value_counts()

            # 格式化为"n(%)"
            formatted = []
            for value, count in value_counts.items():
                percentage = count / len(group_df) * 100
                formatted.append(f"{value}:{count}({percentage:.1f}%)")

            results[group] = "; ".join(formatted)

        # 卡方检验
        if len(self.groups) == 2:
            contingency = pd.crosstab(
                self.df[column],
                self.df[self.group_col]
            )

            _, p_value, _, _ = stats.chi2_contingency(contingency)
            results['P值'] = f"{p_value:.3f}"

        return results

    def generate_table1(self, continuous_vars, categorical_vars):
        """
        生成Table 1

        Args:
            continuous_vars: 连续变量列表
            categorical_vars: 分类变量列表

        Returns:
            DataFrame
        """
        print("生成Table 1...")

        rows = []

        # 样本量
        row = {'特征': '样本量'}
        for group in self.groups:
            n = len(self.df[self.df[self.group_col] == group])
            row[group] = f"n={n}"
        row['P值'] = ''
        rows.append(row)

        # 连续变量
        for var in continuous_vars:
            if var not in self.df.columns:
                continue

            row = {'特征': var}
            stats_dict = self.describe_continuous(var)

            for group in self.groups:
                row[group] = stats_dict.get(group, '')

            row['P值'] = stats_dict.get('P值', '')
            rows.append(row)

        # 分类变量
        for var in categorical_vars:
            if var not in self.df.columns:
                continue

            row = {'特征': var}
            stats_dict = self.describe_categorical(var)

            for group in self.groups:
                row[group] = stats_dict.get(group, '')

            row['P值'] = stats_dict.get('P值', '')
            rows.append(row)

        df_table = pd.DataFrame(rows)

        return df_table

    def save_table(self, df_table, output_file='table1.xlsx'):
        """保存表格"""
        df_table.to_excel(output_file, index=False, engine='openpyxl')
        print(f"✓ Table 1已保存: {output_file}")

    def print_summary(self, column):
        """打印单个变量的详细统计"""
        print(f"\n{column}统计:")
        print("-" * 60)

        data = self.df[column].dropna()

        print(f"样本量: {len(data)}")
        print(f"均值: {data.mean():.2f}")
        print(f"中位数: {data.median():.2f}")
        print(f"标准差: {data.std():.2f}")
        print(f"最小值: {data.min():.2f}")
        print(f"最大值: {data.max():.2f}")
        print(f"25%分位数: {data.quantile(0.25):.2f}")
        print(f"75%分位数: {data.quantile(0.75):.2f}")

def main():
    """主程序"""
    import sys

    if len(sys.argv) < 2:
        print("用法: python descriptive_stats.py <数据文件> <分组列>")
        print("\n示例: python descriptive_stats.py trial_data.xlsx 治疗分组")
        return

    data_file = sys.argv[1]
    group_col = sys.argv[2] if len(sys.argv) > 2 else '治疗分组'

    # 创建分析对象
    stats_analyzer = DescriptiveStats(data_file, group_col)

    # 定义变量
    continuous = ['年龄', '收缩压', '舒张压', 'BMI', '体重']
    categorical = ['性别', '吸烟史', '糖尿病史']

    # 生成Table 1
    table1 = stats_analyzer.generate_table1(continuous, categorical)

    # 打印
    print("\n" + "=" * 60)
    print("Table 1. 患者基线特征")
    print("=" * 60)
    print(table1.to_string(index=False))

    # 保存
    stats_analyzer.save_table(table1)

if __name__ == "__main__":
    main()
```

### 使用示例

```bash
python descriptive_stats.py trial_data_clean.xlsx 治疗分组
```

**输出**:
```
============================================================
Table 1. 患者基线特征
============================================================
       特征           A药组             B药组        P值
  样本量            n=50             n=50
  年龄             45.2±8.3         46.1±7.9      0.520
  收缩压           145.3±12.5       144.8±13.1    0.840
  舒张压           92.1±8.3         91.8±8.7      0.860
  BMI              25.8±3.2         26.1±3.5      0.670
  性别             男:28(56.0%);    男:30(60.0%);  0.650
                   女:22(44.0%)     女:20(40.0%)

✓ Table 1已保存: table1.xlsx
```

## 常用统计量

### 集中趋势

```python
# 均值
mean = df['年龄'].mean()

# 中位数(对于偏态分布更合适)
median = df['年龄'].median()

# 众数
mode = df['性别'].mode()[0]
```

### 离散程度

```python
# 标准差
std = df['年龄'].std()

# 方差
var = df['年龄'].var()

# 四分位数间距(IQR)
Q1 = df['年龄'].quantile(0.25)
Q3 = df['年龄'].quantile(0.75)
IQR = Q3 - Q1

# 范围
range_val = df['年龄'].max() - df['年龄'].min()
```

### 分布形状

```python
# 偏度(Skewness)
skew = df['年龄'].skew()
# < 0: 左偏, = 0: 对称, > 0: 右偏

# 峰度(Kurtosis)
kurt = df['年龄'].kurt()
```

## 快速探索

```python
# Pandas内置方法
df.describe()  # 所有数值列的统计摘要

# 分组统计
df.groupby('治疗分组')['年龄'].describe()

# 相关性矩阵
df[['年龄', '收缩压', '舒张压', 'BMI']].corr()
```

## 检查清单

- [ ] Table 1包含所有重要变量
- [ ] 连续变量用均值±标准差表示
- [ ] 分类变量用频数(百分比)表示
- [ ] P值计算正确
- [ ] 格式符合期刊要求

## 下一步

[10.5 组间对比与假设检验](10.5-hypothesis-testing.md) - 进行统计推断
