# 10.6 数据可视化

## 论文中的常见图表

### 必备图表类型

| 图表类型 | 用途 | 示例场景 |
|---------|------|---------|
| **柱状图** | 组间对比 | A药 vs B药疗效对比 |
| **箱线图** | 分布对比 | 不同剂量血压分布 |
| **散点图** | 相关性 | 年龄与血压的关系 |
| **折线图** | 趋势变化 | 血压随时间变化 |
| **生存曲线** | 生存分析 | Kaplan-Meier曲线 |
| **森林图** | Meta分析 | 多研究效应量 |

## 用AI生成可视化代码

### 需求描述

**向AI提问**:
```
生成临床试验数据可视化代码:

1. 组间对比柱状图:
   - A药vs B药血压下降值
   - 显示均值+误差棒
   - 标注P值

2. 箱线图:
   - 三种剂量的血压分布
   - 显示异常值点

3. 配对前后对比:
   - 治疗前后血压变化
   - 用连线表示配对关系

要求:
- 论文质量(300 DPI)
- 黑白打印友好
- 字体大小适中
- 清晰的图例和标签
```

### AI生成代码

```python
"""
临床数据可视化工具
"""

import matplotlib.pyplot as plt
import seaborn as sns
import pandas as pd
import numpy as np
from scipy import stats

# 设置中文字体和样式
plt.rcParams['font.sans-serif'] = ['Arial Unicode MS', 'SimHei']
plt.rcParams['axes.unicode_minus'] = False
sns.set_style("whitegrid")

class ClinicalVisualizer:
    """临床数据可视化"""

    def __init__(self, data_file):
        self.df = pd.read_excel(data_file)

    def plot_group_comparison(self, column, group_col,
                              output_file='comparison.png'):
        """
        组间对比柱状图(带误差棒和P值)
        """
        fig, ax = plt.subplots(figsize=(8, 6), dpi=300)

        # 计算统计量
        groups = self.df[group_col].unique()
        means = []
        sems = []  # 标准误

        for group in groups:
            data = self.df[self.df[group_col] == group][column].dropna()
            means.append(data.mean())
            sems.append(data.sem())

        # 柱状图
        x = np.arange(len(groups))
        bars = ax.bar(x, means, yerr=sems,
                     capsize=5,
                     color=['#3498db', '#e74c3c'],
                     edgecolor='black',
                     linewidth=1.5,
                     alpha=0.8)

        # 标注数值
        for i, (mean, sem) in enumerate(zip(means, sems)):
            ax.text(i, mean + sem + 1,
                   f'{mean:.1f}±{sem:.1f}',
                   ha='center', va='bottom',
                   fontsize=12, fontweight='bold')

        # 计算P值
        data1 = self.df[self.df[group_col] == groups[0]][column].dropna()
        data2 = self.df[self.df[group_col] == groups[1]][column].dropna()
        _, p_value = stats.ttest_ind(data1, data2)

        # 标注P值
        max_y = max(means) + max(sems) + 3
        ax.plot([0, 1], [max_y, max_y], 'k-', linewidth=1.5)
        ax.plot([0, 0], [max_y - 0.5, max_y], 'k-', linewidth=1.5)
        ax.plot([1, 1], [max_y - 0.5, max_y], 'k-', linewidth=1.5)

        if p_value < 0.001:
            sig_text = '***'
        elif p_value < 0.01:
            sig_text = '**'
        elif p_value < 0.05:
            sig_text = '*'
        else:
            sig_text = 'ns'

        ax.text(0.5, max_y + 0.5,
               f'{sig_text}\nP={p_value:.3f}',
               ha='center', fontsize=11)

        # 设置标签
        ax.set_xticks(x)
        ax.set_xticklabels(groups, fontsize=14, fontweight='bold')
        ax.set_ylabel(column, fontsize=14, fontweight='bold')
        ax.set_title(f'{column}组间对比',
                    fontsize=16, fontweight='bold', pad=20)

        plt.tight_layout()
        plt.savefig(output_file, dpi=300, bbox_inches='tight')
        print(f"✓ 已保存: {output_file}")

        return fig

    def plot_boxplot(self, column, group_col,
                    output_file='boxplot.png'):
        """箱线图"""
        fig, ax = plt.subplots(figsize=(8, 6), dpi=300)

        # 箱线图
        sns.boxplot(data=self.df,
                   x=group_col,
                   y=column,
                   ax=ax,
                   palette='Set2',
                   linewidth=1.5)

        # 叠加数据点
        sns.stripplot(data=self.df,
                     x=group_col,
                     y=column,
                     ax=ax,
                     color='black',
                     alpha=0.3,
                     size=4)

        ax.set_xlabel(group_col, fontsize=14, fontweight='bold')
        ax.set_ylabel(column, fontsize=14, fontweight='bold')
        ax.set_title(f'{column}分布对比',
                    fontsize=16, fontweight='bold')

        plt.tight_layout()
        plt.savefig(output_file, dpi=300, bbox_inches='tight')
        print(f"✓ 已保存: {output_file}")

        return fig

    def plot_paired_comparison(self, before_col, after_col,
                              output_file='paired.png'):
        """配对数据对比(连线图)"""
        fig, ax = plt.subplots(figsize=(6, 8), dpi=300)

        # 准备配对数据
        paired_df = self.df[[before_col, after_col]].dropna()

        # 绘制连线
        for idx, row in paired_df.iterrows():
            ax.plot([0, 1], [row[before_col], row[after_col]],
                   'o-', color='gray', alpha=0.3, linewidth=1)

        # 均值线
        mean_before = paired_df[before_col].mean()
        mean_after = paired_df[after_col].mean()

        ax.plot([0, 1], [mean_before, mean_after],
               'o-', color='red', linewidth=3,
               markersize=10, label='平均值')

        # P值
        _, p_value = stats.ttest_rel(paired_df[before_col],
                                     paired_df[after_col])

        ax.text(0.5, ax.get_ylim()[1] * 0.95,
               f'P={p_value:.4f}',
               ha='center', fontsize=12,
               bbox=dict(boxstyle='round', facecolor='wheat'))

        ax.set_xticks([0, 1])
        ax.set_xticklabels(['治疗前', '治疗后'],
                          fontsize=14, fontweight='bold')
        ax.set_ylabel('血压 (mmHg)', fontsize=14, fontweight='bold')
        ax.set_title('治疗前后血压变化',
                    fontsize=16, fontweight='bold')
        ax.legend(fontsize=12)

        plt.tight_layout()
        plt.savefig(output_file, dpi=300, bbox_inches='tight')
        print(f"✓ 已保存: {output_file}")

        return fig

    def plot_scatter_with_regression(self, x_col, y_col,
                                     output_file='scatter.png'):
        """散点图+回归线"""
        fig, ax = plt.subplots(figsize=(8, 6), dpi=300)

        # 散点图
        ax.scatter(self.df[x_col], self.df[y_col],
                  alpha=0.6, s=50, edgecolors='black')

        # 回归线
        from scipy.stats import linregress
        slope, intercept, r_value, p_value, std_err = linregress(
            self.df[x_col].dropna(),
            self.df[y_col].dropna()
        )

        x_line = np.linspace(self.df[x_col].min(),
                            self.df[x_col].max(), 100)
        y_line = slope * x_line + intercept

        ax.plot(x_line, y_line, 'r-', linewidth=2,
               label=f'R²={r_value**2:.3f}, P={p_value:.3f}')

        ax.set_xlabel(x_col, fontsize=14, fontweight='bold')
        ax.set_ylabel(y_col, fontsize=14, fontweight='bold')
        ax.set_title(f'{x_col} vs {y_col}相关性',
                    fontsize=16, fontweight='bold')
        ax.legend(fontsize=12)
        ax.grid(True, alpha=0.3)

        plt.tight_layout()
        plt.savefig(output_file, dpi=300, bbox_inches='tight')
        print(f"✓ 已保存: {output_file}")

        return fig

def main():
    """主程序示例"""
    viz = ClinicalVisualizer('trial_data.xlsx')

    # 1. 组间对比
    viz.plot_group_comparison('血压下降值', '治疗分组')

    # 2. 箱线图
    viz.plot_boxplot('收缩压', '治疗分组')

    # 3. 配对对比
    viz.plot_paired_comparison('基线收缩压', '随访收缩压')

    # 4. 相关性
    viz.plot_scatter_with_regression('年龄', '血压下降值')

if __name__ == "__main__":
    main()
```

## 检查清单

- [ ] 图表类型适合数据
- [ ] 分辨率300 DPI以上
- [ ] 标签清晰可读
- [ ] 有图例和单位
- [ ] 配色合理
- [ ] P值标注正确

## 下一步

[10.7 完整案例](10.7-complete-case.md) - 临床试验数据分析完整流程
