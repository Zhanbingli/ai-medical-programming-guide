# 10.5 组间对比与假设检验

## 临床研究的核心问题

**研究假设**:
```
问题: A药降压效果是否优于B药?

零假设(H0): A药和B药效果相同
备择假设(H1): A药效果优于B药

统计检验 → P值 → 是否拒绝H0
```

## 常见假设检验场景

### 场景1: 两组连续变量对比

**示例**: 对比A药组和B药组的血压下降值

```
A药组(n=50): 平均下降15.2 mmHg
B药组(n=50): 平均下降10.8 mmHg

问题: 这个差异是真实存在,还是由随机误差造成的?

方法: 独立样本t检验
```

### 场景2: 配对数据对比

**示例**: 对比同一组患者治疗前后血压

```
治疗前: 平均145 mmHg
治疗后: 平均130 mmHg

方法: 配对t检验
```

### 场景3: 分类变量对比

**示例**: 对比两组患者的治愈率

```
A药组: 40/50 治愈(80%)
B药组: 30/50 治愈(60%)

方法: 卡方检验
```

## 用AI生成假设检验代码

### 需求描述

**向AI提问**:
```
我需要对临床试验数据进行统计检验:

1. 独立样本t检验:
   - 对比两组的血压下降值
   - 检查正态性和方差齐性
   - 如果不满足条件,使用Mann-Whitney U检验

2. 配对t检验:
   - 对比治疗前后血压
   - 计算配对差值

3. 卡方检验:
   - 对比两组治愈率

4. 多组对比(方差分析):
   - 对比3种剂量的效果

要求:
- 自动选择合适的检验方法
- 报告效应量(Cohen's d)
- 生成结果表格
```

### AI生成代码

```python
"""
假设检验工具
"""

import pandas as pd
import numpy as np
from scipy import stats
import warnings
warnings.filterwarnings('ignore')

class HypothesisTesting:
    """假设检验工具类"""

    def __init__(self, data_file):
        self.df = pd.read_excel(data_file)

    def check_normality(self, data):
        """
        检查正态性(Shapiro-Wilk检验)

        Returns:
            bool: True表示正态分布
        """
        if len(data) < 3:
            return False

        _, p_value = stats.shapiro(data)
        return p_value > 0.05

    def check_variance_equality(self, data1, data2):
        """
        检查方差齐性(Levene检验)

        Returns:
            bool: True表示方差齐性
        """
        _, p_value = stats.levene(data1, data2)
        return p_value > 0.05

    def cohens_d(self, data1, data2):
        """
        计算Cohen's d效应量

        Returns:
            float: 效应量(0.2=小, 0.5=中, 0.8=大)
        """
        mean_diff = data1.mean() - data2.mean()
        pooled_std = np.sqrt(
            ((len(data1) - 1) * data1.var() + (len(data2) - 1) * data2.var()) /
            (len(data1) + len(data2) - 2)
        )

        return mean_diff / pooled_std

    def independent_ttest(self, column, group_col, group1, group2):
        """
        独立样本t检验

        Args:
            column: 要检验的变量
            group_col: 分组列
            group1, group2: 分组名称

        Returns:
            字典: 检验结果
        """
        print(f"\n独立样本t检验: {column}")
        print("-" * 60)

        # 提取数据
        data1 = self.df[self.df[group_col] == group1][column].dropna()
        data2 = self.df[self.df[group_col] == group2][column].dropna()

        # 基本统计
        mean1, std1 = data1.mean(), data1.std()
        mean2, std2 = data2.mean(), data2.std()

        print(f"{group1}: {mean1:.2f}±{std1:.2f} (n={len(data1)})")
        print(f"{group2}: {mean2:.2f}±{std2:.2f} (n={len(data2)})")

        # 正态性检验
        normal1 = self.check_normality(data1)
        normal2 = self.check_normality(data2)

        print(f"\n正态性检验:")
        print(f"  {group1}: {'✓ 正态' if normal1 else '✗ 非正态'}")
        print(f"  {group2}: {'✓ 正态' if normal2 else '✗ 非正态'}")

        # 选择检验方法
        if normal1 and normal2:
            # 方差齐性检验
            equal_var = self.check_variance_equality(data1, data2)
            print(f"  方差齐性: {'✓ 齐性' if equal_var else '✗ 不齐性'}")

            # t检验
            t_stat, p_value = stats.ttest_ind(data1, data2, equal_var=equal_var)

            # 效应量
            effect_size = abs(self.cohens_d(data1, data2))

            method = "独立样本t检验"
        else:
            # Mann-Whitney U检验(非参数)
            u_stat, p_value = stats.mannwhitneyu(data1, data2, alternative='two-sided')
            t_stat = u_stat
            effect_size = None

            method = "Mann-Whitney U检验(非参数)"

        print(f"\n检验方法: {method}")
        print(f"P值: {p_value:.4f}")

        if p_value < 0.05:
            print(f"结论: ✓ 两组差异有统计学意义(P<0.05)")
        else:
            print(f"结论: ✗ 两组差异无统计学意义(P≥0.05)")

        if effect_size:
            print(f"效应量(Cohen's d): {effect_size:.3f}", end=" ")
            if effect_size < 0.2:
                print("(极小)")
            elif effect_size < 0.5:
                print("(小)")
            elif effect_size < 0.8:
                print("(中)")
            else:
                print("(大)")

        return {
            'Variable': column,
            'Group1': group1,
            'Mean1': f"{mean1:.2f}±{std1:.2f}",
            'Group2': group2,
            'Mean2': f"{mean2:.2f}±{std2:.2f}",
            'Method': method,
            'P-value': f"{p_value:.4f}",
            'Significant': 'Yes' if p_value < 0.05 else 'No',
            'Effect Size': f"{effect_size:.3f}" if effect_size else 'N/A'
        }

    def paired_ttest(self, before_col, after_col):
        """
        配对t检验

        Args:
            before_col: 治疗前变量
            after_col: 治疗后变量
        """
        print(f"\n配对t检验: {before_col} vs {after_col}")
        print("-" * 60)

        # 提取配对数据
        before = self.df[before_col].dropna()
        after = self.df[after_col].dropna()

        # 只保留配对的数据
        paired_df = self.df[[before_col, after_col]].dropna()
        before = paired_df[before_col]
        after = paired_df[after_col]

        # 计算差值
        diff = after - before

        print(f"治疗前: {before.mean():.2f}±{before.std():.2f}")
        print(f"治疗后: {after.mean():.2f}±{after.std():.2f}")
        print(f"差值: {diff.mean():.2f}±{diff.std():.2f}")

        # 正态性检验
        normal = self.check_normality(diff)
        print(f"差值正态性: {'✓ 正态' if normal else '✗ 非正态'}")

        # 选择检验方法
        if normal:
            t_stat, p_value = stats.ttest_rel(before, after)
            method = "配对t检验"
        else:
            w_stat, p_value = stats.wilcoxon(before, after)
            method = "Wilcoxon符号秩检验(非参数)"

        print(f"\n检验方法: {method}")
        print(f"P值: {p_value:.4f}")

        if p_value < 0.05:
            print(f"结论: ✓ 治疗前后差异有统计学意义(P<0.05)")
        else:
            print(f"结论: ✗ 治疗前后差异无统计学意义(P≥0.05)")

        return {
            'Comparison': f'{before_col} vs {after_col}',
            'Before': f"{before.mean():.2f}±{before.std():.2f}",
            'After': f"{after.mean():.2f}±{after.std():.2f}",
            'Change': f"{diff.mean():.2f}±{diff.std():.2f}",
            'Method': method,
            'P-value': f"{p_value:.4f}",
            'Significant': 'Yes' if p_value < 0.05 else 'No'
        }

    def chi_square_test(self, outcome_col, group_col):
        """
        卡方检验(分类变量)

        Args:
            outcome_col: 结局变量(如治愈/未治愈)
            group_col: 分组变量
        """
        print(f"\n卡方检验: {outcome_col} vs {group_col}")
        print("-" * 60)

        # 列联表
        contingency = pd.crosstab(
            self.df[outcome_col],
            self.df[group_col],
            margins=True
        )

        print("列联表:")
        print(contingency)

        # 去除margins计算卡方
        contingency_no_margin = pd.crosstab(
            self.df[outcome_col],
            self.df[group_col]
        )

        # 卡方检验
        chi2, p_value, dof, expected = stats.chi2_contingency(contingency_no_margin)

        print(f"\n卡方值: {chi2:.3f}")
        print(f"自由度: {dof}")
        print(f"P值: {p_value:.4f}")

        if p_value < 0.05:
            print(f"结论: ✓ 两组分布差异有统计学意义(P<0.05)")
        else:
            print(f"结论: ✗ 两组分布差异无统计学意义(P≥0.05)")

        return {
            'Outcome': outcome_col,
            'Group': group_col,
            'Chi-square': f"{chi2:.3f}",
            'P-value': f"{p_value:.4f}",
            'Significant': 'Yes' if p_value < 0.05 else 'No'
        }

    def anova_test(self, column, group_col):
        """
        方差分析(多组对比)

        Args:
            column: 连续变量
            group_col: 分组变量(>2组)
        """
        print(f"\n方差分析(ANOVA): {column} vs {group_col}")
        print("-" * 60)

        # 提取各组数据
        groups = []
        group_names = self.df[group_col].unique()

        for group in group_names:
            data = self.df[self.df[group_col] == group][column].dropna()
            groups.append(data)
            print(f"{group}: {data.mean():.2f}±{data.std():.2f} (n={len(data)})")

        # 方差分析
        f_stat, p_value = stats.f_oneway(*groups)

        print(f"\nF值: {f_stat:.3f}")
        print(f"P值: {p_value:.4f}")

        if p_value < 0.05:
            print(f"结论: ✓ 各组差异有统计学意义(P<0.05)")
            print("(需要进行事后检验,如Tukey HSD)")
        else:
            print(f"结论: ✗ 各组差异无统计学意义(P≥0.05)")

        return {
            'Variable': column,
            'Groups': group_col,
            'F-statistic': f"{f_stat:.3f}",
            'P-value': f"{p_value:.4f}",
            'Significant': 'Yes' if p_value < 0.05 else 'No'
        }

def main():
    """主程序示例"""
    tester = HypothesisTesting('trial_data.xlsx')

    # 1. 独立样本t检验
    result1 = tester.independent_ttest(
        column='血压下降值',
        group_col='治疗分组',
        group1='A药',
        group2='B药'
    )

    # 2. 配对t检验
    result2 = tester.paired_ttest(
        before_col='基线收缩压',
        after_col='随访收缩压'
    )

    # 3. 卡方检验
    result3 = tester.chi_square_test(
        outcome_col='治疗效果',
        group_col='治疗分组'
    )

if __name__ == "__main__":
    main()
```

## 检验方法选择流程图

```
数据类型?
├─ 连续变量
│  ├─ 两组对比?
│  │  ├─ 独立样本?
│  │  │  ├─ 正态分布? → 独立样本t检验
│  │  │  └─ 非正态 → Mann-Whitney U检验
│  │  └─ 配对样本?
│  │     ├─ 正态分布? → 配对t检验
│  │     └─ 非正态 → Wilcoxon符号秩检验
│  └─ 多组对比(>2)?
│     ├─ 正态分布? → 方差分析(ANOVA)
│     └─ 非正态 → Kruskal-Wallis检验
└─ 分类变量
   └─ 卡方检验 或 Fisher精确检验(样本小时)
```

## P值解读

| P值 | 解释 | 临床意义 |
|-----|------|---------|
| P < 0.001 | 极度显著 | 证据非常强 |
| P < 0.01 | 高度显著 | 证据很强 |
| P < 0.05 | 显著 | 有统计学意义 |
| P ≥ 0.05 | 不显著 | 无统计学意义 |

**重要**: P值只表示统计学意义,临床意义需结合效应量和实际差值判断!

## 检查清单

- [ ] 选择了正确的检验方法
- [ ] 检查了数据假设(正态性、方差齐性)
- [ ] 报告了P值和效应量
- [ ] 结论与数据一致
- [ ] 区分了统计学意义和临床意义

## 下一步

[10.6 数据可视化](10.6-visualization.md) - 制作论文级别图表
