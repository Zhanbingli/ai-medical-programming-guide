# 10.7 完整案例:临床试验数据分析

## 项目背景

**研究问题**: 对比A药和B药治疗高血压的疗效

**数据**: trial_data.xlsx
- 100位患者(A药50人,B药50人)
- 基线和随访数据
- 主要结局:收缩压下降值

## 完整分析流程

### 第1步: 数据加载与检查

**Prompt给AI**:
```
读取trial_data.xlsx,检查数据质量:
1. 显示前5行
2. 数据维度
3. 列名和数据类型
4. 缺失值统计
```

**代码**:
```python
import pandas as pd

df = pd.read_excel('trial_data.xlsx')

print("数据维度:", df.shape)
print("\n前5行:")
print(df.head())
print("\n数据类型:")
print(df.dtypes)
print("\n缺失值:")
print(df.isnull().sum())
```

### 第2步: 数据清洗

**使用10.2节的清洗工具**:
```bash
python data_cleaner.py trial_data.xlsx trial_data_clean.xlsx
```

### 第3步: 数据验证

**使用10.3节的验证工具**:
```bash
python data_validator.py trial_data_clean.xlsx
```

### 第4步: 生成Table 1

**使用10.4节的统计工具**:
```bash
python descriptive_stats.py trial_data_clean.xlsx 治疗分组
```

### 第5步: 主要分析

**统计检验**:
```python
from hypothesis_testing import HypothesisTesting

tester = HypothesisTesting('trial_data_clean.xlsx')

# 主要结局:收缩压下降值
result = tester.independent_ttest(
    column='收缩压下降值',
    group_col='治疗分组',
    group1='A药',
    group2='B药'
)
```

### 第6步: 生成图表

**可视化**:
```python
from visualization import ClinicalVisualizer

viz = ClinicalVisualizer('trial_data_clean.xlsx')

# Figure 1: 主要结局对比
viz.plot_group_comparison('收缩压下降值', '治疗分组',
                         output_file='Figure1.png')

# Figure 2: 治疗前后对比
viz.plot_paired_comparison('基线收缩压', '随访收缩压',
                          output_file='Figure2.png')
```

### 第7步: 生成报告

**完整分析报告**:
```python
"""
临床试验分析报告生成器
"""

from docx import Document
from docx.shared import Inches

def generate_analysis_report(data_file, output_file='分析报告.docx'):
    """生成完整分析报告"""

    doc = Document()

    # 标题
    doc.add_heading('临床试验数据分析报告', 0)

    # 1. 研究背景
    doc.add_heading('1. 研究背景', 1)
    doc.add_paragraph(
        '本研究旨在对比A药和B药治疗高血压的疗效。'
        '共纳入100位患者,随机分配到A药组(n=50)和B药组(n=50)。'
    )

    # 2. 数据描述
    doc.add_heading('2. 数据描述', 1)
    doc.add_paragraph('详见Table 1(患者基线特征)')

    # 3. 主要结果
    doc.add_heading('3. 主要结果', 1)
    doc.add_paragraph(
        'A药组收缩压平均下降15.2±3.5 mmHg,'
        'B药组平均下降10.8±3.2 mmHg,'
        '差异有统计学意义(P<0.001)。'
    )

    # 插入图片
    doc.add_paragraph('详见Figure 1')
    doc.add_picture('Figure1.png', width=Inches(5))

    # 4. 结论
    doc.add_heading('4. 结论', 1)
    doc.add_paragraph(
        'A药降压效果优于B药,差异有统计学意义和临床意义。'
    )

    # 保存
    doc.save(output_file)
    print(f"✓ 报告已生成: {output_file}")

# 使用
generate_analysis_report('trial_data_clean.xlsx')
```

## 时间对比

| 步骤 | 传统方式 | AI辅助 | 节省 |
|-----|---------|--------|------|
| 数据清洗 | 3小时 | 10分钟 | 94% |
| 统计分析 | 2小时 | 15分钟 | 87% |
| 制作图表 | 2小时 | 10分钟 | 92% |
| 生成报告 | 1小时 | 5分钟 | 92% |
| **总计** | **8小时** | **40分钟** | **92%** |

## 恭喜!

完成第10章,你已经掌握:
✅ 数据清洗自动化
✅ 数据质量验证
✅ 描述性统计
✅ 假设检验
✅ 数据可视化
✅ 完整分析流程

## 下一章预告

[第11章 病例管理系统](../chapter11/11.1-overview.md) - 构建实用的病例管理工具
