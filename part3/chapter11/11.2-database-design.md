# 11.2 数据库设计

## 为什么使用数据库?

**Excel vs 数据库**:

| 特性 | Excel | SQLite数据库 |
|-----|-------|-------------|
| 数据量 | <10万行 | 百万级+ |
| 并发访问 | ❌ 容易损坏 | ✅ 支持 |
| 查询速度 | ❌ 慢 | ✅ 快(索引) |
| 数据完整性 | ❌ 无约束 | ✅ 有约束 |
| 关系查询 | ❌ 困难 | ✅ SQL |

## 数据库表设计

### 患者基本信息表 (patients)

```sql
CREATE TABLE patients (
    id INTEGER PRIMARY KEY AUTOINCREMENT,  -- 自增ID
    patient_id VARCHAR(20) UNIQUE NOT NULL, -- 患者编号
    name VARCHAR(50) NOT NULL,              -- 姓名
    age INTEGER,                            -- 年龄
    gender VARCHAR(10),                     -- 性别
    phone VARCHAR(20),                      -- 电话
    id_number VARCHAR(18),                  -- 身份证号
    address TEXT,                           -- 地址
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 就诊记录表 (visits)

```sql
CREATE TABLE visits (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    patient_id VARCHAR(20),                 -- 关联患者
    visit_date DATE NOT NULL,               -- 就诊日期
    diagnosis TEXT,                         -- 诊断
    symptoms TEXT,                          -- 症状
    treatment TEXT,                         -- 治疗方案
    doctor VARCHAR(50),                     -- 医生
    notes TEXT,                             -- 备注
    FOREIGN KEY (patient_id) REFERENCES patients(patient_id)
);
```

### 随访记录表 (followups)

```sql
CREATE TABLE followups (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    patient_id VARCHAR(20),
    followup_date DATE NOT NULL,            -- 随访日期
    status VARCHAR(20),                     -- 状态:待随访/已完成
    notes TEXT,
    completed_at DATETIME,
    FOREIGN KEY (patient_id) REFERENCES patients(patient_id)
);
```

## 用AI生成数据库代码

**Prompt**:
```
生成SQLite数据库操作类:
1. 创建patients, visits, followups三个表
2. 提供增删改查方法
3. 包含错误处理
```

**AI生成代码**:
```python
"""
病例数据库管理
"""

import sqlite3
from datetime import datetime

class PatientDB:
    """患者数据库管理类"""

    def __init__(self, db_file='patients.db'):
        self.conn = sqlite3.connect(db_file)
        self.conn.row_factory = sqlite3.Row  # 返回字典格式
        self.create_tables()

    def create_tables(self):
        """创建数据库表"""
        cursor = self.conn.cursor()

        # 患者表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS patients (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                patient_id VARCHAR(20) UNIQUE NOT NULL,
                name VARCHAR(50) NOT NULL,
                age INTEGER,
                gender VARCHAR(10),
                phone VARCHAR(20),
                id_number VARCHAR(18),
                address TEXT,
                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
            )
        ''')

        # 就诊记录表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS visits (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                patient_id VARCHAR(20),
                visit_date DATE NOT NULL,
                diagnosis TEXT,
                symptoms TEXT,
                treatment TEXT,
                doctor VARCHAR(50),
                notes TEXT,
                FOREIGN KEY (patient_id) REFERENCES patients(patient_id)
            )
        ''')

        # 随访表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS followups (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                patient_id VARCHAR(20),
                followup_date DATE NOT NULL,
                status VARCHAR(20) DEFAULT '待随访',
                notes TEXT,
                completed_at DATETIME,
                FOREIGN KEY (patient_id) REFERENCES patients(patient_id)
            )
        ''')

        self.conn.commit()

    def add_patient(self, patient_data):
        """添加患者"""
        cursor = self.conn.cursor()

        cursor.execute('''
            INSERT INTO patients (patient_id, name, age, gender,
                                 phone, id_number, address)
            VALUES (?, ?, ?, ?, ?, ?, ?)
        ''', (
            patient_data['patient_id'],
            patient_data['name'],
            patient_data.get('age'),
            patient_data.get('gender'),
            patient_data.get('phone'),
            patient_data.get('id_number'),
            patient_data.get('address')
        ))

        self.conn.commit()
        return cursor.lastrowid

    def search_patient(self, keyword):
        """检索患者"""
        cursor = self.conn.cursor()

        cursor.execute('''
            SELECT * FROM patients
            WHERE patient_id LIKE ? OR name LIKE ? OR phone LIKE ?
        ''', (f'%{keyword}%', f'%{keyword}%', f'%{keyword}%'))

        return cursor.fetchall()

    def add_visit(self, visit_data):
        """添加就诊记录"""
        cursor = self.conn.cursor()

        cursor.execute('''
            INSERT INTO visits (patient_id, visit_date, diagnosis,
                               symptoms, treatment, doctor, notes)
            VALUES (?, ?, ?, ?, ?, ?, ?)
        ''', (
            visit_data['patient_id'],
            visit_data['visit_date'],
            visit_data.get('diagnosis'),
            visit_data.get('symptoms'),
            visit_data.get('treatment'),
            visit_data.get('doctor'),
            visit_data.get('notes')
        ))

        self.conn.commit()

    def get_patient_history(self, patient_id):
        """获取患者历史记录"""
        cursor = self.conn.cursor()

        cursor.execute('''
            SELECT * FROM visits
            WHERE patient_id = ?
            ORDER BY visit_date DESC
        ''', (patient_id,))

        return cursor.fetchall()

    def close(self):
        """关闭数据库"""
        self.conn.close()
```

## 使用示例

```python
# 初始化数据库
db = PatientDB()

# 添加患者
patient = {
    'patient_id': 'P001',
    'name': '张三',
    'age': 45,
    'gender': '男',
    'phone': '13800138000'
}
db.add_patient(patient)

# 检索患者
results = db.search_patient('张三')
for row in results:
    print(dict(row))

# 关闭数据库
db.close()
```

## 下一步

[11.3 病例录入功能](11.3-data-entry.md) - 构建录入界面
