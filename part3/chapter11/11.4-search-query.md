# 11.4 æ£€ç´¢ä¸æŸ¥è¯¢

## ä¸ºä»€ä¹ˆéœ€è¦å¼ºå¤§çš„æ£€ç´¢åŠŸèƒ½?

**åœºæ™¯**:
```
åŒ»ç”Ÿ: "å¸®æˆ‘æ‰¾ä¸€ä¸‹ä¸Šä¸ªæœˆæ¥çœ‹é«˜è¡€å‹çš„å¼ å§“æ‚£è€…"

ä¼ ç»Ÿæ–¹å¼:
- ç¿»é˜…çº¸è´¨ç—…å†: 20åˆ†é’Ÿ ğŸ˜«
- Excel Ctrl+F: éœ€è¦çŸ¥é“ç¡®åˆ‡ä¿¡æ¯

AI+æ•°æ®åº“:
- SQLå¤šæ¡ä»¶æŸ¥è¯¢: 1ç§’ âœ…
- æ¨¡ç³ŠåŒ¹é…,æ™ºèƒ½æç¤º
```

## æ£€ç´¢ç±»å‹

### 1. ç®€å•æ£€ç´¢(å•æ¡ä»¶)

```python
# æŒ‰å§“å
SELECT * FROM patients WHERE name = 'å¼ ä¸‰';

# æŒ‰æ‚£è€…ID
SELECT * FROM patients WHERE patient_id = 'P0001';

# æŒ‰ç”µè¯
SELECT * FROM patients WHERE phone = '13800138000';
```

### 2. æ¨¡ç³Šæ£€ç´¢

```python
# å§“æ°æ£€ç´¢
SELECT * FROM patients WHERE name LIKE 'å¼ %';

# åŒ…å«å…³é”®è¯
SELECT * FROM patients WHERE diagnosis LIKE '%é«˜è¡€å‹%';
```

### 3. é«˜çº§æ£€ç´¢(å¤šæ¡ä»¶)

```python
# å¹´é¾„èŒƒå›´ + æ€§åˆ« + è¯Šæ–­
SELECT * FROM patients p
JOIN visits v ON p.patient_id = v.patient_id
WHERE p.age BETWEEN 40 AND 60
  AND p.gender = 'ç”·'
  AND v.diagnosis LIKE '%ç³–å°¿ç—…%';
```

### 4. æ—¶é—´èŒƒå›´æ£€ç´¢

```python
# æœ€è¿‘ä¸€ä¸ªæœˆå°±è¯Šæ‚£è€…
SELECT * FROM visits
WHERE visit_date >= date('now', '-30 days');

# æŒ‡å®šæ—¥æœŸèŒƒå›´
SELECT * FROM visits
WHERE visit_date BETWEEN '2024-01-01' AND '2024-01-31';
```

## ç”¨AIç”Ÿæˆæ£€ç´¢ç•Œé¢

### éœ€æ±‚æè¿°

**å‘AIæé—®**:
```
åˆ›å»ºStreamlitæ‚£è€…æ£€ç´¢ç•Œé¢:

åŠŸèƒ½:
1. å¿«é€Ÿæ£€ç´¢(æœç´¢æ¡†)
   - æ”¯æŒå§“åã€IDã€ç”µè¯
   - æ¨¡ç³ŠåŒ¹é…
2. é«˜çº§æ£€ç´¢(å¤šæ¡ä»¶)
   - å¹´é¾„èŒƒå›´
   - æ€§åˆ«
   - è¯Šæ–­å…³é”®è¯
   - æ—¥æœŸèŒƒå›´
3. ç»“æœå±•ç¤º
   - è¡¨æ ¼å½¢å¼
   - å¯ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…
   - æ”¯æŒå¯¼å‡ºExcel
4. ç»Ÿè®¡ä¿¡æ¯
   - æ£€ç´¢ç»“æœæ•°é‡
   - å¯è§†åŒ–(å›¾è¡¨)

è¯·ç”Ÿæˆå®Œæ•´ä»£ç ã€‚
```

### AIç”Ÿæˆä»£ç 

```python
"""
æ‚£è€…æ£€ç´¢æŸ¥è¯¢ç•Œé¢
"""

import streamlit as st
import pandas as pd
from datetime import datetime, timedelta
from database import PatientDB

def main():
    st.title("ğŸ” æ‚£è€…æ£€ç´¢ç³»ç»Ÿ")
    st.markdown("---")

    # ä¾§è¾¹æ :æ£€ç´¢æ–¹å¼
    st.sidebar.header("æ£€ç´¢æ–¹å¼")
    search_mode = st.sidebar.radio(
        "é€‰æ‹©æ£€ç´¢æ¨¡å¼",
        ["å¿«é€Ÿæ£€ç´¢", "é«˜çº§æ£€ç´¢"]
    )

    if search_mode == "å¿«é€Ÿæ£€ç´¢":
        quick_search()
    else:
        advanced_search()

def quick_search():
    """å¿«é€Ÿæ£€ç´¢"""
    st.header("âš¡ å¿«é€Ÿæ£€ç´¢")

    # æœç´¢æ¡†
    col1, col2 = st.columns([3, 1])

    with col1:
        keyword = st.text_input(
            "è¾“å…¥å…³é”®è¯",
            placeholder="å§“åã€æ‚£è€…IDæˆ–ç”µè¯å·ç ",
            label_visibility="collapsed"
        )

    with col2:
        search_btn = st.button("ğŸ” æœç´¢", use_container_width=True)

    if keyword or search_btn:
        if not keyword:
            st.warning("è¯·è¾“å…¥æœç´¢å…³é”®è¯")
            return

        # æ‰§è¡Œæœç´¢
        db = PatientDB()
        results = db.search_patient(keyword)

        if results:
            st.success(f"âœ… æ‰¾åˆ° {len(results)} æ¡è®°å½•")

            # è½¬æ¢ä¸ºDataFrame
            df_results = pd.DataFrame([dict(row) for row in results])

            # æ˜¾ç¤ºç»“æœè¡¨æ ¼
            display_results(df_results)

        else:
            st.warning("âŒ æœªæ‰¾åˆ°åŒ¹é…çš„æ‚£è€…")

        db.close()

def advanced_search():
    """é«˜çº§æ£€ç´¢"""
    st.header("ğŸ¯ é«˜çº§æ£€ç´¢")

    with st.form("advanced_search_form"):
        col1, col2 = st.columns(2)

        with col1:
            st.subheader("åŸºæœ¬ä¿¡æ¯")

            # å§“å
            name = st.text_input("å§“å(æ”¯æŒæ¨¡ç³Š)", placeholder="ä¾‹: å¼ ")

            # æ€§åˆ«
            gender = st.selectbox("æ€§åˆ«", ["å…¨éƒ¨", "ç”·", "å¥³"])

            # å¹´é¾„èŒƒå›´
            age_col1, age_col2 = st.columns(2)
            with age_col1:
                min_age = st.number_input("æœ€å°å¹´é¾„", 0, 120, 0)
            with age_col2:
                max_age = st.number_input("æœ€å¤§å¹´é¾„", 0, 120, 120)

        with col2:
            st.subheader("å°±è¯Šä¿¡æ¯")

            # è¯Šæ–­å…³é”®è¯
            diagnosis = st.text_input("è¯Šæ–­å…³é”®è¯", placeholder="ä¾‹: é«˜è¡€å‹")

            # æ—¥æœŸèŒƒå›´
            date_range = st.radio(
                "å°±è¯Šæ—¶é—´",
                ["å…¨éƒ¨", "æœ€è¿‘ä¸€å‘¨", "æœ€è¿‘ä¸€æœˆ", "æœ€è¿‘ä¸€å¹´", "è‡ªå®šä¹‰"]
            )

            if date_range == "è‡ªå®šä¹‰":
                date_col1, date_col2 = st.columns(2)
                with date_col1:
                    start_date = st.date_input("å¼€å§‹æ—¥æœŸ")
                with date_col2:
                    end_date = st.date_input("ç»“æŸæ—¥æœŸ")

        # æœç´¢æŒ‰é’®
        submitted = st.form_submit_button("ğŸ” å¼€å§‹æ£€ç´¢", use_container_width=True)

        if submitted:
            # æ„å»ºSQLæŸ¥è¯¢
            query = """
                SELECT DISTINCT p.*, v.diagnosis, v.visit_date
                FROM patients p
                LEFT JOIN visits v ON p.patient_id = v.patient_id
                WHERE 1=1
            """
            params = []

            # å§“åæ¡ä»¶
            if name:
                query += " AND p.name LIKE ?"
                params.append(f"%{name}%")

            # æ€§åˆ«æ¡ä»¶
            if gender != "å…¨éƒ¨":
                query += " AND p.gender = ?"
                params.append(gender)

            # å¹´é¾„æ¡ä»¶
            query += " AND (p.age BETWEEN ? AND ?)"
            params.extend([min_age, max_age])

            # è¯Šæ–­æ¡ä»¶
            if diagnosis:
                query += " AND v.diagnosis LIKE ?"
                params.append(f"%{diagnosis}%")

            # æ—¥æœŸæ¡ä»¶
            if date_range != "å…¨éƒ¨":
                if date_range == "æœ€è¿‘ä¸€å‘¨":
                    query += " AND v.visit_date >= date('now', '-7 days')"
                elif date_range == "æœ€è¿‘ä¸€æœˆ":
                    query += " AND v.visit_date >= date('now', '-30 days')"
                elif date_range == "æœ€è¿‘ä¸€å¹´":
                    query += " AND v.visit_date >= date('now', '-365 days')"
                elif date_range == "è‡ªå®šä¹‰":
                    query += " AND v.visit_date BETWEEN ? AND ?"
                    params.extend([start_date, end_date])

            # æ‰§è¡ŒæŸ¥è¯¢
            db = PatientDB()
            cursor = db.conn.cursor()
            cursor.execute(query, params)
            results = cursor.fetchall()

            if results:
                st.success(f"âœ… æ‰¾åˆ° {len(results)} æ¡è®°å½•")

                # æ˜¾ç¤ºç»“æœ
                df_results = pd.DataFrame([dict(row) for row in results])
                display_results(df_results)

                # ç»Ÿè®¡åˆ†æ
                show_statistics(df_results)

            else:
                st.warning("âŒ æœªæ‰¾åˆ°åŒ¹é…çš„è®°å½•")

            db.close()

def display_results(df):
    """æ˜¾ç¤ºæ£€ç´¢ç»“æœ"""

    # é€‰æ‹©è¦æ˜¾ç¤ºçš„åˆ—
    display_columns = ['patient_id', 'name', 'age', 'gender', 'phone', 'diagnosis', 'visit_date']
    available_columns = [col for col in display_columns if col in df.columns]

    # é‡å‘½ååˆ—
    column_names = {
        'patient_id': 'æ‚£è€…ID',
        'name': 'å§“å',
        'age': 'å¹´é¾„',
        'gender': 'æ€§åˆ«',
        'phone': 'ç”µè¯',
        'diagnosis': 'è¯Šæ–­',
        'visit_date': 'å°±è¯Šæ—¥æœŸ'
    }

    df_display = df[available_columns].rename(columns=column_names)

    # æ˜¾ç¤ºè¡¨æ ¼
    st.dataframe(
        df_display,
        use_container_width=True,
        hide_index=True
    )

    # å¯¼å‡ºåŠŸèƒ½
    col1, col2, col3 = st.columns([1, 1, 2])

    with col1:
        # å¯¼å‡ºExcel
        if st.button("ğŸ“Š å¯¼å‡ºExcel"):
            output_file = f"search_results_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx"
            df_display.to_excel(output_file, index=False, engine='openpyxl')
            st.success(f"âœ… å·²å¯¼å‡º: {output_file}")

    with col2:
        # å¯¼å‡ºCSV
        csv = df_display.to_csv(index=False, encoding='utf-8-sig')
        st.download_button(
            label="ğŸ“„ ä¸‹è½½CSV",
            data=csv,
            file_name=f"search_results_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv",
            mime="text/csv"
        )

    # ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…
    st.markdown("---")
    st.subheader("æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯")

    if len(df) > 0:
        # é€‰æ‹©æ‚£è€…
        patient_options = {
            f"{row['name']} ({row['patient_id']})": row['patient_id']
            for _, row in df.iterrows()
        }

        selected = st.selectbox("é€‰æ‹©æ‚£è€…æŸ¥çœ‹è¯¦æƒ…", list(patient_options.keys()))

        if selected:
            patient_id = patient_options[selected]
            show_patient_detail(patient_id)

def show_patient_detail(patient_id):
    """æ˜¾ç¤ºæ‚£è€…è¯¦ç»†ä¿¡æ¯"""
    db = PatientDB()

    # è·å–æ‚£è€…ä¿¡æ¯
    cursor = db.conn.cursor()
    cursor.execute("SELECT * FROM patients WHERE patient_id = ?", (patient_id,))
    patient = cursor.fetchone()

    if patient:
        # åŸºæœ¬ä¿¡æ¯
        col1, col2, col3 = st.columns(3)

        with col1:
            st.metric("æ‚£è€…ID", patient['patient_id'])
            st.metric("å§“å", patient['name'])

        with col2:
            st.metric("å¹´é¾„", f"{patient['age']}å²")
            st.metric("æ€§åˆ«", patient['gender'])

        with col3:
            st.metric("ç”µè¯", patient['phone'] or 'æœªå¡«å†™')

        # å°±è¯Šå†å²
        st.subheader("å°±è¯Šå†å²")
        history = db.get_patient_history(patient_id)

        if history:
            for visit in history:
                with st.expander(f"ğŸ“… {visit['visit_date']} - {visit['diagnosis']}"):
                    st.markdown(f"""
                    **ä¸»è¯‰**: {visit['symptoms'] or 'æ— '}

                    **è¯Šæ–­**: {visit['diagnosis'] or 'æ— '}

                    **æ²»ç–—**: {visit['treatment'] or 'æ— '}

                    **åŒ»ç”Ÿ**: {visit['doctor'] or 'æœªè®°å½•'}

                    **å¤‡æ³¨**: {visit['notes'] or 'æ— '}
                    """)
        else:
            st.info("æš‚æ— å°±è¯Šè®°å½•")

    db.close()

def show_statistics(df):
    """æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯"""
    st.markdown("---")
    st.subheader("ğŸ“Š ç»Ÿè®¡åˆ†æ")

    col1, col2, col3, col4 = st.columns(4)

    with col1:
        st.metric("æ€»æ‚£è€…æ•°", len(df['patient_id'].unique()))

    with col2:
        if 'gender' in df.columns:
            male_count = len(df[df['gender'] == 'ç”·'])
            st.metric("ç”·æ€§", male_count)

    with col3:
        if 'gender' in df.columns:
            female_count = len(df[df['gender'] == 'å¥³'])
            st.metric("å¥³æ€§", female_count)

    with col4:
        if 'age' in df.columns:
            avg_age = df['age'].mean()
            st.metric("å¹³å‡å¹´é¾„", f"{avg_age:.1f}å²")

    # å¹´é¾„åˆ†å¸ƒå›¾
    if 'age' in df.columns and len(df) > 0:
        st.subheader("å¹´é¾„åˆ†å¸ƒ")
        import matplotlib.pyplot as plt

        fig, ax = plt.subplots(figsize=(8, 4))
        ax.hist(df['age'].dropna(), bins=20, edgecolor='black', alpha=0.7)
        ax.set_xlabel('å¹´é¾„')
        ax.set_ylabel('äººæ•°')
        ax.set_title('æ‚£è€…å¹´é¾„åˆ†å¸ƒ')
        st.pyplot(fig)

if __name__ == "__main__":
    main()
```

### è¿è¡Œæ•ˆæœ

```bash
streamlit run patient_search.py
```

**ç•Œé¢å±•ç¤º**:
```
ğŸ” æ‚£è€…æ£€ç´¢ç³»ç»Ÿ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

[å¿«é€Ÿæ£€ç´¢]

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¼                       [ğŸ” æœç´¢] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… æ‰¾åˆ° 3 æ¡è®°å½•

æ‚£è€…ID  | å§“å  | å¹´é¾„ | æ€§åˆ« | ç”µè¯        | è¯Šæ–­
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
P0001  | å¼ ä¸‰  | 45   | ç”·   | 13800138000 | é«˜è¡€å‹
P0015  | å¼ ä¸½  | 38   | å¥³   | 13900139000 | ç³–å°¿ç—…
P0032  | å¼ ä¼Ÿ  | 52   | ç”·   | 13700137000 | å† å¿ƒç—…

[ğŸ“Š å¯¼å‡ºExcel] [ğŸ“„ ä¸‹è½½CSV]
```

## æ£€æŸ¥æ¸…å•

- [ ] æ”¯æŒå¤šç§æ£€ç´¢æ–¹å¼
- [ ] æ¨¡ç³ŠåŒ¹é…å‡†ç¡®
- [ ] ç»“æœå±•ç¤ºæ¸…æ™°
- [ ] å¯å¯¼å‡ºæ•°æ®
- [ ] å“åº”é€Ÿåº¦å¿«
- [ ] æœ‰ç»Ÿè®¡åˆ†æ

## ä¸‹ä¸€æ­¥

[11.5 éšè®¿ç®¡ç†](11.5-followup.md) - è‡ªåŠ¨æé†’æ‚£è€…éšè®¿
