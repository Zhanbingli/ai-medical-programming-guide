# 11.4 检索与查询

## 为什么需要强大的检索功能?

**场景**:
```
医生: "帮我找一下上个月来看高血压的张姓患者"

传统方式:
- 翻阅纸质病历: 20分钟 😫
- Excel Ctrl+F: 需要知道确切信息

AI+数据库:
- SQL多条件查询: 1秒 ✅
- 模糊匹配,智能提示
```

## 检索类型

### 1. 简单检索(单条件)

```python
# 按姓名
SELECT * FROM patients WHERE name = '张三';

# 按患者ID
SELECT * FROM patients WHERE patient_id = 'P0001';

# 按电话
SELECT * FROM patients WHERE phone = '13800138000';
```

### 2. 模糊检索

```python
# 姓氏检索
SELECT * FROM patients WHERE name LIKE '张%';

# 包含关键词
SELECT * FROM patients WHERE diagnosis LIKE '%高血压%';
```

### 3. 高级检索(多条件)

```python
# 年龄范围 + 性别 + 诊断
SELECT * FROM patients p
JOIN visits v ON p.patient_id = v.patient_id
WHERE p.age BETWEEN 40 AND 60
  AND p.gender = '男'
  AND v.diagnosis LIKE '%糖尿病%';
```

### 4. 时间范围检索

```python
# 最近一个月就诊患者
SELECT * FROM visits
WHERE visit_date >= date('now', '-30 days');

# 指定日期范围
SELECT * FROM visits
WHERE visit_date BETWEEN '2024-01-01' AND '2024-01-31';
```

## 用AI生成检索界面

### 需求描述

**向AI提问**:
```
创建Streamlit患者检索界面:

功能:
1. 快速检索(搜索框)
   - 支持姓名、ID、电话
   - 模糊匹配
2. 高级检索(多条件)
   - 年龄范围
   - 性别
   - 诊断关键词
   - 日期范围
3. 结果展示
   - 表格形式
   - 可点击查看详情
   - 支持导出Excel
4. 统计信息
   - 检索结果数量
   - 可视化(图表)

请生成完整代码。
```

### AI生成代码

```python
"""
患者检索查询界面
"""

import streamlit as st
import pandas as pd
from datetime import datetime, timedelta
from database import PatientDB

def main():
    st.title("🔍 患者检索系统")
    st.markdown("---")

    # 侧边栏:检索方式
    st.sidebar.header("检索方式")
    search_mode = st.sidebar.radio(
        "选择检索模式",
        ["快速检索", "高级检索"]
    )

    if search_mode == "快速检索":
        quick_search()
    else:
        advanced_search()

def quick_search():
    """快速检索"""
    st.header("⚡ 快速检索")

    # 搜索框
    col1, col2 = st.columns([3, 1])

    with col1:
        keyword = st.text_input(
            "输入关键词",
            placeholder="姓名、患者ID或电话号码",
            label_visibility="collapsed"
        )

    with col2:
        search_btn = st.button("🔍 搜索", use_container_width=True)

    if keyword or search_btn:
        if not keyword:
            st.warning("请输入搜索关键词")
            return

        # 执行搜索
        db = PatientDB()
        results = db.search_patient(keyword)

        if results:
            st.success(f"✅ 找到 {len(results)} 条记录")

            # 转换为DataFrame
            df_results = pd.DataFrame([dict(row) for row in results])

            # 显示结果表格
            display_results(df_results)

        else:
            st.warning("❌ 未找到匹配的患者")

        db.close()

def advanced_search():
    """高级检索"""
    st.header("🎯 高级检索")

    with st.form("advanced_search_form"):
        col1, col2 = st.columns(2)

        with col1:
            st.subheader("基本信息")

            # 姓名
            name = st.text_input("姓名(支持模糊)", placeholder="例: 张")

            # 性别
            gender = st.selectbox("性别", ["全部", "男", "女"])

            # 年龄范围
            age_col1, age_col2 = st.columns(2)
            with age_col1:
                min_age = st.number_input("最小年龄", 0, 120, 0)
            with age_col2:
                max_age = st.number_input("最大年龄", 0, 120, 120)

        with col2:
            st.subheader("就诊信息")

            # 诊断关键词
            diagnosis = st.text_input("诊断关键词", placeholder="例: 高血压")

            # 日期范围
            date_range = st.radio(
                "就诊时间",
                ["全部", "最近一周", "最近一月", "最近一年", "自定义"]
            )

            if date_range == "自定义":
                date_col1, date_col2 = st.columns(2)
                with date_col1:
                    start_date = st.date_input("开始日期")
                with date_col2:
                    end_date = st.date_input("结束日期")

        # 搜索按钮
        submitted = st.form_submit_button("🔍 开始检索", use_container_width=True)

        if submitted:
            # 构建SQL查询
            query = """
                SELECT DISTINCT p.*, v.diagnosis, v.visit_date
                FROM patients p
                LEFT JOIN visits v ON p.patient_id = v.patient_id
                WHERE 1=1
            """
            params = []

            # 姓名条件
            if name:
                query += " AND p.name LIKE ?"
                params.append(f"%{name}%")

            # 性别条件
            if gender != "全部":
                query += " AND p.gender = ?"
                params.append(gender)

            # 年龄条件
            query += " AND (p.age BETWEEN ? AND ?)"
            params.extend([min_age, max_age])

            # 诊断条件
            if diagnosis:
                query += " AND v.diagnosis LIKE ?"
                params.append(f"%{diagnosis}%")

            # 日期条件
            if date_range != "全部":
                if date_range == "最近一周":
                    query += " AND v.visit_date >= date('now', '-7 days')"
                elif date_range == "最近一月":
                    query += " AND v.visit_date >= date('now', '-30 days')"
                elif date_range == "最近一年":
                    query += " AND v.visit_date >= date('now', '-365 days')"
                elif date_range == "自定义":
                    query += " AND v.visit_date BETWEEN ? AND ?"
                    params.extend([start_date, end_date])

            # 执行查询
            db = PatientDB()
            cursor = db.conn.cursor()
            cursor.execute(query, params)
            results = cursor.fetchall()

            if results:
                st.success(f"✅ 找到 {len(results)} 条记录")

                # 显示结果
                df_results = pd.DataFrame([dict(row) for row in results])
                display_results(df_results)

                # 统计分析
                show_statistics(df_results)

            else:
                st.warning("❌ 未找到匹配的记录")

            db.close()

def display_results(df):
    """显示检索结果"""

    # 选择要显示的列
    display_columns = ['patient_id', 'name', 'age', 'gender', 'phone', 'diagnosis', 'visit_date']
    available_columns = [col for col in display_columns if col in df.columns]

    # 重命名列
    column_names = {
        'patient_id': '患者ID',
        'name': '姓名',
        'age': '年龄',
        'gender': '性别',
        'phone': '电话',
        'diagnosis': '诊断',
        'visit_date': '就诊日期'
    }

    df_display = df[available_columns].rename(columns=column_names)

    # 显示表格
    st.dataframe(
        df_display,
        use_container_width=True,
        hide_index=True
    )

    # 导出功能
    col1, col2, col3 = st.columns([1, 1, 2])

    with col1:
        # 导出Excel
        if st.button("📊 导出Excel"):
            output_file = f"search_results_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx"
            df_display.to_excel(output_file, index=False, engine='openpyxl')
            st.success(f"✅ 已导出: {output_file}")

    with col2:
        # 导出CSV
        csv = df_display.to_csv(index=False, encoding='utf-8-sig')
        st.download_button(
            label="📄 下载CSV",
            data=csv,
            file_name=f"search_results_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv",
            mime="text/csv"
        )

    # 点击查看详情
    st.markdown("---")
    st.subheader("查看详细信息")

    if len(df) > 0:
        # 选择患者
        patient_options = {
            f"{row['name']} ({row['patient_id']})": row['patient_id']
            for _, row in df.iterrows()
        }

        selected = st.selectbox("选择患者查看详情", list(patient_options.keys()))

        if selected:
            patient_id = patient_options[selected]
            show_patient_detail(patient_id)

def show_patient_detail(patient_id):
    """显示患者详细信息"""
    db = PatientDB()

    # 获取患者信息
    cursor = db.conn.cursor()
    cursor.execute("SELECT * FROM patients WHERE patient_id = ?", (patient_id,))
    patient = cursor.fetchone()

    if patient:
        # 基本信息
        col1, col2, col3 = st.columns(3)

        with col1:
            st.metric("患者ID", patient['patient_id'])
            st.metric("姓名", patient['name'])

        with col2:
            st.metric("年龄", f"{patient['age']}岁")
            st.metric("性别", patient['gender'])

        with col3:
            st.metric("电话", patient['phone'] or '未填写')

        # 就诊历史
        st.subheader("就诊历史")
        history = db.get_patient_history(patient_id)

        if history:
            for visit in history:
                with st.expander(f"📅 {visit['visit_date']} - {visit['diagnosis']}"):
                    st.markdown(f"""
                    **主诉**: {visit['symptoms'] or '无'}

                    **诊断**: {visit['diagnosis'] or '无'}

                    **治疗**: {visit['treatment'] or '无'}

                    **医生**: {visit['doctor'] or '未记录'}

                    **备注**: {visit['notes'] or '无'}
                    """)
        else:
            st.info("暂无就诊记录")

    db.close()

def show_statistics(df):
    """显示统计信息"""
    st.markdown("---")
    st.subheader("📊 统计分析")

    col1, col2, col3, col4 = st.columns(4)

    with col1:
        st.metric("总患者数", len(df['patient_id'].unique()))

    with col2:
        if 'gender' in df.columns:
            male_count = len(df[df['gender'] == '男'])
            st.metric("男性", male_count)

    with col3:
        if 'gender' in df.columns:
            female_count = len(df[df['gender'] == '女'])
            st.metric("女性", female_count)

    with col4:
        if 'age' in df.columns:
            avg_age = df['age'].mean()
            st.metric("平均年龄", f"{avg_age:.1f}岁")

    # 年龄分布图
    if 'age' in df.columns and len(df) > 0:
        st.subheader("年龄分布")
        import matplotlib.pyplot as plt

        fig, ax = plt.subplots(figsize=(8, 4))
        ax.hist(df['age'].dropna(), bins=20, edgecolor='black', alpha=0.7)
        ax.set_xlabel('年龄')
        ax.set_ylabel('人数')
        ax.set_title('患者年龄分布')
        st.pyplot(fig)

if __name__ == "__main__":
    main()
```

### 运行效果

```bash
streamlit run patient_search.py
```

**界面展示**:
```
🔍 患者检索系统
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[快速检索]

┌─────────────────────────────────┐
│ 张                      [🔍 搜索] │
└─────────────────────────────────┘

✅ 找到 3 条记录

患者ID  | 姓名  | 年龄 | 性别 | 电话        | 诊断
─────────────────────────────────────────────────
P0001  | 张三  | 45   | 男   | 13800138000 | 高血压
P0015  | 张丽  | 38   | 女   | 13900139000 | 糖尿病
P0032  | 张伟  | 52   | 男   | 13700137000 | 冠心病

[📊 导出Excel] [📄 下载CSV]
```

## 检查清单

- [ ] 支持多种检索方式
- [ ] 模糊匹配准确
- [ ] 结果展示清晰
- [ ] 可导出数据
- [ ] 响应速度快
- [ ] 有统计分析

## 下一步

[11.5 随访管理](11.5-followup.md) - 自动提醒患者随访
