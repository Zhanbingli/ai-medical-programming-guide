# 11.6 病例统计分析

## 为什么需要病例统计?

**医院管理需求**:
```
- 月度/年度工作总结
- 疾病构成分析
- 科室绩效评估
- 科研数据准备
```

**传统方式**: 手工统计 → 2-3天
**AI辅助**: 一键生成 → 1分钟

## 常见统计需求

### 1. 基础统计

```python
# 总患者数
SELECT COUNT(*) FROM patients;

# 性别分布
SELECT gender, COUNT(*) FROM patients GROUP BY gender;

# 年龄分布
SELECT
    CASE
        WHEN age < 18 THEN '儿童'
        WHEN age < 40 THEN '青年'
        WHEN age < 60 THEN '中年'
        ELSE '老年'
    END as age_group,
    COUNT(*)
FROM patients
GROUP BY age_group;
```

### 2. 疾病统计

```python
# 疾病构成前10
SELECT diagnosis, COUNT(*) as count
FROM visits
WHERE diagnosis IS NOT NULL
GROUP BY diagnosis
ORDER BY count DESC
LIMIT 10;
```

### 3. 时间趋势

```python
# 月度就诊量
SELECT
    strftime('%Y-%m', visit_date) as month,
    COUNT(*) as visit_count
FROM visits
GROUP BY month
ORDER BY month;
```

## 用AI生成统计分析代码

**Prompt**:
```
创建病例统计分析界面,包括:
1. 患者基本统计(总数、性别、年龄分布)
2. 疾病构成(饼图、柱状图)
3. 时间趋势(折线图)
4. 生成统计报告(Word)
```

**AI生成简化版**:

```python
import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
from database import PatientDB

def show_statistics():
    st.title("📊 病例统计分析")

    db = PatientDB()

    # 基础统计
    col1, col2, col3 = st.columns(3)

    with col1:
        cursor = db.conn.cursor()
        cursor.execute("SELECT COUNT(*) FROM patients")
        total = cursor.fetchone()[0]
        st.metric("总患者数", total)

    with col2:
        cursor.execute("SELECT COUNT(*) FROM patients WHERE gender='男'")
        male = cursor.fetchone()[0]
        st.metric("男性", male)

    with col3:
        cursor.execute("SELECT COUNT(*) FROM patients WHERE gender='女'")
        female = cursor.fetchone()[0]
        st.metric("女性", female)

    # 疾病构成
    st.subheader("疾病构成TOP10")
    query = '''
        SELECT diagnosis, COUNT(*) as count
        FROM visits
        WHERE diagnosis IS NOT NULL
        GROUP BY diagnosis
        ORDER BY count DESC
        LIMIT 10
    '''
    df = pd.read_sql_query(query, db.conn)

    fig, ax = plt.subplots()
    ax.barh(df['diagnosis'], df['count'])
    ax.set_xlabel('病例数')
    st.pyplot(fig)

    db.close()
```

完整代码见本书配套GitHub仓库。

## 检查清单

- [ ] 统计数据准确
- [ ] 图表清晰美观
- [ ] 可导出报告
- [ ] 支持自定义时间范围

## 下一步

[11.7 完整系统整合](11.7-complete-system.md)
