# 11.3 病例录入功能

## 用户友好的录入界面

### 传统方式 vs 现代方式

```
传统方式:
- 命令行输入,容易出错
- 无数据验证
- 体验差

现代方式:
- Web界面,直观易用
- 自动验证
- 即时反馈
```

## 使用Streamlit构建Web界面

### 为什么选择Streamlit?

| 特性 | 优势 |
|-----|------|
| **零前端代码** | 纯Python,无需HTML/CSS/JS |
| **快速开发** | 10分钟搭建界面 |
| **自动响应** | 修改代码即刷新 |
| **丰富组件** | 表单、图表、文件上传 |

### 安装

```bash
pip install streamlit
```

## 用AI生成录入界面

### 需求描述

**向AI提问**:
```
使用Streamlit创建病例录入界面:

功能:
1. 患者基本信息表单
   - 患者ID(自动生成或手动输入)
   - 姓名、年龄、性别
   - 联系方式
2. 就诊信息表单
   - 就诊日期(日期选择器)
   - 主诉、诊断
   - 治疗方案
3. 数据验证
   - 必填项检查
   - 年龄范围验证
   - 手机号格式验证
4. 保存到数据库
5. 成功提示

请生成完整代码。
```

### AI生成代码

```python
"""
病例录入界面 (Streamlit)
"""

import streamlit as st
import sqlite3
from datetime import datetime, date
import re

from database import PatientDB

# 页面配置
st.set_page_config(
    page_title="病例录入系统",
    page_icon="🏥",
    layout="wide"
)

def validate_phone(phone):
    """验证手机号"""
    pattern = r'^1[3-9]\d{9}$'
    return re.match(pattern, phone) is not None

def validate_id_number(id_number):
    """验证身份证号"""
    if not id_number:
        return True  # 可选项
    pattern = r'^\d{17}[\dXx]$'
    return re.match(pattern, id_number) is not None

def generate_patient_id():
    """自动生成患者ID"""
    db = PatientDB()
    cursor = db.conn.cursor()

    cursor.execute("SELECT MAX(id) FROM patients")
    result = cursor.fetchone()

    db.close()

    max_id = result[0] if result[0] else 0
    return f"P{max_id + 1:04d}"  # P0001, P0002...

def main():
    st.title("🏥 病例录入系统")
    st.markdown("---")

    # 侧边栏:选择录入类型
    st.sidebar.header("录入选项")
    entry_type = st.sidebar.radio(
        "选择录入类型",
        ["新患者", "已有患者就诊"]
    )

    if entry_type == "新患者":
        add_new_patient()
    else:
        add_visit_to_existing_patient()

def add_new_patient():
    """新增患者"""
    st.header("📝 新患者登记")

    # 使用表单
    with st.form("new_patient_form"):
        col1, col2 = st.columns(2)

        with col1:
            st.subheader("基本信息")

            # 患者ID
            auto_id = st.checkbox("自动生成患者ID", value=True)
            if auto_id:
                patient_id = generate_patient_id()
                st.text_input("患者ID", value=patient_id, disabled=True, key='patient_id')
            else:
                patient_id = st.text_input("患者ID(手动输入)", key='patient_id_manual')

            # 姓名
            name = st.text_input("姓名*", placeholder="请输入患者姓名")

            # 年龄和性别
            col_age, col_gender = st.columns(2)
            with col_age:
                age = st.number_input("年龄", min_value=0, max_value=120, value=30)
            with col_gender:
                gender = st.selectbox("性别*", ["男", "女", "未知"])

            # 联系方式
            phone = st.text_input("手机号", placeholder="13800138000")
            id_number = st.text_input("身份证号", placeholder="可选")

            # 地址
            address = st.text_area("住址", placeholder="可选")

        with col2:
            st.subheader("首次就诊信息")

            # 就诊日期
            visit_date = st.date_input("就诊日期", value=date.today())

            # 主诉
            symptoms = st.text_area("主诉", placeholder="患者主要症状...")

            # 诊断
            diagnosis = st.text_area("诊断", placeholder="初步诊断...")

            # 治疗方案
            treatment = st.text_area("治疗方案", placeholder="处方、医嘱...")

            # 医生
            doctor = st.text_input("接诊医生", value="")

            # 备注
            notes = st.text_area("备注", placeholder="其他信息...")

        # 提交按钮
        submitted = st.form_submit_button("💾 保存患者信息", use_container_width=True)

        if submitted:
            # 验证
            errors = []

            if not name:
                errors.append("❌ 姓名不能为空")

            if phone and not validate_phone(phone):
                errors.append("❌ 手机号格式不正确")

            if id_number and not validate_id_number(id_number):
                errors.append("❌ 身份证号格式不正确")

            if not auto_id and not patient_id:
                errors.append("❌ 患者ID不能为空")

            # 显示错误
            if errors:
                for error in errors:
                    st.error(error)
            else:
                # 保存到数据库
                try:
                    db = PatientDB()

                    # 保存患者
                    patient_data = {
                        'patient_id': patient_id if auto_id else patient_id,
                        'name': name,
                        'age': age,
                        'gender': gender,
                        'phone': phone,
                        'id_number': id_number,
                        'address': address
                    }
                    db.add_patient(patient_data)

                    # 保存就诊记录
                    visit_data = {
                        'patient_id': patient_id if auto_id else patient_id,
                        'visit_date': visit_date,
                        'symptoms': symptoms,
                        'diagnosis': diagnosis,
                        'treatment': treatment,
                        'doctor': doctor,
                        'notes': notes
                    }
                    db.add_visit(visit_data)

                    db.close()

                    # 成功提示
                    st.success(f"✅ 患者 {name} ({patient_id if auto_id else patient_id}) 信息已保存!")
                    st.balloons()

                except sqlite3.IntegrityError as e:
                    if "UNIQUE constraint failed" in str(e):
                        st.error(f"❌ 患者ID {patient_id} 已存在,请使用其他ID")
                    else:
                        st.error(f"❌ 数据库错误: {e}")
                except Exception as e:
                    st.error(f"❌ 保存失败: {e}")

def add_visit_to_existing_patient():
    """为已有患者添加就诊记录"""
    st.header("🔍 已有患者就诊")

    # 搜索患者
    search_keyword = st.text_input("搜索患者", placeholder="输入姓名、ID或电话")

    if search_keyword:
        db = PatientDB()
        results = db.search_patient(search_keyword)

        if results:
            st.success(f"找到 {len(results)} 位患者")

            # 显示患者列表
            patient_options = {
                f"{row['name']} ({row['patient_id']}) - {row['phone'] or '无电话'}": row['patient_id']
                for row in results
            }

            selected_patient = st.selectbox("选择患者", list(patient_options.keys()))

            if selected_patient:
                patient_id = patient_options[selected_patient]

                # 显示患者历史
                with st.expander("查看历史就诊记录"):
                    history = db.get_patient_history(patient_id)
                    if history:
                        for visit in history:
                            st.markdown(f"""
                            **日期**: {visit['visit_date']}
                            **诊断**: {visit['diagnosis']}
                            **治疗**: {visit['treatment']}
                            ---
                            """)
                    else:
                        st.info("无历史记录")

                # 新就诊记录表单
                with st.form("new_visit_form"):
                    st.subheader("新就诊记录")

                    visit_date = st.date_input("就诊日期", value=date.today())
                    symptoms = st.text_area("主诉")
                    diagnosis = st.text_area("诊断")
                    treatment = st.text_area("治疗方案")
                    doctor = st.text_input("接诊医生")
                    notes = st.text_area("备注")

                    submitted = st.form_submit_button("💾 保存就诊记录")

                    if submitted:
                        visit_data = {
                            'patient_id': patient_id,
                            'visit_date': visit_date,
                            'symptoms': symptoms,
                            'diagnosis': diagnosis,
                            'treatment': treatment,
                            'doctor': doctor,
                            'notes': notes
                        }

                        db.add_visit(visit_data)
                        st.success("✅ 就诊记录已保存!")
                        st.balloons()

        else:
            st.warning("未找到匹配的患者")

        db.close()

if __name__ == "__main__":
    main()
```

### 运行界面

```bash
streamlit run patient_entry.py
```

**界面效果**:
```
浏览器自动打开: http://localhost:8501

显示:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🏥 病例录入系统
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[新患者登记]

基本信息              |  首次就诊信息
─────────────────────|─────────────────────
患者ID: P0001 ✓      |  就诊日期: 2024-01-15
姓名: 张三*           |  主诉: [文本框]
年龄: 45  性别: 男    |  诊断: [文本框]
手机号: 13800138000  |  治疗方案: [文本框]
...                  |  ...

        [💾 保存患者信息]
```

## 功能增强

### 1. 添加图片上传

```python
# 上传检查报告图片
uploaded_file = st.file_uploader("上传检查报告", type=['jpg', 'png', 'pdf'])

if uploaded_file:
    # 保存文件
    file_path = f"uploads/{patient_id}_{uploaded_file.name}"
    with open(file_path, "wb") as f:
        f.write(uploaded_file.getbuffer())

    st.success(f"✅ 文件已上传: {uploaded_file.name}")
```

### 2. 添加快捷模板

```python
# 常用诊断模板
templates = {
    "高血压": "原发性高血压(1级)",
    "糖尿病": "2型糖尿病",
    "感冒": "上呼吸道感染"
}

selected_template = st.selectbox("选择诊断模板", ["自定义"] + list(templates.keys()))

if selected_template != "自定义":
    diagnosis = st.text_area("诊断", value=templates[selected_template])
else:
    diagnosis = st.text_area("诊断")
```

### 3. 实时保存草稿

```python
# 使用session_state保存草稿
if 'draft' not in st.session_state:
    st.session_state.draft = {}

# 保存草稿
st.session_state.draft['name'] = name
st.session_state.draft['age'] = age

# 提示
if st.session_state.draft:
    st.info("💾 草稿已自动保存")
```

## 使用技巧

### Streamlit常用组件

```python
# 文本输入
name = st.text_input("标签", value="默认值", placeholder="提示文字")

# 数字输入
age = st.number_input("年龄", min_value=0, max_value=120, value=30, step=1)

# 下拉选择
gender = st.selectbox("性别", ["男", "女"])

# 多选
symptoms = st.multiselect("症状", ["发热", "咳嗽", "头痛"])

# 日期选择
visit_date = st.date_input("日期", value=date.today())

# 滑块
severity = st.slider("严重程度", 1, 10, 5)

# 文本区域
notes = st.text_area("备注", height=150)

# 复选框
agree = st.checkbox("我已阅读并同意")

# 单选按钮
option = st.radio("选择", ["选项1", "选项2"])

# 文件上传
file = st.file_uploader("上传文件", type=['pdf', 'jpg'])

# 按钮
if st.button("点击"):
    st.write("按钮被点击")

# 表单(批量提交)
with st.form("my_form"):
    name = st.text_input("姓名")
    age = st.number_input("年龄")
    submitted = st.form_submit_button("提交")
    if submitted:
        st.write(f"{name}, {age}")
```

## 检查清单

- [ ] 界面美观易用
- [ ] 数据验证完整
- [ ] 错误提示清晰
- [ ] 成功保存有反馈
- [ ] 支持快捷操作
- [ ] 响应速度快

## 下一步

[11.4 检索与查询](11.4-search-query.md) - 快速查找患者信息
