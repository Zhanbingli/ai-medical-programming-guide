# 11.3 ç—…ä¾‹å½•å…¥åŠŸèƒ½

## ç”¨æˆ·å‹å¥½çš„å½•å…¥ç•Œé¢

### ä¼ ç»Ÿæ–¹å¼ vs ç°ä»£æ–¹å¼

```
ä¼ ç»Ÿæ–¹å¼:
- å‘½ä»¤è¡Œè¾“å…¥,å®¹æ˜“å‡ºé”™
- æ— æ•°æ®éªŒè¯
- ä½“éªŒå·®

ç°ä»£æ–¹å¼:
- Webç•Œé¢,ç›´è§‚æ˜“ç”¨
- è‡ªåŠ¨éªŒè¯
- å³æ—¶åé¦ˆ
```

## ä½¿ç”¨Streamlitæ„å»ºWebç•Œé¢

### ä¸ºä»€ä¹ˆé€‰æ‹©Streamlit?

| ç‰¹æ€§ | ä¼˜åŠ¿ |
|-----|------|
| **é›¶å‰ç«¯ä»£ç ** | çº¯Python,æ— éœ€HTML/CSS/JS |
| **å¿«é€Ÿå¼€å‘** | 10åˆ†é’Ÿæ­å»ºç•Œé¢ |
| **è‡ªåŠ¨å“åº”** | ä¿®æ”¹ä»£ç å³åˆ·æ–° |
| **ä¸°å¯Œç»„ä»¶** | è¡¨å•ã€å›¾è¡¨ã€æ–‡ä»¶ä¸Šä¼  |

### å®‰è£…

```bash
pip install streamlit
```

## ç”¨AIç”Ÿæˆå½•å…¥ç•Œé¢

### éœ€æ±‚æè¿°

**å‘AIæé—®**:
```
ä½¿ç”¨Streamlitåˆ›å»ºç—…ä¾‹å½•å…¥ç•Œé¢:

åŠŸèƒ½:
1. æ‚£è€…åŸºæœ¬ä¿¡æ¯è¡¨å•
   - æ‚£è€…ID(è‡ªåŠ¨ç”Ÿæˆæˆ–æ‰‹åŠ¨è¾“å…¥)
   - å§“åã€å¹´é¾„ã€æ€§åˆ«
   - è”ç³»æ–¹å¼
2. å°±è¯Šä¿¡æ¯è¡¨å•
   - å°±è¯Šæ—¥æœŸ(æ—¥æœŸé€‰æ‹©å™¨)
   - ä¸»è¯‰ã€è¯Šæ–­
   - æ²»ç–—æ–¹æ¡ˆ
3. æ•°æ®éªŒè¯
   - å¿…å¡«é¡¹æ£€æŸ¥
   - å¹´é¾„èŒƒå›´éªŒè¯
   - æ‰‹æœºå·æ ¼å¼éªŒè¯
4. ä¿å­˜åˆ°æ•°æ®åº“
5. æˆåŠŸæç¤º

è¯·ç”Ÿæˆå®Œæ•´ä»£ç ã€‚
```

### AIç”Ÿæˆä»£ç 

```python
"""
ç—…ä¾‹å½•å…¥ç•Œé¢ (Streamlit)
"""

import streamlit as st
import sqlite3
from datetime import datetime, date
import re

from database import PatientDB

# é¡µé¢é…ç½®
st.set_page_config(
    page_title="ç—…ä¾‹å½•å…¥ç³»ç»Ÿ",
    page_icon="ğŸ¥",
    layout="wide"
)

def validate_phone(phone):
    """éªŒè¯æ‰‹æœºå·"""
    pattern = r'^1[3-9]\d{9}$'
    return re.match(pattern, phone) is not None

def validate_id_number(id_number):
    """éªŒè¯èº«ä»½è¯å·"""
    if not id_number:
        return True  # å¯é€‰é¡¹
    pattern = r'^\d{17}[\dXx]$'
    return re.match(pattern, id_number) is not None

def generate_patient_id():
    """è‡ªåŠ¨ç”Ÿæˆæ‚£è€…ID"""
    db = PatientDB()
    cursor = db.conn.cursor()

    cursor.execute("SELECT MAX(id) FROM patients")
    result = cursor.fetchone()

    db.close()

    max_id = result[0] if result[0] else 0
    return f"P{max_id + 1:04d}"  # P0001, P0002...

def main():
    st.title("ğŸ¥ ç—…ä¾‹å½•å…¥ç³»ç»Ÿ")
    st.markdown("---")

    # ä¾§è¾¹æ :é€‰æ‹©å½•å…¥ç±»å‹
    st.sidebar.header("å½•å…¥é€‰é¡¹")
    entry_type = st.sidebar.radio(
        "é€‰æ‹©å½•å…¥ç±»å‹",
        ["æ–°æ‚£è€…", "å·²æœ‰æ‚£è€…å°±è¯Š"]
    )

    if entry_type == "æ–°æ‚£è€…":
        add_new_patient()
    else:
        add_visit_to_existing_patient()

def add_new_patient():
    """æ–°å¢æ‚£è€…"""
    st.header("ğŸ“ æ–°æ‚£è€…ç™»è®°")

    # ä½¿ç”¨è¡¨å•
    with st.form("new_patient_form"):
        col1, col2 = st.columns(2)

        with col1:
            st.subheader("åŸºæœ¬ä¿¡æ¯")

            # æ‚£è€…ID
            auto_id = st.checkbox("è‡ªåŠ¨ç”Ÿæˆæ‚£è€…ID", value=True)
            if auto_id:
                patient_id = generate_patient_id()
                st.text_input("æ‚£è€…ID", value=patient_id, disabled=True, key='patient_id')
            else:
                patient_id = st.text_input("æ‚£è€…ID(æ‰‹åŠ¨è¾“å…¥)", key='patient_id_manual')

            # å§“å
            name = st.text_input("å§“å*", placeholder="è¯·è¾“å…¥æ‚£è€…å§“å")

            # å¹´é¾„å’Œæ€§åˆ«
            col_age, col_gender = st.columns(2)
            with col_age:
                age = st.number_input("å¹´é¾„", min_value=0, max_value=120, value=30)
            with col_gender:
                gender = st.selectbox("æ€§åˆ«*", ["ç”·", "å¥³", "æœªçŸ¥"])

            # è”ç³»æ–¹å¼
            phone = st.text_input("æ‰‹æœºå·", placeholder="13800138000")
            id_number = st.text_input("èº«ä»½è¯å·", placeholder="å¯é€‰")

            # åœ°å€
            address = st.text_area("ä½å€", placeholder="å¯é€‰")

        with col2:
            st.subheader("é¦–æ¬¡å°±è¯Šä¿¡æ¯")

            # å°±è¯Šæ—¥æœŸ
            visit_date = st.date_input("å°±è¯Šæ—¥æœŸ", value=date.today())

            # ä¸»è¯‰
            symptoms = st.text_area("ä¸»è¯‰", placeholder="æ‚£è€…ä¸»è¦ç—‡çŠ¶...")

            # è¯Šæ–­
            diagnosis = st.text_area("è¯Šæ–­", placeholder="åˆæ­¥è¯Šæ–­...")

            # æ²»ç–—æ–¹æ¡ˆ
            treatment = st.text_area("æ²»ç–—æ–¹æ¡ˆ", placeholder="å¤„æ–¹ã€åŒ»å˜±...")

            # åŒ»ç”Ÿ
            doctor = st.text_input("æ¥è¯ŠåŒ»ç”Ÿ", value="")

            # å¤‡æ³¨
            notes = st.text_area("å¤‡æ³¨", placeholder="å…¶ä»–ä¿¡æ¯...")

        # æäº¤æŒ‰é’®
        submitted = st.form_submit_button("ğŸ’¾ ä¿å­˜æ‚£è€…ä¿¡æ¯", use_container_width=True)

        if submitted:
            # éªŒè¯
            errors = []

            if not name:
                errors.append("âŒ å§“åä¸èƒ½ä¸ºç©º")

            if phone and not validate_phone(phone):
                errors.append("âŒ æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®")

            if id_number and not validate_id_number(id_number):
                errors.append("âŒ èº«ä»½è¯å·æ ¼å¼ä¸æ­£ç¡®")

            if not auto_id and not patient_id:
                errors.append("âŒ æ‚£è€…IDä¸èƒ½ä¸ºç©º")

            # æ˜¾ç¤ºé”™è¯¯
            if errors:
                for error in errors:
                    st.error(error)
            else:
                # ä¿å­˜åˆ°æ•°æ®åº“
                try:
                    db = PatientDB()

                    # ä¿å­˜æ‚£è€…
                    patient_data = {
                        'patient_id': patient_id if auto_id else patient_id,
                        'name': name,
                        'age': age,
                        'gender': gender,
                        'phone': phone,
                        'id_number': id_number,
                        'address': address
                    }
                    db.add_patient(patient_data)

                    # ä¿å­˜å°±è¯Šè®°å½•
                    visit_data = {
                        'patient_id': patient_id if auto_id else patient_id,
                        'visit_date': visit_date,
                        'symptoms': symptoms,
                        'diagnosis': diagnosis,
                        'treatment': treatment,
                        'doctor': doctor,
                        'notes': notes
                    }
                    db.add_visit(visit_data)

                    db.close()

                    # æˆåŠŸæç¤º
                    st.success(f"âœ… æ‚£è€… {name} ({patient_id if auto_id else patient_id}) ä¿¡æ¯å·²ä¿å­˜!")
                    st.balloons()

                except sqlite3.IntegrityError as e:
                    if "UNIQUE constraint failed" in str(e):
                        st.error(f"âŒ æ‚£è€…ID {patient_id} å·²å­˜åœ¨,è¯·ä½¿ç”¨å…¶ä»–ID")
                    else:
                        st.error(f"âŒ æ•°æ®åº“é”™è¯¯: {e}")
                except Exception as e:
                    st.error(f"âŒ ä¿å­˜å¤±è´¥: {e}")

def add_visit_to_existing_patient():
    """ä¸ºå·²æœ‰æ‚£è€…æ·»åŠ å°±è¯Šè®°å½•"""
    st.header("ğŸ” å·²æœ‰æ‚£è€…å°±è¯Š")

    # æœç´¢æ‚£è€…
    search_keyword = st.text_input("æœç´¢æ‚£è€…", placeholder="è¾“å…¥å§“åã€IDæˆ–ç”µè¯")

    if search_keyword:
        db = PatientDB()
        results = db.search_patient(search_keyword)

        if results:
            st.success(f"æ‰¾åˆ° {len(results)} ä½æ‚£è€…")

            # æ˜¾ç¤ºæ‚£è€…åˆ—è¡¨
            patient_options = {
                f"{row['name']} ({row['patient_id']}) - {row['phone'] or 'æ— ç”µè¯'}": row['patient_id']
                for row in results
            }

            selected_patient = st.selectbox("é€‰æ‹©æ‚£è€…", list(patient_options.keys()))

            if selected_patient:
                patient_id = patient_options[selected_patient]

                # æ˜¾ç¤ºæ‚£è€…å†å²
                with st.expander("æŸ¥çœ‹å†å²å°±è¯Šè®°å½•"):
                    history = db.get_patient_history(patient_id)
                    if history:
                        for visit in history:
                            st.markdown(f"""
                            **æ—¥æœŸ**: {visit['visit_date']}
                            **è¯Šæ–­**: {visit['diagnosis']}
                            **æ²»ç–—**: {visit['treatment']}
                            ---
                            """)
                    else:
                        st.info("æ— å†å²è®°å½•")

                # æ–°å°±è¯Šè®°å½•è¡¨å•
                with st.form("new_visit_form"):
                    st.subheader("æ–°å°±è¯Šè®°å½•")

                    visit_date = st.date_input("å°±è¯Šæ—¥æœŸ", value=date.today())
                    symptoms = st.text_area("ä¸»è¯‰")
                    diagnosis = st.text_area("è¯Šæ–­")
                    treatment = st.text_area("æ²»ç–—æ–¹æ¡ˆ")
                    doctor = st.text_input("æ¥è¯ŠåŒ»ç”Ÿ")
                    notes = st.text_area("å¤‡æ³¨")

                    submitted = st.form_submit_button("ğŸ’¾ ä¿å­˜å°±è¯Šè®°å½•")

                    if submitted:
                        visit_data = {
                            'patient_id': patient_id,
                            'visit_date': visit_date,
                            'symptoms': symptoms,
                            'diagnosis': diagnosis,
                            'treatment': treatment,
                            'doctor': doctor,
                            'notes': notes
                        }

                        db.add_visit(visit_data)
                        st.success("âœ… å°±è¯Šè®°å½•å·²ä¿å­˜!")
                        st.balloons()

        else:
            st.warning("æœªæ‰¾åˆ°åŒ¹é…çš„æ‚£è€…")

        db.close()

if __name__ == "__main__":
    main()
```

### è¿è¡Œç•Œé¢

```bash
streamlit run patient_entry.py
```

**ç•Œé¢æ•ˆæœ**:
```
æµè§ˆå™¨è‡ªåŠ¨æ‰“å¼€: http://localhost:8501

æ˜¾ç¤º:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¥ ç—…ä¾‹å½•å…¥ç³»ç»Ÿ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

[æ–°æ‚£è€…ç™»è®°]

åŸºæœ¬ä¿¡æ¯              |  é¦–æ¬¡å°±è¯Šä¿¡æ¯
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€|â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ‚£è€…ID: P0001 âœ“      |  å°±è¯Šæ—¥æœŸ: 2024-01-15
å§“å: å¼ ä¸‰*           |  ä¸»è¯‰: [æ–‡æœ¬æ¡†]
å¹´é¾„: 45  æ€§åˆ«: ç”·    |  è¯Šæ–­: [æ–‡æœ¬æ¡†]
æ‰‹æœºå·: 13800138000  |  æ²»ç–—æ–¹æ¡ˆ: [æ–‡æœ¬æ¡†]
...                  |  ...

        [ğŸ’¾ ä¿å­˜æ‚£è€…ä¿¡æ¯]
```

## åŠŸèƒ½å¢å¼º

### 1. æ·»åŠ å›¾ç‰‡ä¸Šä¼ 

```python
# ä¸Šä¼ æ£€æŸ¥æŠ¥å‘Šå›¾ç‰‡
uploaded_file = st.file_uploader("ä¸Šä¼ æ£€æŸ¥æŠ¥å‘Š", type=['jpg', 'png', 'pdf'])

if uploaded_file:
    # ä¿å­˜æ–‡ä»¶
    file_path = f"uploads/{patient_id}_{uploaded_file.name}"
    with open(file_path, "wb") as f:
        f.write(uploaded_file.getbuffer())

    st.success(f"âœ… æ–‡ä»¶å·²ä¸Šä¼ : {uploaded_file.name}")
```

### 2. æ·»åŠ å¿«æ·æ¨¡æ¿

```python
# å¸¸ç”¨è¯Šæ–­æ¨¡æ¿
templates = {
    "é«˜è¡€å‹": "åŸå‘æ€§é«˜è¡€å‹(1çº§)",
    "ç³–å°¿ç—…": "2å‹ç³–å°¿ç—…",
    "æ„Ÿå†’": "ä¸Šå‘¼å¸é“æ„ŸæŸ“"
}

selected_template = st.selectbox("é€‰æ‹©è¯Šæ–­æ¨¡æ¿", ["è‡ªå®šä¹‰"] + list(templates.keys()))

if selected_template != "è‡ªå®šä¹‰":
    diagnosis = st.text_area("è¯Šæ–­", value=templates[selected_template])
else:
    diagnosis = st.text_area("è¯Šæ–­")
```

### 3. å®æ—¶ä¿å­˜è‰ç¨¿

```python
# ä½¿ç”¨session_stateä¿å­˜è‰ç¨¿
if 'draft' not in st.session_state:
    st.session_state.draft = {}

# ä¿å­˜è‰ç¨¿
st.session_state.draft['name'] = name
st.session_state.draft['age'] = age

# æç¤º
if st.session_state.draft:
    st.info("ğŸ’¾ è‰ç¨¿å·²è‡ªåŠ¨ä¿å­˜")
```

## ä½¿ç”¨æŠ€å·§

### Streamlitå¸¸ç”¨ç»„ä»¶

```python
# æ–‡æœ¬è¾“å…¥
name = st.text_input("æ ‡ç­¾", value="é»˜è®¤å€¼", placeholder="æç¤ºæ–‡å­—")

# æ•°å­—è¾“å…¥
age = st.number_input("å¹´é¾„", min_value=0, max_value=120, value=30, step=1)

# ä¸‹æ‹‰é€‰æ‹©
gender = st.selectbox("æ€§åˆ«", ["ç”·", "å¥³"])

# å¤šé€‰
symptoms = st.multiselect("ç—‡çŠ¶", ["å‘çƒ­", "å’³å—½", "å¤´ç—›"])

# æ—¥æœŸé€‰æ‹©
visit_date = st.date_input("æ—¥æœŸ", value=date.today())

# æ»‘å—
severity = st.slider("ä¸¥é‡ç¨‹åº¦", 1, 10, 5)

# æ–‡æœ¬åŒºåŸŸ
notes = st.text_area("å¤‡æ³¨", height=150)

# å¤é€‰æ¡†
agree = st.checkbox("æˆ‘å·²é˜…è¯»å¹¶åŒæ„")

# å•é€‰æŒ‰é’®
option = st.radio("é€‰æ‹©", ["é€‰é¡¹1", "é€‰é¡¹2"])

# æ–‡ä»¶ä¸Šä¼ 
file = st.file_uploader("ä¸Šä¼ æ–‡ä»¶", type=['pdf', 'jpg'])

# æŒ‰é’®
if st.button("ç‚¹å‡»"):
    st.write("æŒ‰é’®è¢«ç‚¹å‡»")

# è¡¨å•(æ‰¹é‡æäº¤)
with st.form("my_form"):
    name = st.text_input("å§“å")
    age = st.number_input("å¹´é¾„")
    submitted = st.form_submit_button("æäº¤")
    if submitted:
        st.write(f"{name}, {age}")
```

## æ£€æŸ¥æ¸…å•

- [ ] ç•Œé¢ç¾è§‚æ˜“ç”¨
- [ ] æ•°æ®éªŒè¯å®Œæ•´
- [ ] é”™è¯¯æç¤ºæ¸…æ™°
- [ ] æˆåŠŸä¿å­˜æœ‰åé¦ˆ
- [ ] æ”¯æŒå¿«æ·æ“ä½œ
- [ ] å“åº”é€Ÿåº¦å¿«

## ä¸‹ä¸€æ­¥

[11.4 æ£€ç´¢ä¸æŸ¥è¯¢](11.4-search-query.md) - å¿«é€ŸæŸ¥æ‰¾æ‚£è€…ä¿¡æ¯
