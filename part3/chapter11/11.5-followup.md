# 11.5 éšè®¿ç®¡ç†

## éšè®¿ç®¡ç†çš„é‡è¦æ€§

**ä¸´åºŠç°å®**:
```
é—®é¢˜:
- æ‚£è€…å¿˜è®°å¤è¯Šæ—¶é—´
- åŒ»ç”Ÿè®°ä¸ä½å“ªäº›æ‚£è€…éœ€è¦éšè®¿
- æ‰‹å·¥è®°å½•,å®¹æ˜“é—æ¼

åæœ:
âŒ ç—…æƒ…å»¶è¯¯
âŒ æ²»ç–—æ•ˆæœå·®
âŒ æ‚£è€…æµå¤±
âŒ åŒ»æ‚£çº çº·
```

**è‡ªåŠ¨åŒ–è§£å†³æ–¹æ¡ˆ**:
```python
ç³»ç»Ÿè‡ªåŠ¨:
âœ… è®¡ç®—éšè®¿æ—¥æœŸ
âœ… æå‰æé†’
âœ… æ ‡è®°å®ŒæˆçŠ¶æ€
âœ… ç”Ÿæˆéšè®¿æŠ¥å‘Š
```

## éšè®¿ç®¡ç†åŠŸèƒ½è®¾è®¡

### 1. è‡ªåŠ¨æ·»åŠ éšè®¿è®¡åˆ’

```python
# æ‚£è€…å‡ºé™¢æ—¶,è‡ªåŠ¨åˆ›å»ºéšè®¿è®¡åˆ’
def create_followup(patient_id, days_after=30):
    """
    åˆ›å»ºéšè®¿è®¡åˆ’

    Args:
        patient_id: æ‚£è€…ID
        days_after: å¤šå°‘å¤©åéšè®¿
    """
    from datetime import date, timedelta

    followup_date = date.today() + timedelta(days=days_after)

    db = PatientDB()
    cursor = db.conn.cursor()

    cursor.execute('''
        INSERT INTO followups (patient_id, followup_date, status)
        VALUES (?, ?, 'å¾…éšè®¿')
    ''', (patient_id, followup_date))

    db.conn.commit()
    db.close()
```

### 2. æŸ¥è¯¢å¾…éšè®¿æ‚£è€…

```python
def get_pending_followups(days_ahead=7):
    """
    è·å–è¿‘æœŸéœ€è¦éšè®¿çš„æ‚£è€…

    Args:
        days_ahead: æå‰å¤šå°‘å¤©æé†’

    Returns:
        å¾…éšè®¿æ‚£è€…åˆ—è¡¨
    """
    from datetime import date, timedelta

    target_date = date.today() + timedelta(days=days_ahead)

    db = PatientDB()
    cursor = db.conn.cursor()

    cursor.execute('''
        SELECT f.*, p.name, p.phone, v.diagnosis
        FROM followups f
        JOIN patients p ON f.patient_id = p.patient_id
        LEFT JOIN (
            SELECT patient_id, diagnosis
            FROM visits
            ORDER BY visit_date DESC
        ) v ON f.patient_id = v.patient_id
        WHERE f.status = 'å¾…éšè®¿'
          AND f.followup_date <= ?
        ORDER BY f.followup_date
    ''', (target_date,))

    results = cursor.fetchall()
    db.close()

    return results
```

## ç”¨AIç”Ÿæˆéšè®¿ç®¡ç†ç•Œé¢

### éœ€æ±‚æè¿°

**å‘AIæé—®**:
```
åˆ›å»ºStreamlitéšè®¿ç®¡ç†ç•Œé¢:

åŠŸèƒ½:
1. å¾…éšè®¿æ‚£è€…åˆ—è¡¨
   - æ˜¾ç¤ºå§“åã€ç”µè¯ã€éšè®¿æ—¥æœŸ
   - æŒ‰ç´§æ€¥ç¨‹åº¦æ’åº(é€¾æœŸæ ‡çº¢)
2. æ·»åŠ éšè®¿è®¡åˆ’
   - é€‰æ‹©æ‚£è€…
   - è®¾ç½®éšè®¿æ—¥æœŸ
   - å¡«å†™éšè®¿äº‹é¡¹
3. æ ‡è®°éšè®¿å®Œæˆ
   - è®°å½•éšè®¿å†…å®¹
   - æ›´æ–°çŠ¶æ€
4. éšè®¿ç»Ÿè®¡
   - æœ¬æœˆéšè®¿äººæ•°
   - é€¾æœŸæœªéšè®¿äººæ•°
   - å®Œæˆç‡
5. å‘é€æé†’
   - ç”ŸæˆçŸ­ä¿¡æ¨¡æ¿
   - (å¯é€‰)è‡ªåŠ¨å‘é€

è¯·ç”Ÿæˆå®Œæ•´ä»£ç ã€‚
```

### AIç”Ÿæˆä»£ç 

```python
"""
éšè®¿ç®¡ç†ç³»ç»Ÿ
"""

import streamlit as st
import pandas as pd
from datetime import date, datetime, timedelta
from database import PatientDB

def main():
    st.title("ğŸ“… éšè®¿ç®¡ç†ç³»ç»Ÿ")
    st.markdown("---")

    # é€‰é¡¹å¡
    tab1, tab2, tab3, tab4 = st.tabs([
        "ğŸ“‹ å¾…éšè®¿åˆ—è¡¨",
        "â• æ·»åŠ éšè®¿",
        "âœ… æ ‡è®°å®Œæˆ",
        "ğŸ“Š éšè®¿ç»Ÿè®¡"
    ])

    with tab1:
        show_pending_followups()

    with tab2:
        add_followup_plan()

    with tab3:
        mark_followup_completed()

    with tab4:
        show_followup_statistics()

def show_pending_followups():
    """æ˜¾ç¤ºå¾…éšè®¿æ‚£è€…åˆ—è¡¨"""
    st.header("å¾…éšè®¿æ‚£è€…åˆ—è¡¨")

    # ç­›é€‰é€‰é¡¹
    col1, col2 = st.columns(2)

    with col1:
        days_ahead = st.slider("æå‰æé†’å¤©æ•°", 1, 30, 7)

    with col2:
        show_overdue = st.checkbox("åªæ˜¾ç¤ºé€¾æœŸ", value=False)

    # è·å–æ•°æ®
    db = PatientDB()
    cursor = db.conn.cursor()

    target_date = date.today() + timedelta(days=days_ahead)

    query = '''
        SELECT f.id as followup_id, f.patient_id, f.followup_date, f.notes,
               p.name, p.phone, p.age, p.gender
        FROM followups f
        JOIN patients p ON f.patient_id = p.patient_id
        WHERE f.status = 'å¾…éšè®¿'
    '''

    if show_overdue:
        query += " AND f.followup_date < date('now')"
    else:
        query += f" AND f.followup_date <= '{target_date}'"

    query += " ORDER BY f.followup_date"

    cursor.execute(query)
    results = cursor.fetchall()
    db.close()

    if results:
        st.success(f"âœ… æ‰¾åˆ° {len(results)} ä½éœ€è¦éšè®¿çš„æ‚£è€…")

        # è½¬æ¢ä¸ºDataFrame
        df = pd.DataFrame([dict(row) for row in results])

        # è®¡ç®—å¤©æ•°å·®
        today = pd.to_datetime(date.today())
        df['followup_date'] = pd.to_datetime(df['followup_date'])
        df['days_diff'] = (df['followup_date'] - today).dt.days

        # çŠ¶æ€æ ‡è®°
        def get_status(days):
            if days < 0:
                return f"âš ï¸ é€¾æœŸ{abs(days)}å¤©"
            elif days == 0:
                return "ğŸ”´ ä»Šå¤©"
            elif days <= 3:
                return f"ğŸŸ¡ {days}å¤©å"
            else:
                return f"ğŸŸ¢ {days}å¤©å"

        df['status'] = df['days_diff'].apply(get_status)

        # æ˜¾ç¤ºè¡¨æ ¼
        display_df = df[[
            'name', 'phone', 'age', 'gender',
            'followup_date', 'status', 'notes'
        ]].rename(columns={
            'name': 'å§“å',
            'phone': 'ç”µè¯',
            'age': 'å¹´é¾„',
            'gender': 'æ€§åˆ«',
            'followup_date': 'éšè®¿æ—¥æœŸ',
            'status': 'çŠ¶æ€',
            'notes': 'éšè®¿äº‹é¡¹'
        })

        # æ ¹æ®çŠ¶æ€ç€è‰²
        def highlight_overdue(row):
            if 'é€¾æœŸ' in row['çŠ¶æ€']:
                return ['background-color: #ffcccc'] * len(row)
            elif 'ä»Šå¤©' in row['çŠ¶æ€']:
                return ['background-color: #ffffcc'] * len(row)
            else:
                return [''] * len(row)

        styled_df = display_df.style.apply(highlight_overdue, axis=1)

        st.dataframe(styled_df, use_container_width=True, hide_index=True)

        # æ‰¹é‡æ“ä½œ
        st.markdown("---")
        col1, col2, col3 = st.columns(3)

        with col1:
            if st.button("ğŸ“± ç”Ÿæˆæé†’çŸ­ä¿¡"):
                generate_sms_template(df)

        with col2:
            if st.button("ğŸ“Š å¯¼å‡ºåˆ—è¡¨"):
                export_followup_list(display_df)

        with col3:
            if st.button("ğŸ”„ åˆ·æ–°"):
                st.rerun()

    else:
        st.info("âœ… æš‚æ— å¾…éšè®¿æ‚£è€…")

def generate_sms_template(df):
    """ç”ŸæˆçŸ­ä¿¡æ¨¡æ¿"""
    st.subheader("ğŸ“± çŸ­ä¿¡æ¨¡æ¿")

    for _, row in df.iterrows():
        followup_date_str = row['followup_date'].strftime('%Yå¹´%mæœˆ%dæ—¥')

        sms = f"""
ã€XXåŒ»é™¢ã€‘å°Šæ•¬çš„{row['name']}æ‚£è€…,æ‚¨å¥½!
æ‚¨çš„éšè®¿æ—¥æœŸä¸º{followup_date_str},è¯·æŒ‰æ—¶æ¥é™¢å¤è¯Šã€‚
å¦‚æœ‰ç–‘é—®,è¯·è”ç³»:{row['phone']}
        """.strip()

        st.text_area(
            f"{row['name']}çš„çŸ­ä¿¡",
            value=sms,
            height=100
        )

def export_followup_list(df):
    """å¯¼å‡ºéšè®¿åˆ—è¡¨"""
    output_file = f"followup_list_{datetime.now().strftime('%Y%m%d')}.xlsx"
    df.to_excel(output_file, index=False, engine='openpyxl')
    st.success(f"âœ… å·²å¯¼å‡º: {output_file}")

def add_followup_plan():
    """æ·»åŠ éšè®¿è®¡åˆ’"""
    st.header("æ·»åŠ éšè®¿è®¡åˆ’")

    with st.form("add_followup_form"):
        # æœç´¢æ‚£è€…
        search_keyword = st.text_input("æœç´¢æ‚£è€…", placeholder="å§“åæˆ–ID")

        if search_keyword:
            db = PatientDB()
            patients = db.search_patient(search_keyword)

            if patients:
                patient_options = {
                    f"{row['name']} ({row['patient_id']}) - {row['phone']}": row['patient_id']
                    for row in patients
                }

                selected_patient = st.selectbox("é€‰æ‹©æ‚£è€…", list(patient_options.keys()))
                patient_id = patient_options[selected_patient]
            else:
                st.warning("æœªæ‰¾åˆ°æ‚£è€…")
                patient_id = None

            db.close()
        else:
            patient_id = None

        # éšè®¿æ—¥æœŸ
        col1, col2 = st.columns(2)

        with col1:
            method = st.radio("è®¾ç½®æ–¹å¼", ["æŒ‡å®šæ—¥æœŸ", "å¤©æ•°å"])

        with col2:
            if method == "æŒ‡å®šæ—¥æœŸ":
                followup_date = st.date_input("éšè®¿æ—¥æœŸ", value=date.today() + timedelta(days=30))
            else:
                days_after = st.number_input("å¤šå°‘å¤©å", 1, 365, 30)
                followup_date = date.today() + timedelta(days=days_after)
                st.info(f"éšè®¿æ—¥æœŸ: {followup_date}")

        # éšè®¿äº‹é¡¹
        notes = st.text_area("éšè®¿äº‹é¡¹", placeholder="ä¾‹: å¤æŸ¥è¡€å‹ã€è°ƒæ•´è¯ç‰©å‰‚é‡")

        # æäº¤
        submitted = st.form_submit_button("ğŸ’¾ ä¿å­˜éšè®¿è®¡åˆ’")

        if submitted:
            if not patient_id:
                st.error("âŒ è¯·é€‰æ‹©æ‚£è€…")
            else:
                db = PatientDB()
                cursor = db.conn.cursor()

                cursor.execute('''
                    INSERT INTO followups (patient_id, followup_date, status, notes)
                    VALUES (?, ?, 'å¾…éšè®¿', ?)
                ''', (patient_id, followup_date, notes))

                db.conn.commit()
                db.close()

                st.success(f"âœ… å·²ä¸ºæ‚£è€… {patient_id} æ·»åŠ éšè®¿è®¡åˆ’")
                st.balloons()

def mark_followup_completed():
    """æ ‡è®°éšè®¿å®Œæˆ"""
    st.header("æ ‡è®°éšè®¿å®Œæˆ")

    # è·å–å¾…éšè®¿åˆ—è¡¨
    db = PatientDB()
    cursor = db.conn.cursor()

    cursor.execute('''
        SELECT f.id, f.patient_id, f.followup_date, f.notes,
               p.name, p.phone
        FROM followups f
        JOIN patients p ON f.patient_id = p.patient_id
        WHERE f.status = 'å¾…éšè®¿'
        ORDER BY f.followup_date
    ''')

    followups = cursor.fetchall()
    db.close()

    if followups:
        # é€‰æ‹©éšè®¿è®°å½•
        followup_options = {
            f"{row['name']} ({row['patient_id']}) - {row['followup_date']}": row['id']
            for row in followups
        }

        selected = st.selectbox("é€‰æ‹©éšè®¿è®°å½•", list(followup_options.keys()))
        followup_id = followup_options[selected]

        # éšè®¿å†…å®¹è¡¨å•
        with st.form("complete_followup_form"):
            st.subheader("è®°å½•éšè®¿å†…å®¹")

            # æœ¬æ¬¡éšè®¿æƒ…å†µ
            followup_content = st.text_area(
                "éšè®¿å†…å®¹",
                placeholder="æ‚£è€…ç—‡çŠ¶ã€æ£€æŸ¥ç»“æœã€æ²»ç–—è°ƒæ•´ç­‰"
            )

            # ä¸‹æ¬¡éšè®¿
            need_next = st.checkbox("éœ€è¦ä¸‹æ¬¡éšè®¿")

            if need_next:
                next_followup_date = st.date_input(
                    "ä¸‹æ¬¡éšè®¿æ—¥æœŸ",
                    value=date.today() + timedelta(days=30)
                )
                next_notes = st.text_input("ä¸‹æ¬¡éšè®¿äº‹é¡¹")

            # æäº¤
            submitted = st.form_submit_button("âœ… æ ‡è®°å®Œæˆ")

            if submitted:
                db = PatientDB()
                cursor = db.conn.cursor()

                # æ›´æ–°å½“å‰éšè®¿çŠ¶æ€
                cursor.execute('''
                    UPDATE followups
                    SET status = 'å·²å®Œæˆ',
                        completed_at = ?,
                        notes = notes || ? || ?
                    WHERE id = ?
                ''', (
                    datetime.now(),
                    '\n\néšè®¿è®°å½•:\n',
                    followup_content,
                    followup_id
                ))

                # å¦‚æœéœ€è¦ä¸‹æ¬¡éšè®¿,åˆ›å»ºæ–°è®°å½•
                if need_next:
                    # è·å–patient_id
                    selected_followup = [f for f in followups if f['id'] == followup_id][0]

                    cursor.execute('''
                        INSERT INTO followups (patient_id, followup_date, status, notes)
                        VALUES (?, ?, 'å¾…éšè®¿', ?)
                    ''', (
                        selected_followup['patient_id'],
                        next_followup_date,
                        next_notes
                    ))

                db.conn.commit()
                db.close()

                st.success("âœ… éšè®¿å·²æ ‡è®°å®Œæˆ")
                if need_next:
                    st.info(f"ğŸ“… å·²åˆ›å»ºä¸‹æ¬¡éšè®¿è®¡åˆ’: {next_followup_date}")

                st.balloons()

    else:
        st.info("æš‚æ— å¾…éšè®¿è®°å½•")

def show_followup_statistics():
    """éšè®¿ç»Ÿè®¡"""
    st.header("éšè®¿ç»Ÿè®¡")

    db = PatientDB()
    cursor = db.conn.cursor()

    # æœ¬æœˆç»Ÿè®¡
    col1, col2, col3, col4 = st.columns(4)

    with col1:
        cursor.execute('''
            SELECT COUNT(*) FROM followups
            WHERE strftime('%Y-%m', followup_date) = strftime('%Y-%m', 'now')
              AND status = 'å¾…éšè®¿'
        ''')
        month_pending = cursor.fetchone()[0]
        st.metric("æœ¬æœˆå¾…éšè®¿", month_pending)

    with col2:
        cursor.execute('''
            SELECT COUNT(*) FROM followups
            WHERE status = 'å·²å®Œæˆ'
              AND strftime('%Y-%m', completed_at) = strftime('%Y-%m', 'now')
        ''')
        month_completed = cursor.fetchone()[0]
        st.metric("æœ¬æœˆå·²å®Œæˆ", month_completed)

    with col3:
        cursor.execute('''
            SELECT COUNT(*) FROM followups
            WHERE status = 'å¾…éšè®¿'
              AND followup_date < date('now')
        ''')
        overdue = cursor.fetchone()[0]
        st.metric("é€¾æœŸæœªéšè®¿", overdue, delta=f"-{overdue}" if overdue > 0 else None)

    with col4:
        if month_pending + month_completed > 0:
            completion_rate = month_completed / (month_pending + month_completed) * 100
            st.metric("æœ¬æœˆå®Œæˆç‡", f"{completion_rate:.1f}%")
        else:
            st.metric("æœ¬æœˆå®Œæˆç‡", "N/A")

    db.close()

if __name__ == "__main__":
    main()
```

## è¿›é˜¶åŠŸèƒ½

### 1. è‡ªåŠ¨å‘é€çŸ­ä¿¡æé†’

```python
# ä½¿ç”¨ç¬¬ä¸‰æ–¹çŸ­ä¿¡API
import requests

def send_sms_reminder(phone, name, followup_date):
    """å‘é€çŸ­ä¿¡æé†’"""
    message = f"ã€XXåŒ»é™¢ã€‘{name}æ‚£è€…,æ‚¨çš„éšè®¿æ—¥æœŸä¸º{followup_date},è¯·æŒ‰æ—¶æ¥é™¢å¤è¯Šã€‚"

    # è°ƒç”¨çŸ­ä¿¡API(ç¤ºä¾‹)
    response = requests.post(
        "https://sms-api.example.com/send",
        json={
            "phone": phone,
            "message": message
        }
    )

    return response.status_code == 200
```

### 2. é‚®ä»¶æé†’

```python
import smtplib
from email.mime.text import MIMEText

def send_email_reminder(email, name, followup_date):
    """å‘é€é‚®ä»¶æé†’"""
    msg = MIMEText(f"""
    å°Šæ•¬çš„{name}æ‚£è€…:

    æ‚¨çš„éšè®¿æ—¥æœŸä¸º{followup_date},è¯·æŒ‰æ—¶æ¥é™¢å¤è¯Šã€‚

    å¦‚æœ‰ç–‘é—®,è¯·è”ç³»æˆ‘ä»¬ã€‚

    XXåŒ»é™¢
    """)

    msg['Subject'] = 'éšè®¿æé†’'
    msg['From'] = 'hospital@example.com'
    msg['To'] = email

    # å‘é€é‚®ä»¶
    with smtplib.SMTP('smtp.example.com') as server:
        server.send_message(msg)
```

## æ£€æŸ¥æ¸…å•

- [ ] å¾…éšè®¿åˆ—è¡¨æ¸…æ™°
- [ ] é€¾æœŸæ‚£è€…çªå‡ºæ˜¾ç¤º
- [ ] å¯æ ‡è®°å®ŒæˆçŠ¶æ€
- [ ] æ”¯æŒå¾ªç¯éšè®¿
- [ ] æœ‰ç»Ÿè®¡æ•°æ®
- [ ] å¯å¯¼å‡ºåˆ—è¡¨

## ä¸‹ä¸€æ­¥

[11.6 ç»Ÿè®¡åˆ†æ](11.6-statistics.md) - ç—…ä¾‹æ•°æ®ç»Ÿè®¡åˆ†æ

[11.7 å®Œæ•´ç³»ç»Ÿ](11.7-complete-system.md) - æ•´åˆæ‰€æœ‰åŠŸèƒ½
