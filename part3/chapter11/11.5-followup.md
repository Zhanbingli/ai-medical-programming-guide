# 11.5 随访管理

## 随访管理的重要性

**临床现实**:
```
问题:
- 患者忘记复诊时间
- 医生记不住哪些患者需要随访
- 手工记录,容易遗漏

后果:
❌ 病情延误
❌ 治疗效果差
❌ 患者流失
❌ 医患纠纷
```

**自动化解决方案**:
```python
系统自动:
✅ 计算随访日期
✅ 提前提醒
✅ 标记完成状态
✅ 生成随访报告
```

## 随访管理功能设计

### 1. 自动添加随访计划

```python
# 患者出院时,自动创建随访计划
def create_followup(patient_id, days_after=30):
    """
    创建随访计划

    Args:
        patient_id: 患者ID
        days_after: 多少天后随访
    """
    from datetime import date, timedelta

    followup_date = date.today() + timedelta(days=days_after)

    db = PatientDB()
    cursor = db.conn.cursor()

    cursor.execute('''
        INSERT INTO followups (patient_id, followup_date, status)
        VALUES (?, ?, '待随访')
    ''', (patient_id, followup_date))

    db.conn.commit()
    db.close()
```

### 2. 查询待随访患者

```python
def get_pending_followups(days_ahead=7):
    """
    获取近期需要随访的患者

    Args:
        days_ahead: 提前多少天提醒

    Returns:
        待随访患者列表
    """
    from datetime import date, timedelta

    target_date = date.today() + timedelta(days=days_ahead)

    db = PatientDB()
    cursor = db.conn.cursor()

    cursor.execute('''
        SELECT f.*, p.name, p.phone, v.diagnosis
        FROM followups f
        JOIN patients p ON f.patient_id = p.patient_id
        LEFT JOIN (
            SELECT patient_id, diagnosis
            FROM visits
            ORDER BY visit_date DESC
        ) v ON f.patient_id = v.patient_id
        WHERE f.status = '待随访'
          AND f.followup_date <= ?
        ORDER BY f.followup_date
    ''', (target_date,))

    results = cursor.fetchall()
    db.close()

    return results
```

## 用AI生成随访管理界面

### 需求描述

**向AI提问**:
```
创建Streamlit随访管理界面:

功能:
1. 待随访患者列表
   - 显示姓名、电话、随访日期
   - 按紧急程度排序(逾期标红)
2. 添加随访计划
   - 选择患者
   - 设置随访日期
   - 填写随访事项
3. 标记随访完成
   - 记录随访内容
   - 更新状态
4. 随访统计
   - 本月随访人数
   - 逾期未随访人数
   - 完成率
5. 发送提醒
   - 生成短信模板
   - (可选)自动发送

请生成完整代码。
```

### AI生成代码

```python
"""
随访管理系统
"""

import streamlit as st
import pandas as pd
from datetime import date, datetime, timedelta
from database import PatientDB

def main():
    st.title("📅 随访管理系统")
    st.markdown("---")

    # 选项卡
    tab1, tab2, tab3, tab4 = st.tabs([
        "📋 待随访列表",
        "➕ 添加随访",
        "✅ 标记完成",
        "📊 随访统计"
    ])

    with tab1:
        show_pending_followups()

    with tab2:
        add_followup_plan()

    with tab3:
        mark_followup_completed()

    with tab4:
        show_followup_statistics()

def show_pending_followups():
    """显示待随访患者列表"""
    st.header("待随访患者列表")

    # 筛选选项
    col1, col2 = st.columns(2)

    with col1:
        days_ahead = st.slider("提前提醒天数", 1, 30, 7)

    with col2:
        show_overdue = st.checkbox("只显示逾期", value=False)

    # 获取数据
    db = PatientDB()
    cursor = db.conn.cursor()

    target_date = date.today() + timedelta(days=days_ahead)

    query = '''
        SELECT f.id as followup_id, f.patient_id, f.followup_date, f.notes,
               p.name, p.phone, p.age, p.gender
        FROM followups f
        JOIN patients p ON f.patient_id = p.patient_id
        WHERE f.status = '待随访'
    '''

    if show_overdue:
        query += " AND f.followup_date < date('now')"
    else:
        query += f" AND f.followup_date <= '{target_date}'"

    query += " ORDER BY f.followup_date"

    cursor.execute(query)
    results = cursor.fetchall()
    db.close()

    if results:
        st.success(f"✅ 找到 {len(results)} 位需要随访的患者")

        # 转换为DataFrame
        df = pd.DataFrame([dict(row) for row in results])

        # 计算天数差
        today = pd.to_datetime(date.today())
        df['followup_date'] = pd.to_datetime(df['followup_date'])
        df['days_diff'] = (df['followup_date'] - today).dt.days

        # 状态标记
        def get_status(days):
            if days < 0:
                return f"⚠️ 逾期{abs(days)}天"
            elif days == 0:
                return "🔴 今天"
            elif days <= 3:
                return f"🟡 {days}天后"
            else:
                return f"🟢 {days}天后"

        df['status'] = df['days_diff'].apply(get_status)

        # 显示表格
        display_df = df[[
            'name', 'phone', 'age', 'gender',
            'followup_date', 'status', 'notes'
        ]].rename(columns={
            'name': '姓名',
            'phone': '电话',
            'age': '年龄',
            'gender': '性别',
            'followup_date': '随访日期',
            'status': '状态',
            'notes': '随访事项'
        })

        # 根据状态着色
        def highlight_overdue(row):
            if '逾期' in row['状态']:
                return ['background-color: #ffcccc'] * len(row)
            elif '今天' in row['状态']:
                return ['background-color: #ffffcc'] * len(row)
            else:
                return [''] * len(row)

        styled_df = display_df.style.apply(highlight_overdue, axis=1)

        st.dataframe(styled_df, use_container_width=True, hide_index=True)

        # 批量操作
        st.markdown("---")
        col1, col2, col3 = st.columns(3)

        with col1:
            if st.button("📱 生成提醒短信"):
                generate_sms_template(df)

        with col2:
            if st.button("📊 导出列表"):
                export_followup_list(display_df)

        with col3:
            if st.button("🔄 刷新"):
                st.rerun()

    else:
        st.info("✅ 暂无待随访患者")

def generate_sms_template(df):
    """生成短信模板"""
    st.subheader("📱 短信模板")

    for _, row in df.iterrows():
        followup_date_str = row['followup_date'].strftime('%Y年%m月%d日')

        sms = f"""
【XX医院】尊敬的{row['name']}患者,您好!
您的随访日期为{followup_date_str},请按时来院复诊。
如有疑问,请联系:{row['phone']}
        """.strip()

        st.text_area(
            f"{row['name']}的短信",
            value=sms,
            height=100
        )

def export_followup_list(df):
    """导出随访列表"""
    output_file = f"followup_list_{datetime.now().strftime('%Y%m%d')}.xlsx"
    df.to_excel(output_file, index=False, engine='openpyxl')
    st.success(f"✅ 已导出: {output_file}")

def add_followup_plan():
    """添加随访计划"""
    st.header("添加随访计划")

    with st.form("add_followup_form"):
        # 搜索患者
        search_keyword = st.text_input("搜索患者", placeholder="姓名或ID")

        if search_keyword:
            db = PatientDB()
            patients = db.search_patient(search_keyword)

            if patients:
                patient_options = {
                    f"{row['name']} ({row['patient_id']}) - {row['phone']}": row['patient_id']
                    for row in patients
                }

                selected_patient = st.selectbox("选择患者", list(patient_options.keys()))
                patient_id = patient_options[selected_patient]
            else:
                st.warning("未找到患者")
                patient_id = None

            db.close()
        else:
            patient_id = None

        # 随访日期
        col1, col2 = st.columns(2)

        with col1:
            method = st.radio("设置方式", ["指定日期", "天数后"])

        with col2:
            if method == "指定日期":
                followup_date = st.date_input("随访日期", value=date.today() + timedelta(days=30))
            else:
                days_after = st.number_input("多少天后", 1, 365, 30)
                followup_date = date.today() + timedelta(days=days_after)
                st.info(f"随访日期: {followup_date}")

        # 随访事项
        notes = st.text_area("随访事项", placeholder="例: 复查血压、调整药物剂量")

        # 提交
        submitted = st.form_submit_button("💾 保存随访计划")

        if submitted:
            if not patient_id:
                st.error("❌ 请选择患者")
            else:
                db = PatientDB()
                cursor = db.conn.cursor()

                cursor.execute('''
                    INSERT INTO followups (patient_id, followup_date, status, notes)
                    VALUES (?, ?, '待随访', ?)
                ''', (patient_id, followup_date, notes))

                db.conn.commit()
                db.close()

                st.success(f"✅ 已为患者 {patient_id} 添加随访计划")
                st.balloons()

def mark_followup_completed():
    """标记随访完成"""
    st.header("标记随访完成")

    # 获取待随访列表
    db = PatientDB()
    cursor = db.conn.cursor()

    cursor.execute('''
        SELECT f.id, f.patient_id, f.followup_date, f.notes,
               p.name, p.phone
        FROM followups f
        JOIN patients p ON f.patient_id = p.patient_id
        WHERE f.status = '待随访'
        ORDER BY f.followup_date
    ''')

    followups = cursor.fetchall()
    db.close()

    if followups:
        # 选择随访记录
        followup_options = {
            f"{row['name']} ({row['patient_id']}) - {row['followup_date']}": row['id']
            for row in followups
        }

        selected = st.selectbox("选择随访记录", list(followup_options.keys()))
        followup_id = followup_options[selected]

        # 随访内容表单
        with st.form("complete_followup_form"):
            st.subheader("记录随访内容")

            # 本次随访情况
            followup_content = st.text_area(
                "随访内容",
                placeholder="患者症状、检查结果、治疗调整等"
            )

            # 下次随访
            need_next = st.checkbox("需要下次随访")

            if need_next:
                next_followup_date = st.date_input(
                    "下次随访日期",
                    value=date.today() + timedelta(days=30)
                )
                next_notes = st.text_input("下次随访事项")

            # 提交
            submitted = st.form_submit_button("✅ 标记完成")

            if submitted:
                db = PatientDB()
                cursor = db.conn.cursor()

                # 更新当前随访状态
                cursor.execute('''
                    UPDATE followups
                    SET status = '已完成',
                        completed_at = ?,
                        notes = notes || ? || ?
                    WHERE id = ?
                ''', (
                    datetime.now(),
                    '\n\n随访记录:\n',
                    followup_content,
                    followup_id
                ))

                # 如果需要下次随访,创建新记录
                if need_next:
                    # 获取patient_id
                    selected_followup = [f for f in followups if f['id'] == followup_id][0]

                    cursor.execute('''
                        INSERT INTO followups (patient_id, followup_date, status, notes)
                        VALUES (?, ?, '待随访', ?)
                    ''', (
                        selected_followup['patient_id'],
                        next_followup_date,
                        next_notes
                    ))

                db.conn.commit()
                db.close()

                st.success("✅ 随访已标记完成")
                if need_next:
                    st.info(f"📅 已创建下次随访计划: {next_followup_date}")

                st.balloons()

    else:
        st.info("暂无待随访记录")

def show_followup_statistics():
    """随访统计"""
    st.header("随访统计")

    db = PatientDB()
    cursor = db.conn.cursor()

    # 本月统计
    col1, col2, col3, col4 = st.columns(4)

    with col1:
        cursor.execute('''
            SELECT COUNT(*) FROM followups
            WHERE strftime('%Y-%m', followup_date) = strftime('%Y-%m', 'now')
              AND status = '待随访'
        ''')
        month_pending = cursor.fetchone()[0]
        st.metric("本月待随访", month_pending)

    with col2:
        cursor.execute('''
            SELECT COUNT(*) FROM followups
            WHERE status = '已完成'
              AND strftime('%Y-%m', completed_at) = strftime('%Y-%m', 'now')
        ''')
        month_completed = cursor.fetchone()[0]
        st.metric("本月已完成", month_completed)

    with col3:
        cursor.execute('''
            SELECT COUNT(*) FROM followups
            WHERE status = '待随访'
              AND followup_date < date('now')
        ''')
        overdue = cursor.fetchone()[0]
        st.metric("逾期未随访", overdue, delta=f"-{overdue}" if overdue > 0 else None)

    with col4:
        if month_pending + month_completed > 0:
            completion_rate = month_completed / (month_pending + month_completed) * 100
            st.metric("本月完成率", f"{completion_rate:.1f}%")
        else:
            st.metric("本月完成率", "N/A")

    db.close()

if __name__ == "__main__":
    main()
```

## 进阶功能

### 1. 自动发送短信提醒

```python
# 使用第三方短信API
import requests

def send_sms_reminder(phone, name, followup_date):
    """发送短信提醒"""
    message = f"【XX医院】{name}患者,您的随访日期为{followup_date},请按时来院复诊。"

    # 调用短信API(示例)
    response = requests.post(
        "https://sms-api.example.com/send",
        json={
            "phone": phone,
            "message": message
        }
    )

    return response.status_code == 200
```

### 2. 邮件提醒

```python
import smtplib
from email.mime.text import MIMEText

def send_email_reminder(email, name, followup_date):
    """发送邮件提醒"""
    msg = MIMEText(f"""
    尊敬的{name}患者:

    您的随访日期为{followup_date},请按时来院复诊。

    如有疑问,请联系我们。

    XX医院
    """)

    msg['Subject'] = '随访提醒'
    msg['From'] = 'hospital@example.com'
    msg['To'] = email

    # 发送邮件
    with smtplib.SMTP('smtp.example.com') as server:
        server.send_message(msg)
```

## 检查清单

- [ ] 待随访列表清晰
- [ ] 逾期患者突出显示
- [ ] 可标记完成状态
- [ ] 支持循环随访
- [ ] 有统计数据
- [ ] 可导出列表

## 下一步

[11.6 统计分析](11.6-statistics.md) - 病例数据统计分析

[11.7 完整系统](11.7-complete-system.md) - 整合所有功能
