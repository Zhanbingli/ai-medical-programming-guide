# 2.4 函数:标准化的诊疗流程

## 医学类比:理解函数

### 场景1:测量血压

想象你每天要测量几十个患者的血压:

```
测量血压的标准流程:
1. 让患者安静休息5分钟
2. 选择合适的袖带
3. 测量右上臂血压
4. 记录收缩压和舒张压
5. 评估血压分级
6. 给出建议
```

**这个标准流程,每个患者都一样,只是结果不同** - 这就是函数的思想!

### 场景2:计算BMI

```
BMI计算流程(所有患者都一样):
输入:体重(kg)、身高(m)
处理:BMI = 体重 / 身高²
输出:BMI值
```

你不需要每次都重新思考怎么算,只需要**套用公式**即可。

## 什么是函数?

### 定义
**函数** = 完成特定任务的代码块,可以重复使用

### 医学类比

| 医学概念 | 编程概念 | 说明 |
|---------|---------|------|
| 标准操作规程(SOP) | 函数定义 | 一次定义,多次使用 |
| 检查项目 | 函数名 | 清楚表明功能 |
| 患者数据 | 参数(输入) | 每次不同的输入 |
| 检查结果 | 返回值(输出) | 函数的结果 |

### 为什么需要函数?

**问题场景**:需要计算10个患者的BMI

❌ **不用函数(重复代码)**:
```python
# 患者1
weight1 = 70
height1 = 1.75
bmi1 = weight1 / (height1 ** 2)
print(f"患者1 BMI: {bmi1:.1f}")

# 患者2
weight2 = 85
height2 = 1.68
bmi2 = weight2 / (height2 ** 2)
print(f"患者2 BMI: {bmi2:.1f}")

# 患者3...
# 太繁琐了!
```

✅ **使用函数(简洁高效)**:
```python
def calculate_bmi(weight, height):
    """计算BMI"""
    bmi = weight / (height ** 2)
    return bmi

# 使用
bmi1 = calculate_bmi(70, 1.75)
bmi2 = calculate_bmi(85, 1.68)
bmi3 = calculate_bmi(55, 1.62)

print(f"患者1 BMI: {bmi1:.1f}")
print(f"患者2 BMI: {bmi2:.1f}")
print(f"患者3 BMI: {bmi3:.1f}")
```

## 函数的基本结构

```python
def function_name(parameter1, parameter2):
    """函数说明文档"""
    # 函数体:处理逻辑
    result = parameter1 + parameter2
    return result  # 返回结果
```

### 组成部分

1. **def** - 定义函数的关键字
2. **function_name** - 函数名(见名知义)
3. **parameters** - 参数(输入数据)
4. **docstring** - 说明文档(可选但推荐)
5. **function body** - 函数体(具体逻辑)
6. **return** - 返回值(可选)

### 医学示例:血压分级

```python
def classify_blood_pressure(systolic, diastolic):
    """
    根据血压值进行分级

    参数:
    systolic: 收缩压(mmHg)
    diastolic: 舒张压(mmHg)

    返回:
    血压分级(字符串)
    """
    if systolic < 120 and diastolic < 80:
        return "正常血压"
    elif systolic < 140 or diastolic < 90:
        return "正常高值"
    elif systolic < 160 or diastolic < 100:
        return "1级高血压"
    else:
        return "2级高血压"

# 使用函数
result1 = classify_blood_pressure(135, 85)
print(result1)  # 正常高值

result2 = classify_blood_pressure(145, 92)
print(result2)  # 1级高血压
```

## 参数:函数的输入

### 1. 必需参数

```python
def calculate_dosage(weight, drug_per_kg):
    """根据体重计算药物剂量"""
    dosage = weight * drug_per_kg
    return dosage

# 必须提供两个参数
dose = calculate_dosage(70, 5)  # 70kg患者,5mg/kg
print(f"剂量: {dose}mg")  # 剂量: 350mg
```

### 2. 默认参数

```python
def calculate_egfr(creatinine, age, gender="男", is_black=False):
    """
    计算肾小球滤过率

    gender默认为"男",is_black默认为False
    """
    # 简化版计算
    if gender == "男":
        gfr = 186 * (creatinine / 88.4) ** -1.154 * age ** -0.203
    else:
        gfr = 186 * (creatinine / 88.4) ** -1.154 * age ** -0.203 * 0.742

    return round(gfr, 1)

# 使用默认参数
egfr1 = calculate_egfr(88, 45)  # 使用默认gender="男"

# 指定参数
egfr2 = calculate_egfr(88, 45, gender="女")
egfr3 = calculate_egfr(88, 45, "男", True)

print(f"eGFR(男): {egfr1}")
print(f"eGFR(女): {egfr2}")
```

### 3. 关键字参数

```python
def patient_report(name, age, diagnosis, medication):
    """生成患者报告"""
    report = f"""
    患者: {name}
    年龄: {age}岁
    诊断: {diagnosis}
    用药: {medication}
    """
    return report

# 位置参数(按顺序)
report1 = patient_report("张三", 45, "高血压", "氯沙坦")

# 关键字参数(可以不按顺序)
report2 = patient_report(
    diagnosis="糖尿病",
    name="李四",
    medication="二甲双胍",
    age=52
)

print(report1)
print(report2)
```

## 返回值:函数的输出

### 1. 返回单个值

```python
def calculate_bmi(weight, height):
    """计算并返回BMI"""
    bmi = weight / (height ** 2)
    return round(bmi, 1)

result = calculate_bmi(70, 1.75)
print(result)  # 22.9
```

### 2. 返回多个值

```python
def analyze_blood_pressure(systolic, diastolic):
    """分析血压并返回多个信息"""
    # 计算脉压
    pulse_pressure = systolic - diastolic

    # 分级
    if systolic < 120 and diastolic < 80:
        category = "正常"
    elif systolic < 140 or diastolic < 90:
        category = "正常高值"
    else:
        category = "高血压"

    # 建议
    if category == "正常":
        advice = "继续保持"
    elif category == "正常高值":
        advice = "注意监测,改善生活方式"
    else:
        advice = "建议就诊,可能需要药物治疗"

    # 返回多个值(元组)
    return category, pulse_pressure, advice

# 接收多个返回值
grade, pp, suggestion = analyze_blood_pressure(145, 92)

print(f"分级: {grade}")
print(f"脉压: {pp} mmHg")
print(f"建议: {suggestion}")
```

输出:
```
分级: 高血压
脉压: 53 mmHg
建议: 建议就诊,可能需要药物治疗
```

### 3. 无返回值(执行操作)

```python
def print_prescription(patient_name, medication, dosage, frequency):
    """打印处方(不返回值,直接输出)"""
    print("="*50)
    print(f"处方")
    print("="*50)
    print(f"患者: {patient_name}")
    print(f"药品: {medication}")
    print(f"剂量: {dosage}")
    print(f"用法: {frequency}")
    print("="*50)
    # 没有return语句

# 调用函数
print_prescription("张三", "阿司匹林", "100mg", "每日1次")
```

## 实战案例:临床决策支持函数

### 案例:心血管风险评估

```python
def assess_cardiovascular_risk(age, gender, systolic_bp, total_cholesterol,
                               hdl_cholesterol, is_smoker, has_diabetes):
    """
    简化版心血管风险评估

    参数:
    age: 年龄(岁)
    gender: 性别("男"或"女")
    systolic_bp: 收缩压(mmHg)
    total_cholesterol: 总胆固醇(mmol/L)
    hdl_cholesterol: 高密度脂蛋白胆固醇(mmol/L)
    is_smoker: 是否吸烟(True/False)
    has_diabetes: 是否糖尿病(True/False)

    返回:
    (风险等级, 10年风险%, 建议)
    """
    # 计算风险分数(简化版)
    risk_score = 0

    # 年龄分数
    if gender == "男":
        if age >= 70:
            risk_score += 10
        elif age >= 60:
            risk_score += 8
        elif age >= 50:
            risk_score += 5
        else:
            risk_score += 3
    else:  # 女性
        if age >= 70:
            risk_score += 8
        elif age >= 60:
            risk_score += 6
        elif age >= 50:
            risk_score += 4
        else:
            risk_score += 2

    # 血压分数
    if systolic_bp >= 160:
        risk_score += 5
    elif systolic_bp >= 140:
        risk_score += 3
    elif systolic_bp >= 120:
        risk_score += 1

    # 胆固醇分数
    if total_cholesterol >= 6.2:
        risk_score += 3
    elif total_cholesterol >= 5.2:
        risk_score += 2

    # HDL-C(保护因素)
    if hdl_cholesterol < 1.0:
        risk_score += 2
    elif hdl_cholesterol > 1.5:
        risk_score -= 1

    # 吸烟
    if is_smoker:
        risk_score += 4

    # 糖尿病
    if has_diabetes:
        risk_score += 5

    # 评估风险等级
    if risk_score < 10:
        risk_level = "低危"
        risk_percent = "< 10%"
        advice = "继续保持健康生活方式,定期体检"
    elif risk_score < 15:
        risk_level = "中危"
        risk_percent = "10-20%"
        advice = "建议改善生活方式,考虑药物预防,3-6个月随访"
    else:
        risk_level = "高危"
        risk_percent = "> 20%"
        advice = "建议立即就诊,需要药物治疗,定期监测"

    return risk_level, risk_percent, advice

# 使用函数
patient1_risk = assess_cardiovascular_risk(
    age=55,
    gender="男",
    systolic_bp=145,
    total_cholesterol=5.8,
    hdl_cholesterol=1.1,
    is_smoker=True,
    has_diabetes=False
)

level, percent, suggestion = patient1_risk

print("="*60)
print("心血管风险评估报告")
print("="*60)
print(f"风险等级: {level}")
print(f"10年风险: {percent}")
print(f"建议: {suggestion}")
print("="*60)
```

## 函数的进阶技巧

### 1. 函数调用函数

```python
def calculate_bmi(weight, height):
    """计算BMI"""
    return weight / (height ** 2)

def classify_bmi(bmi):
    """BMI分类"""
    if bmi < 18.5:
        return "体重过低"
    elif bmi < 24:
        return "正常"
    elif bmi < 28:
        return "超重"
    else:
        return "肥胖"

def bmi_assessment(weight, height):
    """完整的BMI评估(调用其他函数)"""
    # 调用calculate_bmi函数
    bmi = calculate_bmi(weight, height)

    # 调用classify_bmi函数
    category = classify_bmi(bmi)

    # 生成报告
    report = f"BMI: {bmi:.1f}, 分类: {category}"
    return report

# 使用
result = bmi_assessment(70, 1.75)
print(result)  # BMI: 22.9, 分类: 正常
```

### 2. 列表作为参数

```python
def calculate_average_glucose(glucose_levels):
    """计算平均血糖"""
    if len(glucose_levels) == 0:
        return 0

    total = sum(glucose_levels)
    average = total / len(glucose_levels)
    return round(average, 1)

def analyze_glucose_control(glucose_levels, target=7.0):
    """分析血糖控制情况"""
    avg = calculate_average_glucose(glucose_levels)
    max_value = max(glucose_levels)
    min_value = min(glucose_levels)

    # 计算达标率
    target_count = sum(1 for g in glucose_levels if g < target)
    target_rate = (target_count / len(glucose_levels)) * 100

    return {
        "平均值": avg,
        "最高值": max_value,
        "最低值": min_value,
        "达标率": f"{target_rate:.1f}%"
    }

# 使用
weekly_glucose = [6.2, 5.8, 6.5, 7.1, 6.0, 5.9, 6.3]
result = analyze_glucose_control(weekly_glucose)

print("血糖监测分析:")
for key, value in result.items():
    print(f"{key}: {value}")
```

输出:
```
血糖监测分析:
平均值: 6.3
最高值: 7.1
最低值: 5.8
达标率: 100.0%
```

### 3. 返回字典(结构化数据)

```python
def complete_patient_assessment(name, age, weight, height, glucose, bp_sys, bp_dia):
    """完整患者评估,返回结构化数据"""

    # 计算BMI
    bmi = weight / (height ** 2)

    # BMI分类
    if bmi < 18.5:
        bmi_category = "体重过低"
    elif bmi < 24:
        bmi_category = "正常"
    elif bmi < 28:
        bmi_category = "超重"
    else:
        bmi_category = "肥胖"

    # 血糖评估
    if glucose < 6.1:
        glucose_status = "正常"
    elif glucose < 7.0:
        glucose_status = "糖尿病前期"
    else:
        glucose_status = "糖尿病"

    # 血压评估
    if bp_sys < 120 and bp_dia < 80:
        bp_status = "正常"
    elif bp_sys < 140 or bp_dia < 90:
        bp_status = "正常高值"
    else:
        bp_status = "高血压"

    # 返回完整评估
    return {
        "基本信息": {
            "姓名": name,
            "年龄": age
        },
        "体格检查": {
            "BMI": round(bmi, 1),
            "BMI分类": bmi_category
        },
        "实验室检查": {
            "空腹血糖": glucose,
            "血糖状态": glucose_status
        },
        "生命体征": {
            "血压": f"{bp_sys}/{bp_dia}",
            "血压状态": bp_status
        }
    }

# 使用
assessment = complete_patient_assessment(
    name="张三",
    age=55,
    weight=75,
    height=1.70,
    glucose=6.5,
    bp_sys=135,
    bp_dia=85
)

# 打印评估结果
print("="*50)
print("患者综合评估报告")
print("="*50)
for category, data in assessment.items():
    print(f"\n【{category}】")
    for key, value in data.items():
        print(f"  {key}: {value}")
print("="*50)
```

## Lambda函数:简短的匿名函数

### 语法
```python
lambda 参数: 表达式
```

### 适用场景:简单的一行计算

```python
# 普通函数
def calculate_bmi(weight, height):
    return weight / (height ** 2)

# Lambda函数(等价)
bmi_calculator = lambda weight, height: weight / (height ** 2)

# 使用
result = bmi_calculator(70, 1.75)
print(result)  # 22.86

# 常用于排序
patients = [
    {"name": "张三", "age": 45},
    {"name": "李四", "age": 32},
    {"name": "王五", "age": 58}
]

# 按年龄排序
sorted_patients = sorted(patients, key=lambda p: p["age"])
print(sorted_patients)
```

## 💡 关键要点

### 1. 函数设计原则

| 原则 | 说明 | 示例 |
|------|------|------|
| **单一职责** | 一个函数只做一件事 | `calculate_bmi()`只计算BMI |
| **见名知义** | 函数名清楚表明功能 | `assess_risk()`而不是`func1()` |
| **参数合理** | 不要太多参数(建议≤5个) | 超过5个考虑用字典传参 |
| **有返回值** | 尽量返回结果而不是打印 | `return bmi`而不是`print(bmi)` |
| **加注释** | 写清楚功能、参数、返回值 | 使用docstring |

### 2. 函数 vs 重复代码

❌ **重复代码的问题**:
- 修改困难:一处改需要处处改
- 容易出错:可能漏改某处
- 代码冗长:难以维护

✅ **函数的优势**:
- 一次定义,多次使用
- 修改只需改一处
- 代码简洁,逻辑清晰
- 便于测试和调试

### 3. 何时创建函数?

- 代码重复3次以上 → 考虑写成函数
- 一段代码完成特定功能 → 封装成函数
- 代码超过20行 → 拆分成多个函数
- 需要在不同地方使用 → 写成函数

## 类比总结

| 医学概念 | 编程概念 | 说明 |
|---------|---------|------|
| 诊疗指南 | 函数定义 | 标准化流程 |
| 患者数据 | 参数 | 每次的输入 |
| 诊断结果 | 返回值 | 函数的输出 |
| 标准操作 | 函数调用 | 执行流程 |
| 检查项目名 | 函数名 | 清晰标识 |

## 下一步

掌握了函数的封装,下一节我们将学习[条件判断:临床决策树](2.5-conditionals.md),实现"如果...那么..."的逻辑。

---

## 🔨 动手练习

```python
# 练习1:创建一个函数,根据年龄判断是否为老年人(≥65岁)
def is_elderly(age):
    # 你的代码
    pass

# 练习2:创建一个函数,计算药物剂量(体重 × 每公斤剂量)
def calculate_dose(weight, dose_per_kg):
    # 你的代码
    pass

# 练习3:创建一个函数,分析一组血压数据,返回平均值和最高值
def analyze_bp(bp_list):
    # 你的代码
    pass

# 测试
print(is_elderly(70))  # True
print(calculate_dose(70, 5))  # 350
print(analyze_bp([120, 135, 140, 125, 130]))  # (平均值, 最高值)
```

> 💡 提示:先思考函数的输入和输出,再编写函数体!
