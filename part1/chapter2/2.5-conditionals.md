# 2.5 条件判断:临床决策树

## 医学类比:理解条件判断

### 场景1:发热患者的诊疗决策

```
医生的思维过程:
├─ 如果体温 < 37.3℃
│  └─ 体温正常,继续观察
├─ 如果 37.3℃ ≤ 体温 < 38.0℃
│  └─ 低热,建议多饮水休息
├─ 如果 38.0℃ ≤ 体温 < 39.0℃
│  └─ 中度发热,建议退热药物
└─ 如果体温 ≥ 39.0℃
   └─ 高热,建议立即就诊
```

**这就是条件判断** - 根据不同情况做不同处理!

### 场景2:用药决策

```
开具抗生素的决策:
1. 如果患者对青霉素过敏
   → 不能使用青霉素类药物
   → 改用头孢类或喹诺酮类

2. 如果患者正在服用华法林
   → 避免使用某些抗生素(相互作用)

3. 如果患者是孕妇
   → 使用妊娠分级A或B类药物
```

## 什么是条件判断?

### 定义
**条件判断** = 根据条件是否成立,执行不同的代码

### 基本语法

```python
if 条件:
    # 条件为True时执行
    代码块1
else:
    # 条件为False时执行
    代码块2
```

### 医学示例:体温判断

```python
temperature = 38.5

if temperature >= 37.3:
    print("患者发热")
    print("建议物理降温")
else:
    print("体温正常")
    print("继续观察")
```

## if语句:单条件判断

### 基本形式

```python
blood_glucose = 7.5

if blood_glucose > 7.0:
    print("血糖偏高")
    print("建议复查")
```

**特点**: 条件满足就执行,不满足就跳过

### 医学场景示例

```python
# 1. 检查肾功能
creatinine = 120  # μmol/L

if creatinine > 110:
    print("肌酐升高,提示肾功能异常")
    print("建议肾内科会诊")

# 2. 检查过敏史
is_allergic_to_penicillin = True

if is_allergic_to_penicillin:
    print("⚠️ 警告:患者对青霉素过敏!")
    print("禁用青霉素类药物")

# 3. 检查年龄
patient_age = 70

if patient_age >= 65:
    print("老年患者,用药需谨慎")
    print("注意肝肾功能")
```

## if-else语句:二选一

### 语法

```python
if 条件:
    # 条件为True
    代码块1
else:
    # 条件为False
    代码块2
```

### 医学示例:BMI评估

```python
weight = 70  # kg
height = 1.75  # m
bmi = weight / (height ** 2)

if bmi >= 24:
    print(f"BMI: {bmi:.1f}")
    print("体重偏高,建议控制饮食")
else:
    print(f"BMI: {bmi:.1f}")
    print("体重正常,继续保持")
```

### 实战:用药剂量调整

```python
patient_age = 72
standard_dose = 100  # mg

if patient_age >= 65:
    # 老年患者减量
    adjusted_dose = standard_dose * 0.75
    print(f"老年患者,剂量调整为: {adjusted_dose}mg")
else:
    # 成人标准剂量
    print(f"成人标准剂量: {standard_dose}mg")
```

## if-elif-else语句:多条件判断

### 语法

```python
if 条件1:
    # 条件1为True
    代码块1
elif 条件2:
    # 条件1为False,条件2为True
    代码块2
elif 条件3:
    # 条件1,2都为False,条件3为True
    代码块3
else:
    # 所有条件都为False
    代码块4
```

### 医学示例:血压分级

```python
systolic_bp = 145  # 收缩压
diastolic_bp = 92  # 舒张压

if systolic_bp < 120 and diastolic_bp < 80:
    category = "正常血压"
    advice = "继续保持健康生活方式"
elif systolic_bp < 140 or diastolic_bp < 90:
    category = "正常高值"
    advice = "改善生活方式,定期监测"
elif systolic_bp < 160 or diastolic_bp < 100:
    category = "1级高血压"
    advice = "建议就诊,可能需要药物治疗"
else:
    category = "2级高血压"
    advice = "建议立即就诊,需要药物治疗"

print(f"血压: {systolic_bp}/{diastolic_bp} mmHg")
print(f"分级: {category}")
print(f"建议: {advice}")
```

输出:
```
血压: 145/92 mmHg
分级: 1级高血压
建议: 建议就诊,可能需要药物治疗
```

### 实战:糖尿病诊断

```python
def diagnose_diabetes(fasting_glucose, ogtt_2h=None, hba1c=None):
    """
    糖尿病诊断函数

    参数:
    fasting_glucose: 空腹血糖(mmol/L)
    ogtt_2h: OGTT 2小时血糖(mmol/L), 可选
    hba1c: 糖化血红蛋白(%), 可选
    """

    # 判断逻辑
    if fasting_glucose >= 7.0:
        diagnosis = "糖尿病"
        advice = "建议内分泌科就诊,制定治疗方案"
    elif ogtt_2h and ogtt_2h >= 11.1:
        diagnosis = "糖尿病"
        advice = "建议内分泌科就诊,制定治疗方案"
    elif hba1c and hba1c >= 6.5:
        diagnosis = "糖尿病"
        advice = "建议内分泌科就诊,制定治疗方案"
    elif fasting_glucose >= 6.1:
        diagnosis = "糖尿病前期(IFG)"
        advice = "改善生活方式,3-6个月复查"
    elif ogtt_2h and ogtt_2h >= 7.8:
        diagnosis = "糖尿病前期(IGT)"
        advice = "改善生活方式,3-6个月复查"
    else:
        diagnosis = "血糖正常"
        advice = "保持健康生活方式,每年体检"

    return diagnosis, advice

# 使用示例
result1 = diagnose_diabetes(fasting_glucose=7.5)
print(f"诊断: {result1[0]}, {result1[1]}")

result2 = diagnose_diabetes(fasting_glucose=6.3, hba1c=6.0)
print(f"诊断: {result2[0]}, {result2[1]}")

result3 = diagnose_diabetes(fasting_glucose=5.5)
print(f"诊断: {result3[0]}, {result3[1]}")
```

## 比较运算符

### 基本运算符

| 运算符 | 含义 | 示例 | 结果 |
|-------|------|------|------|
| `==` | 等于 | `5 == 5` | True |
| `!=` | 不等于 | `5 != 3` | True |
| `>` | 大于 | `7 > 5` | True |
| `<` | 小于 | `3 < 5` | True |
| `>=` | 大于等于 | `5 >= 5` | True |
| `<=` | 小于等于 | `3 <= 5` | True |

### 医学场景

```python
temperature = 38.5
heart_rate = 95
age = 45

# 相等判断
if temperature == 37.0:
    print("体温正常")

# 不等判断
if heart_rate != 72:
    print(f"心率异常: {heart_rate}次/分")

# 范围判断
if 60 < heart_rate < 100:
    print("心率正常范围")

if age >= 65:
    print("老年患者")
```

## 逻辑运算符

### 1. and (与):所有条件都要满足

```python
age = 68
has_diabetes = True
creatinine = 95

# 需要同时满足多个条件
if age >= 65 and has_diabetes:
    print("老年糖尿病患者,需特别关注")

if age >= 65 and has_diabetes and creatinine > 110:
    print("老年糖尿病肾病患者,用药需谨慎")
```

### 2. or (或):至少一个条件满足

```python
systolic_bp = 145
diastolic_bp = 85

# 满足任一条件即可
if systolic_bp >= 140 or diastolic_bp >= 90:
    print("高血压")

# 多个或条件
if temperature > 38.5 or heart_rate > 100 or systolic_bp > 160:
    print("患者病情不稳定,需密切监测")
```

### 3. not (非):条件取反

```python
is_allergic_to_penicillin = False

if not is_allergic_to_penicillin:
    print("可以使用青霉素类药物")

is_pregnant = False
if not is_pregnant:
    print("可以进行X光检查")
```

### 复合逻辑判断

```python
age = 35
is_pregnant = True
has_hypertension = True
systolic_bp = 155

# 复杂逻辑
if is_pregnant and has_hypertension and systolic_bp > 140:
    print("⚠️ 妊娠期高血压,需产科紧急处理!")
    print("建议住院观察")
elif is_pregnant and systolic_bp > 140:
    print("妊娠期血压升高,建议产科会诊")
elif is_pregnant:
    print("孕妇,用药需谨慎")

# 用括号明确优先级
if (age < 18 or age > 65) and has_hypertension:
    print("特殊人群高血压,需个体化治疗")
```

## 嵌套条件判断

### 语法

```python
if 外层条件:
    if 内层条件:
        代码块
    else:
        代码块
else:
    代码块
```

### 医学示例:用药决策树

```python
has_infection = True
is_allergic_to_penicillin = False
is_pregnant = False
creatinine = 85

if has_infection:
    print("诊断:感染,需要抗生素治疗")

    if is_allergic_to_penicillin:
        print("患者青霉素过敏")
        if is_pregnant:
            print("建议使用:头孢类(妊娠B级)")
        else:
            print("建议使用:喹诺酮类或头孢类")
    else:
        print("可以使用青霉素类")
        if creatinine > 110:
            print("肾功能异常,需调整剂量")
        else:
            print("使用标准剂量")
else:
    print("无感染征象,暂不需抗生素")
```

输出:
```
诊断:感染,需要抗生素治疗
可以使用青霉素类
使用标准剂量
```

### 更好的写法:减少嵌套

```python
# ❌ 嵌套太深,难以阅读
if has_infection:
    if not is_allergic_to_penicillin:
        if creatinine <= 110:
            print("阿莫西林 500mg tid")

# ✅ 提前返回,逻辑更清晰
def prescribe_antibiotic(has_infection, is_allergic, creatinine):
    if not has_infection:
        return "无需抗生素"

    if is_allergic:
        return "头孢曲松 1g qd"

    if creatinine > 110:
        return "阿莫西林 250mg tid (减量)"

    return "阿莫西林 500mg tid"

# 使用
prescription = prescribe_antibiotic(True, False, 85)
print(prescription)
```

## 三元运算符:简化的if-else

### 语法

```python
结果 = 值1 if 条件 else 值2
```

### 医学示例

```python
age = 70

# 传统写法
if age >= 65:
    patient_type = "老年患者"
else:
    patient_type = "成人患者"

# 三元运算符(简洁)
patient_type = "老年患者" if age >= 65 else "成人患者"
print(patient_type)

# 剂量调整
standard_dose = 100
dose = standard_dose * 0.75 if age >= 65 else standard_dose
print(f"剂量: {dose}mg")

# 性别显示
gender_code = "M"
gender = "男" if gender_code == "M" else "女"
```

## 实战案例:临床风险评分

### 案例:CHADS₂评分(卒中风险评估)

```python
def calculate_chads2_score(age, has_hypertension, has_diabetes,
                           has_heart_failure, has_stroke_history):
    """
    CHADS₂评分计算

    参数:
    age: 年龄
    has_hypertension: 是否有高血压
    has_diabetes: 是否有糖尿病
    has_heart_failure: 是否有心力衰竭
    has_stroke_history: 是否有卒中/TIA病史

    返回:
    (评分, 风险等级, 建议)
    """
    score = 0

    # C - Congestive heart failure (心力衰竭)
    if has_heart_failure:
        score += 1

    # H - Hypertension (高血压)
    if has_hypertension:
        score += 1

    # A - Age ≥75 (年龄≥75岁)
    if age >= 75:
        score += 1

    # D - Diabetes (糖尿病)
    if has_diabetes:
        score += 1

    # S₂ - Stroke/TIA history (卒中/TIA病史,计2分)
    if has_stroke_history:
        score += 2

    # 风险分层
    if score == 0:
        risk = "低危"
        recommendation = "可不抗凝或使用阿司匹林"
    elif score == 1:
        risk = "中危"
        recommendation = "建议抗凝治疗或阿司匹林"
    else:  # score >= 2
        risk = "高危"
        recommendation = "强烈建议抗凝治疗(华法林或新型口服抗凝药)"

    return score, risk, recommendation

# 使用示例
patient1 = calculate_chads2_score(
    age=78,
    has_hypertension=True,
    has_diabetes=True,
    has_heart_failure=False,
    has_stroke_history=False
)

print("="*60)
print("CHADS₂卒中风险评估")
print("="*60)
print(f"评分: {patient1[0]}分")
print(f"风险等级: {patient1[1]}")
print(f"治疗建议: {patient1[2]}")
print("="*60)
```

输出:
```
============================================================
CHADS₂卒中风险评估
============================================================
评分: 3分
风险等级: 高危
治疗建议: 强烈建议抗凝治疗(华法林或新型口服抗凝药)
============================================================
```

## 常见错误与陷阱

### 1. 赋值 vs 比较

```python
age = 45

# ❌ 错误:使用赋值运算符
if age = 65:  # SyntaxError!
    print("老年患者")

# ✅ 正确:使用比较运算符
if age == 65:
    print("老年患者")

# ✅ 大于等于
if age >= 65:
    print("老年患者")
```

### 2. 浮点数比较

```python
glucose = 7.0

# ⚠️ 可能不准确(浮点数精度问题)
if glucose == 7.0:
    print("血糖正常上限")

# ✅ 更好:使用范围判断
if 6.9 <= glucose <= 7.1:
    print("血糖接近正常上限")

# ✅ 或使用round()
if round(glucose, 1) == 7.0:
    print("血糖正常上限")
```

### 3. 逻辑运算符优先级

```python
age = 35
has_diabetes = True
glucose = 8.5

# ❌ 逻辑可能不是你想要的
if age > 65 or has_diabetes and glucose > 7.0:
    # 等价于: age > 65 or (has_diabetes and glucose > 7.0)
    print("需要特别关注")

# ✅ 使用括号明确意图
if (age > 65 or has_diabetes) and glucose > 7.0:
    print("需要特别关注")
```

### 4. 空值判断

```python
test_result = None

# ❌ 错误判断
if test_result:  # None被视为False
    print("检查完成")

# ✅ 明确判断是否为None
if test_result is not None:
    print("检查完成")

# ✅ 判断字符串是否为空
patient_name = ""
if patient_name:  # 空字符串为False
    print(f"患者: {patient_name}")
else:
    print("患者姓名未填写")
```

## 💡 关键要点

### 1. 条件判断决策树

```
选择哪种条件语句?
├─ 只有一种情况需要处理
│  └─ 使用 if
├─ 两种情况二选一
│  └─ 使用 if-else
├─ 多种情况(3种以上)
│  └─ 使用 if-elif-else
└─ 条件嵌套层级多
   └─ 考虑简化逻辑或使用函数
```

### 2. 逻辑运算符记忆

- `and`: 所有条件都要True(更严格)
- `or`: 至少一个条件True(更宽松)
- `not`: 取反

### 3. 最佳实践

| 原则 | 说明 | 示例 |
|------|------|------|
| 简单明了 | 条件表达式要清晰 | `age >= 65` 而不是复杂计算 |
| 避免深嵌套 | 嵌套不超过3层 | 考虑提前返回或拆分函数 |
| 使用括号 | 复杂逻辑加括号 | `(A or B) and C` |
| 先处理特殊情况 | 边界条件放前面 | 先判断None,再判断值 |

## 类比总结

| 医学概念 | 编程概念 | 说明 |
|---------|---------|------|
| 诊疗决策 | if语句 | 根据情况选择方案 |
| 鉴别诊断 | if-elif-else | 多种可能,逐一排查 |
| 禁忌症检查 | 条件判断 | 满足条件才能做 |
| 临床路径分支 | 嵌套if | 逐级决策 |
| 多因素评估 | 逻辑运算符 | 综合考虑多个条件 |

## 下一步

掌握了条件判断,下一节我们将学习[循环:批量处理病历](2.6-loops.md),实现重复性任务的自动化。

---

## 🔨 动手练习

```python
# 练习1:根据BMI给出健康建议
def bmi_advice(bmi):
    # 提示: <18.5体重过低, 18.5-23.9正常, 24-27.9超重, ≥28肥胖
    pass

# 练习2:根据年龄和肌酐计算eGFR并评估肾功能
def assess_kidney_function(age, creatinine):
    # 提示: eGFR≥90正常, 60-89轻度, 30-59中度, <30重度
    pass

# 练习3:实现一个简单的用药禁忌检查
def check_contraindication(is_pregnant, is_allergic, age):
    # 如果孕妇 → "禁用X药"
    # 如果过敏 → "禁用Y药"
    # 如果<18岁 → "儿童慎用"
    pass

# 测试
print(bmi_advice(26.5))  # 应该输出超重的建议
print(assess_kidney_function(70, 150))  # 评估肾功能
print(check_contraindication(True, False, 28))  # 孕妇用药检查
```

> 💡 提示:先画出决策树,再编写代码!
