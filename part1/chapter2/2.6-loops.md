# 2.6 循环:批量处理病历

## 医学类比:理解循环

### 场景1:查房

想象你每天早上查房:

```
查房流程:
对于病区的每一位患者:
    1. 询问症状
    2. 查看体征
    3. 查阅检查结果
    4. 调整医嘱
    5. 记录病程
重复直到所有患者查完
```

**这就是循环** - 重复执行相同的操作!

### 场景2:批量录入检验结果

```
任务:录入50份血常规结果
传统方式:
    打开第1份报告 → 录入 → 保存
    打开第2份报告 → 录入 → 保存
    打开第3份报告 → 录入 → 保存
    ...重复50次

编程方式:
    对于每份报告:
        打开 → 录入 → 保存
    (自动重复50次)
```

## 什么是循环?

### 定义
**循环** = 重复执行一段代码,直到满足停止条件

### 为什么需要循环?

**问题场景**:计算10个患者的BMI

❌ **不用循环(重复代码)**:
```python
# 患者1
bmi1 = 70 / (1.75 ** 2)
print(f"患者1 BMI: {bmi1:.1f}")

# 患者2
bmi2 = 85 / (1.68 ** 2)
print(f"患者2 BMI: {bmi2:.1f}")

# ...重复10次,太麻烦!
```

✅ **使用循环(简洁高效)**:
```python
patients = [
    {"name": "患者1", "weight": 70, "height": 1.75},
    {"name": "患者2", "weight": 85, "height": 1.68},
    # ...更多患者
]

for patient in patients:
    bmi = patient["weight"] / (patient["height"] ** 2)
    print(f"{patient['name']} BMI: {bmi:.1f}")
```

## for循环:遍历集合

### 基本语法

```python
for 元素 in 集合:
    # 对每个元素执行的操作
    代码块
```

### 1. 遍历列表

```python
# 血糖监测记录
glucose_levels = [6.2, 5.8, 6.5, 7.1, 6.0, 5.9, 6.3]

for glucose in glucose_levels:
    print(f"血糖: {glucose} mmol/L")
```

输出:
```
血糖: 6.2 mmol/L
血糖: 5.8 mmol/L
血糖: 6.5 mmol/L
血糖: 7.1 mmol/L
血糖: 6.0 mmol/L
血糖: 5.9 mmol/L
血糖: 6.3 mmol/L
```

### 2. 遍历列表并计算

```python
glucose_levels = [6.2, 5.8, 6.5, 7.1, 6.0, 5.9, 6.3]

# 计算平均值
total = 0
for glucose in glucose_levels:
    total += glucose

average = total / len(glucose_levels)
print(f"平均血糖: {average:.2f} mmol/L")

# 统计异常值
high_count = 0
for glucose in glucose_levels:
    if glucose > 7.0:
        high_count += 1

print(f"血糖偏高的次数: {high_count}")
```

### 3. 遍历字典列表

```python
patients = [
    {"name": "张三", "age": 45, "diagnosis": "高血压"},
    {"name": "李四", "age": 52, "diagnosis": "糖尿病"},
    {"name": "王五", "age": 38, "diagnosis": "高血脂"}
]

print("患者列表:")
print("="*50)
for patient in patients:
    print(f"姓名: {patient['name']}, 年龄: {patient['age']}岁, 诊断: {patient['diagnosis']}")
print("="*50)
```

输出:
```
患者列表:
==================================================
姓名: 张三, 年龄: 45岁, 诊断: 高血压
姓名: 李四, 年龄: 52岁, 诊断: 糖尿病
姓名: 王五, 年龄: 38岁, 诊断: 高血脂
==================================================
```

### 4. 使用enumerate获取索引

```python
medications = ["阿司匹林", "二甲双胍", "阿托伐他汀", "氯吡格雷"]

# 不带索引
for med in medications:
    print(med)

# 带索引(从0开始)
for index, med in enumerate(medications):
    print(f"{index + 1}. {med}")
```

输出:
```
1. 阿司匹林
2. 二甲双胍
3. 阿托伐他汀
4. 氯吡格雷
```

## range()函数:生成数字序列

### 基本用法

```python
# range(n) - 从0到n-1
for i in range(5):
    print(i)
# 输出: 0, 1, 2, 3, 4

# range(start, end) - 从start到end-1
for i in range(1, 6):
    print(i)
# 输出: 1, 2, 3, 4, 5

# range(start, end, step) - 指定步长
for i in range(0, 11, 2):
    print(i)
# 输出: 0, 2, 4, 6, 8, 10
```

### 医学场景:生成病历号

```python
# 生成10个连续病历号
print("生成病历号:")
for i in range(1, 11):
    medical_id = f"MED-2025-{i:04d}"  # :04d表示补齐4位数字
    print(medical_id)
```

输出:
```
生成病历号:
MED-2025-0001
MED-2025-0002
MED-2025-0003
...
MED-2025-0010
```

### 医学场景:定时测量

```python
# 模拟每小时测量体温
print("体温监测记录(24小时):")
base_temp = 37.0

for hour in range(0, 24, 4):  # 每4小时测一次
    # 模拟温度波动
    import random
    temp_variation = random.uniform(-0.5, 0.5)
    temperature = base_temp + temp_variation

    print(f"{hour:02d}:00 - 体温: {temperature:.1f}°C")
```

## while循环:条件循环

### 基本语法

```python
while 条件:
    # 条件为True时重复执行
    代码块
```

### 医学场景:血压控制

```python
systolic_bp = 160  # 初始收缩压
target_bp = 130    # 目标血压
week = 0

print("血压控制过程:")
while systolic_bp > target_bp:
    week += 1
    # 模拟每周降压5mmHg
    systolic_bp -= 5
    print(f"第{week}周: 收缩压 {systolic_bp} mmHg")

print(f"达标!共用时{week}周")
```

输出:
```
血压控制过程:
第1周: 收缩压 155 mmHg
第2周: 收缩压 150 mmHg
第3周: 收缩压 145 mmHg
第4周: 收缩压 140 mmHg
第5周: 收缩压 135 mmHg
第6周: 收缩压 130 mmHg
达标!共用时6周
```

### 注意:避免无限循环

```python
# ❌ 危险:无限循环(条件永远为True)
count = 0
while count < 10:
    print(count)
    # 忘记更新count,会无限循环!

# ✅ 正确:有终止条件
count = 0
while count < 10:
    print(count)
    count += 1  # 确保条件最终会变为False
```

## 循环控制语句

### 1. break:提前退出循环

```python
# 场景:查找第一个异常值
glucose_levels = [5.8, 6.2, 6.5, 8.5, 6.0, 7.2]

for index, glucose in enumerate(glucose_levels):
    if glucose > 8.0:
        print(f"发现异常高血糖: {glucose} mmol/L (第{index+1}次测量)")
        break  # 找到后立即停止
    print(f"第{index+1}次测量: {glucose} mmol/L - 正常")
```

输出:
```
第1次测量: 5.8 mmol/L - 正常
第2次测量: 6.2 mmol/L - 正常
第3次测量: 6.5 mmol/L - 正常
发现异常高血糖: 8.5 mmol/L (第4次测量)
```

### 2. continue:跳过当前循环

```python
# 场景:只处理有效数据(跳过None值)
test_results = [6.2, None, 5.8, None, 6.5, 7.1]

print("有效血糖记录:")
for glucose in test_results:
    if glucose is None:
        continue  # 跳过None,继续下一个
    print(f"血糖: {glucose} mmol/L")
```

输出:
```
有效血糖记录:
血糖: 6.2 mmol/L
血糖: 5.8 mmol/L
血糖: 6.5 mmol/L
血糖: 7.1 mmol/L
```

### 3. else子句:循环正常结束时执行

```python
# 场景:检查是否所有血糖都达标
glucose_levels = [6.2, 5.8, 6.5, 6.0, 5.9, 6.3]
target = 7.0

for glucose in glucose_levels:
    if glucose > target:
        print(f"发现超标血糖: {glucose} mmol/L")
        break
else:
    # 循环正常结束(没有break),执行这里
    print("所有血糖值都达标!")
```

## 嵌套循环:循环中的循环

### 语法

```python
for 外层变量 in 外层集合:
    for 内层变量 in 内层集合:
        代码块
```

### 医学场景:多患者多次测量

```python
# 3个患者,每人3次血压测量
patients_bp = {
    "张三": [135, 132, 138],
    "李四": [145, 142, 148],
    "王五": [128, 125, 130]
}

print("血压监测汇总:")
print("="*60)

for patient_name, bp_readings in patients_bp.items():
    print(f"\n患者: {patient_name}")

    # 内层循环:遍历该患者的多次测量
    for i, bp in enumerate(bp_readings, 1):
        status = "正常" if bp < 140 else "偏高"
        print(f"  第{i}次: {bp} mmHg - {status}")

    # 计算平均
    avg_bp = sum(bp_readings) / len(bp_readings)
    print(f"  平均: {avg_bp:.1f} mmHg")

print("="*60)
```

输出:
```
血压监测汇总:
============================================================

患者: 张三
  第1次: 135 mmHg - 正常
  第2次: 132 mmHg - 正常
  第3次: 138 mmHg - 正常
  平均: 135.0 mmHg

患者: 李四
  第1次: 145 mmHg - 偏高
  第2次: 142 mmHg - 偏高
  第3次: 148 mmHg - 偏高
  平均: 145.0 mmHg

患者: 王五
  第1次: 128 mmHg - 正常
  第2次: 125 mmHg - 正常
  第3次: 130 mmHg - 正常
  平均: 127.7 mmHg
============================================================
```

## 列表推导式:简洁的循环

### 语法

```python
新列表 = [表达式 for 元素 in 集合 if 条件]
```

### 基本示例

```python
# 传统方式:提取所有偏高的血糖
glucose_levels = [6.2, 5.8, 6.5, 7.1, 6.0, 8.2, 5.9]
high_glucose = []
for g in glucose_levels:
    if g > 7.0:
        high_glucose.append(g)

# 列表推导式(一行搞定)
high_glucose = [g for g in glucose_levels if g > 7.0]
print(high_glucose)  # [7.1, 8.2]

# 转换:将mmol/L转为mg/dL
glucose_mg = [g * 18 for g in glucose_levels]
print(glucose_mg)

# 带条件的转换
glucose_status = ["正常" if g < 7.0 else "偏高" for g in glucose_levels]
print(glucose_status)
```

### 医学场景:筛选患者

```python
patients = [
    {"name": "张三", "age": 45, "bp": 135},
    {"name": "李四", "age": 72, "bp": 145},
    {"name": "王五", "age": 38, "bp": 125},
    {"name": "赵六", "age": 68, "bp": 155}
]

# 筛选高血压患者
hypertension_patients = [p["name"] for p in patients if p["bp"] >= 140]
print(f"高血压患者: {hypertension_patients}")

# 筛选老年患者
elderly_patients = [p["name"] for p in patients if p["age"] >= 65]
print(f"老年患者: {elderly_patients}")

# 复合条件:老年高血压患者
elderly_hypertension = [
    p["name"] for p in patients
    if p["age"] >= 65 and p["bp"] >= 140
]
print(f"老年高血压患者: {elderly_hypertension}")
```

## 实战案例:批量处理病历数据

### 案例:住院患者日报

```python
# 住院患者数据
patients = [
    {"id": "P001", "name": "张三", "age": 45, "temp": 37.2, "bp_sys": 135, "bp_dia": 85},
    {"id": "P002", "name": "李四", "age": 68, "temp": 38.5, "bp_sys": 145, "bp_dia": 92},
    {"id": "P003", "name": "王五", "age": 52, "temp": 36.8, "bp_sys": 128, "bp_dia": 78},
    {"id": "P004", "name": "赵六", "age": 75, "temp": 39.1, "bp_sys": 155, "bp_dia": 95},
]

def generate_daily_report(patients):
    """生成住院患者日报"""

    print("="*70)
    print("住院患者生命体征日报")
    print(f"报告时间: 2025-01-15 08:00")
    print("="*70)

    # 统计变量
    total_patients = len(patients)
    fever_count = 0
    hypertension_count = 0
    elderly_count = 0

    # 遍历所有患者
    for patient in patients:
        # 提取数据
        pid = patient["id"]
        name = patient["name"]
        age = patient["age"]
        temp = patient["temp"]
        bp_sys = patient["bp_sys"]
        bp_dia = patient["bp_dia"]

        # 状态判断
        alerts = []

        if temp >= 37.3:
            alerts.append("🌡️ 发热")
            fever_count += 1

        if bp_sys >= 140 or bp_dia >= 90:
            alerts.append("📈 血压偏高")
            hypertension_count += 1

        if age >= 65:
            alerts.append("👴 老年患者")
            elderly_count += 1

        # 打印患者信息
        alert_text = ", ".join(alerts) if alerts else "✓ 正常"
        print(f"\n{pid} - {name} ({age}岁)")
        print(f"  体温: {temp}°C | 血压: {bp_sys}/{bp_dia} mmHg")
        print(f"  状态: {alert_text}")

    # 汇总统计
    print("\n" + "="*70)
    print("统计汇总:")
    print(f"  总患者数: {total_patients}人")
    print(f"  发热患者: {fever_count}人 ({fever_count/total_patients*100:.1f}%)")
    print(f"  高血压患者: {hypertension_count}人 ({hypertension_count/total_patients*100:.1f}%)")
    print(f"  老年患者: {elderly_count}人 ({elderly_count/total_patients*100:.1f}%)")
    print("="*70)

# 生成报告
generate_daily_report(patients)
```

输出:
```
======================================================================
住院患者生命体征日报
报告时间: 2025-01-15 08:00
======================================================================

P001 - 张三 (45岁)
  体温: 37.2°C | 血压: 135/85 mmHg
  状态: ✓ 正常

P002 - 李四 (68岁)
  体温: 38.5°C | 血压: 145/92 mmHg
  状态: 🌡️ 发热, 📈 血压偏高, 👴 老年患者

P003 - 王五 (52岁)
  体温: 36.8°C | 血压: 128/78 mmHg
  状态: ✓ 正常

P004 - 赵六 (75岁)
  体温: 39.1°C | 血压: 155/95 mmHg
  状态: 🌡️ 发热, 📈 血压偏高, 👴 老年患者

======================================================================
统计汇总:
  总患者数: 4人
  发热患者: 2人 (50.0%)
  高血压患者: 2人 (50.0%)
  老年患者: 2人 (50.0%)
======================================================================
```

## 常见循环模式

### 1. 累加求和

```python
glucose_levels = [6.2, 5.8, 6.5, 7.1, 6.0]

total = 0
for glucose in glucose_levels:
    total += glucose

average = total / len(glucose_levels)
print(f"平均血糖: {average:.2f}")

# 或使用内置函数
average = sum(glucose_levels) / len(glucose_levels)
```

### 2. 计数统计

```python
glucose_levels = [6.2, 5.8, 6.5, 7.1, 6.0, 8.2, 5.9]

# 统计达标次数
normal_count = 0
for glucose in glucose_levels:
    if glucose < 7.0:
        normal_count += 1

rate = (normal_count / len(glucose_levels)) * 100
print(f"达标率: {rate:.1f}%")
```

### 3. 查找最值

```python
bp_readings = [135, 142, 138, 145, 132, 140]

# 手动查找最大值
max_bp = bp_readings[0]
for bp in bp_readings:
    if bp > max_bp:
        max_bp = bp

print(f"最高血压: {max_bp}")

# 或使用内置函数
print(f"最高: {max(bp_readings)}, 最低: {min(bp_readings)}")
```

### 4. 过滤筛选

```python
patients = [
    {"name": "张三", "age": 45},
    {"name": "李四", "age": 68},
    {"name": "王五", "age": 52},
    {"name": "赵六", "age": 72}
]

# 筛选老年患者
elderly = []
for patient in patients:
    if patient["age"] >= 65:
        elderly.append(patient)

print(f"老年患者: {[p['name'] for p in elderly]}")
```

## 💡 关键要点

### 1. for vs while选择

| 场景 | 使用 | 示例 |
|------|------|------|
| 遍历已知集合 | for循环 | 遍历患者列表 |
| 重复固定次数 | for + range() | 重复10次 |
| 条件不确定 | while循环 | 血压降到目标值 |
| 无限循环(直到break) | while True | 持续监测 |

### 2. 循环优化技巧

```python
# ❌ 效率低:重复计算
patients = [...]
for patient in patients:
    if len(patients) > 10:  # 每次循环都计算长度
        ...

# ✅ 优化:提前计算
patient_count = len(patients)
for patient in patients:
    if patient_count > 10:
        ...

# ✅ 更好:列表推导式(简洁高效)
elderly_patients = [p for p in patients if p["age"] >= 65]
```

### 3. 避免常见错误

```python
# ❌ 错误:修改正在遍历的列表
patients = ["张三", "李四", "王五"]
for patient in patients:
    if patient == "李四":
        patients.remove(patient)  # 危险!

# ✅ 正确:创建新列表
patients = ["张三", "李四", "王五"]
filtered_patients = [p for p in patients if p != "李四"]

# ❌ 错误:循环内定义函数/类(效率低)
for i in range(100):
    def process():
        ...

# ✅ 正确:在循环外定义
def process():
    ...

for i in range(100):
    process()
```

## 类比总结

| 医学概念 | 编程概念 | 说明 |
|---------|---------|------|
| 查房 | for循环 | 遍历所有患者 |
| 持续监测 | while循环 | 满足条件才停止 |
| 批量处理病历 | 循环处理列表 | 重复相同操作 |
| 定时测量 | range()循环 | 固定次数 |
| 筛选符合条件的患者 | if + 循环 | 条件过滤 |
| 发现异常立即处理 | break | 提前退出 |

## 下一步

掌握了循环,我们已经学完了编程的核心概念!下一节[实战练习:设计一个随访提醒逻辑](2.7-practice.md),我们将综合运用所学知识。

---

## 🔨 动手练习

```python
# 练习1:计算一组患者的平均年龄
ages = [45, 52, 38, 68, 72, 41, 55]
# 使用for循环计算平均值

# 练习2:统计有多少次血糖超过7.0
glucose_readings = [6.2, 5.8, 6.5, 7.1, 6.0, 8.2, 5.9, 7.5]
# 使用for循环统计

# 练习3:为患者列表添加风险等级
patients = [
    {"name": "张三", "age": 45, "bp": 135},
    {"name": "李四", "age": 72, "bp": 155},
    {"name": "王五", "age": 52, "bp": 125}
]
# 如果age>=65或bp>=140,风险="高",否则="低"
# 为每个患者字典添加"risk"字段

# 练习4:使用列表推导式筛选所有高血压患者(bp>=140)
# 提取患者姓名列表
```

> 💡 提示:先用for循环实现,再尝试用列表推导式简化!
