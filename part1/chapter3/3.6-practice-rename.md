# 3.6 实战:批量重命名DICOM文件

## 项目背景

### 现实场景

你是一名放射科医生,每天需要处理大量DICOM影像文件。这些文件通常由设备自动命名:

```
原始文件名:
IM_0001.dcm
IM_0002.dcm
IM_0003.dcm
DCM_20250115_001.dcm
SCAN_12345.dcm
```

**问题**:
- 文件名无意义,无法直接识别患者
- 查找特定患者的影像很困难
- 归档管理混乱

**期望**:
```
规范化文件名:
张三_45岁_CT_胸部_20250115_001.dcm
李四_52岁_MRI_颅脑_20250115_001.dcm
王五_38岁_X光_腹部_20250115_001.dcm
```

## 项目目标

开发一个**批量重命名工具**,实现:

✅ 读取DICOM文件元数据
✅ 提取患者信息(姓名、年龄、检查类型等)
✅ 按规范格式重命名文件
✅ 处理文件名冲突
✅ 生成操作日志

## 版本1:基础文件重命名

### 需求分析

先不考虑DICOM元数据,假设我们有一个CSV文件记录患者信息:

```csv
原文件名,患者姓名,年龄,检查类型,检查部位
IM_0001.dcm,张三,45,CT,胸部
IM_0002.dcm,李四,52,MRI,颅脑
IM_0003.dcm,王五,38,X光,腹部
```

### 实现代码

```python
import os
import csv
from datetime import datetime

def rename_files_from_csv(csv_file, source_dir):
    """
    根据CSV文件批量重命名

    参数:
        csv_file: CSV文件路径
        source_dir: DICOM文件目录
    """

    # 读取CSV
    with open(csv_file, "r", encoding="utf-8") as f:
        reader = csv.DictReader(f)
        rename_list = list(reader)

    print(f"读取到{len(rename_list)}条记录\n")
    print("="*70)

    success_count = 0
    error_count = 0

    # 遍历重命名
    for item in rename_list:
        old_name = item["原文件名"]
        patient_name = item["患者姓名"]
        age = item["年龄"]
        exam_type = item["检查类型"]
        body_part = item["检查部位"]

        # 构造新文件名
        date_str = datetime.now().strftime("%Y%m%d")
        new_name = f"{patient_name}_{age}岁_{exam_type}_{body_part}_{date_str}.dcm"

        # 文件路径
        old_path = os.path.join(source_dir, old_name)
        new_path = os.path.join(source_dir, new_name)

        # 检查原文件是否存在
        if not os.path.exists(old_path):
            print(f"❌ 错误: 文件不存在 - {old_name}")
            error_count += 1
            continue

        # 检查新文件名是否已存在
        if os.path.exists(new_path):
            print(f"⚠️  警告: 文件名冲突 - {new_name}")
            # 添加序号
            base, ext = os.path.splitext(new_name)
            counter = 1
            while os.path.exists(new_path):
                new_name = f"{base}_{counter:03d}{ext}"
                new_path = os.path.join(source_dir, new_name)
                counter += 1

        # 重命名
        try:
            os.rename(old_path, new_path)
            print(f"✅ {old_name} → {new_name}")
            success_count += 1
        except Exception as e:
            print(f"❌ 错误: {old_name} - {str(e)}")
            error_count += 1

    # 汇总
    print("="*70)
    print(f"\n重命名完成!")
    print(f"成功: {success_count}个")
    print(f"失败: {error_count}个")

# 使用
rename_files_from_csv("rename_list.csv", "DICOM_files")
```

### 运行示例

**输入CSV(rename_list.csv)**:
```csv
原文件名,患者姓名,年龄,检查类型,检查部位
IM_0001.dcm,张三,45,CT,胸部
IM_0002.dcm,李四,52,MRI,颅脑
IM_0003.dcm,王五,38,X光,腹部
```

**输出**:
```
读取到3条记录

======================================================================
✅ IM_0001.dcm → 张三_45岁_CT_胸部_20250115.dcm
✅ IM_0002.dcm → 李四_52岁_MRI_颅脑_20250115.dcm
✅ IM_0003.dcm → 王五_38岁_X光_腹部_20250115.dcm
======================================================================

重命名完成!
成功: 3个
失败: 0个
```

## 版本2:处理DICOM元数据

### 安装pydicom库

```bash
pip install pydicom
```

### 读取DICOM元数据

```python
import pydicom

# 读取DICOM文件
ds = pydicom.dcmread("IM_0001.dcm")

# 提取元数据
patient_name = str(ds.PatientName)  # 患者姓名
patient_age = str(ds.PatientAge)  # 患者年龄
study_date = str(ds.StudyDate)  # 检查日期
modality = str(ds.Modality)  # 检查类型(CT/MRI/CR等)
study_description = str(ds.get("StudyDescription", ""))  # 检查描述

print(f"患者: {patient_name}")
print(f"年龄: {patient_age}")
print(f"检查日期: {study_date}")
print(f"检查类型: {modality}")
print(f"描述: {study_description}")
```

### 完整重命名工具

```python
import os
import pydicom
from pathlib import Path
from datetime import datetime

class DICOMRenamer:
    """DICOM文件批量重命名工具"""

    def __init__(self, source_dir, output_dir=None):
        """
        初始化

        参数:
            source_dir: 源文件目录
            output_dir: 输出目录(None表示原地重命名)
        """
        self.source_dir = Path(source_dir)
        self.output_dir = Path(output_dir) if output_dir else self.source_dir
        self.log_file = self.output_dir / "rename_log.txt"
        self.errors = []

    def extract_info(self, dicom_file):
        """从DICOM文件提取信息"""
        try:
            ds = pydicom.dcmread(dicom_file)

            # 提取关键信息
            info = {
                "patient_name": str(ds.get("PatientName", "未知")),
                "patient_age": str(ds.get("PatientAge", "未知")),
                "study_date": str(ds.get("StudyDate", "未知")),
                "modality": str(ds.get("Modality", "未知")),
                "study_desc": str(ds.get("StudyDescription", "")),
                "series_number": str(ds.get("SeriesNumber", "001"))
            }

            return info

        except Exception as e:
            self.errors.append(f"读取失败: {dicom_file.name} - {str(e)}")
            return None

    def generate_new_name(self, info, original_name):
        """生成新文件名"""

        # 清理患者姓名(去除特殊字符)
        name = info["patient_name"].replace("^", "_")
        name = "".join(c for c in name if c.isalnum() or c in ["_", "-"])

        # 年龄处理
        age = info["patient_age"].replace("Y", "")  # 去除Y后缀

        # 日期格式化
        date_str = info["study_date"]
        if len(date_str) == 8:  # YYYYMMDD
            date_str = f"{date_str[:4]}{date_str[4:6]}{date_str[6:]}"

        # 检查类型映射
        modality_map = {
            "CT": "CT",
            "MR": "MRI",
            "CR": "X光",
            "DX": "X光",
            "US": "超声"
        }
        exam_type = modality_map.get(info["modality"], info["modality"])

        # 组合新文件名
        parts = [name, f"{age}岁", exam_type]

        if info["study_desc"]:
            parts.append(info["study_desc"][:10])  # 限制长度

        parts.append(date_str)
        parts.append(info["series_number"])

        new_name = "_".join(parts) + ".dcm"

        # 处理文件名中的非法字符
        illegal_chars = ['<', '>', ':', '"', '/', '\\', '|', '?', '*']
        for char in illegal_chars:
            new_name = new_name.replace(char, '_')

        return new_name

    def rename_files(self, dry_run=False):
        """
        批量重命名

        参数:
            dry_run: True表示只模拟,不实际重命名
        """
        # 查找所有DICOM文件
        dicom_files = list(self.source_dir.glob("*.dcm"))

        if not dicom_files:
            print(f"错误: 在{self.source_dir}中未找到.dcm文件")
            return

        print(f"找到{len(dicom_files)}个DICOM文件\n")
        print("="*80)

        # 创建输出目录
        if not dry_run:
            self.output_dir.mkdir(parents=True, exist_ok=True)

        success_count = 0
        skip_count = 0

        # 日志
        log_lines = []
        log_lines.append(f"DICOM重命名日志 - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        log_lines.append("="*80)

        for dicom_file in dicom_files:
            # 提取信息
            info = self.extract_info(dicom_file)

            if info is None:
                skip_count += 1
                continue

            # 生成新文件名
            new_name = self.generate_new_name(info, dicom_file.name)
            new_path = self.output_dir / new_name

            # 处理文件名冲突
            if new_path.exists():
                base = new_path.stem
                ext = new_path.suffix
                counter = 1
                while new_path.exists():
                    new_name = f"{base}_{counter:03d}{ext}"
                    new_path = self.output_dir / new_name
                    counter += 1

            # 重命名
            log_line = f"{dicom_file.name} → {new_name}"

            if dry_run:
                print(f"[模拟] {log_line}")
            else:
                try:
                    if self.output_dir == self.source_dir:
                        # 原地重命名
                        dicom_file.rename(new_path)
                    else:
                        # 复制到新目录
                        import shutil
                        shutil.copy2(dicom_file, new_path)

                    print(f"✅ {log_line}")
                    success_count += 1
                except Exception as e:
                    error_msg = f"❌ 失败: {dicom_file.name} - {str(e)}"
                    print(error_msg)
                    self.errors.append(error_msg)

            log_lines.append(log_line)

        # 保存日志
        if not dry_run:
            self.log_file.write_text("\n".join(log_lines), encoding="utf-8")

        # 汇总
        print("="*80)
        print(f"\n重命名{'模拟' if dry_run else '完成'}!")
        print(f"成功: {success_count}个")
        print(f"跳过: {skip_count}个")
        print(f"错误: {len(self.errors)}个")

        if self.errors:
            print("\n错误详情:")
            for error in self.errors:
                print(f"  {error}")

        if not dry_run:
            print(f"\n日志已保存: {self.log_file}")

# 使用示例
if __name__ == "__main__":
    # 先模拟运行,检查效果
    renamer = DICOMRenamer("DICOM_files", "renamed_files")
    renamer.rename_files(dry_run=True)

    # 确认无误后,实际重命名
    # input("\n按回车键继续实际重命名...")
    # renamer.rename_files(dry_run=False)
```

## 版本3:带GUI的完整工具

### 安装tkinter(Python自带,无需安装)

```python
import tkinter as tk
from tkinter import filedialog, messagebox, scrolledtext
import os
import pydicom
from pathlib import Path
from datetime import datetime

class DICOMRenamerGUI:
    """DICOM重命名工具 - 图形界面版"""

    def __init__(self, root):
        self.root = root
        self.root.title("DICOM批量重命名工具")
        self.root.geometry("800x600")

        self.source_dir = None
        self.output_dir = None

        self.create_widgets()

    def create_widgets(self):
        """创建界面组件"""

        # 标题
        title = tk.Label(self.root, text="DICOM批量重命名工具",
                        font=("Arial", 16, "bold"))
        title.pack(pady=10)

        # 源目录选择
        frame1 = tk.Frame(self.root)
        frame1.pack(fill="x", padx=20, pady=5)

        tk.Label(frame1, text="源目录:", width=10).pack(side="left")
        self.source_entry = tk.Entry(frame1, width=50)
        self.source_entry.pack(side="left", padx=5)
        tk.Button(frame1, text="浏览...", command=self.browse_source).pack(side="left")

        # 输出目录选择
        frame2 = tk.Frame(self.root)
        frame2.pack(fill="x", padx=20, pady=5)

        tk.Label(frame2, text="输出目录:", width=10).pack(side="left")
        self.output_entry = tk.Entry(frame2, width=50)
        self.output_entry.pack(side="left", padx=5)
        tk.Button(frame2, text="浏览...", command=self.browse_output).pack(side="left")

        # 选项
        frame3 = tk.Frame(self.root)
        frame3.pack(fill="x", padx=20, pady=10)

        self.dry_run_var = tk.BooleanVar(value=True)
        tk.Checkbutton(frame3, text="模拟运行(不实际重命名)",
                      variable=self.dry_run_var).pack(side="left")

        # 按钮
        frame4 = tk.Frame(self.root)
        frame4.pack(pady=10)

        tk.Button(frame4, text="开始处理", command=self.start_rename,
                 bg="#4CAF50", fg="white", width=15).pack(side="left", padx=5)
        tk.Button(frame4, text="清空日志", command=self.clear_log,
                 width=15).pack(side="left", padx=5)

        # 日志显示
        tk.Label(self.root, text="处理日志:").pack(anchor="w", padx=20)

        self.log_text = scrolledtext.ScrolledText(self.root, height=20)
        self.log_text.pack(fill="both", expand=True, padx=20, pady=5)

    def browse_source(self):
        """选择源目录"""
        dir_path = filedialog.askdirectory(title="选择DICOM文件目录")
        if dir_path:
            self.source_dir = dir_path
            self.source_entry.delete(0, tk.END)
            self.source_entry.insert(0, dir_path)

    def browse_output(self):
        """选择输出目录"""
        dir_path = filedialog.askdirectory(title="选择输出目录")
        if dir_path:
            self.output_dir = dir_path
            self.output_entry.delete(0, tk.END)
            self.output_entry.insert(0, dir_path)

    def log(self, message):
        """输出日志"""
        self.log_text.insert(tk.END, message + "\n")
        self.log_text.see(tk.END)
        self.root.update()

    def clear_log(self):
        """清空日志"""
        self.log_text.delete(1.0, tk.END)

    def start_rename(self):
        """开始重命名"""

        # 验证输入
        if not self.source_dir:
            messagebox.showerror("错误", "请选择源目录!")
            return

        if not self.output_dir:
            self.output_dir = self.source_dir

        # 清空日志
        self.clear_log()

        # 执行重命名
        try:
            renamer = DICOMRenamer(self.source_dir, self.output_dir)
            renamer.rename_files_gui(self.log, self.dry_run_var.get())

            messagebox.showinfo("完成", "处理完成!")

        except Exception as e:
            messagebox.showerror("错误", f"处理失败:\n{str(e)}")

# DICOMRenamer类需要添加GUI支持方法
# (在原DICOMRenamer类中添加)
def rename_files_gui(self, log_func, dry_run=False):
    """GUI版本的重命名方法"""
    dicom_files = list(self.source_dir.glob("*.dcm"))

    if not dicom_files:
        log_func(f"错误: 在{self.source_dir}中未找到.dcm文件")
        return

    log_func(f"找到{len(dicom_files)}个DICOM文件\n")
    log_func("="*80)

    if not dry_run:
        self.output_dir.mkdir(parents=True, exist_ok=True)

    success_count = 0
    for dicom_file in dicom_files:
        info = self.extract_info(dicom_file)
        if info:
            new_name = self.generate_new_name(info, dicom_file.name)
            log_func(f"✅ {dicom_file.name} → {new_name}")
            success_count += 1

    log_func("="*80)
    log_func(f"\n完成! 成功处理{success_count}个文件")

# 启动GUI
if __name__ == "__main__":
    root = tk.Tk()
    app = DICOMRenamerGUI(root)
    root.mainloop()
```

## 项目总结

### 完成的功能

✅ 批量读取DICOM文件
✅ 提取患者元数据
✅ 按规范格式重命名
✅ 处理文件名冲突
✅ 生成操作日志
✅ 提供图形界面

### 技术要点回顾

| 知识点 | 应用 |
|-------|------|
| os/pathlib | 文件操作 |
| pydicom | DICOM元数据读取 |
| 字符串处理 | 文件名格式化 |
| 异常处理 | 错误处理 |
| tkinter | GUI开发 |

### 扩展建议

1. **支持更多文件格式** - JPG, PNG等
2. **批量处理子目录** - 递归处理
3. **导出重命名映射表** - CSV格式
4. **撤销功能** - 恢复原文件名
5. **数据库记录** - SQLite保存历史

## 💡 关键要点

### 项目开发流程

```
1. 需求分析 → 明确要解决的问题
2. 功能拆分 → 分成小模块逐个实现
3. 版本迭代 → 从简单到复杂
4. 测试验证 → 确保功能正确
5. 优化改进 → 提升用户体验
```

### 编程最佳实践

1. **先简单后复杂** - 版本1→版本2→版本3
2. **模拟运行** - dry_run避免误操作
3. **异常处理** - try-except捕获错误
4. **日志记录** - 记录操作历史
5. **代码复用** - 封装成类

## 下一步

恭喜完成第3章!你已经:
- ✅ 了解了Python的优势
- ✅ 搭建了开发环境
- ✅ 掌握了基础语法
- ✅ 学会了标准库
- ✅ 完成了第一个实战项目

**接下来**:[第4章 医学数据处理核心库](../../part1/chapter4/4.1-pandas-intro.md),学习Pandas等强大工具!

---

## 🎯 挑战任务

### 任务:改进DICOM重命名工具

**增强功能**:
1. 支持批量处理子目录
2. 添加进度条显示
3. 支持按患者ID分组到不同文件夹
4. 导出重命名记录到Excel

**提示**:
- 进度条: `from tqdm import tqdm`
- Excel导出: `import pandas as pd`
- 递归目录: `Path.rglob("*.dcm")`

试试看能否实现!不会的功能可以问ChatGPT! 🚀
