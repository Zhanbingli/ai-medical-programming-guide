# 5.7 Git基础:代码版本控制

## 什么是Git?为什么医生需要它?

### 医学类比

```
无版本控制:
论文_初稿.docx
论文_修改版.docx
论文_最终版.docx
论文_最终版_导师意见.docx
论文_真正的最终版.docx  ← 混乱!哪个才是最新的?

使用Git:
论文.docx (始终一个文件)
├── 版本1: 初稿 (2025-01-10)
├── 版本2: 添加数据分析 (2025-01-12)
├── 版本3: 导师修改意见 (2025-01-15)
└── 版本4: 最终定稿 (2025-01-20)

随时可以:
- 查看任何历史版本
- 对比两个版本的差异
- 回退到任意版本
- 知道谁在什么时候改了什么
```

### Git的核心价值

✅ **时光机**: 任意回退到过去的版本
✅ **备份**: 代码自动保存在云端(GitHub)
✅ **协作**: 多人同时编辑,自动合并
✅ **追溯**: 知道每行代码是谁写的,为什么写
✅ **实验**: 尝试新功能,失败了轻松回退

### 实际场景

**场景1**: 代码改崩溃了
```
问题: 昨天还能运行,今天改完就报错了,改了啥都忘了
Git: 一键回退到昨天的版本 ✓
```

**场景2**: 多人协作
```
问题: 你和同事同时修改analysis.py,怎么合并?
Git: 自动合并,冲突部分会标注出来 ✓
```

**场景3**: 开源学习
```
问题: GitHub上有个很棒的医学分析项目,如何获取?
Git: git clone一键下载 ✓
```

## Git vs GitHub

**常见误解**: Git和GitHub是一个东西

**实际**:
- **Git**: 版本控制系统(软件),装在你电脑上
- **GitHub**: 代码托管平台(网站),存储Git仓库的云端服务

类比:
```
Git      = 本地的病历管理系统
GitHub   = 云端病历数据库(百度网盘/Dropbox)
```

其他类似GitHub的平台:
- GitLab
- Gitee(码云,国内)
- Bitbucket

## 安装Git

### Mac

**方法1: 检查是否已安装**
```bash
git --version

# 如果输出版本号,已安装
# git version 2.39.0
```

**方法2: 通过Xcode Command Line Tools安装**
```bash
xcode-select --install
```

**方法3: 通过Homebrew安装**
```bash
brew install git
```

### Windows

**推荐: Git for Windows**

1. 下载: https://git-scm.com/download/win
2. 运行安装程序
3. **重要配置**:
   - 选择"Git Bash Here"(右键菜单)
   - 默认编辑器选VSCode(如果已安装)
   - 其他选项默认即可

4. 验证安装:
   ```bash
   git --version
   ```

### 首次配置

安装后,配置你的身份信息(会显示在提交记录中):

```bash
# 配置用户名
git config --global user.name "Zhang San"

# 配置邮箱
git config --global user.email "zhangsan@example.com"

# 查看配置
git config --list
```

## Git核心概念

### 1. 仓库(Repository)

**仓库** = 一个项目的所有文件 + 完整历史记录

```
medical_analysis/          ← 项目文件夹
├── .git/                  ← Git仓库(隐藏文件夹,存储所有版本)
├── analysis.py
├── data/
└── README.md
```

### 2. 三个区域

```
工作区          暂存区          版本库
(Working)      (Staging)      (Repository)
┌────────┐    ┌────────┐    ┌────────┐
│ 你编辑  │    │ 准备    │    │ 永久    │
│ 的文件  │───→│ 提交的  │───→│ 保存的  │
│        │    │ 文件    │    │ 版本    │
└────────┘    └────────┘    └────────┘
   (修改)    git add      git commit
```

**类比病历**:
- 工作区 = 你正在写的病历(草稿)
- 暂存区 = 整理好待归档的病历
- 版本库 = 已归档的正式病历

### 3. 提交(Commit)

**提交** = 保存当前代码快照(像拍照记录当前状态)

每次提交包含:
- 代码快照
- 提交信息(描述做了什么)
- 作者和时间
- 唯一ID(hash值)

## 基本工作流程

### 1. 创建仓库

**场景A: 新项目**

```bash
# 1. 创建项目文件夹
mkdir my_medical_project
cd my_medical_project

# 2. 初始化Git仓库
git init

# 输出: Initialized empty Git repository in /path/to/my_medical_project/.git/
```

**场景B: 从GitHub克隆现有项目**

```bash
# 克隆他人的项目
git clone https://github.com/username/project-name.git

# 自动创建project-name文件夹并下载所有文件
```

### 2. 查看状态

```bash
git status

# 输出示例:
# On branch main
# Untracked files:
#   (use "git add <file>..." to include in what will be committed)
#         analysis.py
#         data.csv
#
# nothing added to commit but untracked files present
```

**解读**:
- `Untracked files`: 新文件,Git还不知道
- `Changes not staged`: 已跟踪的文件有修改,但未添加到暂存区
- `Changes to be committed`: 已在暂存区,准备提交

### 3. 添加文件到暂存区

```bash
# 添加单个文件
git add analysis.py

# 添加多个文件
git add analysis.py data.csv

# 添加所有文件(常用)
git add .

# 添加某类文件
git add *.py
```

### 4. 提交到版本库

```bash
# 提交,附带说明信息
git commit -m "初始版本:添加数据分析脚本"

# 输出:
# [main 3a2b1c4] 初始版本:添加数据分析脚本
#  2 files changed, 150 insertions(+)
#  create mode 100644 analysis.py
#  create mode 100644 data.csv
```

**提交信息规范**:
```bash
✓ "添加患者数据清洗功能"          # 清晰描述做了什么
✓ "修复血压计算错误"
✓ "重构统计分析模块"

✗ "更新"                         # 太笼统
✗ "asdf"                        # 无意义
✗ "试试看能不能用"               # 不专业
```

### 5. 查看历史记录

```bash
# 查看提交历史
git log

# 输出:
# commit 3a2b1c4d5e6f7g8h9i0j1k2l3m4n5o6p7q8r9s0
# Author: Zhang San <zhangsan@example.com>
# Date:   Mon Jan 15 10:30:00 2025 +0800
#
#     初始版本:添加数据分析脚本

# 简洁模式(一行显示)
git log --oneline

# 输出:
# 3a2b1c4 初始版本:添加数据分析脚本
# 7f8e9d0 添加数据清洗功能
# a1b2c3d 修复统计错误

# 查看文件修改历史
git log --oneline analysis.py
```

### 6. 查看修改内容

```bash
# 查看工作区与暂存区的差异(修改了什么)
git diff

# 输出:
# diff --git a/analysis.py b/analysis.py
# index 1234567..abcdefg 100644
# --- a/analysis.py
# +++ b/analysis.py
# @@ -10,7 +10,7 @@ def calculate_mean(data):
# -    return sum(data) / len(data)
# +    return np.mean(data)  # 改用NumPy

# 查看暂存区与版本库的差异
git diff --staged

# 查看两个提交之间的差异
git diff 3a2b1c4 7f8e9d0
```

**符号说明**:
- `-` 红色: 删除的行
- `+` 绿色: 添加的行

## 进阶操作

### 回退版本

```bash
# 查看历史
git log --oneline
# 7f8e9d0 最新版本(有bug)
# 3a2b1c4 上个版本(稳定)
# a1b2c3d 更早的版本

# 回退到上个版本
git reset --hard 3a2b1c4

# 或者回退一个版本
git reset --hard HEAD^

# 回退两个版本
git reset --hard HEAD^^

# 回退10个版本
git reset --hard HEAD~10
```

⚠️ **警告**: `--hard`会丢弃工作区修改!

**更安全的方式**(保留工作区修改):
```bash
git reset --soft HEAD^
```

### 撤销修改

```bash
# 场景1: 工作区的修改还未add(撤销修改)
git checkout -- analysis.py
# 或(新版Git)
git restore analysis.py

# 场景2: 已经add到暂存区(取消暂存)
git reset HEAD analysis.py
# 或(新版Git)
git restore --staged analysis.py

# 场景3: 已经commit(参考"回退版本")
```

### .gitignore - 忽略文件

有些文件不需要版本控制(如大型数据文件、临时文件):

**创建 .gitignore 文件**:
```bash
# .gitignore文件内容

# Python相关
__pycache__/
*.pyc
*.pyo
.ipynb_checkpoints/

# 数据文件
*.csv
*.xlsx
data/raw/*

# 环境
venv/
.env

# 系统文件
.DS_Store
Thumbs.db

# 个人笔记
notes.txt
```

**添加后**:
```bash
git add .gitignore
git commit -m "添加gitignore文件"

# 之后,这些文件会被Git自动忽略
```

## GitHub实战

### 1. 创建GitHub账号

1. 访问 https://github.com
2. 注册账号(免费)
3. 验证邮箱

### 2. 创建远程仓库

1. 点击右上角 "+" → "New repository"
2. 填写:
   - Repository name: `medical-analysis`
   - Description: `医学数据分析工具`
   - Public/Private: 选择公开或私有
   - 不勾选"Initialize with README"(本地已有代码)
3. 点击"Create repository"

### 3. 连接本地和远程仓库

```bash
# 添加远程仓库(只需一次)
git remote add origin https://github.com/your-username/medical-analysis.git

# 验证
git remote -v
# 输出:
# origin  https://github.com/your-username/medical-analysis.git (fetch)
# origin  https://github.com/your-username/medical-analysis.git (push)
```

### 4. 推送代码到GitHub

```bash
# 第一次推送
git push -u origin main

# 之后推送
git push

# 输出:
# Enumerating objects: 5, done.
# ...
# To https://github.com/your-username/medical-analysis.git
#  * [new branch]      main -> main
```

**如果提示需要认证**:
- 推荐使用Personal Access Token(个人访问令牌)
- 设置方法: GitHub → Settings → Developer settings → Personal access tokens

### 5. 从GitHub拉取更新

```bash
# 拉取并合并远程更新
git pull

# 等价于:
git fetch   # 获取远程更新
git merge   # 合并到本地
```

### 6. 克隆他人的项目

```bash
# 下载GitHub上的开源项目
git clone https://github.com/someone/awesome-medical-tools.git

# 进入项目
cd awesome-medical-tools

# 查看代码,学习,运行
```

## VSCode中使用Git

VSCode集成了Git功能,可视化操作:

### 1. 初始化仓库

- 点击左侧"源代码管理"图标(分支图标)
- 点击"Initialize Repository"

### 2. 查看更改

- 修改文件后,左侧会显示"M"(Modified)
- 点击文件查看差异(红绿对比)

### 3. 提交

- 在"Changes"区域,点击文件旁的"+"(暂存)
- 顶部输入提交信息
- 点击"✓"(提交)

### 4. 推送/拉取

- 点击底部状态栏的"↑↓"同步按钮
- 或点击"..."菜单 → Push/Pull

### 5. 查看历史

- 安装扩展"GitLens"
- 查看每行代码的作者和提交时间
- 查看文件历史

## 协作工作流

### Fork & Pull Request(开源贡献)

```
1. Fork别人的项目到你的GitHub
   ↓
2. Clone到本地
   ↓
3. 创建分支: git checkout -b feature-new
   ↓
4. 修改代码,提交
   ↓
5. Push到你的GitHub: git push origin feature-new
   ↓
6. 在GitHub创建Pull Request
   ↓
7. 原作者审核,合并你的代码
```

### 分支管理

```bash
# 查看分支
git branch

# 创建新分支
git branch feature-new

# 切换分支
git checkout feature-new
# 或(新版)
git switch feature-new

# 创建并切换(常用)
git checkout -b feature-new

# 合并分支(在main分支执行)
git checkout main
git merge feature-new

# 删除分支
git branch -d feature-new
```

**分支使用场景**:
```
main分支      = 稳定版,能正常运行
dev分支       = 开发版,测试新功能
feature分支   = 实验性功能
```

## 实战案例

### 案例1: 单人项目版本控制

```bash
# Day 1: 项目初始化
mkdir patient_tracker
cd patient_tracker
git init
echo "# 患者随访管理系统" > README.md
git add .
git commit -m "初始化项目"

# Day 2: 添加功能
# 编写 tracker.py
git add tracker.py
git commit -m "添加患者信息录入功能"

# Day 3: 修复bug
# 修改 tracker.py
git add tracker.py
git commit -m "修复日期格式错误"

# Day 7: 上传到GitHub
git remote add origin https://github.com/yourname/patient_tracker.git
git push -u origin main

# 每天工作结束
git add .
git commit -m "今日工作总结"
git push
```

### 案例2: 团队协作

```bash
# 同事A
git clone https://github.com/team/medical-project.git
cd medical-project
git checkout -b feature-export
# 编写导出功能
git add .
git commit -m "添加数据导出功能"
git push origin feature-export
# 在GitHub创建Pull Request

# 同事B
git clone https://github.com/team/medical-project.git
cd medical-project
git checkout -b feature-chart
# 编写图表功能
git add .
git commit -m "添加统计图表"
git push origin feature-chart
# 在GitHub创建Pull Request

# 项目负责人
# 在GitHub审核两个Pull Request
# 合并到main分支

# 同事A和B拉取最新代码
git checkout main
git pull
```

### 案例3: 实验新功能

```bash
# 当前代码稳定运行
git status
# 确保工作区干净

# 创建实验分支
git checkout -b experiment-ml

# 大胆尝试机器学习
# ... 写代码 ...
git add .
git commit -m "尝试添加机器学习预测"

# 测试发现效果不好
# 放弃实验,回到主分支
git checkout main
git branch -D experiment-ml  # 删除实验分支

# 代码回到实验前的状态,没有任何影响!
```

## 常见问题

### Q1: git add . 后悔了

```bash
# 取消暂存
git reset
```

### Q2: 提交信息写错了

```bash
# 修改最近一次提交信息
git commit --amend -m "新的提交信息"
```

### Q3: 不小心提交了敏感信息(如密码)

```bash
# ⚠️ 如果还没push,可以回退
git reset --soft HEAD^
# 删除敏感信息,重新提交

# ⚠️ 如果已经push,需要强制覆盖(危险操作)
# 先在本地回退,修改,再强制推送
git push -f origin main
```

**更好的办法**: 使用 .gitignore 防止提交敏感文件!

### Q4: push失败:"rejected"

**原因**: 远程仓库有新提交,本地不是最新

**解决**:
```bash
git pull  # 先拉取远程更新
# 解决冲突(如果有)
git push  # 再推送
```

### Q5: 合并冲突

**场景**: 两人修改了同一文件的同一位置

```bash
git pull
# 提示冲突:
# CONFLICT (content): Merge conflict in analysis.py
```

**解决步骤**:
1. 打开冲突文件,会看到:
```python
<<<<<<< HEAD
# 你的代码
result = calculate_mean(data)
=======
# 别人的代码
result = compute_average(data)
>>>>>>> main
```

2. 手动选择保留哪个(或合并):
```python
# 最终决定
result = calculate_mean(data)  # 保留你的
```

3. 删除冲突标记,保存文件

4. 提交:
```bash
git add analysis.py
git commit -m "解决合并冲突"
git push
```

## 检查清单

- [ ] Git已安装,能运行 `git --version`
- [ ] 已配置用户名和邮箱
- [ ] 理解工作区、暂存区、版本库的概念
- [ ] 会初始化Git仓库
- [ ] 会add、commit、查看status和log
- [ ] 会创建和使用.gitignore
- [ ] 会查看diff(修改内容)
- [ ] 注册了GitHub账号
- [ ] 会创建远程仓库并push代码
- [ ] 会clone他人的GitHub项目
- [ ] (可选)会在VSCode中使用Git

## Git命令速查

### 基础操作
```bash
git init                    # 初始化仓库
git clone <url>             # 克隆远程仓库
git status                  # 查看状态
git add <file>              # 添加到暂存区
git add .                   # 添加所有修改
git commit -m "message"     # 提交
git log                     # 查看历史
git log --oneline           # 简洁历史
git diff                    # 查看修改
```

### 撤销操作
```bash
git restore <file>          # 撤销工作区修改
git restore --staged <file> # 取消暂存
git reset --hard <commit>   # 回退版本(危险)
git commit --amend          # 修改最近提交
```

### 远程操作
```bash
git remote add origin <url> # 添加远程仓库
git push                    # 推送到远程
git pull                    # 拉取远程更新
git clone <url>             # 克隆仓库
```

### 分支操作
```bash
git branch                  # 查看分支
git branch <name>           # 创建分支
git checkout <name>         # 切换分支
git checkout -b <name>      # 创建并切换
git merge <name>            # 合并分支
git branch -d <name>        # 删除分支
```

## 下一步

- **5.8 调试技巧**: 使用Git排查bug(bisect命令)
- **第7章 AI编程工具**: GitHub Copilot等AI工具
- **实战项目**: 所有项目代码都用Git管理

## 进阶学习资源

- 官方文档: https://git-scm.com/doc
- 交互式教程: https://learngitbranching.js.org (可视化学习分支)
- GitHub Guides: https://guides.github.com
- 廖雪峰Git教程: https://www.liaoxuefeng.com/wiki/896043488029600
- Pro Git(中文版): https://git-scm.com/book/zh/v2
