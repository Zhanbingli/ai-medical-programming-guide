# 5.5 包管理:pip与conda

## 什么是包(Package)?

**包** = Python的"功能模块",就像医院的科室:

```
Python基础库      =  医院基础科室(内科、外科)
第三方包          =  专科诊室(心内科、神经科、影像科...)
```

例如:
- `pandas` = 数据处理专家
- `matplotlib` = 图表绘制专家
- `scikit-learn` = 机器学习专家

**不装这些包,Python只能做基础运算,就像医院只有挂号处没有诊室。**

## 两大包管理工具

### pip - Python官方包管理器

```python
✓ Python官方标准工具
✓ 包最全(PyPI有40万+包)
✓ 安装速度快
```

### conda - Anaconda的包管理器

```python
✓ 不仅管理Python包,还管理其他软件(如R, C++库)
✓ 自动处理复杂依赖关系
✓ 集成虚拟环境管理
✓ 特别适合数据科学
```

### 对比总结

| 特性 | pip | conda |
|------|-----|-------|
| **包数量** | 超多(40万+) | 较少(7500+) |
| **安装速度** | 快 | 较慢 |
| **依赖处理** | 基础 | 强大 |
| **适用场景** | 通用Python开发 | 数据科学 |
| **是否需要单独安装** | Python自带 | 需要装Anaconda |

### 使用建议

```
医学数据分析: 优先用conda,找不到的包用pip
一般Python项目: 主要用pip
```

## pip基础操作

### 1. 安装包

```bash
# 安装最新版本
pip install pandas

# 安装特定版本
pip install numpy==1.24.0

# 安装多个包
pip install pandas numpy matplotlib

# 从镜像源安装(国内加速)
pip install pandas -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### 2. 升级包

```bash
# 升级特定包
pip install --upgrade pandas

# 升级pip自己
pip install --upgrade pip
```

### 3. 卸载包

```bash
pip uninstall pandas

# 卸载时不要确认提示
pip uninstall -y pandas
```

### 4. 查看已安装的包

```bash
# 列出所有包
pip list

# 输出示例:
# Package         Version
# --------------- -------
# pandas          2.1.4
# numpy           1.26.2
# matplotlib      3.8.2

# 查看特定包信息
pip show pandas

# 输出:
# Name: pandas
# Version: 2.1.4
# Summary: Powerful data structures...
# Location: /opt/anaconda3/lib/python3.11/site-packages
# Requires: numpy, python-dateutil, pytz
```

### 5. 搜索包

```bash
pip search keyword
```

⚠️ **注意**: PyPI暂停了搜索功能,建议直接去官网搜索: https://pypi.org

### 6. 检查依赖问题

```bash
pip check

# 输出示例:
# scikit-learn 1.3.0 has requirement scipy>=1.5.0, but you have scipy 1.4.0.
```

## conda基础操作

### 1. 安装包

```bash
# 从conda默认源安装
conda install pandas

# 安装特定版本
conda install numpy=1.24.0

# 安装多个包
conda install pandas numpy matplotlib

# 从指定channel安装
conda install -c conda-forge scikit-learn
```

**channel**: conda的"软件源",类似App Store的不同区域
- `defaults`: Anaconda官方源
- `conda-forge`: 社区维护,包更多更新

### 2. 升级包

```bash
# 升级特定包
conda update pandas

# 升级conda自己
conda update conda

# 升级Anaconda全部包
conda update --all
```

### 3. 卸载包

```bash
conda remove pandas

# 同时删除不再需要的依赖
conda remove --force pandas
```

### 4. 查看已安装的包

```bash
# 列出所有包
conda list

# 搜索特定包
conda list pandas

# 输出:
# pandas    2.1.4    py311hca03da5_0
```

### 5. 搜索包

```bash
# 搜索包
conda search scikit-learn

# 搜索特定版本
conda search "numpy>=1.20"
```

### 6. 清理缓存

```bash
# 清理未使用的包和缓存
conda clean --all

# 可以释放大量磁盘空间!
```

## 配置国内镜像源(加速下载)

### pip镜像配置

**临时使用**(单次安装):
```bash
pip install pandas -i https://pypi.tuna.tsinghua.edu.cn/simple
```

**永久配置**:

**Mac/Linux**:
```bash
# 创建配置文件
mkdir -p ~/.pip
cat > ~/.pip/pip.conf << EOF
[global]
index-url = https://pypi.tuna.tsinghua.edu.cn/simple
[install]
trusted-host = pypi.tuna.tsinghua.edu.cn
EOF
```

**Windows**:
1. 在用户目录创建 `pip` 文件夹: `C:\Users\你的用户名\pip\`
2. 创建 `pip.ini` 文件,内容:
```ini
[global]
index-url = https://pypi.tuna.tsinghua.edu.cn/simple
[install]
trusted-host = pypi.tuna.tsinghua.edu.cn
```

**推荐镜像源**:
- 清华: `https://pypi.tuna.tsinghua.edu.cn/simple`
- 阿里云: `https://mirrors.aliyun.com/pypi/simple/`
- 豆瓣: `https://pypi.douban.com/simple/`

### conda镜像配置

```bash
# 添加清华镜像
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/conda-forge

# 设置搜索时显示通道地址
conda config --set show_channel_urls yes

# 查看配置
conda config --show channels
```

**恢复默认源**:
```bash
conda config --remove-key channels
```

## pip vs conda: 实际使用场景

### 场景1: 安装常见数据科学包

**推荐: conda**

```bash
# conda一次性处理所有依赖
conda install pandas numpy matplotlib seaborn scikit-learn
```

**原因**:
- conda会自动处理复杂依赖(如NumPy需要底层数学库)
- 避免版本冲突

### 场景2: 安装最新的小众包

**推荐: pip**

```bash
# conda可能没有或版本太旧
pip install some-new-package
```

**原因**:
- PyPI(pip源)包更新更快
- 小众包可能只在PyPI有

### 场景3: 混合使用

**可以!但有顺序**:

```bash
# 1. 先用conda安装大型数据科学包
conda install pandas numpy scipy scikit-learn

# 2. 再用pip安装conda没有的包
pip install some-special-package
```

⚠️ **注意**: 避免用pip升级conda安装的包,可能导致依赖混乱!

## requirements.txt - 批量安装包

### 什么是requirements.txt?

记录项目所需包的清单文件,就像"购物清单":

```txt
pandas==2.1.4
numpy==1.26.2
matplotlib==3.8.2
scikit-learn==1.3.2
```

### 创建requirements.txt

**方法1: 手动创建**
```bash
# 在VSCode或任何文本编辑器创建文件
# 文件名: requirements.txt
# 内容: 一行一个包
pandas
numpy
matplotlib
```

**方法2: 自动生成**(导出当前环境)
```bash
# pip环境
pip freeze > requirements.txt

# conda环境
conda list --export > requirements.txt
```

### 使用requirements.txt安装

```bash
# pip安装
pip install -r requirements.txt

# conda安装
conda install --file requirements.txt
```

### 实际应用场景

**场景**: AI给你一个GitHub项目,包含requirements.txt

```bash
# 1. 克隆项目
git clone https://github.com/some-project.git

# 2. 进入目录
cd some-project

# 3. 一键安装所有依赖
pip install -r requirements.txt

# 4. 运行项目
python main.py
```

## environment.yml - conda环境配置

conda的等价物,功能更强(包含环境和包):

**environment.yml示例**:
```yaml
name: medical_analysis
channels:
  - defaults
  - conda-forge
dependencies:
  - python=3.11
  - pandas=2.1.4
  - numpy=1.26.2
  - matplotlib=3.8.2
  - pip:
    - some-pip-only-package
```

**创建环境**:
```bash
conda env create -f environment.yml
```

**导出环境**:
```bash
conda env export > environment.yml
```

## 常见问题排查

### Q1: pip安装速度很慢

**解决**: 使用国内镜像
```bash
pip install pandas -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### Q2: conda安装时一直"Solving environment"

**原因**: 依赖计算太复杂

**解决方案1**: 使用mamba(更快的conda)
```bash
# 安装mamba
conda install -c conda-forge mamba

# 用mamba代替conda
mamba install pandas
```

**解决方案2**: 减少包数量,分批安装
```bash
# 不要一次装太多
conda install pandas  # 先装这个
conda install matplotlib  # 再装这个
```

### Q3: ImportError: No module named 'xxx'

**原因**: 包未安装或不在当前环境

**检查**:
```bash
# 确认包是否安装
pip list | grep xxx
conda list | grep xxx

# 检查Python环境是否正确
which python  # Mac/Linux
where python  # Windows
```

**解决**: 在正确的环境中安装
```bash
pip install xxx
```

### Q4: 提示版本冲突

**示例错误**:
```
ERROR: package-a requires numpy>=1.20, but you have numpy==1.19.0
```

**解决**:
```bash
# 升级冲突的包
pip install --upgrade numpy

# 或安装兼容版本
pip install "package-a<2.0"
```

### Q5: pip和conda安装的包冲突

**避免方法**:
1. 优先用conda安装数据科学包
2. pip只用于安装conda没有的包
3. 不要用pip升级conda安装的包

**修复方法**:
```bash
# 重建环境(最彻底)
conda create -n new_env python=3.11
conda activate new_env
# 重新安装所有包
```

## 实战案例

### 案例1: 配置医学数据分析环境

```bash
# 1. 创建新环境
conda create -n medical python=3.11

# 2. 激活环境
conda activate medical

# 3. 安装核心包(conda)
conda install pandas numpy matplotlib seaborn jupyter

# 4. 安装医学特定包(pip)
pip install pydicom
pip install lifelines  # 生存分析

# 5. 验证安装
python -c "import pandas; import pydicom; print('✓ All packages ready!')"
```

### 案例2: 复现AI给的代码环境

AI给你一个脚本,顶部写着:

```python
# Requirements:
# pandas>=2.0
# matplotlib>=3.7
# scikit-learn>=1.3
```

**操作**:
```bash
# 1. 创建requirements.txt
cat > requirements.txt << EOF
pandas>=2.0
matplotlib>=3.7
scikit-learn>=1.3
EOF

# 2. 安装
pip install -r requirements.txt

# 3. 运行脚本
python ai_script.py
```

### 案例3: 升级所有包(年度大扫除)

```bash
# pip方式
pip list --outdated  # 查看可更新的包
pip install --upgrade package1 package2 package3

# conda方式(推荐)
conda update --all
```

## 最佳实践

### 1. 项目开始前先规划包

```bash
# 不好的做法:
# 随便装,装得乱七八糟

# 好的做法:
# 1. 创建项目专用环境
conda create -n my_project python=3.11

# 2. 安装必需包
conda install pandas numpy matplotlib

# 3. 记录到requirements.txt
pip freeze > requirements.txt
```

### 2. 定期清理不用的包

```bash
# 查看包大小
conda list --show-channel-urls

# 清理conda缓存
conda clean --all

# 卸载不用的包
pip uninstall unused-package
```

### 3. 读懂包的版本号

```
pandas==2.1.4
       ┬ ┬ ┬
       │ │ └─ 补丁版本(bug修复)
       │ └─── 小版本(新功能,向后兼容)
       └───── 大版本(可能不兼容旧代码)
```

**版本指定语法**:
```bash
pandas==2.1.4    # 精确版本
pandas>=2.0      # 大于等于
pandas>=2.0,<3.0 # 范围
pandas~=2.1.0    # 兼容版本(>=2.1.0, <2.2.0)
```

### 4. 遇到安装问题先尝试

```bash
# 1. 升级pip/conda本身
pip install --upgrade pip
conda update conda

# 2. 清理缓存
pip cache purge
conda clean --all

# 3. 使用国内镜像

# 4. Google报错信息

# 5. 检查Python版本是否兼容
```

## 检查清单

- [ ] 理解pip和conda的区别
- [ ] 会使用pip安装、升级、卸载包
- [ ] 会使用conda安装、升级、卸载包
- [ ] 已配置国内镜像源(加速下载)
- [ ] 知道如何查看已安装的包
- [ ] 理解requirements.txt的作用
- [ ] 会创建和使用requirements.txt
- [ ] 知道pip和conda的混合使用原则
- [ ] 能够排查基本的包安装问题

## 下一步

- **5.6 虚拟环境**: 为不同项目创建隔离的环境
- **5.8 调试技巧**: 解决包导入错误

## 常用命令速查

### pip
```bash
pip install package          # 安装
pip install package==1.0.0   # 安装特定版本
pip install --upgrade package # 升级
pip uninstall package        # 卸载
pip list                     # 列出所有包
pip show package             # 显示包信息
pip freeze > requirements.txt # 导出
pip install -r requirements.txt # 安装
```

### conda
```bash
conda install package        # 安装
conda install package=1.0.0  # 安装特定版本
conda update package         # 升级
conda remove package         # 卸载
conda list                   # 列出所有包
conda search package         # 搜索包
conda clean --all            # 清理缓存
```

## 资源链接

- PyPI官网: https://pypi.org
- Anaconda包搜索: https://anaconda.org
- pip文档: https://pip.pypa.io
- conda文档: https://docs.conda.io
- 清华镜像帮助: https://mirrors.tuna.tsinghua.edu.cn/help/pypi/
