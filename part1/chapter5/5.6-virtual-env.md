# 5.6 虚拟环境:隔离项目依赖

## 为什么需要虚拟环境?

### 问题场景

想象你有两个项目:

**项目A**(去年的老项目):
```python
需要 pandas==1.3.0 (旧版本)
```

**项目B**(新项目):
```python
需要 pandas==2.1.0 (新版本)
```

**问题**: 一台电脑只有一个Python环境,怎么同时满足两个版本要求? 🤔

### 医学类比

```
无虚拟环境 = 所有患者共用一个病房
             (甲流患者和免疫低下患者混住 → 交叉感染!)

虚拟环境   = 每个患者独立隔离病房
             (互不干扰,各自用药)
```

### 虚拟环境的作用

✅ **隔离依赖**: 每个项目独立的包环境
✅ **避免冲突**: 不同项目可以用不同版本的包
✅ **环境复现**: 轻松在其他电脑复现相同环境
✅ **保持整洁**: 测试完就删,不污染系统环境

## 虚拟环境工具对比

### 1. venv (Python内置)

```python
✓ Python 3.3+自带,无需额外安装
✓ 轻量级
✗ 只管理Python包,不管理Python版本
✗ 功能相对简单
```

**适合**: 简单项目,快速隔离

### 2. conda环境 (推荐医学数据分析)

```python
✓ 管理Python版本+包
✓ 处理复杂依赖(C/C++库)
✓ 集成Anaconda生态
✓ 一条命令搞定一切
✗ 需要Anaconda
✗ 占用空间较大
```

**适合**: 数据科学项目,医学分析

### 3. virtualenv (老牌工具)

```python
✓ 功能强大
✓ 兼容性好
✗ 需要单独安装
✗ 被venv和conda取代
```

**适合**: 老项目维护

## conda环境管理 (推荐)

### 创建环境

#### 基本创建

```bash
# 创建名为 medical_analysis 的环境,Python 3.11
conda create -n medical_analysis python=3.11

# 输出:
# Proceed ([y]/n)? y
# ...
# done

# 创建环境并同时安装包
conda create -n data_project python=3.11 pandas numpy matplotlib
```

#### 参数说明

```bash
conda create -n 环境名 python=版本号 [包1 包2 ...]

-n : name,环境名称
```

**命名建议**:
```bash
✓ medical_analysis    # 描述性,小写,下划线
✓ covid19_study
✓ patient_tracking

✗ env1                # 无意义
✗ My Project          # 有空格
✗ 医学分析            # 中文(可能有兼容问题)
```

### 查看环境列表

```bash
conda env list
# 或
conda info --envs

# 输出示例:
# conda environments:
#
# base                  *  /opt/anaconda3
# medical_analysis         /opt/anaconda3/envs/medical_analysis
# data_project             /opt/anaconda3/envs/data_project
```

**解读**:
- `*` 表示当前激活的环境
- `base` 是Anaconda的默认环境

### 激活环境

```bash
# 激活指定环境
conda activate medical_analysis

# 提示符变化:
# (base) user@mac ~ %
# ↓
# (medical_analysis) user@mac ~ %
```

**验证当前环境**:
```bash
# 查看Python路径
which python  # Mac/Linux
where python  # Windows

# 输出应该包含环境名:
# /opt/anaconda3/envs/medical_analysis/bin/python
```

### 退出环境

```bash
conda deactivate

# 返回base环境
# (medical_analysis) → (base)
```

### 删除环境

```bash
# 删除整个环境
conda remove -n medical_analysis --all

# 确认:
# Remove all packages in environment /opt/anaconda3/envs/medical_analysis:
# Proceed ([y]/n)? y
```

⚠️ **警告**: 删除后无法恢复!

### 复制环境

```bash
# 克隆现有环境
conda create -n new_env --clone medical_analysis

# 场景:想实验新包,但不想破坏原环境
```

### 导出和导入环境

#### 导出环境配置

```bash
# 方法1: 导出为YAML文件(推荐)
conda env export > environment.yml

# 方法2: 只导出手动安装的包
conda env export --from-history > environment.yml
```

**environment.yml示例**:
```yaml
name: medical_analysis
channels:
  - defaults
  - conda-forge
dependencies:
  - python=3.11
  - pandas=2.1.4
  - numpy=1.26.2
  - matplotlib=3.8.2
  - pip:
    - pydicom==2.4.3
```

#### 导入环境配置

```bash
# 从YAML创建环境
conda env create -f environment.yml

# 自动创建同名环境并安装所有包
```

**实际应用**:
1. 在A电脑导出环境
2. 发给同事或上传GitHub
3. 同事在B电脑导入,完全一致的环境!

## venv环境管理

### 创建venv环境

```bash
# 在项目目录下创建
cd ~/my_project
python -m venv venv

# 或指定Python版本(如果有多个版本)
python3.11 -m venv venv

# 创建后目录结构:
# my_project/
# ├── venv/           ← 虚拟环境目录
# │   ├── bin/        (Mac/Linux)
# │   ├── Scripts/    (Windows)
# │   ├── lib/
# │   └── ...
# └── your_code.py
```

### 激活venv环境

**Mac/Linux**:
```bash
source venv/bin/activate

# 提示符变化:
# (venv) user@mac ~/my_project %
```

**Windows**:
```bash
# CMD
venv\Scripts\activate.bat

# PowerShell
venv\Scripts\Activate.ps1

# Git Bash
source venv/Scripts/activate
```

### 退出venv环境

```bash
deactivate

# 任何系统都一样
```

### 删除venv环境

```bash
# venv就是一个文件夹,直接删除
rm -rf venv  # Mac/Linux
rmdir /s venv  # Windows
```

### venv导出和导入

```bash
# 1. 激活环境
source venv/bin/activate

# 2. 导出
pip freeze > requirements.txt

# 3. 在新环境导入
pip install -r requirements.txt
```

## 实战场景

### 场景1: 开始新的医学数据分析项目

```bash
# 1. 创建项目目录
mkdir ~/blood_pressure_study
cd ~/blood_pressure_study

# 2. 创建conda环境
conda create -n bp_study python=3.11 pandas matplotlib seaborn jupyter

# 3. 激活环境
conda activate bp_study

# 4. 安装额外的包
pip install lifelines  # 生存分析

# 5. 启动Jupyter
jupyter notebook

# 6. 工作完成后
conda deactivate
```

### 场景2: 复现GitHub上的项目

你在GitHub找到一个临床数据分析项目:

```bash
# 1. 克隆项目
git clone https://github.com/someone/clinical-analysis.git
cd clinical-analysis

# 2. 查看README,发现有environment.yml

# 3. 创建环境
conda env create -f environment.yml

# 4. 激活环境
conda activate clinical-analysis

# 5. 运行项目
python main.py
```

### 场景3: 多项目管理

```bash
# 当前有3个项目:

# 项目A: 文献管理工具(老项目,Python 3.8)
conda create -n literature python=3.8 pandas beautifulsoup4

# 项目B: 新的DICOM处理(Python 3.11)
conda create -n dicom_tool python=3.11 pydicom numpy pillow

# 项目C: 机器学习实验(最新版)
conda create -n ml_exp python=3.11 scikit-learn tensorflow

# 切换自如:
conda activate literature   # 工作在项目A
conda activate dicom_tool   # 切换到项目B
conda activate ml_exp       # 切换到项目C
```

### 场景4: 测试新包,不污染主环境

```bash
# 1. 克隆当前环境
conda create -n test_env --clone medical_analysis

# 2. 激活测试环境
conda activate test_env

# 3. 随便测试
pip install experimental_package
# 测试新功能...

# 4. 测试完毕,直接删除
conda deactivate
conda remove -n test_env --all

# 主环境(medical_analysis)完全未受影响!
```

## 在VSCode/Jupyter中使用虚拟环境

### VSCode选择环境

1. **打开命令面板**: `Cmd/Ctrl + Shift + P`
2. **输入**: "Python: Select Interpreter"
3. **选择你的虚拟环境**:
   ```
   ~/anaconda3/envs/medical_analysis/bin/python
   ```
4. 右下角显示当前环境

### Jupyter中使用conda环境

#### 方法1: 激活环境后启动Jupyter

```bash
conda activate medical_analysis
jupyter notebook
```

Jupyter自动使用该环境。

#### 方法2: 添加环境为Jupyter Kernel

```bash
# 1. 在环境中安装ipykernel
conda activate medical_analysis
conda install ipykernel

# 2. 注册环境为kernel
python -m ipykernel install --user --name medical_analysis --display-name "Python (Medical Analysis)"

# 3. 启动Jupyter(可以在任何环境)
jupyter notebook

# 4. 创建notebook时选择kernel:
# Kernel → Change kernel → Python (Medical Analysis)
```

**好处**: 在一个Jupyter中切换多个环境!

#### 查看已注册的kernels

```bash
jupyter kernelspec list

# 输出:
# Available kernels:
#   medical_analysis    /Users/xxx/Library/Jupyter/kernels/medical_analysis
#   python3             /opt/anaconda3/share/jupyter/kernels/python3
```

#### 删除kernel

```bash
jupyter kernelspec uninstall medical_analysis
```

## 常见问题

### Q1: 激活环境后,import仍然找不到包

**原因**: VSCode/IDE没有切换到正确的环境

**解决**:
1. 在VSCode中重新选择Python解释器
2. 重启VSCode
3. 在终端验证:
   ```bash
   which python  # 应该指向虚拟环境
   pip list  # 应该显示虚拟环境的包
   ```

### Q2: conda activate报错"command not found"

**原因**: conda未正确初始化

**解决**:
```bash
# 初始化conda
conda init bash  # Mac/Linux
conda init powershell  # Windows PowerShell

# 重启终端生效
```

### Q3: Windows PowerShell无法激活环境

**错误**: "cannot be loaded because running scripts is disabled"

**解决**:
```powershell
# 以管理员身份运行PowerShell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

### Q4: 环境太大,占用空间多

**检查大小**:
```bash
du -sh ~/anaconda3/envs/*  # Mac/Linux
```

**解决**:
1. 删除不用的环境
2. 清理缓存: `conda clean --all`
3. 使用venv代替conda(更轻量)

### Q5: base环境被污染,装了很多包

**建议**:
- **不要在base环境装包!**
- base只保留conda本身
- 所有项目都创建独立环境

**补救**:
```bash
# 重置base环境(谨慎!)
conda install --revision 0
```

## 最佳实践

### 1. 环境命名规范

```bash
✓ project_name       # 以项目命名
✓ covid19_analysis
✓ py311_test         # 包含Python版本信息

✗ env1, test, temp   # 无意义名称
```

### 2. 一个项目一个环境

```bash
不要:
所有项目共用一个环境

要:
每个项目独立环境,互不干扰
```

### 3. 及时导出environment.yml

```bash
# 项目达到阶段性成果时
conda env export > environment.yml

# 提交到Git
git add environment.yml
git commit -m "Add environment config"
```

### 4. 保持base环境干净

```bash
# 错误做法:
conda activate base
conda install pandas numpy ...  # ✗ 不要这样!

# 正确做法:
conda create -n my_project python=3.11
conda activate my_project
conda install pandas numpy  # ✓ 在专用环境安装
```

### 5. 定期清理不用的环境

```bash
# 查看所有环境
conda env list

# 删除旧环境
conda remove -n old_project --all

# 清理缓存
conda clean --all
```

## 实战练习

### 练习1: 创建第一个虚拟环境

```bash
# 1. 创建环境
conda create -n my_first_env python=3.11 pandas

# 2. 激活环境
conda activate my_first_env

# 3. 验证
python -c "import pandas; print(pandas.__version__)"

# 4. 退出
conda deactivate

# 5. 删除
conda remove -n my_first_env --all
```

### 练习2: 环境导出与导入

```bash
# 1. 创建并配置环境
conda create -n export_test python=3.11
conda activate export_test
conda install pandas numpy

# 2. 导出
conda env export > test_env.yml

# 3. 删除原环境
conda deactivate
conda remove -n export_test --all

# 4. 从配置文件重建
conda env create -f test_env.yml

# 5. 验证
conda activate export_test
python -c "import pandas; print('Success!')"
```

### 练习3: 多环境切换

```bash
# 1. 创建两个环境
conda create -n env_a python=3.9
conda create -n env_b python=3.11

# 2. 切换练习
conda activate env_a
python --version  # 应显示 3.9.x

conda activate env_b
python --version  # 应显示 3.11.x

# 3. 清理
conda deactivate
conda remove -n env_a --all
conda remove -n env_b --all
```

## 检查清单

- [ ] 理解虚拟环境的作用
- [ ] 能够创建conda环境
- [ ] 能够激活和退出环境
- [ ] 会查看已有环境列表
- [ ] 会删除不需要的环境
- [ ] 会导出environment.yml
- [ ] 会从配置文件创建环境
- [ ] 知道如何在VSCode中选择环境
- [ ] 知道如何为Jupyter添加kernel
- [ ] 养成"一个项目一个环境"的习惯

## 下一步

- **5.7 Git基础**: 版本控制,与虚拟环境配合管理项目
- **第6章**: AI辅助学习编程
- **实战项目(第9-13章)**: 每个项目创建独立环境

## 命令速查

### conda环境
```bash
conda create -n 环境名 python=版本  # 创建
conda activate 环境名               # 激活
conda deactivate                    # 退出
conda env list                      # 查看列表
conda remove -n 环境名 --all        # 删除
conda env export > env.yml          # 导出
conda env create -f env.yml         # 导入
```

### venv环境
```bash
python -m venv venv                 # 创建
source venv/bin/activate            # 激活(Mac/Linux)
venv\Scripts\activate               # 激活(Windows)
deactivate                          # 退出
rm -rf venv                         # 删除
pip freeze > requirements.txt       # 导出
pip install -r requirements.txt     # 导入
```

## 资源

- conda文档: https://docs.conda.io/projects/conda/en/latest/user-guide/tasks/manage-environments.html
- venv文档: https://docs.python.org/3/library/venv.html
- environment.yml示例: https://conda.io/projects/conda/en/latest/user-guide/tasks/manage-environments.html#create-env-file-manually
