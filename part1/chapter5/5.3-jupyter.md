# 5.3 Jupyter Notebook实战

## 什么是Jupyter Notebook?

Jupyter Notebook 就像是"可执行的实验记录本":
- **传统记录本**: 写文字描述 + 手绘图表
- **Jupyter**: 写代码 + 自动生成图表 + 说明文字,一切都在同一个文档中

类比医学:
```
传统方式: 病历本(文字) + 检验单(数据) + X光片(图像) → 分散
Jupyter: 所有内容整合在一个交互式文档中 → 完整病例报告
```

## Jupyter的核心概念

### Cell (单元格)

Jupyter文档由一个个"单元格"组成,每个单元格可以是:

**1. 代码单元格** (Code Cell)
```python
import pandas as pd
df = pd.read_csv('patients.csv')
df.head()
```
运行后,结果直接显示在单元格下方。

**2. 文本单元格** (Markdown Cell)
```markdown
## 数据分析报告
本次分析包含**100名**患者的血压数据。
```
用于写说明文字、标题、总结等。

### Kernel (内核)

Kernel = 运行代码的"引擎"
- 一个Notebook对应一个Kernel
- Kernel记住你定义的所有变量
- 重启Kernel = 清空所有变量,从头开始

## 启动Jupyter的三种方式

### 方式1: 通过Anaconda Navigator(最简单)

1. 打开 Anaconda Navigator
2. 找到 "Jupyter Notebook",点击 "Launch"
3. 自动打开浏览器,显示文件列表

### 方式2: 通过命令行(最常用)

1. 打开终端 (Mac) 或 Anaconda Prompt (Windows)
2. 进入工作目录:
   ```bash
   cd ~/medical_projects
   ```
3. 启动Jupyter:
   ```bash
   jupyter notebook
   ```
4. 自动打开浏览器

### 方式3: 在VSCode中使用(最强大)

1. 在VSCode中创建新文件
2. 保存为 `.ipynb` 扩展名
3. 自动激活Jupyter功能(需要安装Jupyter扩展)

**优势**: 结合了VSCode的强大功能和Jupyter的交互性!

## 创建第一个Notebook

### 步骤

1. 在Jupyter主界面,点击右上角 "New" → "Python 3"
2. 新Notebook会自动打开
3. 重命名: 点击顶部 "Untitled" → 输入 "患者数据分析"

### Notebook界面说明

```
┌─────────────────────────────────────┐
│  患者数据分析.ipynb           ■ ▶ ⏹  │  ← 工具栏
├─────────────────────────────────────┤
│  In [1]: import pandas as pd        │  ← 代码单元格
│         df = pd.read_csv('...')     │
│                                      │
│  [Shift+Enter运行]                  │
├─────────────────────────────────────┤
│  Out[1]:                             │  ← 输出区域
│         患者ID  年龄  性别  血压      │
│         001    45   男   120/80     │
│         ...                          │
└─────────────────────────────────────┘
```

## 基本操作

### 运行单元格

**方法1**: 点击单元格左侧的"▶"按钮
**方法2**: 快捷键(推荐)
- `Shift + Enter`: 运行当前单元格,跳到下一个
- `Ctrl + Enter`: 运行当前单元格,停留在原地
- `Alt + Enter`: 运行当前单元格,下方插入新单元格

### 添加单元格

- 按 `A` (Above): 在当前单元格上方插入
- 按 `B` (Below): 在当前单元格下方插入
- 或点击工具栏的"+"按钮

### 切换单元格类型

- 按 `M`: 切换为Markdown(文本)
- 按 `Y`: 切换为Code(代码)
- 或使用工具栏下拉菜单

### 删除单元格

- 按两次 `D` (即按 `DD`)
- 或点击工具栏的剪刀图标

### 模式切换

Jupyter有两种模式:

**命令模式** (蓝色边框)
- 用于操作单元格(添加、删除、移动)
- 按 `Esc` 进入

**编辑模式** (绿色边框)
- 用于编辑单元格内容
- 按 `Enter` 进入,或直接点击单元格

## 实战案例:分析患者血压数据

### 完整工作流程

#### Cell 1: 标题和说明 (Markdown)

```markdown
# 患者血压数据分析报告

**分析日期**: 2025-01-15
**数据来源**: 心内科住院患者
**样本量**: 50人

## 分析目标
1. 描述性统计
2. 血压分布可视化
3. 识别高血压患者
```

#### Cell 2: 导入库 (Code)

```python
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

# 设置中文显示
plt.rcParams['font.sans-serif'] = ['Arial Unicode MS']  # Mac
# plt.rcParams['font.sans-serif'] = ['SimHei']  # Windows
plt.rcParams['axes.unicode_minus'] = False

print("库导入成功!")
```

**运行结果**:
```
库导入成功!
```

#### Cell 3: 读取数据 (Code)

```python
# 读取CSV文件
df = pd.read_csv('blood_pressure_data.csv')

# 查看前5行
df.head()
```

**运行结果**: 显示表格
```
   患者ID  年龄  性别  收缩压  舒张压
0   P001  45   男   128    82
1   P002  52   女   135    88
2   P003  38   男   118    75
...
```

#### Cell 4: 数据概览 (Code)

```python
print(f"数据形状: {df.shape}")
print(f"\n数据类型:\n{df.dtypes}")
print(f"\n缺失值:\n{df.isnull().sum()}")
```

#### Cell 5: 描述性统计 (Code)

```python
df[['收缩压', '舒张压']].describe()
```

**运行结果**: 自动显示漂亮的统计表格

#### Cell 6: 分析总结 (Markdown)

```markdown
## 主要发现

- 平均收缩压: 132 mmHg
- 平均舒张压: 84 mmHg
- **30%的患者收缩压超过140** (需要关注)
```

#### Cell 7: 可视化 (Code)

```python
fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(12, 4))

# 收缩压分布
ax1.hist(df['收缩压'], bins=15, color='steelblue', alpha=0.7)
ax1.axvline(140, color='red', linestyle='--', label='高血压界值')
ax1.set_xlabel('收缩压 (mmHg)')
ax1.set_ylabel('人数')
ax1.set_title('收缩压分布')
ax1.legend()

# 年龄与血压关系
ax2.scatter(df['年龄'], df['收缩压'], alpha=0.6)
ax2.set_xlabel('年龄')
ax2.set_ylabel('收缩压 (mmHg)')
ax2.set_title('年龄与血压关系')

plt.tight_layout()
plt.show()
```

**运行结果**: 图表直接显示在单元格下方!

#### Cell 8: 筛选高血压患者 (Code)

```python
# 定义高血压标准
hypertension = df[(df['收缩压'] >= 140) | (df['舒张压'] >= 90)]

print(f"高血压患者数量: {len(hypertension)}")
print(f"占比: {len(hypertension)/len(df)*100:.1f}%")

# 显示这些患者
hypertension[['患者ID', '年龄', '性别', '收缩压', '舒张压']]
```

#### Cell 9: 导出结果 (Code)

```python
# 保存高血压患者名单
hypertension.to_csv('高血压患者名单.csv', index=False, encoding='utf-8-sig')
print("✓ 已保存到 高血压患者名单.csv")

# 保存完整分析报告(包含代码和结果)
# 在菜单栏: File > Download as > HTML
```

## Jupyter高级技巧

### 1. Magic命令

Magic命令是Jupyter的特殊功能,以 `%` 或 `%%` 开头:

```python
# 显示当前目录
%pwd

# 列出文件
%ls

# 测量代码运行时间
%timeit df.mean()

# 显示所有变量
%whos

# 运行外部Python文件
%run my_script.py
```

### 2. 单元格内运行Shell命令

```python
# 安装新库(在Notebook中直接安装)
!pip install seaborn

# 查看文件内容
!head data.csv

# 复制文件
!cp source.csv backup.csv
```

### 3. 隐藏长输出

```python
# 分号结尾 = 不显示输出
df.head();  # 只执行,不显示

# 双分号 = 不显示,也不记录到Out[]
df.head();;
```

### 4. 显示多个输出

默认只显示最后一个表达式,如果想显示多个:

```python
from IPython.display import display

display(df.head())
display(df.describe())
display(df.info())
```

### 5. 变量跨单元格传递

```python
# Cell 1
patient_name = "张三"
age = 45

# Cell 2 (可以直接使用)
print(f"{patient_name}, {age}岁")  # 输出: 张三, 45岁
```

**注意**: 执行顺序很重要!如果先运行Cell 2会报错(变量未定义)。

### 6. 导出为其他格式

菜单栏: `File > Download as`

- **HTML**: 包含代码、输出、图表,可以直接发给导师看
- **PDF**: 需要安装LaTeX,适合正式报告
- **Python (.py)**: 只保留代码,去除输出
- **Markdown**: 纯文本格式

## VSCode中使用Jupyter

### 优势

1. **自动补全更强大** (VSCode的智能感知)
2. **多文件对照** (分屏编辑)
3. **Git集成** (版本控制)
4. **AI辅助** (Copilot等)

### 在VSCode中操作Jupyter

1. **创建Notebook**:
   - 新建文件,保存为 `.ipynb`
   - 或 `Cmd/Ctrl + Shift + P` → "Create: New Jupyter Notebook"

2. **运行单元格**:
   - 点击单元格左侧的"▶"
   - 或 `Shift + Enter`

3. **选择Kernel**:
   - 点击右上角的Kernel选择器
   - 选择Python环境

4. **变量查看器**:
   - 点击顶部的"Variables"按钮
   - 实时查看所有变量的值

## 最佳实践

### 1. 组织结构

推荐的Notebook结构:
```
1. 标题 + 目标说明 (Markdown)
2. 导入库 (Code)
3. 读取数据 (Code)
4. 数据清洗 (Code + Markdown说明)
5. 探索性分析 (Code + Markdown + 可视化)
6. 主要分析 (Code + Markdown)
7. 结论总结 (Markdown)
8. 导出结果 (Code)
```

### 2. 命名规范

```python
# ✓ 好的命名
blood_pressure_analysis.ipynb
2025-01-15_patient_followup.ipynb

# ✗ 不好的命名
Untitled1.ipynb
新建文档.ipynb
test123.ipynb
```

### 3. 单元格粒度

**一个单元格做一件事**:
```python
# ✓ 好的做法
# Cell 1: 只读取数据
df = pd.read_csv('data.csv')

# Cell 2: 只清洗数据
df = df.dropna()

# Cell 3: 只做统计
df.describe()

# ✗ 不好的做法 - 全部堆在一个单元格
df = pd.read_csv('data.csv')
df = df.dropna()
df.describe()
# ... 100行代码 ...
```

**好处**:
- 方便调试(只重新运行出错的部分)
- 容易理解
- 可以灵活调整顺序

### 4. 添加说明

```python
# Cell 1: Markdown
"""
## 数据清洗
处理以下问题:
- 删除重复记录
- 填充缺失值
- 修正异常值
"""

# Cell 2: Code
df = df.drop_duplicates()  # 去重
df['age'].fillna(df['age'].median(), inplace=True)  # 填充年龄缺失值
```

### 5. 重启Kernel的时机

**需要重启**:
- 代码逻辑混乱,想从头开始
- 变量定义冲突
- 导入了新的库

**操作**:
- 菜单栏: `Kernel > Restart`
- 或按钮: ⟳

**重启并运行所有单元格**:
- `Kernel > Restart & Run All`
- 用于验证整个分析流程

## 常见问题

### Q1: 单元格运行后一直显示 `In [*]`

**原因**: 代码正在运行(或卡住)

**解决**:
- 等待运行完成
- 或点击工具栏的"■"(停止)按钮
- 或 `Kernel > Interrupt`

### Q2: 变量找不到

**检查**:
1. 是否运行过定义该变量的单元格?
2. 运行顺序是否正确?
3. 是否重启过Kernel但忘了重新运行?

**解决**: `Kernel > Restart & Run All` 从头运行

### Q3: 中文显示为方块

**原因**: matplotlib默认字体不支持中文

**解决**: 在导入库后添加:
```python
import matplotlib.pyplot as plt

# Mac
plt.rcParams['font.sans-serif'] = ['Arial Unicode MS']

# Windows
# plt.rcParams['font.sans-serif'] = ['SimHei']

plt.rcParams['axes.unicode_minus'] = False
```

### Q4: 图片太小看不清

**调整图片大小**:
```python
plt.figure(figsize=(12, 6))  # 宽12英寸,高6英寸
plt.plot(...)
```

### Q5: 在VSCode中Jupyter无法启动

**检查**:
1. 是否安装了Jupyter扩展?
2. 是否选择了正确的Python解释器?
3. 是否安装了jupyter包?
   ```bash
   pip install jupyter
   ```

## 实战练习

### 练习1: 创建你的第一个分析报告

创建 `first_analysis.ipynb`,包含:
1. Markdown单元格: 写标题和分析目标
2. Code单元格: 导入pandas, numpy
3. Code单元格: 创建示例数据(5个患者的年龄、性别、血压)
4. Code单元格: 显示数据
5. Code单元格: 计算平均血压
6. Markdown单元格: 写总结
7. 导出为HTML

### 练习2: 使用Magic命令

1. 用 `%pwd` 查看当前目录
2. 用 `%timeit` 测试 `df.mean()` 的运行时间
3. 用 `!pip list` 查看已安装的包

### 练习3: 在VSCode中使用Jupyter

1. 在VSCode中创建 `vscode_jupyter.ipynb`
2. 尝试变量查看器功能
3. 分屏对照一个.py文件编辑

## 检查清单

- [ ] 能够启动Jupyter Notebook
- [ ] 理解Cell和Kernel的概念
- [ ] 熟练运行、添加、删除单元格
- [ ] 掌握命令模式和编辑模式的切换
- [ ] 能够切换Code和Markdown单元格
- [ ] 完成一个完整的数据分析Notebook
- [ ] 知道如何重启Kernel
- [ ] 能够导出Notebook为HTML
- [ ] (可选)在VSCode中使用Jupyter

## 下一步

- **5.4 终端/命令行基础**: 学习命令行操作
- **5.5 包管理**: 用pip和conda安装Python库
- **第9-13章**: 使用Jupyter完成实战项目

## 资源

- Jupyter官方文档: https://jupyter-notebook.readthedocs.io
- 快捷键列表: 在Notebook中按 `H` 键
- VSCode Jupyter教程: https://code.visualstudio.com/docs/datascience/jupyter-notebooks
