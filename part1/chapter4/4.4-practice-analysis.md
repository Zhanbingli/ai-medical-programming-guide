# 4.4 实战:分析临床试验数据

## 项目背景

### 研究设计

**研究题目**:新型降压药物多中心随机对照试验

**研究目标**:评估新药相比安慰剂的降压效果

**研究设计**:
- 样本量: 200名高血压患者
- 分组: 对照组(安慰剂)100人,治疗组(新药)100人
- 随访时间: 12周
- 主要终点: 收缩压降低幅度
- 次要终点: 达标率(<140/90 mmHg)

### 数据文件

**trial_data.csv**包含以下字段:
- 患者ID
- 组别(对照组/治疗组)
- 年龄、性别
- 基线血压(收缩压、舒张压)
- 基线心率、BMI
- 随访血压(4周、8周、12周)
- 不良反应

## 项目目标

使用Python完成:
1. ✅ 数据导入和清洗
2. ✅ 描述性统计分析
3. ✅ 组间基线比较
4. ✅ 降压效果分析
5. ✅ 可视化展示
6. ✅ 生成分析报告

## 步骤1:准备数据

### 1.1 生成模拟数据

```python
import pandas as pd
import numpy as np

def generate_trial_data(n=200, seed=42):
    """生成模拟临床试验数据"""

    np.random.seed(seed)

    # 基本信息
    patient_ids = [f"P{i:04d}" for i in range(1, n+1)]
    groups = ['对照组'] * (n//2) + ['治疗组'] * (n//2)
    np.random.shuffle(groups)

    ages = np.random.normal(55, 12, n).astype(int)
    ages = np.clip(ages, 25, 80)

    genders = np.random.choice(['男', '女'], n, p=[0.55, 0.45])

    # 基线数据
    baseline_sbp = np.random.normal(155, 15, n)
    baseline_dbp = np.random.normal(95, 10, n)
    baseline_hr = np.random.normal(75, 10, n).astype(int)
    bmi = np.random.normal(26, 4, n)

    # 随访数据
    followup_4w_sbp = []
    followup_8w_sbp = []
    followup_12w_sbp = []
    followup_4w_dbp = []
    followup_8w_dbp = []
    followup_12w_dbp = []

    for i in range(n):
        if groups[i] == '对照组':
            # 对照组:轻微下降
            reduce_4w = np.random.normal(5, 8, 1)[0]
            reduce_8w = np.random.normal(7, 10, 1)[0]
            reduce_12w = np.random.normal(8, 12, 1)[0]
        else:
            # 治疗组:显著下降
            reduce_4w = np.random.normal(15, 8, 1)[0]
            reduce_8w = np.random.normal(22, 10, 1)[0]
            reduce_12w = np.random.normal(25, 12, 1)[0]

        followup_4w_sbp.append(baseline_sbp[i] - reduce_4w)
        followup_8w_sbp.append(baseline_sbp[i] - reduce_8w)
        followup_12w_sbp.append(baseline_sbp[i] - reduce_12w)

        followup_4w_dbp.append(baseline_dbp[i] - reduce_4w * 0.6)
        followup_8w_dbp.append(baseline_dbp[i] - reduce_8w * 0.6)
        followup_12w_dbp.append(baseline_dbp[i] - reduce_12w * 0.6)

    # 创建DataFrame
    df = pd.DataFrame({
        '患者ID': patient_ids,
        '组别': groups,
        '年龄': ages,
        '性别': genders,
        '基线收缩压': baseline_sbp,
        '基线舒张压': baseline_dbp,
        '基线心率': baseline_hr,
        'BMI': bmi,
        '4周收缩压': followup_4w_sbp,
        '8周收缩压': followup_8w_sbp,
        '12周收缩压': followup_12w_sbp,
        '4周舒张压': followup_4w_dbp,
        '8周舒张压': followup_8w_dbp,
        '12周舒张压': followup_12w_dbp
    })

    # 保存
    df.to_csv('trial_data.csv', index=False, encoding='utf-8-sig')
    print("✓ 模拟数据已生成: trial_data.csv")

    return df

# 生成数据
df = generate_trial_data()
```

### 1.2 数据导入和检查

```python
import pandas as pd
import numpy as np

# 读取数据
df = pd.read_csv('trial_data.csv')

print("="*70)
print("数据导入检查")
print("="*70)

# 基本信息
print(f"\n总样本量: {len(df)}例")
print(f"数据维度: {df.shape}")
print(f"\n数据列:\n{df.columns.tolist()}")

# 前5行
print(f"\n前5行数据:")
print(df.head())

# 数据类型
print(f"\n数据类型:")
print(df.dtypes)

# 缺失值检查
print(f"\n缺失值统计:")
missing = df.isnull().sum()
if missing.sum() == 0:
    print("  ✓ 无缺失值")
else:
    print(missing[missing > 0])

print("="*70)
```

## 步骤2:描述性统计

```python
import pandas as pd
import numpy as np

df = pd.read_csv('trial_data.csv')

print("="*70)
print("全体患者基线特征")
print("="*70)

# 基本信息
print(f"\n样本量: {len(df)}例")

# 年龄
print(f"\n年龄 (岁):")
print(f"  均值 ± 标准差: {df['年龄'].mean():.1f} ± {df['年龄'].std():.1f}")
print(f"  中位数 [IQR]: {df['年龄'].median():.0f} [{df['年龄'].quantile(0.25):.0f}-{df['年龄'].quantile(0.75):.0f}]")
print(f"  范围: {df['年龄'].min()}-{df['年龄'].max()}")

# 性别
print(f"\n性别:")
gender_count = df['性别'].value_counts()
for gender, count in gender_count.items():
    pct = count / len(df) * 100
    print(f"  {gender}: {count}例 ({pct:.1f}%)")

# 基线血压
print(f"\n基线收缩压 (mmHg):")
print(f"  {df['基线收缩压'].mean():.1f} ± {df['基线收缩压'].std():.1f}")

print(f"\n基线舒张压 (mmHg):")
print(f"  {df['基线舒张压'].mean():.1f} ± {df['基线舒张压'].std():.1f}")

# BMI
print(f"\nBMI (kg/m²):")
print(f"  {df['BMI'].mean():.1f} ± {df['BMI'].std():.1f}")

print("="*70)
```

## 步骤3:基线特征比较

```python
import pandas as pd
import numpy as np
from scipy import stats

df = pd.read_csv('trial_data.csv')

# 分组
control = df[df['组别'] == '对照组']
treatment = df[df['组别'] == '治疗组']

print("="*70)
print("基线特征组间比较")
print("="*70)

# 样本量
print(f"\n样本量:")
print(f"  对照组: {len(control)}例")
print(f"  治疗组: {len(treatment)}例")

# 年龄
print(f"\n年龄 (岁):")
print(f"  对照组: {control['年龄'].mean():.1f} ± {control['年龄'].std():.1f}")
print(f"  治疗组: {treatment['年龄'].mean():.1f} ± {treatment['年龄'].std():.1f}")
t_stat, p_val = stats.ttest_ind(control['年龄'], treatment['年龄'])
print(f"  P值: {p_val:.3f}")

# 性别
print(f"\n性别 (男性%):")
control_male_pct = (control['性别'] == '男').sum() / len(control) * 100
treatment_male_pct = (treatment['性别'] == '男').sum() / len(treatment) * 100
print(f"  对照组: {control_male_pct:.1f}%")
print(f"  治疗组: {treatment_male_pct:.1f}%")

# 卡方检验
contingency_table = pd.crosstab(df['组别'], df['性别'])
chi2, p_val, dof, expected = stats.chi2_contingency(contingency_table)
print(f"  P值: {p_val:.3f}")

# 基线收缩压
print(f"\n基线收缩压 (mmHg):")
print(f"  对照组: {control['基线收缩压'].mean():.1f} ± {control['基线收缩压'].std():.1f}")
print(f"  治疗组: {treatment['基线收缩压'].mean():.1f} ± {treatment['基线收缩压'].std():.1f}")
t_stat, p_val = stats.ttest_ind(control['基线收缩压'], treatment['基线收缩压'])
print(f"  P值: {p_val:.3f}")

# 基线舒张压
print(f"\n基线舒张压 (mmHg):")
print(f"  对照组: {control['基线舒张压'].mean():.1f} ± {control['基线舒张压'].std():.1f}")
print(f"  治疗组: {treatment['基线舒张压'].mean():.1f} ± {treatment['基线舒张压'].std():.1f}")
t_stat, p_val = stats.ttest_ind(control['基线舒张压'], treatment['基线舒张压'])
print(f"  P值: {p_val:.3f}")

# BMI
print(f"\nBMI (kg/m²):")
print(f"  对照组: {control['BMI'].mean():.1f} ± {control['BMI'].std():.1f}")
print(f"  治疗组: {treatment['BMI'].mean():.1f} ± {treatment['BMI'].std():.1f}")
t_stat, p_val = stats.ttest_ind(control['BMI'], treatment['BMI'])
print(f"  P值: {p_val:.3f}")

print("\n结论: 两组基线特征均衡可比 (P>0.05)")
print("="*70)
```

## 步骤4:主要疗效分析

```python
import pandas as pd
import numpy as np
from scipy import stats

df = pd.read_csv('trial_data.csv')

# 计算血压变化
df['收缩压变化'] = df['12周收缩压'] - df['基线收缩压']
df['舒张压变化'] = df['12周舒张压'] - df['基线舒张压']

# 分组
control = df[df['组别'] == '对照组']
treatment = df[df['组别'] == '治疗组']

print("="*70)
print("主要疗效分析 (12周)")
print("="*70)

# 收缩压变化
print(f"\n收缩压变化 (mmHg):")
print(f"  对照组: {-control['收缩压变化'].mean():.1f} ± {control['收缩压变化'].std():.1f}")
print(f"  治疗组: {-treatment['收缩压变化'].mean():.1f} ± {treatment['收缩压变化'].std():.1f}")

t_stat, p_val = stats.ttest_ind(control['收缩压变化'], treatment['收缩压变化'])
diff = treatment['收缩压变化'].mean() - control['收缩压变化'].mean()
print(f"  组间差异: {-diff:.1f} mmHg")
print(f"  P值: {p_val:.4f}")
print(f"  结论: {'有统计学差异 ✓' if p_val < 0.05 else '无统计学差异'}")

# 舒张压变化
print(f"\n舒张压变化 (mmHg):")
print(f"  对照组: {-control['舒张压变化'].mean():.1f} ± {control['舒张压变化'].std():.1f}")
print(f"  治疗组: {-treatment['舒张压变化'].mean():.1f} ± {treatment['舒张压变化'].std():.1f}")

t_stat, p_val = stats.ttest_ind(control['舒张压变化'], treatment['舒张压变化'])
diff = treatment['舒张压变化'].mean() - control['舒张压变化'].mean()
print(f"  组间差异: {-diff:.1f} mmHg")
print(f"  P值: {p_val:.4f}")
print(f"  结论: {'有统计学差异 ✓' if p_val < 0.05 else '无统计学差异'}")

# 达标率
print(f"\n血压达标率 (<140/90 mmHg):")
control_target = ((control['12周收缩压'] < 140) & (control['12周舒张压'] < 90)).sum()
treatment_target = ((treatment['12周收缩压'] < 140) & (treatment['12周舒张压'] < 90)).sum()

control_target_pct = control_target / len(control) * 100
treatment_target_pct = treatment_target / len(treatment) * 100

print(f"  对照组: {control_target}/{len(control)} ({control_target_pct:.1f}%)")
print(f"  治疗组: {treatment_target}/{len(treatment)} ({treatment_target_pct:.1f}%)")
print(f"  差异: {treatment_target_pct - control_target_pct:.1f}%")

# 卡方检验
contingency = pd.crosstab(
    df['组别'],
    (df['12周收缩压'] < 140) & (df['12周舒张压'] < 90)
)
chi2, p_val, dof, expected = stats.chi2_contingency(contingency)
print(f"  P值: {p_val:.4f}")
print(f"  结论: {'有统计学差异 ✓' if p_val < 0.05 else '无统计学差异'}")

print("="*70)
```

## 步骤5:数据可视化

```python
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

# 配置中文
plt.rcParams['font.sans-serif'] = ['SimHei']
plt.rcParams['axes.unicode_minus'] = False

df = pd.read_csv('trial_data.csv')
df['收缩压变化'] = df['12周收缩压'] - df['基线收缩压']

control = df[df['组别'] == '对照组']
treatment = df[df['组别'] == '治疗组']

# 创建图表
fig = plt.figure(figsize=(16, 12))

# 子图1:基线血压分布
ax1 = plt.subplot(2, 3, 1)
ax1.boxplot([control['基线收缩压'], treatment['基线收缩压']],
           labels=['对照组', '治疗组'])
ax1.set_ylabel('收缩压 (mmHg)')
ax1.set_title('基线收缩压分布')
ax1.grid(True, alpha=0.3, axis='y')

# 子图2:12周血压分布
ax2 = plt.subplot(2, 3, 2)
ax2.boxplot([control['12周收缩压'], treatment['12周收缩压']],
           labels=['对照组', '治疗组'])
ax2.set_ylabel('收缩压 (mmHg)')
ax2.set_title('12周收缩压分布')
ax2.axhline(y=140, color='r', linestyle='--', alpha=0.5)
ax2.grid(True, alpha=0.3, axis='y')

# 子图3:降压幅度对比
ax3 = plt.subplot(2, 3, 3)
reduction_data = [-control['收缩压变化'].mean(), -treatment['收缩压变化'].mean()]
bars = ax3.bar(['对照组', '治疗组'], reduction_data, color=['lightcoral', 'lightblue'])
ax3.set_ylabel('降压幅度 (mmHg)')
ax3.set_title('平均降压效果')
ax3.grid(True, alpha=0.3, axis='y')

# 添加数值标签
for bar in bars:
    height = bar.get_height()
    ax3.text(bar.get_x() + bar.get_width()/2., height,
            f'{height:.1f}', ha='center', va='bottom')

# 子图4:血压变化散点图(对照组)
ax4 = plt.subplot(2, 3, 4)
ax4.scatter(control['基线收缩压'], control['12周收缩压'], alpha=0.6)
ax4.plot([90, 180], [90, 180], 'r--', label='无变化线')
ax4.set_xlabel('基线收缩压 (mmHg)')
ax4.set_ylabel('12周收缩压 (mmHg)')
ax4.set_title('对照组血压变化')
ax4.legend()
ax4.grid(True, alpha=0.3)

# 子图5:血压变化散点图(治疗组)
ax5 = plt.subplot(2, 3, 5)
ax5.scatter(treatment['基线收缩压'], treatment['12周收缩压'],
           alpha=0.6, color='green')
ax5.plot([90, 180], [90, 180], 'r--', label='无变化线')
ax5.set_xlabel('基线收缩压 (mmHg)')
ax5.set_ylabel('12周收缩压 (mmHg)')
ax5.set_title('治疗组血压变化')
ax5.legend()
ax5.grid(True, alpha=0.3)

# 子图6:达标率对比
ax6 = plt.subplot(2, 3, 6)
control_target_pct = ((control['12周收缩压'] < 140) &
                     (control['12周舒张压'] < 90)).sum() / len(control) * 100
treatment_target_pct = ((treatment['12周收缩压'] < 140) &
                       (treatment['12周舒张压'] < 90)).sum() / len(treatment) * 100

bars = ax6.bar(['对照组', '治疗组'],
              [control_target_pct, treatment_target_pct],
              color=['lightcoral', 'lightblue'])
ax6.set_ylabel('达标率 (%)')
ax6.set_title('血压达标率 (<140/90 mmHg)')
ax6.set_ylim([0, 100])

for bar in bars:
    height = bar.get_height()
    ax6.text(bar.get_x() + bar.get_width()/2., height,
            f'{height:.1f}%', ha='center', va='bottom')

plt.suptitle('降压药物临床试验可视化分析', fontsize=16, fontweight='bold')
plt.tight_layout()
plt.savefig('trial_analysis.png', dpi=300, bbox_inches='tight')
plt.show()

print("✓ 可视化图表已保存: trial_analysis.png")
```

## 步骤6:生成完整报告

```python
import pandas as pd
import numpy as np
from scipy import stats
from datetime import datetime

df = pd.read_csv('trial_data.csv')
df['收缩压变化'] = df['12周收缩压'] - df['基线收缩压']
df['舒张压变化'] = df['12周舒张压'] - df['基线舒张压']

control = df[df['组别'] == '对照组']
treatment = df[df['组别'] == '治疗组']

# 生成报告
report = []
report.append("="*70)
report.append("降压药物临床试验统计分析报告")
report.append("="*70)
report.append(f"报告生成时间: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")

# 1. 研究概况
report.append("一、研究概况")
report.append("-"*70)
report.append(f"研究题目: 新型降压药物多中心随机对照试验")
report.append(f"样本量: {len(df)}例")
report.append(f"  对照组: {len(control)}例")
report.append(f"  治疗组: {len(treatment)}例")
report.append(f"随访时间: 12周\n")

# 2. 基线特征
report.append("二、基线特征")
report.append("-"*70)

# 年龄
t_stat, p_age = stats.ttest_ind(control['年龄'], treatment['年龄'])
report.append(f"年龄 (岁):")
report.append(f"  对照组: {control['年龄'].mean():.1f} ± {control['年龄'].std():.1f}")
report.append(f"  治疗组: {treatment['年龄'].mean():.1f} ± {treatment['年龄'].std():.1f}")
report.append(f"  P值: {p_age:.3f}\n")

# 性别
contingency = pd.crosstab(df['组别'], df['性别'])
chi2, p_gender, dof, expected = stats.chi2_contingency(contingency)
control_male_pct = (control['性别'] == '男').sum() / len(control) * 100
treatment_male_pct = (treatment['性别'] == '男').sum() / len(treatment) * 100
report.append(f"性别 (男性%):")
report.append(f"  对照组: {control_male_pct:.1f}%")
report.append(f"  治疗组: {treatment_male_pct:.1f}%")
report.append(f"  P值: {p_gender:.3f}\n")

# 基线血压
t_stat, p_sbp = stats.ttest_ind(control['基线收缩压'], treatment['基线收缩压'])
report.append(f"基线收缩压 (mmHg):")
report.append(f"  对照组: {control['基线收缩压'].mean():.1f} ± {control['基线收缩压'].std():.1f}")
report.append(f"  治疗组: {treatment['基线收缩压'].mean():.1f} ± {treatment['基线收缩压'].std():.1f}")
report.append(f"  P值: {p_sbp:.3f}\n")

report.append(f"结论: 两组基线特征均衡可比 (P>0.05)\n")

# 3. 主要疗效分析
report.append("三、主要疗效分析 (12周)")
report.append("-"*70)

# 收缩压变化
t_stat, p_sbp_change = stats.ttest_ind(control['收缩压变化'], treatment['收缩压变化'])
diff_sbp = treatment['收缩压变化'].mean() - control['收缩压变化'].mean()
report.append(f"收缩压变化 (mmHg):")
report.append(f"  对照组: {-control['收缩压变化'].mean():.1f} ± {control['收缩压变化'].std():.1f}")
report.append(f"  治疗组: {-treatment['收缩压变化'].mean():.1f} ± {treatment['收缩压变化'].std():.1f}")
report.append(f"  组间差异: {-diff_sbp:.1f} mmHg")
report.append(f"  P值: {p_sbp_change:.4f}")
report.append(f"  结论: {'有统计学差异(P<0.05)' if p_sbp_change < 0.05 else '无统计学差异'}\n")

# 达标率
control_target = ((control['12周收缩压'] < 140) & (control['12周舒张压'] < 90)).sum()
treatment_target = ((treatment['12周收缩压'] < 140) & (treatment['12周舒张压'] < 90)).sum()
control_target_pct = control_target / len(control) * 100
treatment_target_pct = treatment_target / len(treatment) * 100

contingency = pd.crosstab(
    df['组别'],
    (df['12周收缩压'] < 140) & (df['12周舒张压'] < 90)
)
chi2, p_target, dof, expected = stats.chi2_contingency(contingency)

report.append(f"血压达标率 (<140/90 mmHg):")
report.append(f"  对照组: {control_target}/{len(control)} ({control_target_pct:.1f}%)")
report.append(f"  治疗组: {treatment_target}/{len(treatment)} ({treatment_target_pct:.1f}%)")
report.append(f"  差异: {treatment_target_pct - control_target_pct:.1f}%")
report.append(f"  P值: {p_target:.4f}")
report.append(f"  结论: {'有统计学差异(P<0.05)' if p_target < 0.05 else '无统计学差异'}\n")

# 4. 结论
report.append("四、研究结论")
report.append("-"*70)
report.append(f"1. 新型降压药物相比安慰剂显著降低收缩压({-diff_sbp:.1f} mmHg, P<0.001)")
report.append(f"2. 治疗组血压达标率显著高于对照组({treatment_target_pct:.1f}% vs {control_target_pct:.1f}%, P<0.05)")
report.append(f"3. 新型降压药物疗效确切,值得临床推广")

report.append("\n" + "="*70)

# 输出到控制台
report_text = "\n".join(report)
print(report_text)

# 保存到文件
with open('trial_report.txt', 'w', encoding='utf-8') as f:
    f.write(report_text)

print("\n✓ 分析报告已保存: trial_report.txt")

# 同时保存为Excel
summary_df = pd.DataFrame({
    '指标': ['样本量', '平均年龄', '基线收缩压', '12周收缩压', '降压幅度', '达标率'],
    '对照组': [
        len(control),
        f"{control['年龄'].mean():.1f}±{control['年龄'].std():.1f}",
        f"{control['基线收缩压'].mean():.1f}±{control['基线收缩压'].std():.1f}",
        f"{control['12周收缩压'].mean():.1f}±{control['12周收缩压'].std():.1f}",
        f"{-control['收缩压变化'].mean():.1f}±{control['收缩压变化'].std():.1f}",
        f"{control_target_pct:.1f}%"
    ],
    '治疗组': [
        len(treatment),
        f"{treatment['年龄'].mean():.1f}±{treatment['年龄'].std():.1f}",
        f"{treatment['基线收缩压'].mean():.1f}±{treatment['基线收缩压'].std():.1f}",
        f"{treatment['12周收缩压'].mean():.1f}±{treatment['12周收缩压'].std():.1f}",
        f"{-treatment['收缩压变化'].mean():.1f}±{treatment['收缩压变化'].std():.1f}",
        f"{treatment_target_pct:.1f}%"
    ]
})

summary_df.to_excel('trial_summary.xlsx', index=False)
print("✓ 汇总表已保存: trial_summary.xlsx")
```

## 项目总结

### 完成的工作

✅ 数据生成和导入
✅ 数据清洗和检查
✅ 描述性统计分析
✅ 组间基线比较
✅ 疗效分析(t检验、卡方检验)
✅ 数据可视化(6种图表)
✅ 自动化报告生成

### 使用的技能

| 技能 | 应用 |
|------|------|
| Pandas | 数据读取、清洗、分组统计 |
| NumPy | 数值计算、随机数生成 |
| SciPy | 统计检验(t检验、卡方检验) |
| Matplotlib | 数据可视化(箱线图、柱状图、散点图) |

### 项目价值

1. **自动化** - 从数据到报告全自动
2. **可复用** - 代码可用于其他临床试验
3. **标准化** - 分析流程规范化
4. **高效** - 几分钟完成传统需要几天的工作

## 💡 关键要点

### 临床试验分析流程

```
1. 数据准备 → 导入、清洗
2. 描述性统计 → 了解数据
3. 基线比较 → 验证均衡性
4. 疗效分析 → 统计检验
5. 可视化 → 直观展示
6. 生成报告 → 自动化输出
```

### Python数据分析优势

- ✅ 可重复 - 代码可保存复用
- ✅ 透明 - 分析过程可审查
- ✅ 高效 - 批量处理大数据
- ✅ 专业 - 生成发表级图表

## 下一步

恭喜完成第4章!你已经掌握了:
- ✅ Pandas数据处理
- ✅ NumPy数值计算
- ✅ Matplotlib可视化
- ✅ 临床试验数据分析

**接下来**:第5章将学习开发环境和工具链,让你的编程更高效!

---

## 🎯 扩展挑战

### 任务:改进分析脚本

1. **增加亚组分析**
   - 按年龄分组(<60 vs ≥60)
   - 按性别分组
   - 分析不同亚组的疗效差异

2. **添加趋势分析**
   - 绘制4周、8周、12周的血压变化趋势
   - 分析降压速度

3. **改进可视化**
   - 使用Seaborn美化图表
   - 添加森林图展示亚组分析
   - 创建交互式图表(Plotly)

4. **完善报告**
   - 生成Word格式报告
   - 自动插入图表
   - 添加统计表格

试试看能实现多少功能!遇到问题就问ChatGPT! 🚀
