# 4.2 NumPy:数值计算基础

## 为什么需要NumPy?

### Python列表 vs NumPy数组

**场景**:计算100名患者的BMI

#### Python列表方式

```python
weights = [70, 85, 55, 92, 68, ...]  # 100个数据
heights = [1.75, 1.68, 1.62, 1.80, 1.72, ...]

# 计算BMI(需要循环)
bmis = []
for w, h in zip(weights, heights):
    bmi = w / (h ** 2)
    bmis.append(bmi)
```

#### NumPy数组方式

```python
import numpy as np

weights = np.array([70, 85, 55, 92, 68, ...])
heights = np.array([1.75, 1.68, 1.62, 1.80, 1.72, ...])

# 向量化计算(无需循环!)
bmis = weights / (heights ** 2)
```

**NumPy优势**:
- ✅ **速度快** - 比Python列表快10-100倍
- ✅ **代码简洁** - 向量化操作,无需循环
- ✅ **内存效率高** - 存储更紧凑
- ✅ **功能强大** - 矩阵运算、统计分析

## NumPy基础

### 1. 创建数组

```python
import numpy as np

# 从列表创建
arr = np.array([1, 2, 3, 4, 5])
print(arr)  # [1 2 3 4 5]

# 二维数组(矩阵)
matrix = np.array([[1, 2, 3], [4, 5, 6]])
print(matrix)
# [[1 2 3]
#  [4 5 6]]

# 特殊数组
zeros = np.zeros(5)  # [0. 0. 0. 0. 0.]
ones = np.ones((3, 4))  # 3×4全1矩阵
empty = np.empty((2, 3))  # 未初始化数组

# 等差数列
arr = np.arange(0, 10, 2)  # [0 2 4 6 8]
arr = np.linspace(0, 10, 5)  # [0.  2.5 5.  7.5 10.]

# 随机数组
random_arr = np.random.rand(5)  # 5个[0,1)随机数
random_int = np.random.randint(1, 100, 10)  # 10个[1,100)随机整数
```

### 2. 数组属性

```python
import numpy as np

arr = np.array([[1, 2, 3], [4, 5, 6]])

print(arr.shape)  # (2, 3) - 形状
print(arr.ndim)  # 2 - 维度数
print(arr.size)  # 6 - 元素总数
print(arr.dtype)  # int64 - 数据类型
```

### 3. 数组索引和切片

```python
import numpy as np

# 一维数组
arr = np.array([10, 20, 30, 40, 50])
print(arr[0])  # 10
print(arr[-1])  # 50
print(arr[1:4])  # [20 30 40]

# 二维数组
matrix = np.array([[1, 2, 3], [4, 5, 6], [7, 8, 9]])
print(matrix[0, 0])  # 1 - 第1行第1列
print(matrix[1, 2])  # 6 - 第2行第3列
print(matrix[0, :])  # [1 2 3] - 第1行所有列
print(matrix[:, 1])  # [2 5 8] - 所有行第2列

# 条件索引(布尔索引)
arr = np.array([10, 20, 30, 40, 50])
high_values = arr[arr > 25]  # [30 40 50]
```

## 数组运算

### 1. 算术运算(向量化)

```python
import numpy as np

# 基本运算
arr = np.array([1, 2, 3, 4, 5])

print(arr + 10)  # [11 12 13 14 15]
print(arr * 2)  # [2 4 6 8 10]
print(arr ** 2)  # [1 4 9 16 25]
print(1 / arr)  # [1.  0.5 0.333... 0.25 0.2]

# 数组间运算
arr1 = np.array([1, 2, 3])
arr2 = np.array([4, 5, 6])

print(arr1 + arr2)  # [5 7 9]
print(arr1 * arr2)  # [4 10 18]
```

### 2. 医学场景:BMI批量计算

```python
import numpy as np

# 100名患者数据
np.random.seed(42)
weights = np.random.uniform(50, 100, 100)  # 体重50-100kg
heights = np.random.uniform(1.5, 1.9, 100)  # 身高1.5-1.9m

# 批量计算BMI(向量化)
bmis = weights / (heights ** 2)

# 统计
print(f"平均BMI: {bmis.mean():.2f}")
print(f"BMI标准差: {bmis.std():.2f}")
print(f"BMI范围: {bmis.min():.2f} - {bmis.max():.2f}")

# BMI分类
normal = np.sum((bmis >= 18.5) & (bmis < 24))
overweight = np.sum((bmis >= 24) & (bmis < 28))
obese = np.sum(bmis >= 28)

print(f"\n体重正常: {normal}人 ({normal/100*100:.1f}%)")
print(f"超重: {overweight}人 ({overweight/100*100:.1f}%)")
print(f"肥胖: {obese}人 ({obese/100*100:.1f}%)")
```

## 统计函数

### 1. 基本统计

```python
import numpy as np

data = np.array([6.2, 5.8, 6.5, 7.1, 6.0, 5.9, 6.3])

# 描述性统计
print(f"平均值: {np.mean(data):.2f}")
print(f"中位数: {np.median(data):.2f}")
print(f"标准差: {np.std(data):.2f}")
print(f"方差: {np.var(data):.2f}")
print(f"最小值: {np.min(data):.2f}")
print(f"最大值: {np.max(data):.2f}")
print(f"求和: {np.sum(data):.2f}")

# 百分位数
print(f"25%分位数: {np.percentile(data, 25):.2f}")
print(f"75%分位数: {np.percentile(data, 75):.2f}")
```

### 2. 轴向操作

```python
import numpy as np

# 二维数组(3名患者,5次血糖测量)
glucose = np.array([
    [6.2, 5.8, 6.5, 7.1, 6.0],  # 患者1
    [7.5, 8.2, 7.8, 7.3, 7.6],  # 患者2
    [5.5, 5.3, 5.8, 5.6, 5.4]   # 患者3
])

# 每个患者的平均血糖(沿行方向)
patient_avg = np.mean(glucose, axis=1)
print(f"各患者平均血糖: {patient_avg}")

# 每次测量的平均值(沿列方向)
time_avg = np.mean(glucose, axis=0)
print(f"各次测量平均: {time_avg}")

# 全体平均
total_avg = np.mean(glucose)
print(f"总体平均血糖: {total_avg:.2f}")
```

## 数组变形

```python
import numpy as np

# 原数组
arr = np.array([1, 2, 3, 4, 5, 6])

# 变形
matrix = arr.reshape(2, 3)  # 变为2×3矩阵
print(matrix)
# [[1 2 3]
#  [4 5 6]]

# 转置
transposed = matrix.T
print(transposed)
# [[1 4]
#  [2 5]
#  [3 6]]

# 展平
flattened = matrix.flatten()
print(flattened)  # [1 2 3 4 5 6]

# 增加维度
arr_2d = arr[:, np.newaxis]  # 变为列向量
```

## 数组合并与分割

```python
import numpy as np

# 合并
arr1 = np.array([1, 2, 3])
arr2 = np.array([4, 5, 6])

# 垂直堆叠
vstacked = np.vstack([arr1, arr2])
print(vstacked)
# [[1 2 3]
#  [4 5 6]]

# 水平堆叠
hstacked = np.hstack([arr1, arr2])
print(hstacked)  # [1 2 3 4 5 6]

# 拼接
concatenated = np.concatenate([arr1, arr2])
print(concatenated)  # [1 2 3 4 5 6]

# 分割
arr = np.array([1, 2, 3, 4, 5, 6])
split = np.split(arr, 3)  # 分成3份
print(split)  # [array([1, 2]), array([3, 4]), array([5, 6])]
```

## 医学场景:血压数据分析

```python
import numpy as np

# 模拟100名患者的血压数据
np.random.seed(42)

# 生成数据
systolic = np.random.normal(130, 20, 100)  # 收缩压,均值130,标准差20
diastolic = np.random.normal(80, 10, 100)  # 舒张压,均值80,标准差10

# 确保合理范围
systolic = np.clip(systolic, 90, 200)
diastolic = np.clip(diastolic, 60, 120)

print("="*60)
print("血压数据分析")
print("="*60)

# 描述性统计
print("\n收缩压统计:")
print(f"  平均值: {np.mean(systolic):.1f} mmHg")
print(f"  中位数: {np.median(systolic):.1f} mmHg")
print(f"  标准差: {np.std(systolic):.1f} mmHg")
print(f"  范围: {np.min(systolic):.1f} - {np.max(systolic):.1f} mmHg")

print("\n舒张压统计:")
print(f"  平均值: {np.mean(diastolic):.1f} mmHg")
print(f"  中位数: {np.median(diastolic):.1f} mmHg")
print(f"  标准差: {np.std(diastolic):.1f} mmHg")
print(f"  范围: {np.min(diastolic):.1f} - {np.max(diastolic):.1f} mmHg")

# 血压分级
normal = np.sum((systolic < 120) & (diastolic < 80))
prehypertension = np.sum(((systolic >= 120) & (systolic < 140)) |
                         ((diastolic >= 80) & (diastolic < 90)))
stage1 = np.sum(((systolic >= 140) & (systolic < 160)) |
                ((diastolic >= 90) & (diastolic < 100)))
stage2 = np.sum((systolic >= 160) | (diastolic >= 100))

print("\n血压分级:")
print(f"  正常血压: {normal}人 ({normal/100*100:.1f}%)")
print(f"  正常高值: {prehypertension}人 ({prehypertension/100*100:.1f}%)")
print(f"  1级高血压: {stage1}人 ({stage1/100*100:.1f}%)")
print(f"  2级高血压: {stage2}人 ({stage2/100*100:.1f}%)")

# 脉压差分析
pulse_pressure = systolic - diastolic
print("\n脉压差分析:")
print(f"  平均脉压差: {np.mean(pulse_pressure):.1f} mmHg")
print(f"  脉压差 >60 的人数: {np.sum(pulse_pressure > 60)}人")

# 相关性分析(简单)
correlation = np.corrcoef(systolic, diastolic)[0, 1]
print(f"\n收缩压与舒张压相关系数: {correlation:.3f}")

print("="*60)
```

## 随机数生成

### 1. 基本随机数

```python
import numpy as np

# 设置随机种子(保证可重复)
np.random.seed(42)

# 均匀分布[0, 1)
uniform = np.random.rand(5)

# 正态分布(均值0,标准差1)
normal = np.random.randn(5)

# 指定范围的均匀分布
ages = np.random.uniform(20, 80, 100)  # 年龄20-80岁

# 指定参数的正态分布
glucose = np.random.normal(6.0, 1.5, 100)  # 血糖,均值6.0,标准差1.5

# 随机整数
patient_ids = np.random.randint(1, 1000, 50)  # 50个1-999的ID

# 随机选择
diagnoses = np.random.choice(['高血压', '糖尿病', '高血脂'], 100)
```

### 2. 医学场景:模拟临床试验数据

```python
import numpy as np

def generate_trial_data(n_patients=100, seed=42):
    """
    生成模拟临床试验数据

    参数:
        n_patients: 患者数量
        seed: 随机种子

    返回:
        dict: 包含各项数据的字典
    """
    np.random.seed(seed)

    # 基本信息
    ages = np.random.normal(55, 15, n_patients).astype(int)
    ages = np.clip(ages, 18, 90)  # 限制在18-90岁

    genders = np.random.choice(['男', '女'], n_patients)

    # 基线数据
    baseline_sbp = np.random.normal(150, 20, n_patients)
    baseline_dbp = np.random.normal(95, 10, n_patients)

    # 治疗后数据(假设治疗有效,降低血压)
    # 治疗组降压效果更好
    treatment_effect = np.random.normal(-20, 5, n_patients)
    followup_sbp = baseline_sbp + treatment_effect
    followup_dbp = baseline_dbp + treatment_effect * 0.5

    # 确保合理范围
    followup_sbp = np.clip(followup_sbp, 90, 180)
    followup_dbp = np.clip(followup_dbp, 60, 110)

    # 计算变化
    sbp_change = followup_sbp - baseline_sbp
    dbp_change = followup_dbp - baseline_dbp

    return {
        '年龄': ages,
        '性别': genders,
        '基线收缩压': baseline_sbp,
        '基线舒张压': baseline_dbp,
        '随访收缩压': followup_sbp,
        '随访舒张压': followup_dbp,
        '收缩压变化': sbp_change,
        '舒张压变化': dbp_change
    }

# 生成数据
data = generate_trial_data(100)

# 分析
print("="*60)
print("临床试验数据分析")
print("="*60)

print(f"\n总样本量: {len(data['年龄'])}人")
print(f"平均年龄: {np.mean(data['年龄']):.1f}岁")
print(f"男性比例: {np.sum(data['性别']=='男')/len(data['性别'])*100:.1f}%")

print("\n基线血压:")
print(f"  收缩压: {np.mean(data['基线收缩压']):.1f} ± {np.std(data['基线收缩压']):.1f} mmHg")
print(f"  舒张压: {np.mean(data['基线舒张压']):.1f} ± {np.std(data['基线舒张压']):.1f} mmHg")

print("\n随访血压:")
print(f"  收缩压: {np.mean(data['随访收缩压']):.1f} ± {np.std(data['随访收缩压']):.1f} mmHg")
print(f"  舒张压: {np.mean(data['随访舒张压']):.1f} ± {np.std(data['随访舒张压']):.1f} mmHg")

print("\n血压变化:")
print(f"  收缩压降低: {-np.mean(data['收缩压变化']):.1f} ± {np.std(data['收缩压变化']):.1f} mmHg")
print(f"  舒张压降低: {-np.mean(data['舒张压变化']):.1f} ± {np.std(data['舒张压变化']):.1f} mmHg")

# 达标率(收缩压<140)
target_achieved = np.sum(data['随访收缩压'] < 140)
print(f"\n达标率: {target_achieved/len(data['年龄'])*100:.1f}%")

print("="*60)
```

## NumPy与Pandas结合

```python
import numpy as np
import pandas as pd

# NumPy数组转DataFrame
ages = np.array([45, 52, 38, 68, 55])
names = np.array(['张三', '李四', '王五', '赵六', '孙七'])

df = pd.DataFrame({
    '姓名': names,
    '年龄': ages
})

# DataFrame转NumPy数组
age_array = df['年龄'].values  # 提取为NumPy数组
all_data = df.values  # 整个DataFrame转为数组

# NumPy运算结果添加到DataFrame
df['BMI'] = np.random.uniform(20, 30, 5)
df['年龄组'] = np.where(df['年龄'] >= 60, '老年', '中青年')

print(df)
```

## 💡 关键要点

### NumPy核心功能

| 功能 | 方法 | 示例 |
|------|------|------|
| **创建数组** | array, zeros, ones | `np.array([1,2,3])` |
| **算术运算** | +, -, *, /, ** | `arr * 2` |
| **统计** | mean, std, min, max | `np.mean(arr)` |
| **条件筛选** | 布尔索引 | `arr[arr > 10]` |
| **变形** | reshape, T | `arr.reshape(2,3)` |
| **随机数** | random.rand, normal | `np.random.rand(5)` |

### NumPy vs Python列表

| 特性 | Python列表 | NumPy数组 |
|------|-----------|----------|
| **速度** | 慢 | 快(10-100倍) |
| **内存** | 大 | 小 |
| **功能** | 基础 | 丰富(统计、线性代数) |
| **操作** | 需要循环 | 向量化 |

### 何时使用NumPy?

- ✅ 大量数值计算
- ✅ 矩阵运算
- ✅ 统计分析
- ✅ 需要性能优化

## 下一步

掌握了NumPy后,下一节[Matplotlib:绘制统计图表](4.3-matplotlib.md)将学习数据可视化!

---

## 🔨 练习任务

```python
# 任务1: 批量计算100名患者的BMI并分类
weights = np.random.uniform(50, 100, 100)
heights = np.random.uniform(1.5, 1.9, 100)
# 计算BMI,统计各分类人数

# 任务2: 分析一周血糖数据
glucose = np.random.normal(6.5, 1.5, (10, 7))  # 10名患者,7天数据
# 计算每个患者的平均血糖
# 计算每天的平均血糖
# 找出血糖控制最好的患者

# 任务3: 模拟药物试验
# 生成100名患者的基线和随访血压数据
# 计算降压效果
# 统计达标率
```

> 💡 提示:NumPy的关键是向量化思维,避免使用循环!
