# 4.3 Matplotlib:绘制统计图表

## 为什么需要数据可视化?

> "一图胜千言" - 数据可视化让复杂数据一目了然

**场景**:你分析了100名患者的血压数据,想向主任汇报。

### 方式1:纯文字

```
平均收缩压: 135.2 mmHg
标准差: 18.5 mmHg
最小值: 98 mmHg
最大值: 182 mmHg
...
```

❌ 枯燥、难以理解、无法看出分布规律

### 方式2:图表

📊 一张直方图清晰展示:
- 血压分布情况
- 异常值位置
- 集中趋势

✅ 直观、专业、易于沟通

## Matplotlib基础

### 1. 第一个图表

```python
import matplotlib.pyplot as plt

# 数据
x = [1, 2, 3, 4, 5]
y = [2, 4, 6, 8, 10]

# 绘图
plt.plot(x, y)
plt.xlabel('X轴')
plt.ylabel('Y轴')
plt.title('我的第一个图表')
plt.show()
```

### 2. 医学场景:血糖监测曲线

```python
import matplotlib.pyplot as plt

# 一周血糖数据
days = ['周一', '周二', '周三', '周四', '周五', '周六', '周日']
glucose = [6.2, 5.8, 6.5, 7.1, 6.0, 5.9, 6.3]

# 绘制折线图
plt.figure(figsize=(10, 6))
plt.plot(days, glucose, marker='o', linewidth=2, markersize=8)

# 添加目标线
plt.axhline(y=7.0, color='r', linestyle='--', label='目标值')

# 标签和标题
plt.xlabel('日期', fontsize=12)
plt.ylabel('血糖 (mmol/L)', fontsize=12)
plt.title('患者血糖监测 - 一周趋势', fontsize=14, fontweight='bold')
plt.legend()
plt.grid(True, alpha=0.3)

# 显示
plt.tight_layout()
plt.show()
```

## 常用图表类型

### 1. 折线图 - 趋势变化

```python
import matplotlib.pyplot as plt
import numpy as np

# 患者体温监测(24小时)
hours = np.arange(0, 24)
temperature = 37.0 + np.sin(hours/24 * 2 * np.pi) * 1.5 + np.random.rand(24) * 0.3

plt.figure(figsize=(12, 5))
plt.plot(hours, temperature, marker='o', linestyle='-', color='steelblue')
plt.axhline(y=37.3, color='red', linestyle='--', label='发热线')
plt.xlabel('时间 (小时)')
plt.ylabel('体温 (°C)')
plt.title('患者24小时体温监测')
plt.legend()
plt.grid(True, alpha=0.3)
plt.show()
```

### 2. 柱状图 - 分类比较

```python
import matplotlib.pyplot as plt

# 各科室患者数
departments = ['心内科', '神经内科', '呼吸内科', '消化内科', '内分泌科']
patient_counts = [45, 38, 52, 31, 42]

plt.figure(figsize=(10, 6))
plt.bar(departments, patient_counts, color='skyblue', edgecolor='black')
plt.xlabel('科室')
plt.ylabel('患者数')
plt.title('各科室住院患者统计')
plt.xticks(rotation=45)  # 旋转标签
plt.tight_layout()
plt.show()
```

### 3. 水平柱状图

```python
import matplotlib.pyplot as plt

# 疾病谱统计
diseases = ['高血压', '糖尿病', '冠心病', '高血脂', '慢性肾病']
patient_nums = [120, 95, 78, 85, 62]

plt.figure(figsize=(10, 6))
plt.barh(diseases, patient_nums, color='coral')
plt.xlabel('患者数')
plt.ylabel('诊断')
plt.title('疾病谱统计(Top 5)')
plt.tight_layout()
plt.show()
```

### 4. 直方图 - 数据分布

```python
import matplotlib.pyplot as plt
import numpy as np

# 100名患者的年龄分布
np.random.seed(42)
ages = np.random.normal(55, 15, 100).astype(int)
ages = np.clip(ages, 18, 90)

plt.figure(figsize=(10, 6))
plt.hist(ages, bins=15, color='lightgreen', edgecolor='black', alpha=0.7)
plt.xlabel('年龄 (岁)')
plt.ylabel('人数')
plt.title('患者年龄分布直方图')
plt.grid(True, alpha=0.3, axis='y')
plt.tight_layout()
plt.show()
```

### 5. 散点图 - 相关性分析

```python
import matplotlib.pyplot as plt
import numpy as np

# 身高体重关系
np.random.seed(42)
heights = np.random.normal(1.70, 0.10, 100)
weights = heights * 40 + np.random.normal(0, 5, 100)

plt.figure(figsize=(10, 6))
plt.scatter(heights, weights, alpha=0.6, s=50)
plt.xlabel('身高 (m)')
plt.ylabel('体重 (kg)')
plt.title('身高与体重关系')
plt.grid(True, alpha=0.3)
plt.tight_layout()
plt.show()
```

### 6. 箱线图 - 数据分布和异常值

```python
import matplotlib.pyplot as plt
import numpy as np

# 三组患者的血压数据
np.random.seed(42)
group1 = np.random.normal(130, 15, 50)
group2 = np.random.normal(140, 18, 50)
group3 = np.random.normal(150, 20, 50)

data = [group1, group2, group3]
labels = ['对照组', '治疗组A', '治疗组B']

plt.figure(figsize=(10, 6))
plt.boxplot(data, labels=labels)
plt.ylabel('收缩压 (mmHg)')
plt.title('各组血压分布箱线图')
plt.grid(True, alpha=0.3, axis='y')
plt.tight_layout()
plt.show()
```

### 7. 饼图 - 比例构成

```python
import matplotlib.pyplot as plt

# 疾病构成
diseases = ['高血压', '糖尿病', '冠心病', '高血脂', '其他']
proportions = [35, 25, 18, 12, 10]

plt.figure(figsize=(8, 8))
plt.pie(proportions, labels=diseases, autopct='%1.1f%%',
        startangle=90, colors=['#ff9999','#66b3ff','#99ff99','#ffcc99','#ff99cc'])
plt.title('疾病谱构成')
plt.axis('equal')
plt.tight_layout()
plt.show()
```

## 子图布局

### 1. 多子图

```python
import matplotlib.pyplot as plt
import numpy as np

# 创建2×2子图
fig, axes = plt.subplots(2, 2, figsize=(12, 10))

# 子图1:折线图
days = ['周一', '周二', '周三', '周四', '周五']
glucose = [6.2, 5.8, 6.5, 7.1, 6.0]
axes[0, 0].plot(days, glucose, marker='o')
axes[0, 0].set_title('血糖趋势')
axes[0, 0].set_ylabel('血糖 (mmol/L)')

# 子图2:柱状图
axes[0, 1].bar(['男', '女'], [45, 55])
axes[0, 1].set_title('性别分布')
axes[0, 1].set_ylabel('人数')

# 子图3:直方图
ages = np.random.normal(55, 15, 100).astype(int)
axes[1, 0].hist(ages, bins=15, color='lightgreen', edgecolor='black')
axes[1, 0].set_title('年龄分布')
axes[1, 0].set_xlabel('年龄 (岁)')

# 子图4:散点图
heights = np.random.normal(1.70, 0.10, 100)
weights = heights * 40 + np.random.normal(0, 5, 100)
axes[1, 1].scatter(heights, weights, alpha=0.6)
axes[1, 1].set_title('身高-体重关系')
axes[1, 1].set_xlabel('身高 (m)')
axes[1, 1].set_ylabel('体重 (kg)')

plt.tight_layout()
plt.show()
```

## 图表美化

### 1. 颜色和样式

```python
import matplotlib.pyplot as plt

# 数据
x = [1, 2, 3, 4, 5]
y1 = [2, 4, 6, 8, 10]
y2 = [1, 3, 5, 7, 9]

plt.figure(figsize=(10, 6))

# 不同颜色和样式
plt.plot(x, y1, color='blue', linestyle='-', linewidth=2, marker='o', label='组1')
plt.plot(x, y2, color='red', linestyle='--', linewidth=2, marker='s', label='组2')

plt.xlabel('时间点')
plt.ylabel('血压 (mmHg)')
plt.title('两组患者血压对比')
plt.legend()
plt.grid(True, alpha=0.3)
plt.tight_layout()
plt.show()
```

### 2. 中文显示配置

```python
import matplotlib.pyplot as plt

# 配置中文字体
plt.rcParams['font.sans-serif'] = ['SimHei']  # Windows
# plt.rcParams['font.sans-serif'] = ['Arial Unicode MS']  # macOS
plt.rcParams['axes.unicode_minus'] = False  # 解决负号显示问题

# 现在可以正常显示中文了
plt.figure(figsize=(8, 6))
plt.plot([1, 2, 3], [4, 5, 6])
plt.xlabel('时间')
plt.ylabel('血压')
plt.title('血压监测图表')
plt.show()
```

### 3. 保存图表

```python
import matplotlib.pyplot as plt

plt.figure(figsize=(10, 6))
plt.plot([1, 2, 3], [4, 5, 6])
plt.title('示例图表')

# 保存为不同格式
plt.savefig('chart.png', dpi=300, bbox_inches='tight')  # 高分辨率PNG
plt.savefig('chart.pdf', bbox_inches='tight')  # PDF(矢量图)
plt.savefig('chart.svg', bbox_inches='tight')  # SVG(矢量图)

plt.show()
```

## 医学场景综合案例

### 案例:临床试验可视化报告

```python
import matplotlib.pyplot as plt
import numpy as np
import pandas as pd

# 配置中文
plt.rcParams['font.sans-serif'] = ['SimHei']
plt.rcParams['axes.unicode_minus'] = False

# 模拟数据
np.random.seed(42)

# 对照组和治疗组数据
control_baseline = np.random.normal(150, 15, 50)
control_followup = control_baseline - np.random.normal(5, 8, 50)

treatment_baseline = np.random.normal(148, 16, 50)
treatment_followup = treatment_baseline - np.random.normal(20, 10, 50)

# 创建图表
fig = plt.figure(figsize=(16, 12))

# 子图1:基线血压对比(箱线图)
ax1 = plt.subplot(2, 3, 1)
ax1.boxplot([control_baseline, treatment_baseline],
            labels=['对照组', '治疗组'])
ax1.set_ylabel('收缩压 (mmHg)')
ax1.set_title('基线血压分布')
ax1.grid(True, alpha=0.3, axis='y')

# 子图2:随访血压对比(箱线图)
ax2 = plt.subplot(2, 3, 2)
ax2.boxplot([control_followup, treatment_followup],
            labels=['对照组', '治疗组'])
ax2.set_ylabel('收缩压 (mmHg)')
ax2.set_title('随访血压分布')
ax2.grid(True, alpha=0.3, axis='y')

# 子图3:降压幅度对比(柱状图)
ax3 = plt.subplot(2, 3, 3)
control_reduction = control_baseline.mean() - control_followup.mean()
treatment_reduction = treatment_baseline.mean() - treatment_followup.mean()
ax3.bar(['对照组', '治疗组'], [control_reduction, treatment_reduction],
       color=['lightcoral', 'lightblue'])
ax3.set_ylabel('降压幅度 (mmHg)')
ax3.set_title('平均降压效果')
ax3.grid(True, alpha=0.3, axis='y')

# 子图4:对照组散点图
ax4 = plt.subplot(2, 3, 4)
ax4.scatter(control_baseline, control_followup, alpha=0.6)
ax4.plot([90, 180], [90, 180], 'r--', label='无变化线')
ax4.set_xlabel('基线血压 (mmHg)')
ax4.set_ylabel('随访血压 (mmHg)')
ax4.set_title('对照组血压变化')
ax4.legend()
ax4.grid(True, alpha=0.3)

# 子图5:治疗组散点图
ax5 = plt.subplot(2, 3, 5)
ax5.scatter(treatment_baseline, treatment_followup, alpha=0.6, color='green')
ax5.plot([90, 180], [90, 180], 'r--', label='无变化线')
ax5.set_xlabel('基线血压 (mmHg)')
ax5.set_ylabel('随访血压 (mmHg)')
ax5.set_title('治疗组血压变化')
ax5.legend()
ax5.grid(True, alpha=0.3)

# 子图6:达标率对比(饼图)
ax6 = plt.subplot(2, 3, 6)
control_target = np.sum(control_followup < 140) / 50 * 100
treatment_target = np.sum(treatment_followup < 140) / 50 * 100

x = np.arange(2)
bars = ax6.bar(x, [control_target, treatment_target],
               color=['lightcoral', 'lightblue'])
ax6.set_xticks(x)
ax6.set_xticklabels(['对照组', '治疗组'])
ax6.set_ylabel('达标率 (%)')
ax6.set_title('血压达标率(<140 mmHg)')
ax6.set_ylim([0, 100])

# 在柱上显示数值
for bar in bars:
    height = bar.get_height()
    ax6.text(bar.get_x() + bar.get_width()/2., height,
            f'{height:.1f}%', ha='center', va='bottom')

plt.suptitle('降压药物临床试验可视化分析报告', fontsize=16, fontweight='bold', y=0.98)
plt.tight_layout(rect=[0, 0, 1, 0.96])

# 保存
plt.savefig('clinical_trial_report.png', dpi=300, bbox_inches='tight')
plt.show()

# 打印统计摘要
print("="*60)
print("临床试验统计摘要")
print("="*60)
print(f"\n对照组 (n=50):")
print(f"  基线血压: {control_baseline.mean():.1f} ± {control_baseline.std():.1f} mmHg")
print(f"  随访血压: {control_followup.mean():.1f} ± {control_followup.std():.1f} mmHg")
print(f"  降压幅度: {control_reduction:.1f} mmHg")
print(f"  达标率: {control_target:.1f}%")

print(f"\n治疗组 (n=50):")
print(f"  基线血压: {treatment_baseline.mean():.1f} ± {treatment_baseline.std():.1f} mmHg")
print(f"  随访血压: {treatment_followup.mean():.1f} ± {treatment_followup.std():.1f} mmHg")
print(f"  降压幅度: {treatment_reduction:.1f} mmHg")
print(f"  达标率: {treatment_target:.1f}%")

print(f"\n组间差异:")
print(f"  降压幅度差异: {treatment_reduction - control_reduction:.1f} mmHg")
print(f"  达标率差异: {treatment_target - control_target:.1f}%")
print("="*60)
```

## 💡 关键要点

### 常用图表选择指南

| 数据类型 | 推荐图表 | 用途 |
|---------|---------|------|
| 时间序列 | 折线图 | 趋势变化 |
| 分类比较 | 柱状图 | 组间对比 |
| 数据分布 | 直方图、箱线图 | 分布情况 |
| 相关关系 | 散点图 | 两变量关系 |
| 比例构成 | 饼图 | 占比情况 |

### Matplotlib常用命令

```python
# 创建图表
plt.figure(figsize=(10, 6))

# 绘图
plt.plot(x, y)  # 折线图
plt.bar(x, y)  # 柱状图
plt.hist(data)  # 直方图
plt.scatter(x, y)  # 散点图
plt.boxplot(data)  # 箱线图

# 标签
plt.xlabel('X轴标签')
plt.ylabel('Y轴标签')
plt.title('标题')
plt.legend()  # 图例

# 其他
plt.grid(True)  # 网格
plt.tight_layout()  # 自动调整布局
plt.savefig('file.png')  # 保存
plt.show()  # 显示
```

## 下一步

掌握了数据可视化后,下一节[实战:分析临床试验数据](4.4-practice-analysis.md)将综合运用Pandas、NumPy和Matplotlib!

---

## 🔨 练习任务

```python
# 任务1: 绘制一周血压监测图
# 折线图,包含收缩压和舒张压两条线

# 任务2: 疾病谱统计
# 读取患者数据,绘制Top 10疾病的水平柱状图

# 任务3: 年龄-血压关系
# 绘制散点图,分析年龄和血压的关系

# 任务4: 创建2×2子图
# 包含:折线图、柱状图、直方图、箱线图
```

> 💡 提示:Matplotlib的Gallery有大量示例,可以参考学习!
