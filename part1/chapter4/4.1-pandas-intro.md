# 4.1 Pandas:表格数据的瑞士军刀

## 为什么需要Pandas?

### 传统方式 vs Pandas

**场景**:你有一个包含100名患者数据的Excel文件,需要:
1. 筛选出高血压患者
2. 计算平均年龄
3. 按性别统计人数

#### 传统方式(Excel手工操作)

```
1. 打开Excel
2. 手动筛选"诊断"列 = "高血压"
3. 复制筛选结果到新表
4. 用公式计算平均年龄
5. 用数据透视表统计性别
6. 耗时: 15-30分钟
```

#### Pandas方式

```python
import pandas as pd

# 读取数据
df = pd.read_excel("patients.xlsx")

# 筛选高血压患者
hypertension = df[df['诊断'] == '高血压']

# 计算平均年龄
avg_age = hypertension['年龄'].mean()

# 按性别统计
gender_count = hypertension['性别'].value_counts()

# 耗时: 30秒(包含写代码)
```

**Pandas的优势**:
- ✅ 速度快(处理百万行数据也轻松)
- ✅ 可复用(下次只需运行,无需重复操作)
- ✅ 准确(避免手工错误)
- ✅ 强大(支持复杂分析)

## Pandas基础概念

### 两个核心数据结构

#### 1. Series - 一维数据(像Excel的一列)

```python
import pandas as pd

# 创建Series
ages = pd.Series([45, 52, 38, 68, 55])
print(ages)
```

输出:
```
0    45
1    52
2    38
3    68
4    55
dtype: int64
```

#### 2. DataFrame - 二维表格(像Excel表)

```python
import pandas as pd

# 创建DataFrame
patients = pd.DataFrame({
    '姓名': ['张三', '李四', '王五', '赵六'],
    '年龄': [45, 52, 38, 68],
    '性别': ['男', '男', '女', '男'],
    '诊断': ['高血压', '糖尿病', '高血脂', '高血压']
})

print(patients)
```

输出:
```
   姓名  年龄 性别   诊断
0  张三  45  男  高血压
1  李四  52  男  糖尿病
2  王五  38  女  高血脂
3  赵六  68  男  高血压
```

## 读取和导出数据

### 1. 读取Excel文件

```python
import pandas as pd

# 基本读取
df = pd.read_excel("patients.xlsx")

# 指定工作表
df = pd.read_excel("patients.xlsx", sheet_name="Sheet1")

# 指定列
df = pd.read_excel("patients.xlsx", usecols=['姓名', '年龄', '诊断'])

# 跳过行
df = pd.read_excel("patients.xlsx", skiprows=2)  # 跳过前2行
```

### 2. 读取CSV文件

```python
# 基本读取
df = pd.read_csv("patients.csv")

# 指定编码(处理中文)
df = pd.read_csv("patients.csv", encoding='utf-8')

# 指定分隔符
df = pd.read_csv("data.txt", sep='\t')  # Tab分隔

# 指定列名
df = pd.read_csv("data.csv", names=['姓名', '年龄', '诊断'])
```

### 3. 导出数据

```python
# 导出为Excel
df.to_excel("output.xlsx", index=False)  # index=False不保存行号

# 导出为CSV
df.to_csv("output.csv", index=False, encoding='utf-8-sig')  # utf-8-sig避免中文乱码

# 导出指定列
df[['姓名', '年龄']].to_excel("subset.xlsx", index=False)
```

## 数据查看与探索

### 1. 快速查看

```python
import pandas as pd

df = pd.read_excel("patients.xlsx")

# 查看前几行
print(df.head())  # 默认前5行
print(df.head(10))  # 前10行

# 查看后几行
print(df.tail())

# 查看数据形状(行数, 列数)
print(df.shape)  # (100, 5)

# 查看列名
print(df.columns)

# 查看数据类型
print(df.dtypes)

# 查看基本信息
print(df.info())

# 统计描述
print(df.describe())  # 数值列的均值、标准差等
```

### 2. 医学场景示例

```python
import pandas as pd

# 读取患者数据
df = pd.read_excel("patient_data.xlsx")

print("="*60)
print("患者数据概览")
print("="*60)

# 基本信息
print(f"总患者数: {len(df)}人")
print(f"数据列: {', '.join(df.columns)}")

# 前5行
print("\n前5名患者:")
print(df.head())

# 统计信息
print("\n数值列统计:")
print(df.describe())

# 缺失值检查
print("\n缺失值统计:")
print(df.isnull().sum())
```

## 数据选择与筛选

### 1. 选择列

```python
# 选择单列(返回Series)
ages = df['年龄']

# 选择多列(返回DataFrame)
subset = df[['姓名', '年龄', '诊断']]

# 选择列的另一种方式
ages = df.年龄  # 仅当列名是合法变量名时可用
```

### 2. 选择行

```python
# 按索引选择
first_row = df.iloc[0]  # 第一行
first_five = df.iloc[0:5]  # 前5行
last_row = df.iloc[-1]  # 最后一行

# 按标签选择
row = df.loc[0]  # 索引为0的行

# 选择特定行和列
value = df.iloc[0, 1]  # 第1行,第2列
subset = df.iloc[0:5, [0, 1, 3]]  # 前5行,第1,2,4列
```

### 3. 条件筛选(最常用!)

```python
# 单条件筛选
elderly = df[df['年龄'] >= 65]
male = df[df['性别'] == '男']
hypertension = df[df['诊断'] == '高血压']

# 多条件筛选(与)
elderly_male = df[(df['年龄'] >= 65) & (df['性别'] == '男')]

# 多条件筛选(或)
high_risk = df[(df['年龄'] >= 65) | (df['诊断'] == '高血压')]

# 多值筛选(in)
chronic = df[df['诊断'].isin(['高血压', '糖尿病', '高血脂'])]

# 排除筛选(not in)
non_hypertension = df[~df['诊断'].isin(['高血压'])]

# 字符串包含
chest_pain = df[df['主诉'].str.contains('胸痛')]

# 范围筛选
middle_age = df[(df['年龄'] >= 40) & (df['年龄'] < 60)]
```

### 4. 医学场景:复杂筛选

```python
import pandas as pd

df = pd.read_excel("patient_data.xlsx")

# 筛选高风险患者
high_risk = df[
    ((df['年龄'] >= 65) & (df['诊断'] == '高血压')) |
    ((df['年龄'] >= 60) & (df['诊断'] == '糖尿病') & (df['吸烟'] == '是'))
]

print(f"高风险患者数: {len(high_risk)}人")
print("\n高风险患者名单:")
print(high_risk[['姓名', '年龄', '性别', '诊断']])

# 保存筛选结果
high_risk.to_excel("high_risk_patients.xlsx", index=False)
```

## 数据清洗

### 1. 处理缺失值

```python
# 检查缺失值
print(df.isnull().sum())  # 每列的缺失数量
print(df.isnull().any())  # 每列是否有缺失

# 删除缺失值
df_clean = df.dropna()  # 删除任何有缺失值的行
df_clean = df.dropna(subset=['年龄'])  # 只删除年龄列有缺失的行

# 填充缺失值
df['年龄'].fillna(df['年龄'].mean(), inplace=True)  # 用平均值填充
df['诊断'].fillna('未诊断', inplace=True)  # 用指定值填充

# 填充不同的值
fill_values = {'年龄': df['年龄'].mean(), '诊断': '未诊断'}
df.fillna(fill_values, inplace=True)
```

### 2. 处理重复值

```python
# 检查重复
print(df.duplicated().sum())  # 重复行数

# 删除重复
df_unique = df.drop_duplicates()

# 基于特定列删除重复
df_unique = df.drop_duplicates(subset=['患者ID'], keep='first')
# keep='first': 保留第一次出现
# keep='last': 保留最后一次出现
```

### 3. 数据类型转换

```python
# 查看类型
print(df.dtypes)

# 转换类型
df['年龄'] = df['年龄'].astype(int)
df['日期'] = pd.to_datetime(df['日期'])

# 字符串转数字(处理包含非数字的情况)
df['血糖'] = pd.to_numeric(df['血糖'], errors='coerce')  # 无法转换的变为NaN
```

### 4. 医学场景:数据清洗流程

```python
import pandas as pd

def clean_patient_data(file_path):
    """
    清洗患者数据

    处理:
    1. 删除完全重复的记录
    2. 填充缺失值
    3. 转换数据类型
    4. 删除异常值
    """

    # 读取数据
    df = pd.read_excel(file_path)

    print(f"原始数据: {len(df)}行")

    # 1. 删除重复
    df = df.drop_duplicates()
    print(f"删除重复后: {len(df)}行")

    # 2. 处理缺失值
    # 年龄用中位数填充
    df['年龄'].fillna(df['年龄'].median(), inplace=True)

    # 性别用众数填充
    df['性别'].fillna(df['性别'].mode()[0], inplace=True)

    # 诊断为空的删除(关键字段)
    df = df.dropna(subset=['诊断'])
    print(f"删除缺失诊断后: {len(df)}行")

    # 3. 类型转换
    df['年龄'] = df['年龄'].astype(int)
    df['入院日期'] = pd.to_datetime(df['入院日期'])

    # 4. 删除异常值
    # 年龄范围: 0-120
    df = df[(df['年龄'] > 0) & (df['年龄'] <= 120)]

    # 血压合理范围
    df = df[(df['收缩压'] >= 60) & (df['收缩压'] <= 250)]
    df = df[(df['舒张压'] >= 40) & (df['舒张压'] <= 150)]

    print(f"删除异常值后: {len(df)}行")

    # 保存清洗后的数据
    df.to_excel("cleaned_patient_data.xlsx", index=False)
    print("\n清洗完成!已保存到 cleaned_patient_data.xlsx")

    return df

# 使用
clean_df = clean_patient_data("raw_patient_data.xlsx")
```

## 数据统计与分组

### 1. 基本统计

```python
# 单列统计
print(df['年龄'].mean())  # 平均值
print(df['年龄'].median())  # 中位数
print(df['年龄'].std())  # 标准差
print(df['年龄'].min())  # 最小值
print(df['年龄'].max())  # 最大值
print(df['年龄'].sum())  # 总和
print(df['年龄'].count())  # 计数

# 分类统计
print(df['性别'].value_counts())  # 每个类别的数量
print(df['诊断'].value_counts(normalize=True))  # 比例
```

### 2. 分组统计(GroupBy)

```python
# 按单列分组
by_gender = df.groupby('性别')['年龄'].mean()
print("按性别统计平均年龄:")
print(by_gender)

# 按多列分组
by_gender_diagnosis = df.groupby(['性别', '诊断'])['年龄'].mean()

# 多种统计
stats = df.groupby('诊断').agg({
    '年龄': ['mean', 'min', 'max'],
    '收缩压': 'mean',
    '患者ID': 'count'
})

print(stats)
```

### 3. 医学场景:诊断统计报告

```python
import pandas as pd

df = pd.read_excel("patient_data.xlsx")

print("="*70)
print("患者诊断统计报告")
print("="*70)

# 总体统计
print(f"\n总患者数: {len(df)}人")
print(f"平均年龄: {df['年龄'].mean():.1f}岁")
print(f"年龄范围: {df['年龄'].min()}-{df['年龄'].max()}岁")

# 性别分布
print("\n性别分布:")
gender_count = df['性别'].value_counts()
for gender, count in gender_count.items():
    percentage = count / len(df) * 100
    print(f"  {gender}: {count}人 ({percentage:.1f}%)")

# 诊断分布
print("\n诊断分布:")
diagnosis_count = df['诊断'].value_counts()
for diagnosis, count in diagnosis_count.head(10).items():
    percentage = count / len(df) * 100
    print(f"  {diagnosis}: {count}人 ({percentage:.1f}%)")

# 按诊断分组统计
print("\n各诊断平均年龄:")
age_by_diagnosis = df.groupby('诊断')['年龄'].agg(['mean', 'count'])
age_by_diagnosis = age_by_diagnosis.sort_values('count', ascending=False)
print(age_by_diagnosis.head(10))

# 按性别和诊断交叉统计
print("\n性别-诊断交叉表:")
crosstab = pd.crosstab(df['性别'], df['诊断'])
print(crosstab)

print("="*70)
```

## 数据排序

```python
# 单列排序
df_sorted = df.sort_values('年龄')  # 升序
df_sorted = df.sort_values('年龄', ascending=False)  # 降序

# 多列排序
df_sorted = df.sort_values(['诊断', '年龄'])

# 原地排序
df.sort_values('年龄', inplace=True)
```

## 添加和修改列

```python
# 添加新列
df['BMI'] = df['体重'] / (df['身高'] ** 2)

# 基于条件创建列
df['年龄组'] = df['年龄'].apply(lambda x: '老年' if x >= 65 else '中年' if x >= 40 else '青年')

# 或使用numpy.where
import numpy as np
df['高血压'] = np.where(df['收缩压'] >= 140, '是', '否')

# 或使用pd.cut进行分箱
df['年龄段'] = pd.cut(df['年龄'],
                      bins=[0, 40, 60, 120],
                      labels=['青年', '中年', '老年'])

# 修改现有列
df['姓名'] = df['姓名'].str.upper()

# 重命名列
df = df.rename(columns={'旧列名': '新列名'})
```

## 综合实战:患者数据分析

```python
import pandas as pd
import numpy as np

# 读取数据
df = pd.read_excel("hospital_patients.xlsx")

print("="*80)
print("医院患者数据分析报告")
print(f"数据采集时间: 2025-01-15")
print("="*80)

# === 数据清洗 ===
print("\n1. 数据清洗")
print(f"  原始记录数: {len(df)}")

# 删除重复
df = df.drop_duplicates(subset=['患者ID'])
print(f"  删除重复后: {len(df)}")

# 处理缺失值
df['年龄'].fillna(df['年龄'].median(), inplace=True)
df = df.dropna(subset=['诊断'])
print(f"  处理缺失值后: {len(df)}")

# 删除异常值
df = df[(df['年龄'] > 0) & (df['年龄'] <= 120)]
print(f"  删除异常值后: {len(df)}")

# === 基本统计 ===
print("\n2. 患者基本信息")
print(f"  总人数: {len(df)}")
print(f"  平均年龄: {df['年龄'].mean():.1f}岁")
print(f"  年龄中位数: {df['年龄'].median():.0f}岁")

# 性别分布
print("\n3. 性别分布")
gender_stats = df['性别'].value_counts()
for gender, count in gender_stats.items():
    pct = count / len(df) * 100
    print(f"  {gender}: {count}人 ({pct:.1f}%)")

# 年龄段分布
print("\n4. 年龄段分布")
df['年龄段'] = pd.cut(df['年龄'],
                      bins=[0, 18, 40, 60, 120],
                      labels=['儿童(<18)', '青年(18-40)', '中年(40-60)', '老年(60+)'])
age_group_stats = df['年龄段'].value_counts().sort_index()
for group, count in age_group_stats.items():
    pct = count / len(df) * 100
    print(f"  {group}: {count}人 ({pct:.1f}%)")

# 疾病谱分析
print("\n5. 疾病谱分析(Top 10)")
disease_stats = df['诊断'].value_counts().head(10)
for i, (disease, count) in enumerate(disease_stats.items(), 1):
    pct = count / len(df) * 100
    print(f"  {i}. {disease}: {count}人 ({pct:.1f}%)")

# 按诊断分组分析
print("\n6. 各疾病患者特征")
disease_profile = df.groupby('诊断').agg({
    '年龄': 'mean',
    '收缩压': 'mean',
    '舒张压': 'mean',
    '患者ID': 'count'
}).round(1)
disease_profile.columns = ['平均年龄', '平均收缩压', '平均舒张压', '患者数']
disease_profile = disease_profile.sort_values('患者数', ascending=False).head(10)
print(disease_profile)

# 高危患者筛查
print("\n7. 高危患者筛查")
high_risk = df[
    ((df['年龄'] >= 65) & (df['收缩压'] >= 140)) |
    ((df['年龄'] >= 60) & (df['诊断'].str.contains('糖尿病', na=False)))
]
print(f"  高危患者数: {len(high_risk)}人 ({len(high_risk)/len(df)*100:.1f}%)")

# 导出结果
print("\n8. 导出分析结果")
# 总体报告
summary = pd.DataFrame({
    '指标': ['总人数', '平均年龄', '男性占比', '老年人占比', '高危患者占比'],
    '数值': [
        len(df),
        f"{df['年龄'].mean():.1f}岁",
        f"{(df['性别']=='男').sum()/len(df)*100:.1f}%",
        f"{(df['年龄']>=60).sum()/len(df)*100:.1f}%",
        f"{len(high_risk)/len(df)*100:.1f}%"
    ]
})
summary.to_excel("分析报告_总览.xlsx", index=False)

# 疾病谱
disease_stats.to_excel("分析报告_疾病谱.xlsx")

# 高危患者名单
high_risk[['患者ID', '姓名', '年龄', '性别', '诊断', '收缩压', '舒张压']].to_excel(
    "高危患者名单.xlsx", index=False
)

print("  ✓ 分析报告_总览.xlsx")
print("  ✓ 分析报告_疾病谱.xlsx")
print("  ✓ 高危患者名单.xlsx")

print("\n" + "="*80)
print("分析完成!")
print("="*80)
```

## 💡 关键要点

### Pandas核心功能

| 功能 | 方法 | 示例 |
|------|------|------|
| **读取数据** | read_excel, read_csv | `pd.read_excel("data.xlsx")` |
| **查看数据** | head, info, describe | `df.head()` |
| **选择列** | df['列名'] | `df['年龄']` |
| **筛选行** | df[条件] | `df[df['年龄']>=65]` |
| **删除缺失** | dropna | `df.dropna()` |
| **填充缺失** | fillna | `df.fillna(0)` |
| **分组统计** | groupby | `df.groupby('性别')['年龄'].mean()` |
| **排序** | sort_values | `df.sort_values('年龄')` |
| **导出数据** | to_excel, to_csv | `df.to_excel("out.xlsx")` |

### 常用技巧

```python
# 1. 链式操作
result = (df
    .dropna()
    .query('年龄 >= 65')
    .groupby('诊断')['年龄']
    .mean()
    .sort_values(ascending=False)
)

# 2. 使用query简化筛选
elderly = df.query('年龄 >= 65 and 性别 == "男"')

# 3. 使用pipe传递函数
df = (df
    .pipe(lambda x: x.dropna())
    .pipe(lambda x: x[x['年龄'] > 0])
)
```

## 下一步

掌握了Pandas后,下一节[NumPy:数值计算基础](4.2-numpy-basics.md)将学习高效的数值计算!

---

## 🔨 练习任务

```python
# 任务1: 读取患者数据并进行清洗
# - 删除重复记录
# - 处理缺失值
# - 删除年龄异常的记录

# 任务2: 统计分析
# - 按性别统计人数
# - 按诊断统计平均年龄
# - 生成交叉表

# 任务3: 筛选高风险患者
# - 年龄>=65或血压>=140/90
# - 导出名单到Excel

# 任务4: 生成完整报告
# - 包含基本统计、疾病谱、高危患者
# - 保存为多个Excel工作表
```

> 💡 提示:Pandas文档非常详细,遇到问题可以Google或问ChatGPT!
